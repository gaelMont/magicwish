This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/api/search/route.ts
app/favicon.ico
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/wishlist/page.tsx
components/Header.tsx
eslint.config.mjs
lib/AuthContext.tsx
lib/firebase.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="app/layout.tsx">
// app/layout.tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/lib/AuthContext';
import Header from '@/components/Header'; 
import { Toaster } from 'react-hot-toast'; // <--- IMPORT ICI

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'MagicWish',
  description: 'Votre wishlist de cartes Magic',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="fr">
      <body className={inter.className}>
        <AuthProvider>
          <Header />
          {children}
          <Toaster position="bottom-right" /> {/* <--- AJOUTE √áA ICI */}
        </AuthProvider>
      </body>
    </html>
  );
}
</file>

<file path="app/login/page.tsx">
// Fichier : app/login/page.tsx

'use client'; // Cette page est interactive

import { useRouter } from 'next/navigation'; // Pour rediriger l'utilisateur
import { useAuth } from '@/lib/AuthContext'; // On utilise notre "raccourci" !

export default function LoginPage() {
  // On r√©cup√®re les infos de notre "carte d'identit√©"
  const { user, signInWithGoogle, loading } = useAuth();
  const router = useRouter(); // L'outil de redirection

  // Si le chargement est termin√© ET que l'utilisateur est D√âJ√Ä connect√©...
  if (!loading && user) {
    // ...on le renvoie √† la page d'accueil.
    router.push('/');
    return null; // On n'affiche rien sur cette page
  }

  // Si on charge, on affiche un message simple
  if (loading) {
    return <p>Chargement...</p>;
  }

  // C'est le HTML (JSX) qui s'affiche
  return (
    <main className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <h1 className="text-3xl font-bold mb-4">Bienvenue sur MagicWish</h1>
        <p className="mb-6">Veuillez vous connecter pour cr√©er votre wishlist.</p>
        
        {/* LE BOUTON DE CONNEXION */}
        <button
          onClick={signInWithGoogle} // Au clic, on appelle la fonction du Contexte
          className="bg-blue-500 text-white p-3 rounded-lg font-semibold"
        >
          Se connecter avec Google
        </button>
      </div>
    </main>
  );
}
</file>

<file path="components/Header.tsx">
// components/Header.tsx
'use client';

import Link from 'next/link';
import { useAuth } from '@/lib/AuthContext';

export default function Header() {
  const { user, logOut } = useAuth();

  return (
    <header className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 p-4 shadow-sm">
      <div className="container mx-auto flex justify-between items-center">
        <Link href="/" className="text-xl font-bold text-blue-600 dark:text-blue-400 hover:opacity-80">
          ‚ú® MagicWish
        </Link>

        <div>
          {user ? (
            <div className="flex items-center gap-4">
              {/* LIEN WISHLIST AJOUT√â ICI */}
              <Link 
                href="/wishlist" 
                className="font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400"
              >
                Ma Wishlist
              </Link>

              <div className="h-6 w-px bg-gray-300 dark:bg-gray-600 mx-1 hidden md:block"></div>

              {/* Avatar */}
              {user.photoURL && (
                <img 
                  src={user.photoURL} 
                  alt="Avatar" 
                  className="w-8 h-8 rounded-full border border-gray-300"
                  title={user.displayName || ''}
                />
              )}

              <button
                onClick={logOut}
                className="text-sm bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400 px-3 py-1 rounded hover:opacity-80 transition"
              >
                D√©connexion
              </button>
            </div>
          ) : (
            <Link
              href="/login"
              className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
            >
              Se connecter
            </Link>
          )}
        </div>
      </div>
    </header>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="lib/AuthContext.tsx">
// Fichier : lib/AuthContext.tsx

'use client'; // Ce fichier est c√¥t√© client (navigateur)

import React, { createContext, useContext, useEffect, useState } from 'react';
import { 
  onAuthStateChanged, 
  GoogleAuthProvider, 
  signInWithPopup, 
  signOut,
  type User // Le "type" de l'utilisateur Firebase
} from 'firebase/auth';
import { auth } from './firebase'; // On importe 'auth' de notre fichier firebase.ts

// 1. On d√©finit la forme de notre "carte d'identit√©" (le Contexte)
interface AuthContextType {
  user: User | null; // L'utilisateur (ou null s'il n'est pas connect√©)
  loading: boolean; // Pour savoir si on est en train de v√©rifier (au chargement)
  signInWithGoogle: () => Promise<void>; // La fonction pour se connecter
  logOut: () => Promise<void>; // La fonction pour se d√©connecter
}

// 2. On cr√©e le Contexte
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// 3. On cr√©e "l'Enveloppe" (le Fournisseur/Provider)
export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true); // On commence en mode "chargement"

  // Cette fonction s'ex√©cute quand on se connecte avec Google
  const signInWithGoogle = async () => {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
    } catch (error) {
      console.error("Erreur lors de la connexion Google", error);
    }
  };

  // Cette fonction s'ex√©cute quand on se d√©connecte
  const logOut = async () => {
    try {
      await signOut(auth);
    } catch (error) {
      console.error("Erreur lors de la d√©connexion", error);
    }
  };

  // C'est le C≈íUR du syst√®me.
  // Ce 'useEffect' s'ex√©cute une fois au d√©marrage.
  // 'onAuthStateChanged' est un "auditeur" de Firebase.
  // Il nous dit "un utilisateur s'est connect√©" ou "il s'est d√©connect√©".
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user); // On met √† jour la "carte d'identit√©"
      setLoading(false); // On a fini de v√©rifier, on arr√™te de charger
    });

    // On "nettoie" l'auditeur quand le composant est d√©truit
    return () => unsubscribe();
  }, []);

  // On fournit la "carte d'identit√©" (valeur) √† tous les enfants (children)
  const value = {
    user,
    loading,
    signInWithGoogle,
    logOut
  };

  // On n'affiche l'app que si on n'est pas en train de charger
  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

// 4. On cr√©e un "raccourci" (un Hook) pour lire le contexte facilement
// Au lieu d'√©crire 'useContext(AuthContext)' partout, on √©crira 'useAuth()'
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth doit √™tre utilis√© dans un AuthProvider');
  }
  return context;
};
</file>

<file path="lib/firebase.ts">
import { initializeApp, getApps, getApp, type FirebaseApp } from "firebase/app"; 
import { getAuth } from "firebase/auth";
import { getFirestore } from "firebase/firestore";
import { getAnalytics, isSupported, type Analytics } from "firebase/analytics"; 
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
  measurementId: process.env.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID
};

let app: FirebaseApp; 
if (!getApps().length) {
  app = initializeApp(firebaseConfig);
} else {
  app = getApp();
}

const auth = getAuth(app);
const db = getFirestore(app);

let analytics: Analytics | undefined;
if (typeof window !== 'undefined') {
  isSupported().then((supported) => {
    if (supported) {
      analytics = getAnalytics(app);
    }
  });
}

export { app, auth, db, analytics };
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "magicwish",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "firebase": "^12.5.0",
    "next": "^16.0.8",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-hot-toast": "^2.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="app/api/search/route.ts">
// app/api/search/route.ts
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const query = searchParams.get('q'); 

  if (!query) {
    return NextResponse.json(
      { error: 'Aucun terme de recherche fourni.' }, 
      { status: 400 } 
    );
  }

  // --- MODIFICATION ICI : Ajout des guillemets "${query}" ---
  // Cela force la recherche exacte de l'expression
  const scryfallUrl = `https://api.scryfall.com/cards/search?q="${query}"&unique=prints`;

  try {
    const scryfallResponse = await fetch(scryfallUrl);

    if (!scryfallResponse.ok) {
      const errorData = await scryfallResponse.json();
      console.error('Erreur Scryfall:', errorData);
      return NextResponse.json(
        { error: errorData.details || 'Carte non trouv√©e' }, 
        { status: scryfallResponse.status }
      );
    }

    const data = await scryfallResponse.json();
    return NextResponse.json(data);

  } catch (error) {
    console.error('Erreur interne du serveur:', error);
    return NextResponse.json(
      { error: 'Une erreur est survenue sur le serveur.' }, 
      { status: 500 }
    );
  }
}
</file>

<file path="app/wishlist/page.tsx">
// app/wishlist/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { collection, onSnapshot, deleteDoc, doc, updateDoc, increment } from 'firebase/firestore';
import toast from 'react-hot-toast';

// Mise √† jour du Type pour inclure le nom de l'√©dition (setName)
type WishlistCard = {
  id: string;
  name: string;
  imageUrl: string;
  quantity: number;
  price?: number;
  setName?: string; // <--- Nouveau champ optionnel
};

export default function WishlistPage() {
  const { user, loading } = useAuth();
  const [cards, setCards] = useState<WishlistCard[]>([]);

  useEffect(() => {
    if (!user) return;

    // √âcoute en temps r√©el de la collection Wishlist
    const unsubscribe = onSnapshot(collection(db, 'users', user.uid, 'wishlist'), (snapshot) => {
      const items = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        quantity: doc.data().quantity || 1,
        price: doc.data().price || 0,
        setName: doc.data().setName || null // On r√©cup√®re l'√©dition si elle existe
      })) as WishlistCard[];
      
      // Tri par nom alphab√©tique
      items.sort((a, b) => a.name.localeCompare(b.name));
      setCards(items);
    });

    return () => unsubscribe();
  }, [user]);

  // Gestion des quantit√©s (+ / -) et suppression
  const updateQuantity = async (cardId: string, amount: number, currentQuantity: number) => {
    if (!user) return;
    const cardRef = doc(db, 'users', user.uid, 'wishlist', cardId);

    if (currentQuantity + amount <= 0) {
      // Demande de confirmation avant suppression
      if (confirm('Voulez-vous retirer cette carte de la liste ?')) {
        await deleteDoc(cardRef);
        toast('Carte retir√©e', { icon: 'üóëÔ∏è' });
      }
    } else {
      await updateDoc(cardRef, { quantity: increment(amount) });
    }
  };

  // Calcul du Grand Total
  const totalPrice = cards.reduce((acc, card) => {
    return acc + (card.price || 0) * card.quantity;
  }, 0);

  if (loading) return <p className="text-center p-10">Chargement...</p>;
  if (!user) return <p className="text-center p-10">Connectez-vous pour voir votre liste.</p>;

  return (
    <main className="container mx-auto p-4">
      {/* En-t√™te avec Titre et Total */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <h1 className="text-3xl font-bold text-center md:text-left">
          Ma Wishlist 
          <span className="ml-3 text-lg font-normal text-gray-500">
            ({cards.reduce((acc, c) => acc + c.quantity, 0)} cartes)
          </span>
        </h1>
        
        <div className="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100 px-6 py-3 rounded-xl shadow-sm border border-green-200 dark:border-green-700">
          <span className="text-sm uppercase tracking-wide opacity-80">Estimation Total</span>
          <div className="text-2xl font-bold">{totalPrice.toFixed(2)} ‚Ç¨</div>
        </div>
      </div>

      {/* Grille des cartes */}
      {cards.length === 0 ? (
        <p className="text-center text-gray-500 mt-10">Votre wishlist est vide.</p>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {cards.map((card) => (
            <div key={card.id} className="flex bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden p-3 gap-4 items-center border border-gray-100 dark:border-gray-700">
              {/* Image Miniature */}
              <img
                src={card.imageUrl}
                alt={card.name}
                className="w-20 h-28 object-cover rounded shadow-sm bg-gray-200"
              />
              
              <div className="flex-1 min-w-0">
                <h3 className="font-bold text-lg truncate" title={card.name}>{card.name}</h3>
                
                {/* --- NOUVEAU : Affichage de l'√©dition --- */}
                {card.setName && (
                  <p className="text-xs text-blue-600 dark:text-blue-400 mb-1 truncate font-medium">
                    {card.setName}
                  </p>
                )}
                
                {/* Prix unitaire */}
                <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                  Prix unit. : {card.price && card.price > 0 ? `${card.price} ‚Ç¨` : 'N/A'}
                </p>
                
                {/* Contr√¥les Quantit√© et Prix Total ligne */}
                <div className="flex justify-between items-end mt-2">
                  <div className="flex items-center gap-3">
                    <button 
                      onClick={() => updateQuantity(card.id, -1, card.quantity)}
                      className="bg-gray-200 dark:bg-gray-700 w-8 h-8 rounded hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center font-bold transition-colors"
                    >
                      -
                    </button>
                    
                    <span className="font-mono text-xl w-6 text-center">{card.quantity}</span>
                    
                    <button 
                      onClick={() => updateQuantity(card.id, 1, card.quantity)}
                      className="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 w-8 h-8 rounded hover:bg-blue-200 dark:hover:bg-blue-800 flex items-center justify-center font-bold transition-colors"
                    >
                      +
                    </button>
                  </div>

                  {/* Prix total de la ligne (Qt√© * Prix) */}
                  {card.price && card.price > 0 && (
                     <div className="font-bold text-lg text-right text-gray-700 dark:text-gray-200">
                       {(card.price * card.quantity).toFixed(2)} ‚Ç¨
                     </div>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </main>
  );
}
</file>

<file path="app/page.tsx">
// app/page.tsx
'use client'; 

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, setDoc, updateDoc, getDoc, increment } from 'firebase/firestore'; 
import toast from 'react-hot-toast';

// --- TYPES ---
type ScryfallCard = {
  id: string;
  oracle_id: string; // <--- C'est la cl√© magique pour le groupement
  name: string;
  set_name: string;
  set: string;
  released_at: string;
  image_uris?: {
    small: string;
    normal: string;
  };
  card_faces?: {
    image_uris?: {
      small: string;
      normal: string;
    };
  }[];
  prices?: {
    eur?: string;
  };
};

const CARD_BACK_URL = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";

// --- FONCTION UTILITAIRE IMAGE ---
const getCardImage = (card: ScryfallCard): string => {
  if (card.image_uris?.normal) return card.image_uris.normal;
  if (card.card_faces && card.card_faces[0]?.image_uris?.normal) {
    return card.card_faces[0].image_uris.normal;
  }
  return CARD_BACK_URL;
};

// --- SOUS-COMPOSANT : G√®re l'affichage d'une carte et ses versions ---
const CardGroup = ({ name, versions }: { name: string, versions: ScryfallCard[] }) => {
  const { user } = useAuth();
  
  // Par d√©faut, on prend la version la plus r√©cente (souvent la 1√®re de la liste renvoy√©e)
  const [selectedCard, setSelectedCard] = useState<ScryfallCard>(versions[0]);

  const handleVersionChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const newVersion = versions.find(v => v.id === e.target.value);
    if (newVersion) setSelectedCard(newVersion);
  };

  const addToWishlist = async () => {
    if (!user) {
      toast.error("Connectez-vous pour ajouter des cartes !");
      return;
    }

    const card = selectedCard; 
    const wishlistRef = doc(db, 'users', user.uid, 'wishlist', card.id);
    const validImageUrl = getCardImage(card);
    const priceNumber = card.prices?.eur ? parseFloat(card.prices.eur) : 0;
    
    // On nettoie le nom pour la sauvegarde aussi
    const cleanName = card.name.split(' // ')[0];

    try {
      const docSnap = await getDoc(wishlistRef);
      if (docSnap.exists()) {
        await updateDoc(wishlistRef, { 
          quantity: increment(1),
          price: priceNumber
        });
        toast.success(`+1 exemplaire (${card.set_name})`);
      } else {
        await setDoc(wishlistRef, {
          name: cleanName, // On sauvegarde le nom propre
          imageUrl: validImageUrl,
          quantity: 1,
          price: priceNumber,
          setName: card.set_name,
          setCode: card.set,
          addedAt: new Date()
        });
        toast.success(`Ajout√©e : ${card.set_name}`);
      }
    } catch (error) {
      console.error(error);
      toast.error("Erreur sauvegarde");
    }
  };

  return (
    <div className="relative group flex flex-col h-full bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 overflow-hidden">
      {/* Image qui change selon la s√©lection */}
      <div className="relative w-full min-h-[250px] bg-gray-200 dark:bg-gray-900 flex items-center justify-center p-2">
        <img
          src={getCardImage(selectedCard)}
          alt={name}
          className="w-full h-full object-contain max-h-[350px]"
        />
      </div>

      <div className="p-3 flex flex-col flex-grow gap-2">
        <h3 className="font-bold text-center truncate" title={name}>{name}</h3>

        {/* --- S√âLECTEUR D'√âDITION --- */}
        <select 
          value={selectedCard.id}
          onChange={handleVersionChange}
          className="w-full p-2 text-xs border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white outline-none cursor-pointer"
        >
          {versions.map((v) => (
            <option key={v.id} value={v.id}>
              {v.set_name} ({v.set.toUpperCase()}) - {v.prices?.eur ? `${v.prices.eur}‚Ç¨` : "N/A"}
            </option>
          ))}
        </select>

        {/* PRIX et BOUTON */}
        <div className="flex justify-between items-center mt-auto pt-2 border-t border-gray-100 dark:border-gray-700">
          <span className="font-bold text-blue-600 dark:text-blue-400">
             {selectedCard.prices?.eur ? `${selectedCard.prices.eur} ‚Ç¨` : "Prix N/A"}
          </span>

          {user && (
            <button
              onClick={addToWishlist}
              className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-full text-sm font-medium transition shadow-sm"
            >
              Ajouter +
            </button>
          )}
        </div>
      </div>
    </div>
  );
};


// --- COMPOSANT PRINCIPAL ---
export default function HomePage() {
  const [query, setQuery] = useState('');
  const [groupedResults, setGroupedResults] = useState<{ name: string, versions: ScryfallCard[] }[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!query.trim()) return;

    setIsLoading(true);
    setGroupedResults([]); 

    try {
      const response = await fetch(`/api/search?q=${query}`);
      if (!response.ok) throw new Error('Erreur');
      const data = await response.json();
      const rawCards: ScryfallCard[] = data.data || [];

      // --- NOUVEL ALGORITHME DE GROUPEMENT (PAR ORACLE_ID) ---
      // C'est beaucoup plus robuste : toutes les variantes d'une carte partagent le m√™me oracle_id
      const groups = new Map<string, ScryfallCard[]>();

      rawCards.forEach(card => {
        // Si oracle_id n'existe pas (rare, cartes sp√©ciales), on utilise le nom comme secours
        const groupKey = card.oracle_id || card.name; 

        if (!groups.has(groupKey)) {
          groups.set(groupKey, []);
        }
        groups.get(groupKey)?.push(card);
      });

      // On transforme le Map en tableau pour l'afficher
      const resultsArray = Array.from(groups.values()).map((versions) => {
        // Pour le nom d'affichage, on prend le nom de la premi√®re carte 
        // et on le nettoie (on retire " // ...") pour que ce soit joli
        const displayName = versions[0].name.split(' // ')[0];
        return {
          name: displayName,
          versions: versions
        };
      });

      setGroupedResults(resultsArray);

    } catch (err) {
      toast.error("Aucune carte trouv√©e.");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <main className="container mx-auto p-4 max-w-7xl">
      <h1 className="text-3xl font-bold mb-8 text-center mt-8">MagicWish ‚ú®</h1>

      <form onSubmit={handleSearch} className="flex gap-2 mb-10 max-w-xl mx-auto">
        <input
          type="text"
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Rechercher (ex: Sol Ring)..."
          className="flex-grow p-3 border rounded-lg shadow-sm outline-none transition-colors
            bg-white text-gray-900 border-gray-300 placeholder-gray-500
            dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:placeholder-gray-400"
        />
        <button 
          type="submit" 
          disabled={isLoading}
          className="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-lg font-semibold disabled:opacity-50 transition"
        >
          {isLoading ? '...' : 'üîç'}
        </button>
      </form>

      {/* GRILLE D'AFFICHAGE */}
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {groupedResults.map((group) => (
          <CardGroup 
            key={group.name} // React demande une cl√© unique
            name={group.name} 
            versions={group.versions} 
          />
        ))}
      </div>
    </main>
  );
}
</file>

</files>
