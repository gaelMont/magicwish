This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.firebaserc
.gitignore
app/actions/friends.ts
app/actions/trade-proposal.ts
app/actions/trade.ts
app/actions/wishlist.ts
app/api/portal/route.ts
app/api/search/route.ts
app/api/webhook/stripe/route.ts
app/collection/page.tsx
app/contacts/page.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/premium/page.tsx
app/search/page.tsx
app/trades/manual/page.tsx
app/trades/new/[uid]/page.tsx
app/trades/page.tsx
app/user/[uid]/page.tsx
app/wishlist/page.tsx
components/AdContainer.tsx
components/CardVersionPickerModal.tsx
components/CollectionToolsModal.tsx
components/ConfirmModal.tsx
components/DeleteAllButton.tsx
components/Header.tsx
components/ImportModal.tsx
components/MagicCard.tsx
components/ThemeProvider.tsx
components/ThemeToggle.tsx
components/UsernameSetupModal.tsx
components/wishlist/GlobalWishlistView.tsx
components/wishlist/SingleWishlistView.tsx
eslint.config.mjs
firebase.json
firestore.indexes.json
firestore.rules
hooks/useCardCollection.ts
hooks/useFriends.ts
hooks/usePremium.ts
hooks/useTradeMatcher.ts
hooks/useTradeSystem.ts
hooks/useWishlists.ts
lib/AuthContext.tsx
lib/cardUtils.ts
lib/firebase-admin.ts
lib/firebase.ts
lib/services/collectionService.ts
lib/validators.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/manifest.json
public/next.svg
public/vercel.svg
public/window.svg
README.md
repomix-output-previous.xml
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".firebaserc">
{
  "projects": {
    "mw": "magicwish-48604"
  },
  "targets": {},
  "etags": {}
}
</file>

<file path="app/actions/friends.ts">
// app/actions/friends.ts
'use server';

import { getAdminFirestore } from '@/lib/firebase-admin';

// D√©finition stricte des types pour √©viter le 'any'
type FriendInput = {
  uid: string;
  username: string;
  displayName: string;
  photoURL: string | null;
};

type ActionResponse = {
  success: boolean;
  error?: string;
};

export async function acceptFriendRequestAction(
  currentUserId: string,
  targetUser: FriendInput
): Promise<ActionResponse> {
  const db = getAdminFirestore();
  
  try {
    // 1. R√©cup√©rer les infos √† jour de l'utilisateur courant (pour √™tre s√ªr des donn√©es)
    const currentUserDoc = await db.doc(`users/${currentUserId}/public_profile/info`).get();
    
    if (!currentUserDoc.exists) {
      throw new Error("Profil utilisateur introuvable.");
    }

    const currentUserData = currentUserDoc.data();
    
    // On s√©curise les donn√©es de l'utilisateur courant
    const currentUserPayload: FriendInput = {
        uid: currentUserId,
        username: currentUserData?.username || "Inconnu",
        displayName: currentUserData?.displayName || "Sans nom",
        photoURL: currentUserData?.photoURL || null
    };

    // 2. Pr√©parer le Batch
    const batch = db.batch();

    // A. Ajouter l'ami dans MA liste
    const myFriendRef = db.doc(`users/${currentUserId}/friends/${targetUser.uid}`);
    batch.set(myFriendRef, {
      uid: targetUser.uid,
      username: targetUser.username,
      displayName: targetUser.displayName,
      photoURL: targetUser.photoURL || null,
      addedAt: new Date()
    });

    // B. M'ajouter dans SA liste (C'est ici que √ßa bloquait c√¥t√© client)
    const hisFriendRef = db.doc(`users/${targetUser.uid}/friends/${currentUserId}`);
    batch.set(hisFriendRef, {
      ...currentUserPayload,
      addedAt: new Date()
    });

    // C. Supprimer la demande d'ami re√ßue
    const reqRef = db.doc(`users/${currentUserId}/friend_requests_received/${targetUser.uid}`);
    batch.delete(reqRef);

    // 3. Valider la transaction
    await batch.commit();

    return { success: true };

  } catch (error: unknown) {
    console.error("Erreur acceptFriendRequestAction:", error);
    let errorMessage = "Erreur serveur";
    
    if (error instanceof Error) {
        errorMessage = error.message;
    } else if (typeof error === "string") {
        errorMessage = error;
    }

    return { success: false, error: errorMessage };
  }
}
</file>

<file path="app/actions/trade-proposal.ts">
// app/actions/trade-proposal.ts
'use server';

import { getAdminFirestore } from '@/lib/firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';
import { z } from 'zod';
// Import du sch√©ma partag√© pour √©viter la duplication
import { CardSchema } from '@/lib/validators';

// On r√©utilise CardSchema pour d√©finir la structure de la proposition
const ProposalSchema = z.object({
  senderUid: z.string().min(1),
  senderName: z.string().min(1),
  receiverUid: z.string().min(1),
  receiverName: z.string().min(1),
  itemsGiven: z.array(CardSchema),
  itemsReceived: z.array(CardSchema)
});

type ActionResponse = {
  success: boolean;
  error?: string;
};

export async function proposeTradeAction(rawData: unknown): Promise<ActionResponse> {
  const db = getAdminFirestore();

  try {
    // 1. PARSING & VALIDATION
    const data = ProposalSchema.parse(rawData);

    // 2. VALIDATION M√âTIER SUPPL√âMENTAIRE
    if (data.itemsGiven.length === 0 && data.itemsReceived.length === 0) {
      throw new Error("La proposition ne peut pas √™tre vide.");
    }

    // 3. ENREGISTREMENT
    // Les donn√©es sont garanties propres par Zod
    await db.collection('trades').add({
      senderUid: data.senderUid,
      senderName: data.senderName,
      receiverUid: data.receiverUid,
      receiverName: data.receiverName,
      itemsGiven: data.itemsGiven,
      itemsReceived: data.itemsReceived,
      status: 'pending',
      createdAt: FieldValue.serverTimestamp()
    });

    return { success: true };

  } catch (error: unknown) {
    console.error("Erreur proposeTradeAction:", error);
    let errorMessage = "Erreur lors de la proposition";
    
    if (error instanceof z.ZodError) {
      errorMessage = "Donn√©es invalides : " + error.issues.map(i => i.message).join(', ');
    } else if (error instanceof Error) {
      errorMessage = error.message;
    }

    return { success: false, error: errorMessage };
  }
}
</file>

<file path="app/actions/wishlist.ts">
// app/actions/wishlist.ts
'use server';

import { getAdminFirestore } from '@/lib/firebase-admin';

type ActionResponse = {
  success: boolean;
  error?: string;
};

export async function deleteWishlistAction(userId: string, listId: string): Promise<ActionResponse> {
  const db = getAdminFirestore();

  try {
    // 1. R√©cup√©rer toutes les cartes de la sous-collection
    // Note : Si la liste contient plus de 500 cartes, il faudrait boucler. 
    // Ici on g√®re un batch simple (jusqu'√† 500 ops), suffisant pour une wishlist standard.
    const cardsRef = db.collection(`users/${userId}/wishlists_data/${listId}/cards`);
    const snapshot = await cardsRef.get();

    const batch = db.batch();

    // 2. Ajouter la suppression de chaque carte au batch
    snapshot.docs.forEach((doc) => {
      batch.delete(doc.ref);
    });

    // 3. Supprimer le document de m√©tadonn√©es (le pointeur de la liste)
    const metaRef = db.doc(`users/${userId}/wishlists_meta/${listId}`);
    batch.delete(metaRef);

    // 4. Ex√©cuter
    await batch.commit();

    return { success: true };

  } catch (error: unknown) {
    console.error("Erreur deleteWishlistAction:", error);
    let errorMessage = "Erreur suppression";
    if (error instanceof Error) errorMessage = error.message;
    
    return { success: false, error: errorMessage };
  }
}
</file>

<file path="app/login/page.tsx">
// Fichier : app/login/page.tsx

'use client'; // Cette page est interactive

import { useRouter } from 'next/navigation'; // Pour rediriger l'utilisateur
import { useAuth } from '@/lib/AuthContext'; // On utilise notre "raccourci" !

export default function LoginPage() {
  // On r√©cup√®re les infos de notre "carte d'identit√©"
  const { user, signInWithGoogle, loading } = useAuth();
  const router = useRouter(); // L'outil de redirection

  // Si le chargement est termin√© ET que l'utilisateur est D√âJ√Ä connect√©...
  if (!loading && user) {
    // ...on le renvoie √† la page d'accueil.
    router.push('/');
    return null; // On n'affiche rien sur cette page
  }

  // Si on charge, on affiche un message simple
  if (loading) {
    return <p>Chargement...</p>;
  }

  // C'est le HTML (JSX) qui s'affiche
  return (
    <main className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <h1 className="text-3xl font-bold mb-4">Bienvenue sur MagicWish</h1>
        <p className="mb-6">Veuillez vous connecter pour cr√©er votre wishlist.</p>
        
        {/* LE BOUTON DE CONNEXION */}
        <button
          onClick={signInWithGoogle} // Au clic, on appelle la fonction du Contexte
          className="bg-blue-500 text-white p-3 rounded-lg font-semibold"
        >
          Se connecter avec Google
        </button>
      </div>
    </main>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="firebase.json">
{
  "firestore": {
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  }
}
</file>

<file path="firestore.indexes.json">
{
  "indexes": [
    {
      "collectionGroup": "trades",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "receiverUid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "status",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        },
        {
          "fieldPath": "__name__",
          "order": "DESCENDING"
        }
      ],
      "density": "SPARSE_ALL"
    },
    {
      "collectionGroup": "trades",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "senderUid",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "status",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        },
        {
          "fieldPath": "__name__",
          "order": "DESCENDING"
        }
      ],
      "density": "SPARSE_ALL"
    }
  ],
  "fieldOverrides": [
    {
      "collectionGroup": "public_profile",
      "fieldPath": "username",
      "ttl": false,
      "indexes": [
        {
          "order": "ASCENDING",
          "queryScope": "COLLECTION"
        },
        {
          "order": "DESCENDING",
          "queryScope": "COLLECTION"
        },
        {
          "arrayConfig": "CONTAINS",
          "queryScope": "COLLECTION"
        },
        {
          "order": "ASCENDING",
          "queryScope": "COLLECTION_GROUP"
        }
      ]
    }
  ]
}
</file>

<file path="firestore.rules">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FONCTIONS UTILITAIRES ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Co√ªt : 1 lecture
    function isFriend(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)/friends/$(request.auth.uid));
    }

    // --- NOUVEAU : CORRECTION POUR LA RECHERCHE ---
    // Cette r√®gle globale est indispensable pour "searchUsers" (collectionGroup)
    match /{path=**}/public_profile/{docId} {
      allow read: if isAuthenticated();
    }

    // --- R√àGLES PAR COLLECTION ---

    // 1. PSEUDOS
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }

    // 2. DONN√âES UTILISATEUR
    match /users/{userId} {

      // A. Profil Public
      match /public_profile/info {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }

      // B. Collection & Wishlist
      match /collection/{cardId} {
        allow read: if isOwner(userId) || isFriend(userId);
        allow write: if isOwner(userId);
      }

      match /wishlist/{cardId} {
        allow read: if isOwner(userId) || isFriend(userId);
        allow write: if isOwner(userId);
      }

      // C. Wishlists Multiples
      match /wishlists_meta/{listId} {
        allow read: if isOwner(userId) || isFriend(userId);
        allow write: if isOwner(userId);
      }
      match /wishlists_data/{listId}/cards/{cardId} {
        allow read: if isOwner(userId) || isFriend(userId);
        allow write: if isOwner(userId);
      }

      // D. Amis
      // CORRECTION : On autorise le delete si c'est MOI ou si c'est L'AMI en question (pour le nettoyage r√©ciproque)
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
        allow delete: if isOwner(userId) || request.auth.uid == friendId;
      }

      // E. Demandes d'amis Re√ßues
      // CORRECTION : On remplace 'create' par 'write' pour g√©rer le cas o√π le document existe d√©j√† (demande renvoy√©e)
      match /friend_requests_received/{senderId} {
        allow read: if isOwner(userId);
        
        allow write: if isAuthenticated() 
                     && request.resource.data.uid == request.auth.uid
                     && request.auth.uid == senderId; // S√©curit√© : seul l'exp√©diteur peut √©crire sa propre demande
                     
        allow delete: if isOwner(userId) || request.auth.uid == senderId;
      }
    }

    // 3. PROPOSITIONS D'√âCHANGE
    match /trades/{tradeId} {
      // Lecture : Participants uniquement
      allow read: if isAuthenticated() && (
        resource.data.senderUid == request.auth.uid || 
        resource.data.receiverUid == request.auth.uid
      );

      // Cr√©ation : Je dois √™tre l'exp√©diteur
      allow create: if isAuthenticated() && request.resource.data.senderUid == request.auth.uid;

      // Mise √† jour : Status uniquement (cancelled/rejected) par le client
      allow update: if isAuthenticated() 
        && (resource.data.senderUid == request.auth.uid || resource.data.receiverUid == request.auth.uid)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
        && request.resource.data.status in ['cancelled', 'rejected'];
    }
  }
}
</file>

<file path="lib/services/collectionService.ts">
// lib/services/collectionService.ts
import { db } from '@/lib/firebase';
import { doc, runTransaction, increment, serverTimestamp } from 'firebase/firestore';
import { CardType } from '@/hooks/useCardCollection';

/**
 * D√©place une carte d'une Wishlist vers la Collection principale.
 * G√®re la transaction atomique (Ajout Collection + Suppression Wishlist).
 */
export async function moveCardFromWishlistToCollection(
    userId: string,
    card: CardType,
    originListId: string = 'default'
): Promise<{ success: boolean; error?: string }> {
    
    try {
        const sourcePath = originListId === 'default' 
            ? 'wishlist' 
            : `wishlists_data/${originListId}/cards`;
            
        const wishlistRef = doc(db, 'users', userId, sourcePath, card.id);
        const collectionRef = doc(db, 'users', userId, 'collection', card.id);

        await runTransaction(db, async (transaction) => {
            // Lecture (n√©cessaire avant √©criture dans une transaction)
            const colDoc = await transaction.get(collectionRef);

            // √âcritures
            if (colDoc.exists()) {
                // Si la carte existe, on incr√©mente
                transaction.update(collectionRef, { 
                    quantity: increment(card.quantity) 
                });
            } else {
                // Sinon on cr√©e
                transaction.set(collectionRef, { 
                    ...card,
                    // On s'assure que les champs sont propres
                    imageBackUrl: card.imageBackUrl || null, 
                    wishlistId: null, // Elle n'est plus dans une wishlist
                    addedAt: serverTimestamp(), // Utilisation du timestamp client
                    isFoil: card.isFoil || false,
                    isForTrade: false // Par d√©faut, pas √† l'√©change quand on vient de l'acheter
                });
            }

            // Suppression de la source
            transaction.delete(wishlistRef);
        });

        return { success: true };

    } catch (error: unknown) {
        console.error("Erreur Service Collection:", error);
        let msg = "Erreur inconnue";
        if (error instanceof Error) msg = error.message;
        return { success: false, error: msg };
    }
}
</file>

<file path="lib/validators.ts">
// lib/validators.ts
import { z } from 'zod';

// Sch√©ma complet d'une carte (bas√© sur ton CardType)
export const CardSchema = z.object({
  id: z.string().min(1),
  name: z.string().min(1),
  imageUrl: z.string().url(),
  imageBackUrl: z.string().nullable().optional(),
  quantity: z.number().int().positive(),
  price: z.number().min(0).default(0),
  customPrice: z.number().min(0).optional(),
  setName: z.string().default(''),
  setCode: z.string().default(''),
  isFoil: z.boolean().default(false),
  isSpecificVersion: z.boolean().default(false),
  isForTrade: z.boolean().default(false).optional(),
  wishlistId: z.string().nullable().optional(),
  // On accepte un objet inconnu pour scryfallData, mais on le type proprement
  scryfallData: z.record(z.string(), z.unknown()).nullable().optional()
});

// Sch√©ma pour l'ex√©cution d'un √©change
export const TradeExecutionSchema = z.object({
  tradeId: z.string().min(1),
  senderUid: z.string().min(1),
  receiverUid: z.string().min(1),
  itemsGiven: z.array(CardSchema),
  itemsReceived: z.array(CardSchema)
});

// Type d√©duit automatiquement pour l'usage dans TypeScript
export type ValidatedCard = z.infer<typeof CardSchema>;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="repomix-output-previous.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
app/actions/trade.ts
app/api/portal/route.ts
app/api/search/route.ts
app/api/webhook/stripe/route.ts
app/collection/page.tsx
app/contacts/page.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/premium/page.tsx
app/search/page.tsx
app/trades/manual/page.tsx
app/trades/new/[uid]/page.tsx
app/trades/page.tsx
app/user/[uid]/page.tsx
app/wishlist/page.tsx
components/AdContainer.tsx
components/CardVersionPickerModal.tsx
components/CollectionToolsModal.tsx
components/ConfirmModal.tsx
components/DeleteAllButton.tsx
components/Header.tsx
components/ImportModal.tsx
components/MagicCard.tsx
components/ThemeProvider.tsx
components/ThemeToggle.tsx
components/UsernameSetupModal.tsx
components/wishlist/GlobalWishlistView.tsx
components/wishlist/SingleWishlistView.tsx
eslint.config.mjs
hooks/useCardCollection.ts
hooks/useFriends.ts
hooks/usePremium.ts
hooks/useTradeMatcher.ts
hooks/useTradeSystem.ts
hooks/useWishlists.ts
lib/AuthContext.tsx
lib/cardUtils.ts
lib/firebase-admin.ts
lib/firebase.ts
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/manifest.json
public/next.svg
public/vercel.svg
public/window.svg
README.md
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/login/page.tsx">
// Fichier : app/login/page.tsx

'use client'; // Cette page est interactive

import { useRouter } from 'next/navigation'; // Pour rediriger l'utilisateur
import { useAuth } from '@/lib/AuthContext'; // On utilise notre "raccourci" !

export default function LoginPage() {
  // On r√©cup√®re les infos de notre "carte d'identit√©"
  const { user, signInWithGoogle, loading } = useAuth();
  const router = useRouter(); // L'outil de redirection

  // Si le chargement est termin√© ET que l'utilisateur est D√âJ√Ä connect√©...
  if (!loading && user) {
    // ...on le renvoie √† la page d'accueil.
    router.push('/');
    return null; // On n'affiche rien sur cette page
  }

  // Si on charge, on affiche un message simple
  if (loading) {
    return <p>Chargement...</p>;
  }

  // C'est le HTML (JSX) qui s'affiche
  return (
    <main className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <h1 className="text-3xl font-bold mb-4">Bienvenue sur MagicWish</h1>
        <p className="mb-6">Veuillez vous connecter pour cr√©er votre wishlist.</p>
        
        {/* LE BOUTON DE CONNEXION */}
        <button
          onClick={signInWithGoogle} // Au clic, on appelle la fonction du Contexte
          className="bg-blue-500 text-white p-3 rounded-lg font-semibold"
        >
          Se connecter avec Google
        </button>
      </div>
    </main>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# local tools
stripe.exe
</file>

<file path="app/user/[uid]/page.tsx">
// app/user/[uid]/page.tsx
'use client';

import { useState, useEffect, use } from 'react';
import { db } from '@/lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import { useCardCollection } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import { FriendProfile } from '@/hooks/useFriends'; // R√©utilisation du type

export default function UserProfilePage({ params }: { params: Promise<{ uid: string }> }) {
  // En Next.js 15+, params est une Promise
  const unwrappedParams = use(params);
  const targetUid = unwrappedParams.uid;

  const [profile, setProfile] = useState<FriendProfile | null>(null);
  const [activeTab, setActiveTab] = useState<'collection' | 'wishlist'>('collection');
  
  // On utilise notre hook modifi√© avec le targetUid !
  const { cards, loading, totalPrice } = useCardCollection(activeTab, 'default', targetUid);

  // Charger les infos du profil (Nom, Avatar)
  useEffect(() => {
    const fetchProfile = async () => {
      try {
        const docRef = doc(db, 'users', targetUid, 'public_profile', 'info');
        const snap = await getDoc(docRef);
        if (snap.exists()) {
            setProfile({ uid: targetUid, ...snap.data() } as FriendProfile);
        }
      } catch (e) {
        console.error("Erreur profil", e);
      }
    };
    fetchProfile();
  }, [targetUid]);

  if (!profile && !loading) return <div className="p-10 text-center">Profil introuvable ou priv√©.</div>;

  return (
    <main className="container mx-auto p-4 pb-20">
        
        {/* HEADER PROFIL */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-6 flex flex-col md:flex-row items-center md:items-start gap-6">
            {/* Avatar */}
            <div className="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold border-4 border-white dark:border-gray-700 shadow-md overflow-hidden">
                {profile?.photoURL ? <img src={profile.photoURL} alt="" className="w-full h-full object-cover"/> : profile?.username?.[0]?.toUpperCase()}
            </div>
            
            {/* Infos */}
            <div className="text-center md:text-left flex-grow">
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                    {profile?.displayName || 'Utilisateur'}
                </h1>
                <p className="text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 inline-block px-3 py-1 rounded-full text-sm">
                    @{profile?.username}
                </p>
            </div>

            {/* Stats Valeur */}
            <div className="bg-green-50 dark:bg-green-900/20 px-6 py-4 rounded-xl border border-green-100 dark:border-green-800 text-center">
                <p className="text-xs uppercase text-green-600 dark:text-green-400 font-bold mb-1">Valeur affich√©e</p>
                <p className="text-2xl font-bold text-green-700 dark:text-green-300">{totalPrice.toFixed(2)} ‚Ç¨</p>
            </div>
        </div>

        {/* TABS (Collection vs Wishlist) */}
        <div className="flex justify-center mb-8 border-b border-gray-200 dark:border-gray-700">
            <button 
                onClick={() => setActiveTab('collection')}
                className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                    activeTab === 'collection' 
                    ? 'border-blue-600 text-blue-600' 
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                üìö Sa Collection
            </button>
            <button 
                onClick={() => setActiveTab('wishlist')}
                className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                    activeTab === 'wishlist' 
                    ? 'border-purple-600 text-purple-600' 
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                ‚ú® Sa Wishlist
            </button>
        </div>

        {/* GRILLE DE CARTES */}
        {loading ? (
            <p className="text-center p-10 text-gray-500">Chargement des cartes...</p>
        ) : cards.length === 0 ? (
            <div className="text-center py-16 bg-gray-50 dark:bg-gray-800/50 rounded-xl border-dashed border-2 border-gray-200 dark:border-gray-700">
                <p className="text-gray-400 italic">Cette liste est vide.</p>
            </div>
        ) : (
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                {cards.map(card => (
                    <MagicCard 
                        key={card.id} 
                        {...card} 
                        readOnly={true} // <--- Important : Mode lecture seule
                    />
                ))}
            </div>
        )}

    </main>
  );
}
</file>

<file path="components/AdContainer.tsx">
// components/AdContainer.tsx
'use client';
import { usePremium } from '@/hooks/usePremium';
import Link from 'next/link';

export default function AdContainer() {
  const { isPremium, loading } = usePremium();

  if (loading || isPremium) return null;

  return (
    <div className="w-full my-4 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg flex flex-col items-center justify-center text-center animate-in fade-in duration-500">
        
        {/* Placeholder pour AdSense / Banni√®re */}
        <div className="w-full max-w-[300px] h-[250px] bg-white dark:bg-black border-2 border-dashed border-gray-300 flex flex-col items-center justify-center gap-2 text-gray-400 text-sm overflow-hidden">
            <span className="text-2xl">üì¢</span>
            <p>Espace Publicitaire</p>
        </div>
        
        <p className="text-[10px] text-gray-500 mt-3 uppercase tracking-wide">
            Supportez MagicWish - <Link href="/premium" className="underline hover:text-blue-500 font-bold">Retirer la pub (1‚Ç¨)</Link>
        </p>
    </div>
  );
}
</file>

<file path="components/ConfirmModal.tsx">
// components/ConfirmModal.tsx
'use client';

type ConfirmModalProps = {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  message?: string;
};

export default function ConfirmModal({ 
  isOpen, 
  onClose, 
  onConfirm, 
  title = "Confirmation", 
  message = "√ätes-vous s√ªr de vouloir faire √ßa ?" 
}: ConfirmModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full shadow-2xl border border-gray-100 dark:border-gray-700 animate-in fade-in zoom-in duration-200">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
        <p className="text-gray-500 dark:text-gray-300 mb-6">{message}</p>
        
        <div className="flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
          >
            Annuler
          </button>
          <button
            onClick={() => {
              onConfirm();
              onClose();
            }}
            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition shadow-sm"
          >
            Supprimer
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/DeleteAllButton.tsx">
// components/DeleteAllButton.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { collection, getDocs, writeBatch } from 'firebase/firestore';
import toast from 'react-hot-toast';
import ConfirmModal from './ConfirmModal';

type DeleteAllButtonProps = {
  targetCollection: 'wishlist' | 'collection';
};

export default function DeleteAllButton({ targetCollection }: DeleteAllButtonProps) {
  const { user } = useAuth();
  const [isDeleting, setIsDeleting] = useState(false);
  const [isConfirmOpen, setIsConfirmOpen] = useState(false);

  // Fonction utilitaire pour d√©couper en paquets de 500
  const chunkArray = <T,>(arr: T[], size: number): T[][] => {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
      chunks.push(arr.slice(i, i + size));
    }
    return chunks;
  };

  const handleDeleteAll = async () => {
    if (!user) return;

    setIsDeleting(true);
    const toastId = toast.loading("Suppression en cours...");

    try {
      // 1. On r√©cup√®re TOUTES les cartes
      const colRef = collection(db, 'users', user.uid, targetCollection);
      const snapshot = await getDocs(colRef);

      if (snapshot.empty) {
        toast.success("La liste est d√©j√† vide !", { id: toastId });
        setIsDeleting(false);
        return;
      }

      const docs = snapshot.docs;
      // 2. On d√©coupe en lots de 500 (limite technique Firestore)
      const batches = chunkArray(docs, 500);

      // 3. On supprime lot par lot
      for (const batchDocs of batches) {
        const batch = writeBatch(db);
        batchDocs.forEach((doc) => {
          batch.delete(doc.ref);
        });
        await batch.commit();
      }

      toast.success(`Tout a √©t√© supprim√© (${docs.length} cartes).`, { id: toastId });

    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de la suppression.", { id: toastId });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <>
      <button
        onClick={() => setIsConfirmOpen(true)}
        disabled={isDeleting}
        className="text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
        title="Tout effacer"
      >
        {isDeleting ? '...' : 'üóëÔ∏è Vider la liste'}
      </button>

      <ConfirmModal
        isOpen={isConfirmOpen}
        onClose={() => setIsConfirmOpen(false)}
        onConfirm={handleDeleteAll}
        title="‚ö†Ô∏è DANGER : Tout supprimer ?"
        message={`Vous √™tes sur le point de supprimer INT√âGRALEMENT votre ${targetCollection}. Cette action est irr√©versible.`}
      />
    </>
  );
}
</file>

<file path="components/ThemeProvider.tsx">
'use client';

import { ThemeProvider as NextThemesProvider } from 'next-themes';
import { type ThemeProviderProps } from 'next-themes'; // corrig√© l'import

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
</file>

<file path="components/UsernameSetupModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, getDoc, writeBatch, serverTimestamp } from 'firebase/firestore';
import toast from 'react-hot-toast';

export default function UsernameSetupModal() {
  const { user, username, loading } = useAuth();
  const [isOpen, setIsOpen] = useState(false);
  
  const [inputVal, setInputVal] = useState('');
  const [isChecking, setIsChecking] = useState(false);

  // On ouvre la modale SI : user connect√©, chargement fini, ET pas de username
  useEffect(() => {
    if (!loading && user && !username) {
      setIsOpen(true);
    } else {
      setIsOpen(false);
    }
  }, [user, username, loading]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !inputVal) return;

    // 1. Nettoyage et Validation basique
    // Uniquement lettres minuscules, chiffres et underscores
    const cleanUsername = inputVal.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');

    if (cleanUsername.length < 3) {
      toast.error("Le pseudo doit faire au moins 3 caract√®res.");
      return;
    }
    
    if (cleanUsername !== inputVal.trim().toLowerCase()) {
        toast.error("Caract√®res sp√©ciaux interdits (sauf _ )");
        return;
    }

    setIsChecking(true);

    try {
      // 2. V√©rification d'unicit√© (On check la collection 'usernames')
      const usernameRef = doc(db, 'usernames', cleanUsername);
      const usernameSnap = await getDoc(usernameRef);

      if (usernameSnap.exists()) {
        toast.error(`Le pseudo "${cleanUsername}" est d√©j√† pris.`);
        setIsChecking(false);
        return;
      }

      // 3. Cr√©ation atomique (Tout ou rien) via Batch
      const batch = writeBatch(db);

      // A. R√©server le pseudo dans la collection globale
      batch.set(usernameRef, { uid: user.uid });

      // B. Cr√©er le profil public de l'utilisateur
      const profileRef = doc(db, 'users', user.uid, 'public_profile', 'info');
      batch.set(profileRef, {
        username: cleanUsername,
        displayName: user.displayName || 'Joueur Inconnu',
        photoURL: user.photoURL || null,
        createdAt: serverTimestamp(),
        bio: "Nouveau membre MagicWish"
      });

      await batch.commit();

      toast.success(`Bienvenue, @${cleanUsername} !`);
      setIsOpen(false); // Le AuthContext va se mettre √† jour auto et fermer la modale, mais on force ici pour UI instantan√©e

    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de la cr√©ation du profil.");
    } finally {
      setIsChecking(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 backdrop-blur-md">
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700 animate-in zoom-in duration-300">
        <div className="text-center mb-6">
          <div className="text-4xl mb-2">üëã</div>
          <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Bienvenue sur MagicWish !</h2>
          <p className="text-gray-500 dark:text-gray-400 mt-2">
            Pour permettre √† vos amis de vous trouver, veuillez choisir un <span className="font-bold text-blue-600">nom d'utilisateur unique</span>.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Votre pseudo (ex: jace_beleren)
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">@</span>
              <input
                type="text"
                value={inputVal}
                onChange={(e) => setInputVal(e.target.value.toLowerCase())}
                className="w-full pl-8 p-3 border rounded-lg bg-gray-50 dark:bg-gray-900 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none lowercase"
                placeholder="pseudo_unique"
                disabled={isChecking}
                autoFocus
              />
            </div>
            <p className="text-xs text-gray-400 mt-1">Lettres minuscules, chiffres et underscore (_) uniquement.</p>
          </div>

          <button
            type="submit"
            disabled={isChecking || inputVal.length < 3}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isChecking ? 'V√©rification...' : 'Valider mon profil üöÄ'}
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="hooks/useWishlists.ts">
// hooks/useWishlists.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { collection, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp, setDoc } from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import toast from 'react-hot-toast';

export type WishlistMeta = {
  id: string;
  name: string;
  isDefault?: boolean; // Pour identifier la liste principale historique
};

export function useWishlists() {
  const { user } = useAuth();
  const [lists, setLists] = useState<WishlistMeta[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setLists([]);
      setLoading(false);
      return;
    }

    // On √©coute la collection des m√©tadonn√©es
    const metaRef = collection(db, 'users', user.uid, 'wishlists_meta');
    
    const unsubscribe = onSnapshot(metaRef, (snapshot) => {
      const fetchedLists = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as WishlistMeta[];

      // Si aucune liste n'existe (premier lancement V2), on cr√©e la liste "D√©faut"
      // qui pointera conceptuellement vers ton ancienne collection
      if (fetchedLists.length === 0 && !snapshot.metadata.fromCache) {
        createList("Liste principale", "default");
      } else {
        // On trie : D√©faut en premier, puis alphab√©tique
        fetchedLists.sort((a, b) => {
          if (a.id === 'default') return -1;
          if (b.id === 'default') return 1;
          return a.name.localeCompare(b.name);
        });
        setLists(fetchedLists);
      }
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const createList = async (name: string, customId?: string) => {
    if (!user) return;
    try {
      const data = { name, createdAt: serverTimestamp() };
      if (customId) {
        await setDoc(doc(db, 'users', user.uid, 'wishlists_meta', customId), { ...data, isDefault: true });
      } else {
        await addDoc(collection(db, 'users', user.uid, 'wishlists_meta'), data);
      }
      toast.success(`Liste "${name}" cr√©√©e`);
    } catch (err) {
      console.error(err);
      toast.error("Erreur cr√©ation liste");
    }
  };

  const deleteList = async (listId: string) => {
    if (!user || listId === 'default') return; // On prot√®ge la liste par d√©faut
    if (!confirm("Supprimer cette liste et toutes ses cartes ?")) return;
    
    try {
        // 1. Supprimer les m√©tadonn√©es
        await deleteDoc(doc(db, 'users', user.uid, 'wishlists_meta', listId));
        
        // 2. Note: Id√©alement, il faudrait aussi supprimer la sous-collection 'cards'.
        // C'est complexe c√¥t√© client. Pour l'instant on supprime juste l'acc√®s (meta).
        // Une Cloud Function serait id√©ale ici pour le nettoyage complet.
        
        toast.success("Liste supprim√©e");
    } catch (err) {
        console.error(err);
        toast.error("Erreur suppression");
    }
  };

  return { lists, loading, createList, deleteList };
}
</file>

<file path="lib/firebase-admin.ts">
// lib/firebase-admin.ts
import 'server-only';
import * as admin from 'firebase-admin';

// Fonction pour nettoyer la cl√© priv√©e (probl√®me fr√©quent avec les variables d'env)
function formatPrivateKey(key: string) {
  return key.replace(/\\n/g, '\n');
}

export function getAdminFirestore() {
  // On v√©rifie si une instance existe d√©j√† pour √©viter les erreurs de hot-reload
  if (admin.apps.length === 0) {
    admin.initializeApp({
      credential: admin.credential.cert({
        projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
        privateKey: formatPrivateKey(process.env.FIREBASE_PRIVATE_KEY || ""),
      }),
    });
  }
  return admin.firestore();
}
</file>

<file path="lib/firebase.ts">
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

// Initialisation unique (√©vite les erreurs de re-init en dev)
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();

export const auth = getAuth(app);
export const db = getFirestore(app);
</file>

<file path="next.config.ts">
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // Mode strict pour d√©tecter les bugs en dev
  reactStrictMode: true,

  // Optimisation des images
  images: {
    formats: ['image/avif', 'image/webp'],
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cards.scryfall.io', // Indispensable pour tes cartes
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: '*.googleusercontent.com', // Indispensable pour les avatars Google Auth
        port: '',
        pathname: '/**',
      },
    ],
  },

  // S√©curit√© (Headers HTTP)
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        ],
      },
    ];
  },
};

export default nextConfig;
</file>

<file path="public/manifest.json">
{
  "name": "MagicWish",
  "short_name": "MagicWish",
  "description": "Votre wishlist et collection de cartes Magic",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/file.svg",
      "sizes": "any",
      "type": "image/svg+xml"
    }
  ]
}
</file>

<file path="app/actions/trade.ts">
// app/actions/trade.ts
'use server';

import { getAdminFirestore } from '@/lib/firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';
import { CardType } from '@/hooks/useCardCollection';

const createCardData = (card: CardType) => {
    return {
        name: card.name,
        imageUrl: card.imageUrl,
        imageBackUrl: card.imageBackUrl || null,
        setName: card.setName || '',
        setCode: card.setCode || '',
        price: card.price || 0,
        quantity: card.quantity, 
        isFoil: card.isFoil || false,
        isSpecificVersion: card.isSpecificVersion || false,
        scryfallData: card.scryfallData || null,
        addedAt: FieldValue.serverTimestamp(),
        wishlistId: null,
        isForTrade: false 
    };
};

// --- ACTION 1 : √âCHANGE P2P AVEC VALIDATION STATUS ---
export async function executeServerTrade(
    tradeId: string, // <-- Nouveau param√®tre
    senderUid: string,
    receiverUid: string,
    itemsGiven: CardType[],
    itemsReceived: CardType[]
) {
    const db = getAdminFirestore();

    try {
        await db.runTransaction(async (t) => {
            // PHASE 1 : TOUTES LES LECTURES
            
            // A. V√©rifier que l'√©change est toujours 'pending'
            const tradeRef = db.doc(`trades/${tradeId}`);
            const tradeSnap = await t.get(tradeRef);
            if (!tradeSnap.exists) throw new Error("√âchange introuvable");
            if (tradeSnap.data()?.status !== 'pending') throw new Error("Cet √©change n'est plus en attente.");

            // B. Lire les stocks Exp√©diteur
            const senderStockSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${senderUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                senderStockSnaps.push({ ref, card, snap });
            }

            // C. Lire les stocks Receveur
            const receiverStockSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${receiverUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                receiverStockSnaps.push({ ref, card, snap });
            }

            // D. Lire les destinations
            const senderDestSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${senderUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                senderDestSnaps.push({ ref, card, snap });
            }

            const receiverDestSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${receiverUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                receiverDestSnaps.push({ ref, card, snap });
            }

            // PHASE 2 : TOUTES LES √âCRITURES

            // 1. Mise √† jour du statut de l'√©change (IMPORTANT)
            t.update(tradeRef, { 
                status: 'completed',
                completedAt: FieldValue.serverTimestamp()
            });

            // 2. RETIRER les cartes de l'Exp√©diteur
            for (const item of senderStockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: ${item.card.name} manquante chez l'exp√©diteur.`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            // 3. RETIRER les cartes du Receveur
            for (const item of receiverStockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: ${item.card.name} manquante chez le partenaire.`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            // 4. AJOUTER chez l'Exp√©diteur + Clean Wishlist
            for (const item of senderDestSnaps) {
                const wishRef = db.doc(`users/${senderUid}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef); 
            }

            // 5. AJOUTER chez le Receveur + Clean Wishlist
            for (const item of receiverDestSnaps) {
                const wishRef = db.doc(`users/${receiverUid}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef);
            }
        });

        return { success: true };

    } catch (error: unknown) {
        console.error("Trade Error:", error);
        let errorMessage = "Une erreur inconnue est survenue";
        if (error instanceof Error) errorMessage = error.message;
        else if (typeof error === "string") errorMessage = error;
        return { success: false, error: errorMessage };
    }
}

// --- ACTION 2 : √âCHANGE MANUEL (SOLO) ---
export async function executeManualTrade(
    userId: string,
    itemsGiven: CardType[],    
    itemsReceived: CardType[]  
) {
    const db = getAdminFirestore();

    try {
        await db.runTransaction(async (t) => {
            // PHASE 1 : LECTURES
            const stockSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${userId}/collection/${card.id}`);
                const snap = await t.get(ref);
                stockSnaps.push({ ref, card, snap });
            }

            const destSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${userId}/collection/${card.id}`);
                const snap = await t.get(ref);
                destSnaps.push({ ref, card, snap });
            }

            // PHASE 2 : √âCRITURES
            for (const item of stockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: Vous ne poss√©dez pas assez de "${item.card.name}".`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            for (const item of destSnaps) {
                const wishRef = db.doc(`users/${userId}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef);
            }
        });

        return { success: true };

    } catch (error: unknown) {
        console.error("Manual Trade Error:", error);
        let errorMessage = "Erreur lors de l'√©change manuel";
        if (error instanceof Error) errorMessage = error.message;
        return { success: false, error: errorMessage };
    }
}
</file>

<file path="app/api/webhook/stripe/route.ts">
// app/api/webhook/stripe/route.ts
import { NextResponse } from 'next/server';
import { headers } from 'next/headers';
import Stripe from 'stripe';
import { getAdminFirestore } from '@/lib/firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';

export async function POST(req: Request) {
  // CORRECTION : Initialisation Lazy (au moment de la requ√™te)
  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
    apiVersion: '2025-11-17.clover',
  });

  const body = await req.text();
  const headerList = await headers();
  const signature = headerList.get('Stripe-Signature') as string;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
        body, 
        signature, 
        process.env.STRIPE_WEBHOOK_SECRET!
    );
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  } catch (error: any) {
    console.error("Webhook signature failed", error.message);
    return new NextResponse(`Webhook Error: ${error.message}`, { status: 400 });
  }

  const db = getAdminFirestore();

  try {
      switch (event.type) {
        case 'checkout.session.completed': {
          const session = event.data.object as Stripe.Checkout.Session;
          const userId = session.client_reference_id; 
          
          if (userId) {
            await db.collection('users').doc(userId).set({
              isPremium: true,
              stripeCustomerId: session.customer as string,
              stripeSubscriptionId: session.subscription as string,
              premiumSince: FieldValue.serverTimestamp(),
            }, { merge: true });
            console.log(`‚úÖ User ${userId} passed Premium`);
          }
          break;
        }

        case 'customer.subscription.deleted': {
          const subscription = event.data.object as Stripe.Subscription;
          const stripeSubId = subscription.id;

          const snapshot = await db.collection('users')
            .where('stripeSubscriptionId', '==', stripeSubId)
            .get();

          if (!snapshot.empty) {
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { 
                    isPremium: false,
                    premiumEndedAt: FieldValue.serverTimestamp()
                });
            });
            await batch.commit();
            console.log(`Subscription ${stripeSubId} deleted. User downgraded.`);
          }
          break;
        }
      }
  } catch (err) {
      console.error("Firebase update error", err);
      return new NextResponse("Server Error", { status: 500 });
  }

  return NextResponse.json({ received: true });
}
</file>

<file path="app/premium/page.tsx">
// app/premium/page.tsx
'use client';

import { useAuth } from '@/lib/AuthContext';
import { usePremium } from '@/hooks/usePremium';
import { useState } from 'react';
import toast from 'react-hot-toast';
import { doc, getDoc } from 'firebase/firestore'; // Import suppl√©mentaire
import { db } from '@/lib/firebase';

export default function PremiumPage() {
    const { user } = useAuth();
    const { isPremium, loading } = usePremium();
    const [isRedirecting, setIsRedirecting] = useState(false);

    // Le lien de paiement avec le client_reference_id pour l'identification
    const paymentLink = `${process.env.NEXT_PUBLIC_STRIPE_PAYMENT_LINK}?client_reference_id=${user?.uid}`;

    // G√©rer la redirection vers le portail client Stripe pour annuler/modifier
    const handleManageSubscription = async () => {
        if (!user) return;
        setIsRedirecting(true);
        try {
            // On doit lire l'ID client Stripe stock√© dans le profil de l'utilisateur
            const docRef = await getDoc(doc(db, 'users', user.uid));
            const customerId = docRef.data()?.stripeCustomerId;

            if (!customerId) {
                toast.error("Impossible de trouver votre abonnement. Contactez le support.");
                setIsRedirecting(false);
                return;
            }

            // Appel de l'API pour g√©n√©rer le lien de gestion du portail Stripe
            const res = await fetch('/api/portal', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerId })
            });
            
            const data = await res.json();
            if (data.url) {
                window.location.href = data.url; // Redirection vers Stripe
            } else {
                throw new Error(data.error || "Erreur redirection Stripe");
            }
        } catch (e) {
            console.error(e);
            toast.error("Erreur gestion d'abonnement.");
            setIsRedirecting(false);
        }
    };

    if (loading) return <div className="p-10 text-center">Chargement...</div>;
    if (!user) return <div className="p-10 text-center">Connectez-vous pour acc√©der au Premium.</div>;

    return (
        <div className="container mx-auto p-8 text-center max-w-lg min-h-[80vh] flex flex-col justify-center">
            
            {isPremium ? (
                // --- VUE D√âJ√Ä ABONN√â ---
                <div className="bg-green-50 dark:bg-green-900/20 p-8 rounded-2xl border border-green-200 dark:border-green-800">
                    <div className="text-5xl mb-4">üíé</div>
                    <h1 className="text-3xl font-bold text-green-700 dark:text-green-400 mb-2">Vous √™tes Premium !</h1>
                    <p className="text-gray-600 dark:text-gray-300 mb-6">
                        Merci de soutenir le projet.
                    </p>
                    <button 
                        onClick={handleManageSubscription}
                        disabled={isRedirecting}
                        className="text-sm text-gray-500 underline hover:text-gray-700 dark:hover:text-gray-200 font-medium"
                    >
                        {isRedirecting ? 'Chargement...' : 'G√©rer mon abonnement / Annuler'}
                    </button>
                </div>
            ) : (
                // --- VUE VENTE ---
                <>
                    <h1 className="text-4xl font-bold mb-4 bg-linear-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Passez Premium
                    </h1>
                    <p className="mb-8 text-gray-600 dark:text-gray-300 text-lg">
                        Soutenez le d√©veloppement pour 1‚Ç¨ / mois.
                    </p>
                    
                    <ul className="text-left bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 space-y-4">
                        <li className="flex items-center gap-3">
                            <span className="bg-green-100 text-green-700 p-1 rounded-full text-xs">‚úì</span>
                            <span>Plus aucune publicit√©</span>
                        </li>
                        <li className="flex items-center gap-3">
                            <span className="bg-purple-100 text-purple-700 p-1 rounded-full text-xs">‚ô•</span>
                            <span className="font-bold">Juste 1,00 ‚Ç¨ / mois</span>
                        </li>
                    </ul>

                    <a 
                        href={paymentLink} 
                        className="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-105 transition transform"
                    >
                        Devenir Premium (1‚Ç¨)
                    </a>
                    <p className="text-xs text-gray-400 mt-4">Paiement s√©curis√© par Stripe.</p>
                </>
            )}
        </div>
    );
}
</file>

<file path="components/ThemeToggle.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useTheme } from 'next-themes';

export default function ThemeToggle() {
  const [mounted, setMounted] = useState(false);
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    // Cette ligne est n√©cessaire pour √©viter l'erreur "hydration mismatch"
    // Le linter r√¢le car on set un state dans un effect sans d√©pendance,
    // mais c'est le comportement voulu ici.
    // eslint-disable-next-line react-hooks/exhaustive-deps
    setMounted(true);
  }, []);

  // Si pas encore mont√© (c√¥t√© serveur), on renvoie un carr√© vide de la m√™me taille
  // pour √©viter le d√©calage visuel (Layout Shift)
  if (!mounted) {
    return <div className="w-9 h-9 p-2" />; 
  }

  return (
    <button
      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
      className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
      title="Changer de th√®me"
      aria-label="Changer de th√®me"
    >
      {theme === 'dark' ? (
        // LUNE (Mode Nuit actif -> clique pour passer en Jour)
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
          <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
        </svg>
      ) : (
        // SOLEIL (Mode Jour actif -> clique pour passer en Nuit)
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-orange-500">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
        </svg>
      )}
    </button>
  );
}
</file>

<file path="components/wishlist/GlobalWishlistView.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { WishlistMeta } from '@/hooks/useWishlists';
import { CardType } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import { db } from '@/lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import toast from 'react-hot-toast';

type Props = {
    lists: WishlistMeta[];
};

export default function GlobalWishlistView({ lists }: Props) {
    const { user } = useAuth();
    const [allCards, setAllCards] = useState<(CardType & { sourceListName: string })[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user || lists.length === 0) return;

        const fetchAll = async () => {
            setLoading(true);
            let combined: (CardType & { sourceListName: string })[] = [];

            try {
                // A. Liste par d√©faut
                const defaultRef = collection(db, 'users', user.uid, 'wishlist');
                const defaultSnap = await getDocs(defaultRef);
                const defaultCards = defaultSnap.docs.map(d => ({ 
                    ...d.data(), id: d.id, sourceListName: 'Liste principale' 
                })) as (CardType & { sourceListName: string })[];
                combined = [...defaultCards];

                // B. Listes customs
                const customLists = lists.filter(l => l.id !== 'default');
                const promises = customLists.map(async (list) => {
                    const colRef = collection(db, 'users', user.uid, 'wishlists_data', list.id, 'cards');
                    const snap = await getDocs(colRef);
                    return snap.docs.map(d => ({
                        ...d.data(),
                        id: d.id,
                        sourceListName: list.name
                    })) as (CardType & { sourceListName: string })[];
                });

                const results = await Promise.all(promises);
                results.forEach(res => {
                    combined = [...combined, ...res];
                });

                setAllCards(combined);
            } catch (error) {
                console.error("Erreur chargement global", error);
                toast.error("Erreur chargement global");
            } finally {
                setLoading(false);
            }
        };

        fetchAll();
    }, [user, lists]);

    const globalTotal = useMemo(() => {
        return allCards.reduce((acc, card) => acc + (card.price || 0) * card.quantity, 0);
    }, [allCards]);

    if (loading) return <div className="p-10 text-center animate-pulse">Fusion des listes en cours...</div>;

    return (
        <div className="animate-in fade-in duration-300">
             <div className="flex justify-between items-end mb-6 border-b pb-4 dark:border-gray-700 bg-linear-to-r from-blue-50 to-transparent dark:from-blue-900/20 p-4 rounded-t-xl">
                <div>
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                        üåç Vue Globale
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">
                        Toutes vos cartes fusionn√©es ({allCards.length} cartes distinctes)
                    </p>
                </div>
                <div className="text-right">
                    <span className="text-xs text-gray-500 uppercase font-semibold">Valeur Totale</span>
                    <p className="text-3xl font-bold text-blue-600 dark:text-blue-400">{globalTotal.toFixed(2)} ‚Ç¨</p>
                </div>
            </div>

            {allCards.length === 0 ? (
                <div className="text-center py-12">
                    <p className="text-gray-500 italic">Aucune carte trouv√©e.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {allCards.map((card, idx) => (
                        <div key={`${card.id}-${idx}`} className="relative group">
                            <div className="absolute top-0 right-0 z-30 bg-black/70 text-white text-[10px] px-2 py-1 rounded-bl-lg backdrop-blur-sm pointer-events-none">
                                {card.sourceListName}
                            </div>
                            <MagicCard {...card} isWishlist={false} />
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="hooks/usePremium.ts">
// hooks/usePremium.ts
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, onSnapshot } from 'firebase/firestore';
import { useState, useEffect } from 'react';

export function usePremium() {
  const { user } = useAuth();
  const [isPremium, setIsPremium] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
        // eslint-disable-next-line react-hooks/set-state-in-effect
        setIsPremium(false);
        setLoading(false);
        return;
    }

    // √âcoute en temps r√©el les changements sur le document utilisateur
    const unsub = onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
        // Le Webhook Stripe met √† jour ce champ
        setIsPremium(docSnap.data()?.isPremium === true);
        setLoading(false);
    }, (error) => {
        console.error("Erreur check premium", error);
        setLoading(false);
    });

    return () => unsub();
  }, [user]);

  return { isPremium, loading };
}
</file>

<file path="app/api/portal/route.ts">
// app/api/portal/route.ts
import { NextResponse } from 'next/server';
import Stripe from 'stripe';

export async function POST(req: Request) {
    try {
        // On initialise Stripe ICI, √† l'int√©rieur de la fonction
        // Cela √©vite de faire planter le build si la cl√© n'est pas encore l√†
        const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
            apiVersion: '2025-11-17.clover', 
        });

        const body = await req.json();
        const { customerId } = body; 

        if (!customerId) {
             return NextResponse.json({ error: "Customer ID manquant" }, { status: 400 });
        }

        const session = await stripe.billingPortal.sessions.create({
            customer: customerId,
            return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/premium`,
        });

        return NextResponse.json({ url: session.url });
        
    } catch (err: unknown) {
        console.error("Erreur cr√©ation portail Stripe:", err);
        let errorMessage = "Erreur serveur";
        if (err instanceof Error) errorMessage = err.message;
        else if (typeof err === 'string') errorMessage = err;
        return NextResponse.json({ error: errorMessage }, { status: 500 });
    }
}
</file>

<file path="app/api/search/route.ts">
// app/api/search/route.ts
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const query = searchParams.get('q'); 

  if (!query) {
    return NextResponse.json(
      { error: 'Aucun terme de recherche fourni.' }, 
      { status: 400 } 
    );
  }

  // --- CORRECTION : Suppression des guillemets pour permettre la recherche partielle ---
  // On utilise encodeURIComponent pour g√©rer proprement les espaces et caract√®res sp√©ciaux
  const scryfallUrl = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&unique=prints`;

  try {
    const scryfallResponse = await fetch(scryfallUrl);

    if (!scryfallResponse.ok) {
      const errorData = await scryfallResponse.json();
      console.error('Erreur Scryfall:', errorData);
      return NextResponse.json(
        { error: errorData.details || 'Carte non trouv√©e' }, 
        { status: scryfallResponse.status }
      );
    }

    const data = await scryfallResponse.json();
    return NextResponse.json(data);

  } catch (error) {
    console.error('Erreur interne du serveur:', error);
    return NextResponse.json(
      { error: 'Une erreur est survenue sur le serveur.' }, 
      { status: 500 }
    );
  }
}
</file>

<file path="app/layout.tsx">
// app/layout.tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/lib/AuthContext';
import { ThemeProvider } from '@/components/ThemeProvider'; // <-- IMPORT
import Header from '@/components/Header'; 
import { Toaster } from 'react-hot-toast';
import UsernameSetupModal from '@/components/UsernameSetupModal'; 

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'MagicWish',
  description: 'Votre wishlist de cartes Magic',
  manifest: '/manifest.json',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Ajout de suppressHydrationWarning pour √©viter les warnings li√©s au th√®me
    <html lang="fr" suppressHydrationWarning>
      <body className={inter.className}>
        {/* On enveloppe tout avec le ThemeProvider */}
        <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
          <AuthProvider>
            <Header />
            {children}
            <UsernameSetupModal />
            <Toaster position="bottom-right" />
          </AuthProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
</file>

<file path="app/trades/new/[uid]/page.tsx">
// app/trades/new/[uid]/page.tsx
'use client';

import { useState, use, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import { useTradeSystem } from '@/hooks/useTradeSystem';
import { db } from '@/lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import { useRouter } from 'next/navigation';
import toast from 'react-hot-toast';

export default function DirectTradePage({ params }: { params: Promise<{ uid: string }> }) {
  const unwrappedParams = use(params);
  const targetUid = unwrappedParams.uid;

  const { user } = useAuth();
  const router = useRouter();
  const { proposeTrade } = useTradeSystem();

  // --- CHARGEMENT ---
  const { cards: myCollection, loading: loadingMe } = useCardCollection('collection');
  const { cards: friendCollection, loading: loadingHim } = useCardCollection('collection', 'default', targetUid);

  // --- √âTATS ---
  const [targetName, setTargetName] = useState('L\'ami');
  const [toGive, setToGive] = useState<CardType[]>([]);
  const [toReceive, setToReceive] = useState<CardType[]>([]);
  const [searchMe, setSearchMe] = useState('');
  const [searchHim, setSearchHim] = useState('');

  useEffect(() => {
    const fetchName = async () => {
        try {
            const snap = await getDoc(doc(db, 'users', targetUid, 'public_profile', 'info'));
            if(snap.exists()) setTargetName(snap.data().displayName || snap.data().username);
        } catch(e) { console.error(e); }
    };
    if (targetUid) fetchName();
  }, [targetUid]);

  // --- ACTIONS ---
  const handleSelectCard = (card: CardType, listType: 'give' | 'receive') => {
    const targetList = listType === 'give' ? toGive : toReceive;
    const setTarget = listType === 'give' ? setToGive : setToReceive;
    const existing = targetList.find(c => c.id === card.id);
    const maxStock = card.quantity;
    const currentSelected = existing ? existing.quantity : 0;

    if (currentSelected < maxStock) {
        if (existing) {
            setTarget(prev => prev.map(c => c.id === card.id ? { ...c, quantity: c.quantity + 1 } : c));
        } else {
            setTarget(prev => [...prev, { ...card, quantity: 1 }]);
        }
    } else {
        toast.error("Stock maximum atteint");
    }
  };

  const handleRemoveCard = (cardId: string, listType: 'give' | 'receive') => {
    const setTarget = listType === 'give' ? setToGive : setToReceive;
    setTarget(prev => prev.filter(c => c.id !== cardId));
  };

  const handlePropose = async () => {
    if (toGive.length === 0 && toReceive.length === 0) return;
    const success = await proposeTrade(targetUid, targetName, toGive, toReceive);
    if (success) router.push('/trades'); 
  };

  // CALCULS
  const valGive = toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const valReceive = toReceive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const balance = valGive - valReceive;

  if (!user) return <div className="p-10 text-center">Connexion requise.</div>;

  return (
    <div className="container mx-auto p-4 h-[calc(100vh-64px)] flex flex-col">
        
        {/* HEADER */}
        <div className="flex-none flex items-center gap-4 mb-4">
            <button onClick={() => router.back()} className="text-gray-500 hover:text-gray-700 bg-gray-100 px-3 py-1 rounded-lg text-sm">
                ‚Üê Retour
            </button>
            <h1 className="text-2xl font-bold truncate">
                √âchange avec <span className="text-blue-600">{targetName}</span>
            </h1>
        </div>

        {/* GRILLE PRINCIPALE */}
        <div className="grid lg:grid-cols-2 gap-6 grow overflow-hidden pb-24">
            
            {/* --- COLONNE GAUCHE (MOI) --- */}
            <div className="flex flex-col h-full bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                     <h2 className="font-bold text-red-600 mb-2">üì§ Je donne (Ma Collection)</h2>
                     <input 
                        type="text" 
                        placeholder="Filtrer ma collection..." 
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={searchMe}
                        onChange={e => setSearchMe(e.target.value)}
                    />
                </div>
                
                {/* LISTE D√âFILANTE UNIQUE (S√©lectionn√©s en haut, Dispos en bas) */}
                <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    
                    {/* S√âLECTIONN√âS */}
                    {toGive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800 overflow-hidden">
                            <div className="bg-red-100 dark:bg-red-900/30 px-3 py-1 text-xs font-bold text-red-700 dark:text-red-300">
                                S√âLECTION ({toGive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toGive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => handleRemoveCard(card.id, 'give')} className="text-red-500 hover:bg-red-50 rounded px-2">‚úï</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* DISPONIBLES */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Mon Classeur d&apos;√©change</p>
                        {loadingMe ? <p className="text-sm">Chargement...</p> : 
                            myCollection
                                .filter(c => c.isForTrade) // <--- FILTRE AJOUT√â ICI
                                .filter(c => c.name.toLowerCase().includes(searchMe.toLowerCase()))
                                .slice(0, 50) 
                                .map(card => (
                                    <div key={card.id} onClick={() => handleSelectCard(card, 'give')} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-red-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden relative">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                            {card.isForTrade && <div className="absolute bottom-0 right-0 bg-green-500 text-white text-[8px] px-1">ü§ù</div>}
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Dispo: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-red-500 transition-colors shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                {/* TOTAL COLONNE GAUCHE (Fixe en bas de colonne) */}
                <div className="flex-none bg-red-50 dark:bg-red-900/20 p-3 border-t border-red-100 dark:border-red-900 text-center">
                    <span className="text-xs text-red-600 dark:text-red-400 font-bold uppercase">Total Donn√©</span>
                    <div className="text-xl font-bold text-red-700 dark:text-red-300">{valGive.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>

            {/* --- COLONNE DROITE (AMI) --- */}
            <div className="flex flex-col h-full bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-blue-600 mb-2">üì• Je re√ßois (Sa Collection)</h2>
                    <input 
                        type="text" 
                        placeholder={`Filtrer chez ${targetName}...`}
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={searchHim}
                        onChange={e => setSearchHim(e.target.value)}
                    />
                </div>

                {/* LISTE D√âFILANTE UNIQUE */}
                <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                     {/* S√âLECTIONN√âS */}
                     {toReceive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800 overflow-hidden">
                            <div className="bg-blue-100 dark:bg-blue-900/30 px-3 py-1 text-xs font-bold text-blue-700 dark:text-blue-300">
                                S√âLECTION ({toReceive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toReceive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => handleRemoveCard(card.id, 'receive')} className="text-red-500 hover:bg-red-50 rounded px-2">‚úï</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* DISPONIBLES */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Son Classeur d&apos;√©change</p>
                        {loadingHim ? <p className="text-sm">Chargement...</p> : 
                            friendCollection
                                .filter(c => c.isForTrade) // FILTRE D√âJ√Ä PR√âSENT
                                .filter(c => c.name.toLowerCase().includes(searchHim.toLowerCase()))
                                .slice(0, 50)
                                .map(card => (
                                    <div key={card.id} onClick={() => handleSelectCard(card, 'receive')} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-blue-100 dark:hover:bg-blue-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-blue-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden relative">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                            <div className="absolute bottom-0 right-0 bg-green-500 text-white text-[8px] px-1">ü§ù</div>
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Dispo: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-blue-500 transition-colors shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                {/* TOTAL COLONNE DROITE (Fixe en bas de colonne) */}
                <div className="flex-none bg-blue-50 dark:bg-blue-900/20 p-3 border-t border-blue-100 dark:border-blue-900 text-center">
                    <span className="text-xs text-blue-600 dark:text-blue-400 font-bold uppercase">Total Re√ßu</span>
                    <div className="text-xl font-bold text-blue-700 dark:text-blue-300">{valReceive.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>
        </div>

        {/* FOOTER PRINCIPAL AVEC BALANCE CENTR√âE */}
        <div className="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-900 border-t dark:border-gray-800 flex items-center px-6 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            
            {/* Espace vide √† gauche pour l'√©quilibre */}
            <div className="flex-1"></div>

            {/* BALANCE CENTRALE */}
            <div className="flex-1 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-widest">Valeur R√©siduelle</span>
                <div className={`text-2xl font-black ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {balance > 0 ? '+' : ''}{balance.toFixed(2)} ‚Ç¨
                </div>
            </div>

            {/* BOUTON D'ACTION √Ä DROITE */}
            <div className="flex-1 flex justify-end">
                <button 
                    onClick={handlePropose}
                    disabled={toGive.length === 0 && toReceive.length === 0}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 transition shadow-lg transform active:scale-95 flex items-center gap-2"
                >
                    <span>üöÄ</span> Proposer
                </button>
            </div>
        </div>

    </div>
  );
}
</file>

<file path="components/CollectionToolsModal.tsx">
// components/CollectionToolsModal.tsx
'use client';

import { useState } from 'react';
import AdContainer from './AdContainer';

type CollectionToolsModalProps = {
  isOpen: boolean;
  onClose: () => void;
  onRefreshPrices: () => Promise<void>;
  onBulkTrade: (action: 'excess' | 'all' | 'reset', threshold?: number) => void;
  totalCards: number;
};

export default function CollectionToolsModal({ 
    isOpen, onClose, onRefreshPrices, onBulkTrade, totalCards 
}: CollectionToolsModalProps) {
  
  const [threshold, setThreshold] = useState(4);
  const [isRefreshing, setIsRefreshing] = useState(false);

  if (!isOpen) return null;

  const handleRefresh = async () => {
      setIsRefreshing(true);
      await onRefreshPrices();
      setIsRefreshing(false);
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700" onClick={e => e.stopPropagation()}>
        
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold flex items-center gap-2 text-gray-900 dark:text-white">
                ‚öôÔ∏è Gestion Collection
            </h2>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">‚úï</button>
        </div>

        <div className="space-y-8">
            
            {/* SECTION 1 : CLASSEUR D'√âCHANGE */}
            <div>
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">Automatisations √âchange</h3>
                
                {/* Option Playset */}
                <div className="bg-green-50 dark:bg-green-900/10 p-3 rounded-xl border border-green-100 dark:border-green-800 mb-3">
                    <label className="text-sm font-medium text-gray-800 dark:text-gray-200 mb-2 block">
                        Mettre en √©change le surplus (Playset)
                    </label>
                    <div className="flex gap-2">
                        <div className="flex items-center bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-2">
                            <span className="text-xs text-gray-500 mr-2">Qt√© &gt;</span>
                            <input 
                                type="number" 
                                min="1" 
                                max="100" 
                                value={threshold} 
                                onChange={(e) => setThreshold(parseInt(e.target.value) || 4)}
                                className="w-10 text-center font-bold outline-none bg-transparent text-gray-900 dark:text-white"
                            />
                        </div>
                        <button 
                            onClick={() => onBulkTrade('excess', threshold)}
                            className="grow bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 rounded-lg transition"
                        >
                            Appliquer
                        </button>
                    </div>
                    <p className="text-[10px] text-gray-500 mt-2">
                        Exemple : Si Qt√© &gt; 4, la carte est marqu√©e &quot;Disponible √† l&apos;√©change&quot;.
                    </p>
                </div>

                {/* Actions Rapides */}
                <div className="grid grid-cols-2 gap-3">
                    <button 
                        onClick={() => onBulkTrade('all')}
                        className="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 text-gray-700 dark:text-gray-200 rounded-lg text-xs font-bold transition"
                    >
                        Tout mettre en Trade
                    </button>
                    <button 
                        onClick={() => onBulkTrade('reset')}
                        className="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-red-100 hover:text-red-600 text-gray-700 dark:text-gray-200 rounded-lg text-xs font-bold transition"
                    >
                        Tout retirer (Reset)
                    </button>
                </div>
            </div>

            {/* SECTION 2 : ACTUALISATION */}
            <div>
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">Donn√©es & Prix</h3>
                
                {isRefreshing && (
                    <div className="mb-4">
                        <AdContainer /> {/* <--- LA PUB APPARAIT PENDANT L'ATTENTE */}
                        <p className="text-center text-sm text-blue-600 animate-pulse mt-2">
                            Analyse des prix en cours...
                        </p>
                    </div>
                )}
                
                <button 
                    onClick={handleRefresh}
                    disabled={isRefreshing}
                    className="w-full bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2"
                >
                    {isRefreshing ? 'Mise √† jour en cours...' : 'üîÑ Actualiser Scryfall (Prix)'}
                </button>
                <p className="text-[10px] text-gray-400 text-center mt-2">
                    Met √† jour les prix et informations de vos {totalCards} cartes.
                </p>
            </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="hooks/useFriends.ts">
// hooks/useFriends.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { useAuth } from '@/lib/AuthContext';
import { 
  doc, setDoc, deleteDoc, 
  collection, onSnapshot, serverTimestamp, writeBatch,
  query, collectionGroup, where, getDocs, limit 
} from 'firebase/firestore';
import toast from 'react-hot-toast';

export type FriendProfile = {
  uid: string;
  username: string;
  displayName: string;
  photoURL?: string;
};

export function useFriends() {
  const { user, username } = useAuth();
  
  const [friends, setFriends] = useState<FriendProfile[]>([]);
  const [requestsReceived, setRequestsReceived] = useState<FriendProfile[]>([]);
  const [loading, setLoading] = useState(true);

  // √âcouter les amis et les demandes en temps r√©el
  useEffect(() => {
    if (!user) {
      // CORRECTION : On ne set que si n√©cessaire pour √©viter la boucle
      setFriends(prev => prev.length > 0 ? [] : prev);
      setRequestsReceived(prev => prev.length > 0 ? [] : prev);
      setLoading(prev => prev ? false : prev);
      return;
    }

    // 1. √âcoute Mes Amis
    const friendsRef = collection(db, 'users', user.uid, 'friends');
    const unsubFriends = onSnapshot(friendsRef, (snap) => {
      const list = snap.docs.map(d => d.data() as FriendProfile);
      setFriends(list);
    });

    // 2. √âcoute Demandes Re√ßues
    const reqRef = collection(db, 'users', user.uid, 'friend_requests_received');
    const unsubReq = onSnapshot(reqRef, (snap) => {
      const list = snap.docs.map(d => ({ uid: d.id, ...d.data() } as FriendProfile));
      setRequestsReceived(list);
    });

    setLoading(false);

    return () => {
      unsubFriends();
      unsubReq();
    };
  }, [user]);

  // --- ACTIONS ---

  // 1. Rechercher des utilisateurs (Partiel : "Commence par...")
  const searchUsers = async (searchTerm: string) => {
    const term = searchTerm.trim().toLowerCase();
    if (term.length < 2) return [];

    // Technique Firestore pour "Starts With"
    const usersQuery = query(
      collectionGroup(db, 'public_profile'), // Cherche dans TOUS les profils publics
      where('username', '>=', term),
      where('username', '<=', term + '\uf8ff'),
      limit(5)
    );

    const snapshot = await getDocs(usersQuery);
    
    const results: FriendProfile[] = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      // Retrouver l'UID parent (users/{uid}/public_profile/info)
      const foundUid = doc.ref.parent.parent?.id;

      if (foundUid && foundUid !== user?.uid) {
        results.push({
            uid: foundUid,
            username: data.username,
            displayName: data.displayName,
            photoURL: data.photoURL
        });
      }
    });

    return results;
  };

  // 2. Envoyer une demande
  const sendFriendRequest = async (targetUser: FriendProfile) => {
    if (!user || !username) return;

    // Check si d√©j√† ami
    if (friends.some(f => f.uid === targetUser.uid)) {
      toast.error("Vous √™tes d√©j√† amis !");
      return;
    }

    try {
      // On √©crit dans SA collection 'friend_requests_received'
      await setDoc(doc(db, 'users', targetUser.uid, 'friend_requests_received', user.uid), {
        uid: user.uid,
        username: username,
        displayName: user.displayName,
        photoURL: user.photoURL,
        sentAt: serverTimestamp()
      });
      
      toast.success(`Demande envoy√©e √† @${targetUser.username}`);
    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de l'envoi.");
    }
  };

  // 3. Accepter une demande (Transaction Batch)
  const acceptRequest = async (sender: FriendProfile) => {
    if (!user || !username) return;

    try {
      const batch = writeBatch(db);

      // A. Ajouter dans MES amis
      const myFriendRef = doc(db, 'users', user.uid, 'friends', sender.uid);
      batch.set(myFriendRef, sender);

      // B. Ajouter MOI dans SES amis
      const hisFriendRef = doc(db, 'users', sender.uid, 'friends', user.uid);
      batch.set(hisFriendRef, {
        uid: user.uid,
        username: username,
        displayName: user.displayName,
        photoURL: user.photoURL
      });

      // C. Supprimer la demande re√ßue
      const reqRef = doc(db, 'users', user.uid, 'friend_requests_received', sender.uid);
      batch.delete(reqRef);

      await batch.commit();
      toast.success(`Ami ajout√© : @${sender.username}`);
    } catch (err) {
      console.error(err);
      toast.error("Erreur validation");
    }
  };

  // 4. Refuser
  const declineRequest = async (senderUid: string) => {
    if (!user) return;
    await deleteDoc(doc(db, 'users', user.uid, 'friend_requests_received', senderUid));
    toast.success("Demande supprim√©e");
  };
  
  // 5. Supprimer ami
  const removeFriend = async (friendUid: string) => {
      if(!user) return;
      if(!confirm("Retirer cet ami ?")) return;
      
      await deleteDoc(doc(db, 'users', user.uid, 'friends', friendUid));
      toast.success("Ami retir√©");
  };

  return { 
    friends, 
    requestsReceived, 
    loading, 
    searchUsers, 
    sendFriendRequest, 
    acceptRequest, 
    declineRequest, 
    removeFriend
  };
}
</file>

<file path="lib/AuthContext.tsx">
'use client';

import { createContext, useContext, useEffect, useState, useMemo } from 'react';
import { 
  onAuthStateChanged, 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  User 
} from 'firebase/auth';
import { doc, onSnapshot, collection } from 'firebase/firestore'; 
import { auth, db } from './firebase'; 
import toast from 'react-hot-toast';

type AuthContextType = {
  user: User | null;
  username: string | null;
  loading: boolean;
  friendRequestCount: number; // Compteur pour les notifications
  signInWithGoogle: () => Promise<void>;
  logOut: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType>({
  user: null,
  username: null,
  loading: true,
  friendRequestCount: 0,
  signInWithGoogle: async () => {},
  logOut: async () => {},
});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [username, setUsername] = useState<string | null>(null);
  const [friendRequestCount, setFriendRequestCount] = useState(0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);

      if (currentUser) {
        // 1. √âcoute du Pseudo (Profil Public)
        const profileRef = doc(db, 'users', currentUser.uid, 'public_profile', 'info');
        const unsubProfile = onSnapshot(profileRef, (docSnap) => {
          if (docSnap.exists()) {
            setUsername(docSnap.data().username);
          } else {
            setUsername(null);
          }
          // On ne met loading √† false qu'ici pour √™tre s√ªr d'avoir le username
          setLoading(false);
        });

        // 2. √âcoute des Demandes d'amis (Notifications)
        const requestsRef = collection(db, 'users', currentUser.uid, 'friend_requests_received');
        const unsubRequests = onSnapshot(requestsRef, (snap) => {
          setFriendRequestCount(snap.docs.length);
        });

        // Nettoyage quand l'utilisateur change ou se d√©connecte
        return () => {
          unsubProfile();
          unsubRequests();
        };
      } else {
        setUsername(null);
        setFriendRequestCount(0);
        setLoading(false);
      }
    });

    return () => unsubscribeAuth();
  }, []);

  const signInWithGoogle = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      toast.success('Connexion r√©ussie !');
    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de la connexion Google");
    }
  };

  const logOut = async () => {
    try {
      await signOut(auth);
      toast.success('D√©connect√©');
    } catch (error) {
      console.error(error);
      toast.error("Erreur d√©connexion");
    }
  };

  const value = useMemo(() => ({
    user,
    username,
    friendRequestCount,
    loading,
    signInWithGoogle,
    logOut
  }), [user, username, loading, friendRequestCount]);

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};
</file>

<file path="components/wishlist/SingleWishlistView.tsx">
// components/wishlist/SingleWishlistView.tsx
'use client';

import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import { db } from '@/lib/firebase';
import { doc, runTransaction, increment } from 'firebase/firestore';
import toast from 'react-hot-toast';

type Props = {
    listId: string;
    listName: string;
};

export default function SingleWishlistView({ listId, listName }: Props) {
    const { cards, loading, updateQuantity, removeCard, toggleAttribute, totalPrice } = useCardCollection('wishlist', listId);
    const { user } = useAuth();
    
    const moveToCollection = async (card: CardType) => {
        if (!user) return;
        const toastId = toast.loading("D√©placement...");
        try {
            const sourcePath = listId === 'default' ? 'wishlist' : `wishlists_data/${listId}/cards`;
            const wishlistRef = doc(db, 'users', user.uid, sourcePath, card.id);
            const collectionRef = doc(db, 'users', user.uid, 'collection', card.id);

            await runTransaction(db, async (transaction) => {
                const colDoc = await transaction.get(collectionRef);
                if (colDoc.exists()) {
                    transaction.update(collectionRef, { quantity: increment(card.quantity) });
                } else {
                    transaction.set(collectionRef, { 
                        ...card,
                        // CORRECTION CRITIQUE ICI : On force null si undefined
                        imageBackUrl: card.imageBackUrl || null, 
                        wishlistId: null, 
                        addedAt: new Date(),
                        isFoil: card.isFoil || false
                    });
                }
                transaction.delete(wishlistRef);
            });
            toast.success("Ajout√©e √† la collection !", { id: toastId });
        } catch (error) {
            console.error(error);
            toast.error("Erreur technique (voir console)", { id: toastId });
        }
    };

    if (loading) return <div className="p-10 text-center text-gray-500">Chargement des cartes...</div>;

    return (
        <div className="animate-in fade-in duration-300">
            <div className="flex justify-between items-end mb-6 border-b pb-4 dark:border-gray-700">
                <h2 className="text-2xl font-bold text-gray-800 dark:text-white">{listName}</h2>
                <div className="text-right">
                    <span className="text-xs text-gray-500 uppercase font-semibold">Total estim√©</span>
                    <p className="text-2xl font-bold text-green-600 dark:text-green-400">{totalPrice.toFixed(2)} ‚Ç¨</p>
                </div>
            </div>

            {cards.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                    <p className="text-gray-500 italic">Cette liste est vide.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {cards.map(card => (
                        <MagicCard 
                            key={card.id} 
                            {...card} 
                            isWishlist={true}
                            onIncrement={() => updateQuantity(card.id, 1, card.quantity)}
                            onDecrement={() => {
                                if(card.quantity === 1) { if(confirm("Supprimer ?")) removeCard(card.id); } 
                                else { updateQuantity(card.id, -1, card.quantity); }
                            }}
                            onMove={() => moveToCollection(card)}
                            onToggleAttribute={(field, val) => toggleAttribute(card.id, field, val)}
                        />
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="lib/cardUtils.ts">
// lib/cardUtils.ts

// D√©finition stricte des champs Scryfall que nous utilisons
// Cela √©vite les crashs si l'API change ou si on acc√®de √† un champ inexistant
export type ScryfallRawData = {
  id: string;
  name: string;
  set: string;
  set_name: string;
  collector_number: string;
  released_at?: string;
  image_uris?: {
    small?: string;
    normal?: string;
    large?: string;
    png?: string;
  };
  card_faces?: Array<{
    name: string;
    image_uris?: {
      normal?: string;
    };
  }>;
  prices?: {
    eur?: string;
    eur_foil?: string;
    usd?: string;
  };
  finishes?: string[]; // 'foil', 'nonfoil', 'etched'
  // On autorise d'autres champs inconnus sans casser le typage strict ci-dessus
  [key: string]: unknown;
};

export const normalizeCardData = (data: ScryfallRawData) => {
  // Gestion des noms pour les cartes doubles (ex: "Malakir Rebirth // Malakir Mire")
  const rawName = data.name;
  const name = rawName.split(' // ')[0]; 

  let imageUrl = "";
  let imageBackUrl: string | null = null;

  // CAS 1 : Carte standard (image √† la racine)
  if (data.image_uris?.normal) {
    imageUrl = data.image_uris.normal;
  } 
  // CAS 2 : Carte double face (Transform, Modal DFC, etc.)
  else if (data.card_faces && data.card_faces.length > 0) {
    // Face Avant
    if (data.card_faces[0].image_uris?.normal) {
      imageUrl = data.card_faces[0].image_uris.normal;
    }
    
    // Face Arri√®re (si elle a une image)
    if (data.card_faces[1] && data.card_faces[1].image_uris?.normal) {
      imageBackUrl = data.card_faces[1].image_uris.normal;
    }
  }

  // Fallback si aucune image trouv√©e (Card Back par d√©faut)
  if (!imageUrl) {
    imageUrl = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";
  }

  return {
    id: data.id,
    scryfallId: data.id,
    name,
    imageUrl,
    imageBackUrl, // Sera string ou null (jamais undefined)
    setName: data.set_name,
    setCode: data.set,
    price: parseFloat(data.prices?.eur || "0"),
    scryfallData: data // On garde la donn√©e brute
  };
};
</file>

<file path="package.json">
{
  "name": "magicwish",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@types/papaparse": "^5.5.1",
    "firebase": "^12.5.0",
    "firebase-admin": "^13.6.0",
    "next": "^16.0.8",
    "next-themes": "^0.4.6",
    "papaparse": "^5.5.3",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-hot-toast": "^2.6.0",
    "stripe": "^20.0.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  /* COULEURS DU TH√àME */
  --background: #fafafa; /* Zinc-50 (Blanc cass√© doux) */
  --foreground: #27272a; /* Zinc-800 (Gris anthracite) */
  
  /* Ta nouvelle couleur de marque */
  --brand-blue: #6275b3; 
}

.dark {
  --background: #09090b; /* Zinc-950 */
  --foreground: #f4f4f5; /* Zinc-100 */
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  -webkit-font-smoothing: antialiased;
}

@layer components {
  /* Mise √† jour du bouton principal avec le nouveau bleu */
  .btn-primary {
    @apply bg-[#6275b3] hover:bg-[#53639c] text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-transform active:scale-95;
  }
}
</file>

<file path="app/search/page.tsx">
'use client';

import { useState, useMemo } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, setDoc, increment, serverTimestamp } from 'firebase/firestore';
import { ScryfallRawData } from '@/lib/cardUtils';
import { CardType } from '@/hooks/useCardCollection';
import { useWishlists } from '@/hooks/useWishlists';
import CardVersionPickerModal from '@/components/CardVersionPickerModal';
import toast from 'react-hot-toast';

export default function SearchPage() {
  const { user } = useAuth();
  const { lists } = useWishlists();
  
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<ScryfallRawData[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);

  const [modalOpen, setModalOpen] = useState(false);
  const [selectedBaseCard, setSelectedBaseCard] = useState<ScryfallRawData | null>(null);
  const [targetDestination, setTargetDestination] = useState<'collection' | 'wishlist'>('collection');

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!query.trim()) return;

    setIsSearching(true);
    setHasSearched(true);
    setResults([]);

    try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        if (data.data) {
            setResults(data.data);
        } else {
            toast.error("Aucune carte trouvee.");
        }
    } catch (error) {
        console.error(error);
        toast.error("Erreur de recherche.");
    } finally {
        setIsSearching(false);
    }
  };

  const openPicker = (card: ScryfallRawData, destination: 'collection' | 'wishlist') => {
      setSelectedBaseCard(card);
      setTargetDestination(destination);
      setModalOpen(true);
  };

  const handleConfirmAdd = async (card: CardType, targetListId: string = 'default') => {
      if (!user) return;

      const destLabel = targetDestination === 'collection' ? 'Collection' : 'Wishlist';
      const toastId = toast.loading(`Ajout a : ${destLabel}...`);
      
      try {
          let collectionPath = 'collection';
          if (targetDestination === 'wishlist') {
              if (targetListId === 'default') {
                  collectionPath = 'wishlist';
              } else {
                  collectionPath = `wishlists_data/${targetListId}/cards`;
              }
          }

          const cardRef = doc(db, 'users', user.uid, collectionPath, card.id);

          const dataToSave = {
              ...card,
              imageBackUrl: card.imageBackUrl || null,
              addedAt: serverTimestamp(),
              wishlistId: targetDestination === 'wishlist' ? targetListId : null, 
              isForTrade: false 
          };

          await setDoc(cardRef, {
              ...dataToSave,
              quantity: increment(card.quantity)
          }, { merge: true });

          toast.success(`Ajoute avec succes !`, { id: toastId });

      } catch (error) {
          console.error(error);
          toast.error("Erreur lors de l'ajout", { id: toastId });
      }
  };

  const uniqueResults = useMemo(() => {
    const seen = new Set();
    return results.filter(c => {
        const name = c.name.split(' // ')[0];
        if (seen.has(name)) return false;
        seen.add(name);
        return true;
    });
  }, [results]);

  return (
    <main className="container mx-auto p-4 max-w-5xl min-h-[85vh]">
      
      <div className="text-center mb-8 pt-4">
          <h1 className="text-3xl font-bold bg-linear-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
              Centre de Recherche
          </h1>
          <p className="text-gray-500">
              Trouvez n&apos;importe quelle carte et ajoutez-la a votre Collection ou votre Wishlist.
          </p>
      </div>

      <div className="max-w-2xl mx-auto mb-10 sticky top-4 z-20">
          <form onSubmit={handleSearch} className="relative shadow-lg rounded-full">
              <input 
                  type="text" 
                  className="w-full p-4 pl-6 pr-14 rounded-full border-2 border-transparent bg-white dark:bg-gray-800 dark:text-white focus:border-blue-500 outline-none transition text-lg"
                  placeholder="Nom de la carte (ex: Black Lotus, Sol Ring...)"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  autoFocus
              />
              <button 
                  type="submit"
                  disabled={isSearching || !query.trim()}
                  className="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 flex items-center justify-center transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                  {isSearching ? '...' : 'Go'}
              </button>
          </form>
      </div>

      {isSearching ? (
          <div className="text-center py-20">
              <div className="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
              <p className="text-gray-400">Interrogation de Scryfall...</p>
          </div>
      ) : uniqueResults.length > 0 ? (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
              {uniqueResults.map((card) => (
                  <div key={card.id} className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden flex flex-col group hover:shadow-md transition">
                      <div className="relative aspect-[2.5/3.5] bg-gray-200 overflow-hidden">
                          {card.image_uris?.normal ? (
                              <img src={card.image_uris.normal} alt={card.name} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                          ) : (
                             <div className="flex items-center justify-center h-full text-gray-400 text-xs">Pas d&apos;image</div>
                          )}
                          
                          <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4">
                              <button 
                                  onClick={() => openPicker(card, 'collection')}
                                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300"
                              >
                                  + Collection
                              </button>
                              <button 
                                  onClick={() => openPicker(card, 'wishlist')}
                                  className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-sm shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75"
                              >
                                  + Wishlist
                              </button>
                          </div>
                      </div>

                      <div className="p-3">
                          <h3 className="font-bold text-gray-900 dark:text-white truncate" title={card.name}>{card.name}</h3>
                          <p className="text-xs text-gray-500">{card.set_name}</p>
                      </div>
                  </div>
              ))}
          </div>
      ) : hasSearched ? (
          <div className="text-center py-20 bg-gray-50 dark:bg-gray-800/50 rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-700">
              <p className="text-xl text-gray-500">Aucun resultat trouve pour &quot;{query}&quot;.</p>
          </div>
      ) : (
          <div className="grid md:grid-cols-2 gap-4 max-w-3xl mx-auto opacity-50 hover:opacity-100 transition-opacity">
               <div className="p-6 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl text-center">
                   <span className="text-4xl mb-2 block font-bold text-gray-300">COLLECTION</span>
                   <h3 className="font-bold">Completer ma Collection</h3>
               </div>
               <div className="p-6 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl text-center">
                   <span className="text-4xl mb-2 block font-bold text-gray-300">WISHLIST</span>
                   <h3 className="font-bold">Remplir ma Wishlist</h3>
               </div>
          </div>
      )}

      <CardVersionPickerModal 
          isOpen={modalOpen}
          onClose={() => setModalOpen(false)}
          baseCard={selectedBaseCard}
          onConfirm={handleConfirmAdd}
          destination={targetDestination}
          availableLists={lists}
      />

    </main>
  );
}
</file>

<file path="hooks/useTradeMatcher.ts">
// hooks/useTradeMatcher.ts
import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { collection, getDocs, doc, writeBatch } from 'firebase/firestore'; 
import { useWishlists, WishlistMeta } from './useWishlists'; 
import { useFriends, FriendProfile } from './useFriends';
import { CardType } from './useCardCollection';

export type TradeProposal = {
  friend: FriendProfile;
  toReceive: CardType[]; 
  toGive: CardType[];    
  balance: number;       
};

export function useTradeMatcher() {
  const { user } = useAuth();
  const { lists } = useWishlists();
  const { friends } = useFriends();
  
  const [proposals, setProposals] = useState<TradeProposal[]>([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState("");

  // --- 1. CHARGEMENT OPTIMIS√â (Retourne une Map directement) ---
  const fetchCardsAsMap = async (uid: string, mode: 'collection' | 'wishlist', userLists: WishlistMeta[] = []) => {
    const cardsMap = new Map<string, CardType>();

    try {
        if (mode === 'collection') {
            const snap = await getDocs(collection(db, 'users', uid, 'collection'));
            snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
        } else {
            // Charge la liste par d√©faut
            const defSnap = await getDocs(collection(db, 'users', uid, 'wishlist'));
            defSnap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
            
            // Charge les listes customs en parall√®le
            if (userLists.length > 0) {
                const listPromises = userLists
                    .filter(l => l.id !== 'default')
                    .map(list => getDocs(collection(db, 'users', uid, 'wishlists_data', list.id, 'cards')));
                
                const snapshots = await Promise.all(listPromises);
                snapshots.forEach(snap => {
                    snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
                });
            } else {
                // Fallback si pas de userLists fournies (pour les amis) : on lit les m√©tadonn√©es
                const metaSnap = await getDocs(collection(db, 'users', uid, 'wishlists_meta'));
                const listPromises = metaSnap.docs.map(m => getDocs(collection(db, 'users', uid, 'wishlists_data', m.id, 'cards')));
                const snapshots = await Promise.all(listPromises);
                snapshots.forEach(snap => {
                     snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
                });
            }
        }
    } catch (e) {
        console.error(`Erreur chargement ${mode} pour ${uid}`, e);
    }
    return cardsMap;
  };

  // --- 2. MISE √Ä JOUR PRIX CIBL√âE (CORRIG√âE : SEULEMENT MES CARTES) ---
  const refreshPricesForProposals = async (currentProposals: TradeProposal[], myUid: string) => {
     // On extrait toutes les cartes uniques impliqu√©es
     const cardsToUpdateMap = new Map<string, { card: CardType, ownerUid: string, collection: string }>();

     currentProposals.forEach(p => {
         // IMPORTANT: On ne mettra pas √† jour les cartes de l'ami ici car on n'a pas les droits d'√©criture
         // On peut les lire pour le calcul de balance, mais pas les update en base.
         p.toReceive.forEach(c => cardsToUpdateMap.set(`${p.friend.uid}_${c.id}`, { card: c, ownerUid: p.friend.uid, collection: 'collection' }));
         p.toGive.forEach(c => cardsToUpdateMap.set(`${myUid}_${c.id}`, { card: c, ownerUid: myUid, collection: 'collection' }));
     });

     const updatesArray = Array.from(cardsToUpdateMap.values());
     if (updatesArray.length === 0) return;

     // On traite par paquets de 75 (limite Scryfall)
     const chunks = [];
     for (let i = 0; i < updatesArray.length; i += 75) {
         chunks.push(updatesArray.slice(i, i + 75));
     }

     const batch = writeBatch(db); 
     let hasUpdates = false;

     for (const chunk of chunks) {
         try {
             // On ne demande √† Scryfall que les IDs
             const identifiers = chunk.map(item => ({ id: item.card.id }));
             
             const res = await fetch('https://api.scryfall.com/cards/collection', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ identifiers })
             });

             if (!res.ok) continue;

             const data = await res.json();
             // eslint-disable-next-line @typescript-eslint/no-explicit-any
             const foundCards: any[] = data.data || [];

             foundCards.forEach(scryCard => {
                 const newPrice = parseFloat(scryCard.prices?.eur || "0");
                 
                 // On retrouve les cartes locales qui correspondent √† cet ID Scryfall
                 const localMatches = chunk.filter(item => item.card.id === scryCard.id);

                 localMatches.forEach(match => {
                     // Update m√©moire (ref) pour l'affichage imm√©diat
                     if (match.card.price !== newPrice) {
                         match.card.price = newPrice;
                         
                         // Update Firestore : UNIQUEMENT SI C'EST MA CARTE
                         if (match.ownerUid === myUid) {
                             const ref = doc(db, 'users', match.ownerUid, match.collection, match.card.id);
                             batch.update(ref, { price: newPrice });
                             hasUpdates = true;
                         }
                     }
                 });
             });
         } catch (e) { console.error("Err price fetch batch", e); }
     }

     if (hasUpdates) {
         await batch.commit();
     }
  };

  // --- 3. ALGORITHME PRINCIPAL ---
  const runScan = async () => {
    if (!user || friends.length === 0) return;
    setLoading(true);
    setStatus("Chargement de vos donn√©es...");

    try {
        // A. Charger MES donn√©es
        const [myCollectionMap, myWishlistMap] = await Promise.all([
            fetchCardsAsMap(user.uid, 'collection'),
            fetchCardsAsMap(user.uid, 'wishlist', lists)
        ]);

        // B. Indexation de MA Wishlist (Set pour O(1))
        const myWishlistIds = new Set<string>();
        const myWishlistNames = new Set<string>();
        myWishlistMap.forEach(c => {
            if (c.isSpecificVersion) myWishlistIds.add(c.id);
            else myWishlistNames.add(c.name);
        });

        // C. Indexation de MON Trade Binder
        const myTradeCards = Array.from(myCollectionMap.values()).filter(c => c.isForTrade);

        setStatus(`Analyse simultan√©e de ${friends.length} amis...`);

        // D. SCAN PARALL√àLE DES AMIS
        const matchPromises = friends.map(async (friend) => {
            const [friendCollectionMap, friendWishlistMap] = await Promise.all([
                fetchCardsAsMap(friend.uid, 'collection'),
                fetchCardsAsMap(friend.uid, 'wishlist')
            ]);

            const toReceive: CardType[] = [];
            const toGive: CardType[] = [];

            // 1. Check ce que JE re√ßois (Sa Collection vs Ma Wishlist)
            friendCollectionMap.forEach(card => {
                if (card.isForTrade) { 
                    if (myWishlistIds.has(card.id) || myWishlistNames.has(card.name)) {
                        toReceive.push(card);
                    }
                }
            });

            // 2. Check ce que JE donne (Ma Collection vs Sa Wishlist)
            const friendWishlistIds = new Set<string>();
            const friendWishlistNames = new Set<string>();
            friendWishlistMap.forEach(c => {
                if (c.isSpecificVersion) friendWishlistIds.add(c.id);
                else friendWishlistNames.add(c.name);
            });

            myTradeCards.forEach(card => {
                if (friendWishlistIds.has(card.id) || friendWishlistNames.has(card.name)) {
                    toGive.push(card);
                }
            });

            if (toReceive.length > 0 || toGive.length > 0) {
                return {
                    friend,
                    toReceive,
                    toGive,
                    balance: 0 
                } as TradeProposal;
            }
            return null;
        });

        const results = await Promise.all(matchPromises);
        const validProposals = results.filter((p): p is TradeProposal => p !== null);

        // E. MISE √Ä JOUR DES PRIX (Seulement pour les cartes match√©es)
        if (validProposals.length > 0) {
            setStatus("Actualisation des prix...");
            await refreshPricesForProposals(validProposals, user.uid);
            
            validProposals.forEach(p => {
                const valReceive = p.toReceive.reduce((sum, c) => sum + (c.customPrice ?? c.price ?? 0), 0);
                const valGive = p.toGive.reduce((sum, c) => sum + (c.customPrice ?? c.price ?? 0), 0);
                p.balance = valGive - valReceive;
            });
        }

        setProposals(validProposals);

    } catch (error) {
        console.error("Erreur scan", error);
    } finally {
        setLoading(false);
        setStatus("");
    }
  };

  return { proposals, loading, status, runScan };
}
</file>

<file path="hooks/useTradeSystem.ts">
// hooks/useTradeSystem.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { 
  collection, addDoc, query, where, onSnapshot, 
  doc, updateDoc, serverTimestamp, orderBy, 
  Timestamp
} from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import { CardType } from './useCardCollection';
import { executeServerTrade } from '@/app/actions/trade'; 
import toast from 'react-hot-toast';

export type TradeStatus = 'pending' | 'completed' | 'rejected' | 'cancelled';

export type TradeRequest = {
  id: string;
  senderUid: string;
  senderName: string;
  receiverUid: string;
  receiverName: string;
  itemsGiven: CardType[];
  itemsReceived: CardType[];
  status: TradeStatus;
  createdAt: Timestamp;
};

// Fonction de nettoyage
const cleanCardsForServer = (cards: CardType[]) => {
    return cards.map(card => {
        const clean = { ...card };
        // @ts-expect-error: Timestamp Firestore non s√©rialisable
        delete clean.addedAt;
        // @ts-expect-error: Timestamp Firestore non s√©rialisable
        delete clean.importedAt;
        // @ts-expect-error: Timestamp Firestore non s√©rialisable
        delete clean.createdAt;
        // @ts-expect-error: Timestamp Firestore non s√©rialisable
        delete clean.lastUpdated;
        
        Object.keys(clean).forEach(key => {
            const k = key as keyof CardType;
            if (clean[k] === undefined) delete clean[k];
        });
        
        return clean;
    });
};

export function useTradeSystem() {
  const { user, username } = useAuth();
  
  const [incomingTrades, setIncomingTrades] = useState<TradeRequest[]>([]);
  const [outgoingTrades, setOutgoingTrades] = useState<TradeRequest[]>([]);
  const [loading, setLoading] = useState(true);
  const [isProcessing, setIsProcessing] = useState(false);

  useEffect(() => {
    if (!user) return;

    const qIn = query(
      collection(db, 'trades'),
      where('receiverUid', '==', user.uid),
      where('status', '==', 'pending'),
      orderBy('createdAt', 'desc')
    );

    const qOut = query(
      collection(db, 'trades'),
      where('senderUid', '==', user.uid),
      where('status', '==', 'pending'),
      orderBy('createdAt', 'desc')
    );

    const unsubIn = onSnapshot(qIn, (snap) => {
      setIncomingTrades(snap.docs.map(d => ({ id: d.id, ...d.data() } as TradeRequest)));
    });

    const unsubOut = onSnapshot(qOut, (snap) => {
      setOutgoingTrades(snap.docs.map(d => ({ id: d.id, ...d.data() } as TradeRequest)));
      setLoading(false);
    });

    return () => { unsubIn(); unsubOut(); };
  }, [user]);

  const proposeTrade = async (receiverUid: string, receiverName: string, toGive: CardType[], toReceive: CardType[]) => {
    if (!user) return;
    const toastId = toast.loading("Envoi de la proposition...");

    try {
      const cleanGiven = cleanCardsForServer(toGive);
      const cleanReceived = cleanCardsForServer(toReceive);

      await addDoc(collection(db, 'trades'), {
        senderUid: user.uid,
        senderName: username || user.displayName || 'Inconnu',
        receiverUid,
        receiverName,
        itemsGiven: cleanGiven,    
        itemsReceived: cleanReceived, 
        status: 'pending',
        createdAt: serverTimestamp()
      });
      toast.success("Proposition envoyee !", { id: toastId });
      return true;
    } catch (e) {
      console.error("Erreur Firestore:", e);
      toast.error("Erreur envoi", { id: toastId });
      return false;
    }
  };

  const acceptTrade = async (trade: TradeRequest) => {
    if (!user) return;
    
    setIsProcessing(true);
    const toastId = toast.loading("Validation securisee en cours...");

    try {
        const safeItemsGiven = cleanCardsForServer(trade.itemsGiven);
        const safeItemsReceived = cleanCardsForServer(trade.itemsReceived);

        // Appel Server Action (qui g√®re stocks + status)
        const result = await executeServerTrade(
            trade.id, // <-- On passe l'ID de l'√©change
            trade.senderUid,
            user.uid, 
            safeItemsGiven,
            safeItemsReceived
        );

        if (result.success) {
            // Note: On ne fait plus updateDoc ici pour 'completed', 
            // le serveur l'a fait. Le onSnapshot mettra l'UI √† jour.
            toast.success("Echange termine avec succes !", { id: toastId });
        } else {
            throw new Error(result.error || "Erreur serveur inconnue");
        }

    } catch (error: unknown) { 
        console.error("Erreur Accept Trade:", error);
        let msg = "Echec de l'echange";
        if (error instanceof Error) msg = error.message;
        else if (typeof error === "string") msg = error;
        toast.error(msg, { id: toastId });
    } finally {
        setIsProcessing(false);
    }
  };

  // 'rejected' reste autoris√© c√¥t√© client dans les nouvelles r√®gles
  const rejectTrade = async (tradeId: string) => {
    if(!confirm("Refuser cet echange ?")) return;
    await updateDoc(doc(db, 'trades', tradeId), { status: 'rejected' });
    toast.success("Echange refuse");
  };

  // 'cancelled' reste autoris√© c√¥t√© client dans les nouvelles r√®gles
  const cancelTrade = async (tradeId: string) => {
    if(!confirm("Annuler cette proposition ?")) return;
    await updateDoc(doc(db, 'trades', tradeId), { status: 'cancelled' });
    toast.success("Proposition annulee");
  };

  return { 
    incomingTrades, outgoingTrades, loading, 
    proposeTrade, acceptTrade, rejectTrade, cancelTrade,
    isProcessing 
  };
}
</file>

<file path="app/contacts/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { useAuth } from '@/lib/AuthContext';
import { useFriends, FriendProfile } from '@/hooks/useFriends';
import toast from 'react-hot-toast';

const PLANESWALKERS = [
  "Jace", "Liliana", "Chandra", "Ajani", "Garruk", 
  "Teferi", "Nissa", "Gideon", "Nicol_Bolas", "Ugin", 
  "Karn", "Sorin", "Elspeth", "Tezzeret", "Sarkhan",
  "Vraska", "Domri", "Ral_Zarek", "Kaya", "Narset"
];

export default function ContactsPage() {
  const { user } = useAuth();
  
  const { 
    friends, requestsReceived, loading,
    searchUsers, 
    sendFriendRequest, acceptRequest, declineRequest, removeFriend
  } = useFriends();

  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<FriendProfile[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  
  const [randomPlaceholder, setRandomPlaceholder] = useState("ex: Jace...");

  useEffect(() => {
    const randomName = PLANESWALKERS[Math.floor(Math.random() * PLANESWALKERS.length)];
    setRandomPlaceholder(`ex: ${randomName} (pour trouver ${randomName.toLowerCase()}_fan...)`);
  }, []);

  if (!user) return <div className="p-10 text-center">Veuillez vous connecter pour gerer vos contacts.</div>;

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!searchQuery.trim()) return;
    
    setIsSearching(true);
    setSearchResults([]);
    
    try {
      const results = await searchUsers(searchQuery);
      setSearchResults(results);
      
      if (results.length === 0) {
        toast("Aucun utilisateur trouve");
      }
    } catch (err: unknown) { 
        console.error(err);
        
        if (err instanceof Error && err.message.includes("indexes")) {
            toast.error("Configuration serveur requise (voir console F12)");
        } else {
            toast.error("Erreur lors de la recherche");
        }
    } finally {
      setIsSearching(false);
    }
  };

  return (
    <main className="container mx-auto p-4 max-w-4xl min-h-[80vh]">
      <h1 className="text-3xl font-bold mb-8 text-blue-600 dark:text-blue-400 flex items-center gap-2">
        Mes Contacts
      </h1>

      <div className="grid md:grid-cols-2 gap-8">
        
        <div className="space-y-8">
            
            <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <h2 className="font-bold text-lg mb-4 text-gray-800 dark:text-white">Chercher un ami</h2>
                
                <form onSubmit={handleSearch} className="flex gap-2 mb-4">
                    <div className="relative grow">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">@</span>
                        <input 
                            type="text" 
                            placeholder={randomPlaceholder} 
                            className="w-full pl-7 p-2 border rounded-lg bg-gray-50 dark:bg-gray-900 dark:border-gray-600 outline-none focus:ring-2 focus:ring-blue-500 lowercase text-gray-900 dark:text-white"
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value.toLowerCase())}
                        />
                    </div>
                    <button 
                        type="submit" 
                        disabled={isSearching}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition disabled:opacity-50"
                    >
                        {isSearching ? '...' : 'Chercher'}
                    </button>
                </form>

                <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                    {searchResults.map(result => (
                        <div key={result.uid} className="flex items-center justify-between bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800 animate-in fade-in">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-blue-200 flex items-center justify-center text-blue-700 font-bold text-xs overflow-hidden relative">
                                    {result.photoURL ? <Image src={result.photoURL} alt="" fill className="object-cover" /> : result.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <p className="font-bold text-sm text-gray-900 dark:text-white">{result.displayName}</p>
                                    <p className="text-xs text-blue-600 dark:text-blue-400">@{result.username}</p>
                                </div>
                            </div>
                            <button 
                                onClick={() => sendFriendRequest(result)}
                                className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded-full hover:bg-blue-700 transition shadow-sm"
                            >
                                Ajouter
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            {requestsReceived.length > 0 && (
                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-orange-200 dark:border-orange-900/50 animate-in slide-in-from-left-4">
                    <h2 className="font-bold text-lg mb-4 text-orange-600 dark:text-orange-400 flex items-center gap-2">
                        Demandes recues <span className="bg-orange-100 text-orange-800 text-xs px-2 py-0.5 rounded-full">{requestsReceived.length}</span>
                    </h2>
                    <div className="space-y-3">
                        {requestsReceived.map(req => (
                            <div key={req.uid} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gray-300 overflow-hidden relative">
                                        {req.photoURL ? <Image src={req.photoURL} alt="" fill className="object-cover" /> : <span className="flex items-center justify-center h-full font-bold text-gray-500">{req.username[0].toUpperCase()}</span>}
                                    </div>
                                    <div>
                                        <p className="font-bold text-sm text-gray-900 dark:text-white">{req.displayName}</p>
                                        <p className="text-xs text-gray-500">@{req.username}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => acceptRequest(req)} className="p-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-full transition" title="Accepter">V</button>
                                    <button onClick={() => declineRequest(req.uid)} className="p-2 bg-red-100 text-red-700 hover:bg-red-200 rounded-full transition" title="Refuser">X</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>

        <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 h-fit">
            <h2 className="font-bold text-lg mb-4 flex items-center gap-2 text-gray-800 dark:text-white">
                Mes Amis <span className="text-gray-400 font-normal">({friends.length})</span>
            </h2>
            
            {loading ? (
                <p className="text-gray-500 text-sm">Chargement...</p>
            ) : friends.length === 0 ? (
                <div className="text-center py-10 text-gray-400 italic">
                    <p>Aucun ami pour l&apos;instant.</p>
                </div>
            ) : (
                <div className="space-y-2">
                    {friends.map(friend => (
                        <div key={friend.uid} className="group flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition border border-transparent hover:border-gray-100 dark:hover:border-gray-600">
                            
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-linear-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold shadow-sm overflow-hidden relative">
                                    {friend.photoURL ? <Image src={friend.photoURL} alt="" fill className="object-cover" /> : friend.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <p className="font-bold text-gray-800 dark:text-gray-200">{friend.displayName}</p>
                                    <p className="text-xs text-gray-500">@{friend.username}</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                <Link 
                                    href={`/user/${friend.uid}`}
                                    className="text-xs bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-3 py-1.5 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition font-medium"
                                >
                                    Voir
                                </Link>

                                <Link 
                                    href={`/trades/new/${friend.uid}`}
                                    className="text-xs bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 px-3 py-1.5 rounded hover:bg-purple-200 dark:hover:bg-purple-800 transition font-medium flex items-center gap-1"
                                >
                                    Echanger
                                </Link>
                                
                                <button 
                                    onClick={() => removeFriend(friend.uid)} 
                                    className="text-red-400 hover:text-red-600 text-xs px-2 py-1"
                                    title="Retirer cet ami"
                                >
                                    X
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>

      </div>
    </main>
  );
}
</file>

<file path="app/trades/manual/page.tsx">
'use client';

import { useState, useMemo, useTransition } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import { executeManualTrade } from '@/app/actions/trade'; // <--- Import de la Server Action
import toast from 'react-hot-toast';
import CardVersionPickerModal from '@/components/CardVersionPickerModal';
import { ScryfallRawData } from '@/lib/cardUtils';

export default function ManualTradePage() {
  const { user } = useAuth();
  const { cards: myCollection, loading } = useCardCollection('collection'); 
  
  // useTransition g√®re l'√©tat "pending" pendant que le serveur travaille
  const [isPending, startTransition] = useTransition();

  const [toGive, setToGive] = useState<CardType[]>([]);
  const [toReceive, setToReceive] = useState<CardType[]>([]);
  
  const [localSearch, setLocalSearch] = useState('');
  
  const [remoteSearch, setRemoteSearch] = useState('');
  const [searchResults, setSearchResults] = useState<ScryfallRawData[]>([]);
  const [isSearching, setIsSearching] = useState(false);

  const [cardToPick, setCardToPick] = useState<ScryfallRawData | null>(null);

  const handleAddToGive = (card: CardType) => {
      const existing = toGive.find(c => c.id === card.id);
      if (existing) {
          if (existing.quantity < card.quantity) { 
              setToGive(prev => prev.map(c => c.id === card.id ? { ...c, quantity: c.quantity + 1 } : c));
          } else {
              toast.error("Stock max atteint");
          }
      } else {
          setToGive(prev => [...prev, { ...card, quantity: 1 }]);
      }
  };

  const handleSearchScryfall = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!remoteSearch.trim()) return;
      setIsSearching(true);
      try {
          const res = await fetch(`/api/search?q=${remoteSearch}`); 
          const data = await res.json();
          setSearchResults(data.data || []);
      } catch (e) { toast.error("Erreur recherche"); }
      finally { setIsSearching(false); }
  };

  const handleSearchResultClick = (scryfallCard: ScryfallRawData) => {
    setCardToPick(scryfallCard);
  };

  const handleConfirmReceive = (card: CardType) => {
      const existing = toReceive.find(c => c.id === card.id && c.isFoil === card.isFoil); 
      
      if (existing) {
          setToReceive(prev => prev.map(c => 
              (c.id === card.id && c.isFoil === card.isFoil) 
              ? { ...c, quantity: c.quantity + card.quantity } 
              : c
          ));
      } else {
          setToReceive(prev => [...prev, card]);
      }
      
      setSearchResults([]); 
      setRemoteSearch("");
      toast.success(`Ajout√© : ${card.name}`);
  };

  // --- NOUVELLE LOGIQUE DE VALIDATION S√âCURIS√âE ---
  const handleValidate = async () => {
      if (!user) return;
      if (toGive.length === 0 && toReceive.length === 0) return;
      if (!confirm("Confirmer cet √©change ? Vos cartes donn√©es seront retir√©es de votre collection.")) return;

      const toastId = toast.loading("Validation s√©curis√©e...");

      startTransition(async () => {
        // On appelle le serveur
        const result = await executeManualTrade(user.uid, toGive, toReceive);
        
        if (result.success) {
            toast.success("Echange valid√© !", { id: toastId });
            setToGive([]);
            setToReceive([]);
            setLocalSearch("");
        } else {
            toast.error(result.error || "Erreur lors de l'√©change", { id: toastId });
        }
      });
  };

  const valGive = toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const valReceive = toReceive.reduce((acc, c) => acc + (c.price || 0) * c.quantity, 0);

  const uniqueSearchResults = useMemo(() => {
    const seen = new Set();
    return searchResults.filter(card => {
      const rawName = card.name || "";
      const name = rawName.split(' // ')[0];
      if (seen.has(name)) return false;
      seen.add(name);
      return true;
    });
  }, [searchResults]);

  if (!user) return <div className="p-10 text-center">Connectez-vous.</div>;

  return (
    <div className="container mx-auto p-4 h-[calc(100vh-64px)] flex flex-col">
        
        <h1 className="text-2xl font-bold mb-4 flex-none flex items-center gap-2">
            √âchange Manuel / Externe
        </h1>

        <div className="grid lg:grid-cols-2 gap-6 grow overflow-hidden pb-24">
            
            {/* COLONNE GAUCHE : JE DONNE */}
            <div className="flex flex-col h-full bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-red-600 mb-2">Je donne (De ma collection)</h2>
                    <input 
                        type="text" 
                        placeholder="Chercher dans ma collection..." 
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={localSearch}
                        onChange={e => setLocalSearch(e.target.value)}
                    />
                </div>
                
                 <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    {/* Liste des cartes s√©lectionn√©es */}
                    {toGive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800 overflow-hidden">
                            <div className="bg-red-100 dark:bg-red-900/30 px-3 py-1 text-xs font-bold text-red-700 dark:text-red-300">
                                S√âLECTION ({toGive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toGive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => setToGive(p => p.filter(c => c.id !== card.id))} className="text-red-500 hover:bg-red-50 rounded px-1">X</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Liste de la collection */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ma Collection</p>
                        {loading ? <p className="text-sm">Chargement...</p> : 
                            myCollection
                                .filter(c => c.name.toLowerCase().includes(localSearch.toLowerCase()))
                                .slice(0, 50)
                                .map(card => (
                                    <div key={card.id} onClick={() => handleAddToGive(card)} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-red-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Stock: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-red-500 shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                <div className="flex-none bg-red-50 dark:bg-red-900/20 p-3 border-t border-red-100 dark:border-red-900 text-center">
                    <span className="text-xs text-red-600 dark:text-red-400 font-bold uppercase">Total Donn√©</span>
                    <div className="text-xl font-bold text-red-700 dark:text-red-300">{valGive.toFixed(2)} EUR</div>
                </div>
            </div>

            {/* COLONNE DROITE : JE RE√áOIS */}
            <div className="flex flex-col h-full bg-green-50/50 dark:bg-green-900/10 rounded-xl border border-green-100 dark:border-green-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-green-600 mb-2">Je re√ßois (Ajout libre)</h2>
                    <form onSubmit={handleSearchScryfall} className="flex gap-2 mb-2">
                        <input 
                            type="text" 
                            placeholder="Rechercher carte √† recevoir..." 
                            className="grow p-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                            value={remoteSearch}
                            onChange={e => setRemoteSearch(e.target.value)}
                        />
                        <button type="submit" className="bg-green-600 hover:bg-green-700 text-white px-3 rounded shadow-sm">V</button>
                    </form>
                </div>

                 <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    
                    {toReceive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-green-200 dark:border-green-800 overflow-hidden">
                            <div className="bg-green-100 dark:bg-green-900/30 px-3 py-1 text-xs font-bold text-green-700 dark:text-green-300">
                                S√âLECTION ({toReceive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toReceive.map((card, idx) => (
                                <div key={`${card.id}-${idx}`} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <span className="font-bold shrink-0">{card.quantity}x</span>
                                        <div className="flex flex-col truncate">
                                            <span className="dark:text-gray-200 truncate">{card.name}</span>
                                            <span className="text-[10px] text-gray-500 truncate">
                                                {card.setName} {card.isFoil && 'Foil'}
                                            </span>
                                        </div>
                                    </div>
                                    <button onClick={() => setToReceive(p => p.filter((_, i) => i !== idx))} className="text-red-500 hover:bg-red-50 rounded px-1 ml-2">X</button>
                                </div>
                            ))}
                        </div>
                    )}

                     <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">R√©sultats Scryfall</p>
                        {isSearching && <p className="text-xs text-center py-4">Recherche...</p>}
                        
                        {uniqueSearchResults.map(card => (
                            <div key={card.id} onClick={() => handleSearchResultClick(card)} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-green-100 dark:hover:bg-green-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-green-200 transition shadow-sm group">
                                 <div className="w-8 h-11 bg-gray-200 rounded overflow-hidden shrink-0">
                                    {card.image_uris?.small && <img src={card.image_uris.small} className="w-full h-full object-cover" alt="" />}
                                 </div>
                                 <div className="grow min-w-0">
                                    <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                    <p className="text-[10px] text-gray-500 italic">S√©lectionner version...</p>
                                 </div>
                                 <span className="text-xs font-bold text-gray-400 group-hover:text-green-500 shrink-0">Choisir</span>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="flex-none bg-green-50 dark:bg-green-900/20 p-3 border-t border-green-100 dark:border-green-900 text-center">
                    <span className="text-xs text-green-600 dark:text-green-400 font-bold uppercase">Total Re√ßu</span>
                    <div className="text-xl font-bold text-green-700 dark:text-green-300">{valReceive.toFixed(2)} EUR</div>
                </div>
            </div>
        </div>

        <div className="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-900 border-t dark:border-gray-800 flex justify-between items-center px-6 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            
            <div className="flex-1"></div>

            <div className="flex-1 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-widest">Balance</span>
                <div className={`text-2xl font-black ${valGive - valReceive >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {valGive - valReceive > 0 ? '+' : ''}{(valGive - valReceive).toFixed(2)} EUR
                </div>
            </div>

            <div className="flex-1 flex justify-end">
                <button 
                    onClick={handleValidate}
                    // D√©sactiv√© pendant le chargement (isPending) ou si vide
                    disabled={isPending || (toGive.length === 0 && toReceive.length === 0)}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 transition shadow-lg transform active:scale-95"
                >
                    {isPending ? 'Validation...' : 'Valider l\'√©change'}
                </button>
            </div>
        </div>

        <CardVersionPickerModal 
            isOpen={!!cardToPick}
            baseCard={cardToPick}
            onClose={() => setCardToPick(null)}
            onConfirm={handleConfirmReceive}
        />

    </div>
  );
}
</file>

<file path="app/trades/page.tsx">
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useTradeMatcher, TradeProposal } from '@/hooks/useTradeMatcher';
import { useTradeSystem, TradeRequest } from '@/hooks/useTradeSystem';
import Link from 'next/link';
import { useCardCollection, CardType } from '@/hooks/useCardCollection'; 
import MagicCard from '@/components/MagicCard'; 

const IncomingRequestCard = ({ trade }: { trade: TradeRequest }) => {
    // ... (Code existant inchang√©)
    const { acceptTrade, rejectTrade, isProcessing } = useTradeSystem();
    const [isOpen, setIsOpen] = useState(false);

    const valReceive = trade.itemsGiven.reduce((acc: number, c: CardType) => acc + (c.price || 0), 0); 
    const valGive = trade.itemsReceived.reduce((acc: number, c: CardType) => acc + (c.price || 0), 0);

    return (
        <div className="bg-white dark:bg-gray-800 rounded-xl border-l-4 border-blue-500 shadow-sm p-4 mb-4">
            <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                <div>
                    <h3 className="font-bold text-gray-900 dark:text-white">Proposition de {trade.senderName}</h3>
                    <p className="text-sm text-gray-500">
                        Tu recois <span className="text-green-600 font-bold">{trade.itemsGiven.length} cartes</span> (~{valReceive.toFixed(0)}EUR) 
                        contre <span className="text-red-600 font-bold">{trade.itemsReceived.length} cartes</span> (~{valGive.toFixed(0)}EUR)
                    </p>
                </div>
                <div className="flex gap-2 self-end sm:self-auto">
                    <button onClick={() => setIsOpen(!isOpen)} className="text-sm text-gray-500 underline mr-2">
                        {isOpen ? 'Masquer' : 'Details'}
                    </button>
                    <button 
                        onClick={() => rejectTrade(trade.id)}
                        disabled={isProcessing}
                        className="px-3 py-1.5 bg-gray-200 hover:bg-red-100 text-red-700 rounded-lg text-sm font-medium transition"
                    >
                        Refuser
                    </button>
                    <button 
                        onClick={() => acceptTrade(trade)}
                        disabled={isProcessing}
                        className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition shadow-sm"
                    >
                        {isProcessing ? '...' : 'Accepter'}
                    </button>
                </div>
            </div>

            {isOpen && (
                <div className="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 grid md:grid-cols-2 gap-4">
                    <div className="bg-green-50/50 p-3 rounded">
                        <p className="text-xs font-bold text-green-700 mb-2">Tu vas recevoir :</p>
                        <div className="flex flex-wrap gap-2">
                            {trade.itemsGiven.map((c: CardType) => (
                                <div key={c.id} className="relative group w-12 h-16 bg-gray-200 rounded overflow-hidden">
                                     <img src={c.imageUrl} className="w-full h-full object-cover" alt="" title={c.name} />
                                     <div className="absolute bottom-0 right-0 bg-black/50 text-white text-[8px] px-1">{c.quantity}x</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="bg-red-50/50 p-3 rounded">
                        <p className="text-xs font-bold text-red-700 mb-2">Tu vas donner :</p>
                         <div className="flex flex-wrap gap-2">
                            {trade.itemsReceived.map((c: CardType) => (
                                <div key={c.id} className="relative group w-12 h-16 bg-gray-200 rounded overflow-hidden">
                                     <img src={c.imageUrl} className="w-full h-full object-cover" alt="" title={c.name} />
                                     <div className="absolute bottom-0 right-0 bg-black/50 text-white text-[8px] px-1">{c.quantity}x</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

const TradeRowProposal = ({ proposal, onProposalSent }: { proposal: TradeProposal, onProposalSent: () => void }) => {
    // ... (Code existant inchang√©)
    const { setCustomPrice } = useCardCollection('collection');
    const { proposeTrade } = useTradeSystem(); 

    const totalGive = proposal.toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0), 0);
    const totalReceive = proposal.toReceive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0), 0);
    const delta = totalGive - totalReceive;

    const handlePropose = async () => {
        const success = await proposeTrade(
            proposal.friend.uid,
            proposal.friend.displayName,
            proposal.toGive,
            proposal.toReceive 
        );
        if (success) onProposalSent();
    };

    return (
        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden mb-8 shrink-0">
            <div className="bg-gray-50 dark:bg-gray-900/50 p-4 border-b border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-linear-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold overflow-hidden">
                        {proposal.friend.photoURL ? <img src={proposal.friend.photoURL} alt="" className="w-full h-full object-cover"/> : proposal.friend.username[0].toUpperCase()}
                    </div>
                    <div>
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Potentiel avec {proposal.friend.displayName}</h2>
                        <Link href={`/user/${proposal.friend.uid}`} className="text-sm text-blue-600 hover:underline">Voir profil</Link>
                    </div>
                </div>
                <button
                    onClick={handlePropose}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm transition text-sm flex items-center gap-2 w-full sm:w-auto justify-center"
                >
                    Proposer l&apos;echange
                </button>
            </div>

            <div className="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x border-gray-100 dark:border-gray-700">
                <div className="p-4 bg-red-50/30 dark:bg-red-900/10">
                    <h3 className="font-bold text-red-600 dark:text-red-400 mb-4 flex justify-between">
                        Tu donnerais ({proposal.toGive.length})
                        <span className="text-sm bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm">{totalGive.toFixed(2)} EUR</span>
                    </h3>
                    <div className="space-y-3">
                        {proposal.toGive.map(card => (
                            <MagicCard 
                                key={card.id} {...card} isTradeView={true} allowPriceEdit={true}
                                onEditPrice={(newPrice) => setCustomPrice(card.id, newPrice)}
                            />
                        ))}
                    </div>
                </div>

                <div className="p-4 bg-green-50/30 dark:bg-green-900/10">
                    <h3 className="font-bold text-green-600 dark:text-green-400 mb-4 flex justify-between">
                        Tu recevrais ({proposal.toReceive.length})
                        <span className="text-sm bg-white dark:bg-gray-800 px-2 py-1 rounded shadow-sm">{totalReceive.toFixed(2)} EUR</span>
                    </h3>
                    <div className="space-y-3">
                         {proposal.toReceive.map(card => (
                            <MagicCard key={card.id} {...card} isTradeView={true} allowPriceEdit={false} />
                        ))}
                    </div>
                </div>
            </div>
            
            <div className="p-2 text-center text-xs text-gray-400 border-t border-gray-100 dark:border-gray-700">
                Balance : {delta.toFixed(2)} EUR
            </div>
        </div>
    );
};

export default function TradesPage() {
  const { user } = useAuth();
  const { proposals, loading, status, runScan } = useTradeMatcher();
  const { incomingTrades, outgoingTrades, cancelTrade } = useTradeSystem(); 
  const [activeTab, setActiveTab] = useState<'scan' | 'requests'>('scan');

  if (!user) return <div className="p-10 text-center">Connectez-vous.</div>;

  return (
    <main className="container mx-auto p-4 max-w-5xl h-[calc(100vh-64px)] flex flex-col">
        
        <div className="flex-none flex flex-col md:flex-row justify-between items-end mb-4 gap-4 border-b border-gray-200 dark:border-gray-700 pb-4">
            <div>
                <h1 className="text-3xl font-bold text-purple-600 dark:text-purple-400">Centre d&apos;Echanges</h1>
            </div>
            <div className="flex gap-4">
                <button 
                    onClick={() => setActiveTab('scan')}
                    className={`pb-2 px-2 font-bold transition ${activeTab === 'scan' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500 hover:text-gray-700'}`}
                >
                    Scanner ({proposals.length})
                </button>
                <button 
                    onClick={() => setActiveTab('requests')}
                    className={`pb-2 px-2 font-bold transition relative ${activeTab === 'requests' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                >
                    Demandes 
                    {incomingTrades.length > 0 && <span className="ml-2 bg-red-500 text-white text-[10px] px-1.5 rounded-full align-top">{incomingTrades.length}</span>}
                </button>
            </div>
        </div>

        <div className="grow overflow-y-auto custom-scrollbar pb-10">
            
            {activeTab === 'scan' && (
                <div className="animate-in fade-in">
                    {/* EN-T√äTE SCANNER MOBILE FRIENDLY */}
                    <div className="flex flex-col sm:flex-row justify-end mb-6 gap-3 sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm z-10 py-2">
                         <Link href="/trades/manual" className="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-bold transition text-sm flex items-center justify-center">
                            Mode Manuel
                        </Link>
                        <button onClick={runScan} disabled={loading} className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold shadow transition text-sm disabled:opacity-50 w-full sm:w-auto">
                            {loading ? status : "Lancer le Scanner"}
                        </button>
                    </div>

                    {proposals.length === 0 && !loading && (
                        <div className="text-center py-20 text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-xl">
                            Lancez le scanner pour trouver des &quot;matchs&quot; avec vos amis.
                        </div>
                    )}

                    <div className="space-y-8">
                        {proposals.map(proposal => (
                            <TradeRowProposal key={proposal.friend.uid} proposal={proposal} onProposalSent={runScan} />
                        ))}
                    </div>
                </div>
            )}

            {/* ... (Reste inchang√©) ... */}
            {activeTab === 'requests' && (
                <div className="animate-in fade-in space-y-8">
                    <div>
                        <h2 className="font-bold text-gray-500 uppercase text-xs mb-4 sticky top-0 bg-white dark:bg-gray-900 py-2 z-10">A traiter ({incomingTrades.length})</h2>
                        {incomingTrades.length === 0 && <p className="text-gray-400 italic text-sm">Aucune demande en attente.</p>}
                        {incomingTrades.map((trade: TradeRequest) => (
                            <IncomingRequestCard key={trade.id} trade={trade} />
                        ))}
                    </div>
                    <div>
                        <h2 className="font-bold text-gray-500 uppercase text-xs mb-4 pt-4 border-t dark:border-gray-700">En attente de reponse ({outgoingTrades.length})</h2>
                        {outgoingTrades.length === 0 && <p className="text-gray-400 italic text-sm">Aucune proposition en cours.</p>}
                        {outgoingTrades.map((trade: TradeRequest) => (
                             <div key={trade.id} className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-700 mb-2">
                                <span className="text-sm text-gray-600 dark:text-gray-300">
                                    Envoyee a <span className="font-bold">{trade.receiverName}</span>
                                </span>
                                <button onClick={() => cancelTrade(trade.id)} className="text-xs text-red-500 hover:underline">Annuler</button>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>

    </main>
  );
}
</file>

<file path="components/CardVersionPickerModal.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { CardType } from '@/hooks/useCardCollection';
import { normalizeCardData, ScryfallRawData } from '@/lib/cardUtils'; 
import { WishlistMeta } from '@/hooks/useWishlists'; 
import toast from 'react-hot-toast';

type Props = {
  isOpen: boolean;
  onClose: () => void;
  baseCard: ScryfallRawData | null; 
  onConfirm: (card: CardType, targetListId?: string) => void;
  destination?: 'collection' | 'wishlist'; 
  availableLists?: WishlistMeta[];
};

export default function CardVersionPickerModal({ 
  isOpen, onClose, baseCard, onConfirm, destination, availableLists 
}: Props) {
  const [versions, setVersions] = useState<ScryfallRawData[]>([]);
  const [loading, setLoading] = useState(false);
  
  const [selectedVersionId, setSelectedVersionId] = useState<string>('');
  const [isFoil, setIsFoil] = useState(false);
  const [quantity, setQuantity] = useState(1);
  const [isFlipped, setIsFlipped] = useState(false); 
  const [anyVersion, setAnyVersion] = useState(false);
  
  const [selectedListId, setSelectedListId] = useState<string>('default');

  useEffect(() => {
    const fetchVersions = async (oracleId: string) => {
        setLoading(true);
        try {
          const res = await fetch(`https://api.scryfall.com/cards/search?q=oracle_id:${oracleId}&unique=prints&order=released`);
          const data = await res.json();
          
          if (data.data && data.data.length > 0) {
            setVersions(data.data); 
            const defaultVer = data.data.find((c: ScryfallRawData) => c.id === baseCard?.id) || data.data[0];
            setSelectedVersionId(defaultVer.id);
          }
        } catch (e) {
          console.error(e);
          toast.error("Impossible de charger les versions");
        } finally {
          setLoading(false);
        }
    };

    if (isOpen && baseCard?.oracle_id) {
      fetchVersions(baseCard.oracle_id as string);
    }

    setQuantity(1);
    setIsFoil(false);
    setIsFlipped(false);
    setAnyVersion(false);
    setSelectedListId('default'); 
  }, [isOpen, baseCard]); 

  const currentCardRaw = useMemo(() => {
    return versions.find(v => v.id === selectedVersionId) || baseCard;
  }, [versions, selectedVersionId, baseCard]);

  if (!isOpen || !currentCardRaw) return null;

  const { imageUrl, imageBackUrl, name, setName, setCode, price } = normalizeCardData(currentCardRaw);
  
  const priceNormal = parseFloat(currentCardRaw.prices?.eur || "0");
  const priceFoil = parseFloat(currentCardRaw.prices?.eur_foil || "0");
  const currentPrice = isFoil ? (priceFoil || priceNormal) : (priceNormal || priceFoil);
  
  const hasFoilVersion = currentCardRaw.finishes?.includes('foil') || !!currentCardRaw.prices?.eur_foil;
  const hasNonFoilVersion = currentCardRaw.finishes?.includes('nonfoil') || !!currentCardRaw.prices?.eur;

  const handleConfirm = () => {
    const finalCard: CardType = {
        id: currentCardRaw.id,
        name: name,
        imageUrl: imageUrl,
        imageBackUrl: imageBackUrl || null,
        quantity: quantity,
        price: currentPrice,
        setName: setName,
        setCode: setCode,
        isFoil: isFoil,
        isSpecificVersion: !anyVersion,
        scryfallData: currentCardRaw,
        wishlistId: destination === 'wishlist' ? selectedListId : undefined 
    };
    
    onConfirm(finalCard, selectedListId);
    onClose();
  };

  const handleAnyVersionChange = (checked: boolean) => {
      setAnyVersion(checked);
      
      if (checked && versions.length > 0) {
          const sorted = [...versions].sort((a, b) => 
              (b.released_at || '').localeCompare(a.released_at || '')
          );
          
          const newest = sorted[0];
          if (newest) {
              setSelectedVersionId(newest.id);
              setIsFoil(false);
              setIsFlipped(false);
          }
      }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-gray-900 w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
        
        <div className="p-4 flex justify-between items-center border-b border-gray-800">
            <h3 className="text-white font-bold truncate pr-4">{name}</h3>
            <button onClick={onClose} className="text-gray-400 hover:text-white px-2 text-xl">X</button>
        </div>

        <div className="overflow-y-auto p-6 flex flex-col items-center space-y-6 custom-scrollbar">
            
            <div className="relative w-64 aspect-[2.5/3.5] rounded-xl overflow-hidden shadow-lg ring-1 ring-white/10 group cursor-pointer" onClick={() => imageBackUrl && setIsFlipped(!isFlipped)}>
                {loading ? (
                    <div className="w-full h-full bg-gray-800 animate-pulse flex items-center justify-center text-gray-500">Chargement...</div>
                ) : (
                    <img src={isFlipped && imageBackUrl ? imageBackUrl : imageUrl} alt="" className={`w-full h-full object-cover transition-transform duration-300 ${anyVersion ? 'opacity-80 grayscale-[50%]' : ''}`} />
                )}
                {anyVersion && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-[2px]">
                        <span className="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-sm shadow-lg border border-white/20">Generique</span>
                    </div>
                )}
                {isFoil && !anyVersion && <div className="absolute inset-0 bg-gradient-to-tr from-purple-500/30 to-transparent mix-blend-overlay pointer-events-none" />}
            </div>

            {destination === 'wishlist' && availableLists && availableLists.length > 0 && (
                <div className="w-full space-y-1 bg-purple-900/20 p-3 rounded-xl border border-purple-500/30">
                    <label className="text-xs text-purple-300 font-bold uppercase tracking-wider">Ajouter a la liste :</label>
                    <select 
                        value={selectedListId}
                        onChange={(e) => setSelectedListId(e.target.value)}
                        className="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                    >
                        {availableLists.map(list => (
                            <option key={list.id} value={list.id}>{list.name}</option>
                        ))}
                    </select>
                </div>
            )}

            <div className={`w-full space-y-2 transition-opacity ${anyVersion ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                <label className="text-xs text-gray-400 uppercase font-bold tracking-wider">Edition / Set</label>
                <div className="relative">
                    <select 
                        className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl p-3 appearance-none focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                        value={selectedVersionId}
                        onChange={(e) => { setSelectedVersionId(e.target.value); setIsFoil(false); setIsFlipped(false); }}
                    >
                        {versions.map((v) => (
                            <option key={v.id} value={v.id}>{v.set_name} ({v.set.toUpperCase()}) #{v.collector_number}</option>
                        ))}
                    </select>
                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">V</div>
                </div>
            </div>

            <div className="w-full space-y-4">
                <label className="flex items-center justify-between bg-blue-900/20 p-3 rounded-xl border border-blue-900/50 cursor-pointer hover:bg-blue-900/30 transition">
                    <div className="flex flex-col">
                        <span className="text-sm font-bold text-blue-100">Peu importe l&apos;edition</span>
                        <span className="text-[10px] text-blue-300">Selectionnera la version la plus recente</span>
                    </div>
                    <div className="relative inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            className="sr-only peer" 
                            checked={anyVersion} 
                            onChange={(e) => handleAnyVersionChange(e.target.checked)} 
                        />
                        <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </div>
                </label>

                <div className="flex gap-4">
                    <div className={`flex-1 bg-gray-800 rounded-xl p-2 flex flex-col items-center justify-center gap-1 border border-gray-700 transition-opacity ${anyVersion ? 'opacity-30 pointer-events-none' : ''}`}>
                        <span className="text-[10px] text-gray-400 font-bold uppercase">Finition</span>
                        <div className="flex bg-gray-900 rounded-lg p-1 w-full">
                            <button onClick={() => setIsFoil(false)} disabled={!hasNonFoilVersion} className={`flex-1 text-[10px] py-1 rounded transition ${!isFoil ? 'bg-gray-700 text-white font-bold' : 'text-gray-500'} ${!hasNonFoilVersion && 'opacity-30'}`}>Normal</button>
                            <button onClick={() => setIsFoil(true)} disabled={!hasFoilVersion} className={`flex-1 text-[10px] py-1 rounded transition ${isFoil ? 'bg-purple-600 text-white font-bold' : 'text-gray-500'} ${!hasFoilVersion && 'opacity-30'}`}>Foil</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-gray-800 rounded-xl p-2 flex flex-col items-center justify-center gap-1 border border-gray-700">
                         <span className="text-[10px] text-gray-400 font-bold uppercase">Quantite</span>
                         <div className="flex items-center gap-3">
                            <button onClick={() => setQuantity(Math.max(1, quantity - 1))} className="w-6 h-6 rounded-full bg-gray-700 text-white font-bold">-</button>
                            <span className="text-lg font-bold text-white w-4 text-center">{quantity}</span>
                            <button onClick={() => setQuantity(quantity + 1)} className="w-6 h-6 rounded-full bg-blue-600 text-white font-bold">+</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div className="p-4 bg-gray-800 border-t border-gray-700">
            <button 
                onClick={handleConfirm}
                className={`w-full font-bold py-4 rounded-xl text-lg transition shadow-lg transform active:scale-95 flex justify-center items-center gap-2 ${anyVersion ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-amber-500 hover:bg-amber-400 text-black'}`}
            >
                <span>{anyVersion ? 'Ajouter (Generique)' : 'Ajouter (Exact)'}</span>
                {quantity > 1 && <span className="bg-black/20 px-2 py-0.5 rounded text-sm">{quantity}</span>}
            </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/Header.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useAuth } from '@/lib/AuthContext';
import { usePathname } from 'next/navigation';
import ThemeToggle from './ThemeToggle';

export default function Header() {
  const { user, logOut, friendRequestCount } = useAuth();
  const pathname = usePathname();
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  // Le lien actif devient #6275b3 (Bleu Ardoise)
  const linkClass = (path: string) => `
    text-sm font-medium transition-colors block py-2 md:py-0
    ${pathname === path 
      ? 'text-[#6275b3] font-bold' 
      : 'text-zinc-600 dark:text-zinc-400 hover:text-[#6275b3] dark:hover:text-[#8ea0db]'}
  `;

  return (
    <header className="bg-white/90 dark:bg-zinc-950/90 backdrop-blur-sm border-b border-zinc-200 dark:border-zinc-800 p-4 sticky top-0 z-40">
      <div className="container mx-auto">
        <div className="flex justify-between items-center">
          {/* LOGO avec ta couleur */}
          <Link 
            href="/" 
            className="text-2xl font-black tracking-tight text-[#6275b3] hover:opacity-80 transition"
            onClick={() => setIsMenuOpen(false)}
          >
            MagicWish
          </Link>

          <div className="flex items-center gap-4">
            <ThemeToggle />

            {user ? (
              <>
                <nav className="hidden md:flex gap-6 mr-4 items-center">
                  <Link href="/search" className={linkClass('/search')}>Recherche</Link> 
                  <Link href="/wishlist" className={linkClass('/wishlist')}>Wishlist</Link>
                  <Link href="/collection" className={linkClass('/collection')}>Collection</Link>
                  <Link href="/trades" className={linkClass('/trades')}>Echanges</Link>
                  <Link href="/contacts" className={`${linkClass('/contacts')} relative flex items-center gap-1`}>
                    Contacts
                    {friendRequestCount > 0 && (
                      <span className="absolute -top-1.5 -right-2 bg-[#6275b3] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse">
                        {friendRequestCount}
                      </span>
                    )}
                  </Link>
                </nav>

                <div className="h-5 w-px bg-zinc-200 dark:bg-zinc-700 hidden md:block"></div>

                <div className="flex items-center gap-3">
                  {user.photoURL && (
                    <img 
                      src={user.photoURL} 
                      alt="Avatar" 
                      className="w-8 h-8 rounded-full bg-zinc-100 border border-zinc-200 dark:border-zinc-700 object-cover"
                    />
                  )}
                  <button
                    onClick={logOut}
                    className="hidden md:block text-xs font-medium text-zinc-500 hover:text-[#6275b3] transition"
                  >
                    D√©connexion
                  </button>

                  <button 
                    onClick={() => setIsMenuOpen(!isMenuOpen)}
                    className="md:hidden p-2 text-zinc-600 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-lg"
                  >
                    Menu
                  </button>
                </div>
              </>
            ) : (
              <Link
                href="/login"
                className="bg-[#6275b3] text-white px-5 py-2 rounded-lg text-sm font-bold hover:bg-[#53639c] transition shadow-md"
              >
                Se connecter
              </Link>
            )}
          </div>
        </div>
        
        {/* MOBILE MENU */}
        {user && isMenuOpen && (
          <div className="md:hidden mt-4 pt-4 border-t border-zinc-100 dark:border-zinc-800 animate-in slide-in-from-top-2">
             <nav className="flex flex-col space-y-3">
               <Link href="/search" className={linkClass('/search')} onClick={() => setIsMenuOpen(false)}>Recherche</Link>
               <Link href="/wishlist" className={linkClass('/wishlist')} onClick={() => setIsMenuOpen(false)}>Wishlist</Link>
               <Link href="/collection" className={linkClass('/collection')} onClick={() => setIsMenuOpen(false)}>Collection</Link>
               <Link href="/trades" className={linkClass('/trades')} onClick={() => setIsMenuOpen(false)}>Echanges</Link>
               <Link href="/contacts" className={linkClass('/contacts')} onClick={() => setIsMenuOpen(false)}>Contacts</Link>
               <button onClick={() => { logOut(); setIsMenuOpen(false); }} className="text-left py-2 text-red-500 text-sm font-medium">D√©connexion</button>
             </nav>
          </div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="hooks/useCardCollection.ts">
// hooks/useCardCollection.ts
import { useState, useEffect, useMemo } from 'react';
import { db } from '@/lib/firebase';
import { collection, onSnapshot, doc, updateDoc, deleteDoc, increment, writeBatch } from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import toast from 'react-hot-toast';

// Definition d'un type partiel pour Scryfall
type ScryfallDataRaw = {
    id: string;
    prices?: { eur?: string; usd?: string };
    [key: string]: unknown; 
};

export type CardType = {
  id: string;
  name: string;
  imageUrl: string;
  imageBackUrl?: string | null;
  quantity: number;
  price?: number; 
  customPrice?: number;
  setName?: string;
  setCode?: string;
  wishlistId?: string;
  
  isFoil?: boolean;             
  isSpecificVersion?: boolean;
  isForTrade?: boolean; 
  
  scryfallData?: Record<string, unknown>;
};

export function useCardCollection(
    target: 'collection' | 'wishlist', 
    listId: string = 'default',
    targetUid?: string
) {
  const { user, loading: authLoading } = useAuth();
  const [cards, setCards] = useState<CardType[]>([]);
  const [loading, setLoading] = useState(true);

  const effectiveUid = targetUid || user?.uid;
  const isOwner = user?.uid === effectiveUid; 

  useEffect(() => {
    if (!effectiveUid || authLoading) {
        if (!authLoading && !effectiveUid) setLoading(false);
        return;
    }
    setLoading(true);

    let collectionPath = '';
    if (target === 'collection') {
        collectionPath = `users/${effectiveUid}/collection`;
    } else {
        if (listId === 'default') collectionPath = `users/${effectiveUid}/wishlist`;
        else collectionPath = `users/${effectiveUid}/wishlists_data/${listId}/cards`;
    }

    const colRef = collection(db, collectionPath);
    const unsubscribe = onSnapshot(colRef, (snapshot) => {
      const items = snapshot.docs.map((doc) => ({
        id: doc.id,
        wishlistId: listId,
        ...doc.data(),
      })) as CardType[];
      setCards(items);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [effectiveUid, target, listId, authLoading]);

  // --- ACTIONS ---

  const getDocRef = (cardId: string) => {
      if (!isOwner || !effectiveUid) return null;
      let path = '';
      if (target === 'collection') path = `users/${effectiveUid}/collection`;
      else if (listId === 'default') path = `users/${effectiveUid}/wishlist`;
      else path = `users/${effectiveUid}/wishlists_data/${listId}/cards`;
      return doc(db, path, cardId);
  };

  const setCustomPrice = async (cardId: string, price: number) => {
      if (!isOwner) return;
      const ref = getDocRef(cardId);
      if (ref) {
          await updateDoc(ref, { customPrice: price });
          toast.success("Prix mis √† jour");
      }
  };

  const toggleAttribute = async (
      cardId: string, 
      field: 'isFoil' | 'isSpecificVersion' | 'isForTrade', 
      currentValue: boolean
  ) => {
      if (!isOwner) return;
      const ref = getDocRef(cardId);
      if (ref) {
          await updateDoc(ref, { [field]: !currentValue });
      }
  };

  const updateQuantity = async (cardId: string, amount: number, currentQuantity: number) => {
    if (!isOwner) return;
    const ref = getDocRef(cardId);
    if (!ref) return;
    if (currentQuantity + amount <= 0) return 'shouldDelete';
    try {
      await updateDoc(ref, { quantity: increment(amount) });
      return 'updated';
    } catch (err) { return 'error'; }
  };

  const removeCard = async (cardId: string) => {
    if (!isOwner) return;
    const ref = getDocRef(cardId);
    if(ref) { await deleteDoc(ref); toast.success('Carte retir√©e', { icon: 'üóëÔ∏è' }); }
  };

  // --- MISE √Ä JOUR GLOBALE DES PRIX ---
  const refreshCollectionPrices = async () => {
      if (!isOwner || cards.length === 0) return;
      const toastId = toast.loading(`Mise √† jour de ${cards.length} cartes...`);

      try {
          const chunks = [];
          for (let i = 0; i < cards.length; i += 75) {
              chunks.push(cards.slice(i, i + 75));
          }

          for (const chunk of chunks) {
              const identifiers = chunk.map(c => ({ id: c.id }));

              const res = await fetch('https://api.scryfall.com/cards/collection', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ identifiers })
              });

              if (!res.ok) continue;

              const data = await res.json();
              const foundCards = (data.data as ScryfallDataRaw[]) || [];
              
              const batch = writeBatch(db);
              let batchHasOps = false;

              foundCards.forEach(scryCard => {
                  const localCard = chunk.find(c => c.id === scryCard.id);
                  const newPrice = parseFloat(scryCard.prices?.eur || "0");

                  if (localCard) {
                      const ref = getDocRef(localCard.id);
                      if (ref) {
                          batch.update(ref, { 
                              price: newPrice,
                              scryfallData: scryCard as Record<string, unknown>
                          });
                          batchHasOps = true;
                      }
                  }
              });

              if (batchHasOps) await batch.commit();
              await new Promise(r => setTimeout(r, 100));
          }

          toast.success("Collection mise √† jour avec succ√®s !", { id: toastId });

      } catch (e) {
          console.error(e);
          toast.error("Erreur lors de la mise √† jour", { id: toastId });
      }
  };

  // --- GESTION DE MASSE DU CLASSEUR D'√âCHANGE ---
  const bulkSetTradeStatus = async (
      action: 'excess' | 'all' | 'reset', 
      threshold: number = 4
  ) => {
      if (!isOwner || cards.length === 0) return;
      
      const batch = writeBatch(db);
      let opCount = 0;
      let label = "";

      cards.forEach(card => {
          let shouldUpdate = false;
          let newValue = false;

          if (action === 'reset') {
              if (card.isForTrade) {
                  shouldUpdate = true;
                  newValue = false;
              }
              label = "Remise √† z√©ro";
          } 
          else if (action === 'all') {
              if (!card.isForTrade) {
                  shouldUpdate = true;
                  newValue = true;
              }
              label = "Tout ajouter";
          } 
          else if (action === 'excess') {
              if (card.quantity > threshold && !card.isForTrade) {
                  shouldUpdate = true;
                  newValue = true;
              }
          }

          if (shouldUpdate) {
              const ref = getDocRef(card.id);
              if (ref) {
                  batch.update(ref, { isForTrade: newValue });
                  opCount++;
              }
          }
      });

      if (opCount > 0) {
          await batch.commit();
          toast.success(`${opCount} cartes mises √† jour (${action === 'excess' ? `Quantit√© > ${threshold}` : label})`);
      } else {
          toast(`Aucune carte ne correspond aux crit√®res.`);
      }
  };

  // --- NOUVEAU : ACTIONS DE S√âLECTION MULTIPLE ---

  const bulkRemoveCards = async (cardIds: string[]) => {
      if (!isOwner || cardIds.length === 0) return;
      
      const batch = writeBatch(db);
      cardIds.forEach(id => {
          const ref = getDocRef(id);
          if (ref) batch.delete(ref);
      });

      await batch.commit();
      toast.success(`${cardIds.length} cartes supprim√©es`);
  };

  const bulkUpdateAttribute = async (cardIds: string[], field: 'isForTrade' | 'isFoil', value: boolean) => {
      if (!isOwner || cardIds.length === 0) return;

      const batch = writeBatch(db);
      cardIds.forEach(id => {
          const ref = getDocRef(id);
          if (ref) batch.update(ref, { [field]: value });
      });

      await batch.commit();
      toast.success("Mise √† jour effectu√©e");
  };

  const totalPrice = useMemo(() => {
    return cards.reduce((acc, card) => {
        const effectivePrice = card.customPrice !== undefined ? card.customPrice : (card.price || 0);
        return acc + effectivePrice * card.quantity;
    }, 0);
  }, [cards]);

  return { 
      cards, loading, isOwner, totalPrice,
      updateQuantity, removeCard, setCustomPrice, toggleAttribute,
      refreshCollectionPrices, bulkSetTradeStatus,
      bulkRemoveCards, bulkUpdateAttribute 
  };
}
</file>

<file path="app/wishlist/page.tsx">
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useWishlists } from '@/hooks/useWishlists';
import SingleWishlistView from '@/components/wishlist/SingleWishlistView';
import GlobalWishlistView from '@/components/wishlist/GlobalWishlistView';

export default function WishlistPage() {
  const { user } = useAuth();
  const { lists, createList, deleteList, loading: metaLoading } = useWishlists();
  
  const [selectedListId, setSelectedListId] = useState<string>('default');
  const [newListName, setNewListName] = useState('');

  if (!user) return <p className="p-10 text-center">Veuillez vous connecter.</p>;

  const handleCreate = (e: React.FormEvent) => {
    e.preventDefault();
    if(newListName.trim()) {
        createList(newListName);
        setNewListName('');
    }
  };

  return (
    <main className="container mx-auto p-4 flex flex-col md:flex-row gap-8 min-h-[85vh]">
      
      {/* SIDEBAR */}
      <aside className="w-full md:w-72 flex-none space-y-6">
        <div className="bg-white dark:bg-zinc-900 p-5 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-800 sticky top-24">
            <h3 className="font-bold mb-4 text-zinc-900 dark:text-white flex items-center gap-2 border-b border-zinc-100 dark:border-zinc-800 pb-2">
                üìë Mes Listes
            </h3>
            
            {metaLoading ? (
                <p className="text-sm text-zinc-400">Chargement...</p>
            ) : (
                <div className="flex flex-col gap-1 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                    
                    {/* BOUTON VUE GLOBALE */}
                    <button
                        onClick={() => setSelectedListId('GLOBAL_VIEW')}
                        className={`text-left px-3 py-2.5 rounded-lg text-sm transition-all duration-200 flex items-center gap-2 mb-2 ${
                            selectedListId === 'GLOBAL_VIEW'
                            ? 'bg-purple-600 text-white shadow-md font-medium' 
                            : 'bg-purple-50 text-purple-700 hover:bg-purple-100 dark:bg-purple-900/20 dark:text-purple-300'
                        }`}
                    >
                        <span>üåç</span> Tout voir (Fusionn√©)
                    </button>

                    <div className="border-t border-zinc-100 dark:border-zinc-800 my-2"></div>

                    {lists.map(list => (
                        <div key={list.id} className="group flex items-center relative">
                            <button
                                onClick={() => setSelectedListId(list.id)}
                                className={`grow text-left px-3 py-2.5 rounded-lg text-sm transition-all duration-200 ${
                                    selectedListId === list.id 
                                    ? 'bg-[#6275b3] text-white shadow-md font-medium' // <--- ICI LE BLEU CUSTOM
                                    : 'hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-300'
                                }`}
                            >
                                {list.name}
                            </button>
                            
                            {list.id !== 'default' && (
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        deleteList(list.id);
                                        if (selectedListId === list.id) setSelectedListId('default');
                                    }}
                                    className={`absolute right-2 p-1.5 rounded-md transition-opacity ${
                                        selectedListId === list.id 
                                        ? 'text-white/70 hover:text-white' 
                                        : 'opacity-0 group-hover:opacity-100 text-zinc-400 hover:text-red-600'
                                    }`}
                                    title="Supprimer"
                                >
                                    ‚úï
                                </button>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* Formulaire Cr√©ation */}
            <form onSubmit={handleCreate} className="mt-6 pt-4 border-t border-zinc-100 dark:border-zinc-800">
                <div className="flex gap-2">
                    <input 
                        type="text" 
                        placeholder="Nom nouvelle liste..." 
                        className="w-full text-sm p-2 border rounded-lg bg-zinc-50 dark:bg-zinc-950 dark:border-zinc-700 focus:ring-2 focus:ring-[#6275b3] outline-none"
                        value={newListName}
                        onChange={e => setNewListName(e.target.value)}
                    />
                    <button 
                        type="submit"
                        className="bg-[#6275b3] hover:bg-[#53639c] text-white px-3 rounded-lg font-bold text-lg leading-none pb-1"
                    >
                        +
                    </button>
                </div>
            </form>
        </div>
      </aside>

      <section className="grow min-w-0">
          {selectedListId === 'GLOBAL_VIEW' ? (
              <GlobalWishlistView lists={lists} />
          ) : (
              <SingleWishlistView 
                key={selectedListId} 
                listId={selectedListId} 
                listName={lists.find(l => l.id === selectedListId)?.name || 'Liste'} 
              />
          )}
      </section>

    </main>
  );
}
</file>

<file path="app/page.tsx">
'use client';

import { useAuth } from '@/lib/AuthContext';
import { useCardCollection } from '@/hooks/useCardCollection';
import { useTradeSystem } from '@/hooks/useTradeSystem';
import Link from 'next/link';
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { collection, query, orderBy, limit, getDocs } from 'firebase/firestore';
import { CardType } from '@/hooks/useCardCollection';

export default function DashboardPage() {
  const { user, loading: authLoading, friendRequestCount, username } = useAuth();
  const { totalPrice, cards } = useCardCollection('collection'); 
  const { incomingTrades, outgoingTrades } = useTradeSystem(); 
  
  const [recentCards, setRecentCards] = useState<CardType[]>([]);

  useEffect(() => {
    const fetchRecent = async () => {
      if (!user) return;
      try {
        const q = query(
            collection(db, 'users', user.uid, 'collection'), 
            orderBy('addedAt', 'desc'), 
            limit(5)
        );
        const snap = await getDocs(q);
        setRecentCards(snap.docs.map(d => ({ id: d.id, ...d.data() } as CardType)));
      } catch (e) { console.error(e); }
    };
    fetchRecent();
  }, [user]);

  if (authLoading) return <div className="flex h-screen items-center justify-center animate-pulse text-[#6275b3]">Chargement...</div>;

  if (!user) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[80vh] text-center p-4">
        <h1 className="text-5xl font-black text-[#6275b3] mb-6 tracking-tight">
          MagicWish
        </h1>
        <p className="text-xl text-zinc-600 dark:text-zinc-400 max-w-lg mb-8">
          G√©rez votre collection, vos wishlists et vos √©changes en toute simplicit√©.
        </p>
        <Link 
          href="/login"
          className="bg-[#6275b3] hover:bg-[#53639c] text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition transform hover:scale-105"
        >
          Commencer maintenant
        </Link>
      </div>
    );
  }

  return (
    <main className="container mx-auto p-4 max-w-5xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-zinc-900 dark:text-white">
          Bonjour, <span className="text-[#6275b3]">{username || user.displayName}</span>
        </h1>
        <p className="text-zinc-500">Tableau de bord</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        
        {/* CARTE ECHANGES */}
        <Link href="/trades" className={`p-6 rounded-2xl border transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-1 group
            ${incomingTrades.length > 0 
                ? 'bg-orange-50 border-orange-200 dark:bg-orange-900/10 dark:border-orange-800' 
                : 'bg-white border-zinc-200 dark:bg-zinc-900 dark:border-zinc-800 hover:border-[#6275b3] dark:hover:border-[#6275b3]'
            }`}>
            <div className="flex justify-between items-start mb-2">
                <span className={`font-bold text-lg group-hover:text-[#6275b3] transition-colors ${incomingTrades.length > 0 ? 'text-orange-700' : 'text-zinc-800 dark:text-zinc-100'}`}>
                    √âchanges
                </span>
                {incomingTrades.length > 0 && <span className="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">{incomingTrades.length}</span>}
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {incomingTrades.length > 0 ? "Propositions en attente !" : `${outgoingTrades.length} propositions en cours.`}
            </p>
        </Link>

        {/* CARTE CONTACTS */}
        <Link href="/contacts" className={`p-6 rounded-2xl border transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-1 group
            ${friendRequestCount > 0 
                ? 'bg-[#6275b3]/10 border-[#6275b3]/30' 
                : 'bg-white border-zinc-200 dark:bg-zinc-900 dark:border-zinc-800 hover:border-[#6275b3] dark:hover:border-[#6275b3]'
            }`}>
            <div className="flex justify-between items-start mb-2">
                <span className={`font-bold text-lg group-hover:text-[#6275b3] transition-colors ${friendRequestCount > 0 ? 'text-[#6275b3]' : 'text-zinc-800 dark:text-zinc-100'}`}>
                    Contacts
                </span>
                {friendRequestCount > 0 && <span className="bg-[#6275b3] text-white text-xs font-bold px-2 py-1 rounded-full">{friendRequestCount}</span>}
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {friendRequestCount > 0 ? "Nouvelles demandes d'amis." : "G√©rer ma liste d'amis."}
            </p>
        </Link>

        {/* CARTE TOTAL */}
        <Link href="/collection" className="p-6 rounded-2xl border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900 transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-1 hover:border-[#6275b3] dark:hover:border-[#6275b3] group">
            <div className="flex justify-between items-start mb-2">
                <span className="font-bold text-lg text-zinc-800 dark:text-zinc-100 group-hover:text-[#6275b3] transition-colors">Total</span>
                <span className="text-emerald-500 font-bold bg-emerald-500/10 px-2 py-1 rounded text-xs">{totalPrice.toFixed(2)} ‚Ç¨</span>
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {cards.length} cartes collectionn√©es.
            </p>
        </Link>
      </div>

      <div className="grid lg:grid-cols-3 gap-8">
          {/* LISTE R√âCENTS */}
          <div className="lg:col-span-2 space-y-4">
              <div className="flex justify-between items-center">
                  <h2 className="font-bold text-lg text-zinc-800 dark:text-white">Derniers ajouts</h2>
                  <Link href="/collection" className="text-sm text-[#6275b3] hover:underline font-medium">Tout voir</Link>
              </div>
              
              <div className="bg-white dark:bg-zinc-900 rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                  {recentCards.length === 0 ? (
                      <div className="p-8 text-center text-zinc-400">
                          Pas encore de cartes ? <Link href="/collection" className="text-[#6275b3] underline">Importez-en !</Link>
                      </div>
                  ) : (
                      recentCards.map((card) => (
                          <div key={card.id} className="flex items-center gap-4 p-3 border-b border-zinc-100 dark:border-zinc-800 last:border-0 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition">
                              <div className="w-10 h-14 bg-zinc-200 rounded overflow-hidden shrink-0">
                                  <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                              </div>
                              <div className="grow">
                                  <p className="font-semibold text-sm text-zinc-900 dark:text-zinc-100">{card.name}</p>
                                  <p className="text-xs text-zinc-500">{card.setName} {card.isFoil && <span className="text-amber-600 bg-amber-50 px-1 rounded text-[9px] font-bold">Foil</span>}</p>
                              </div>
                              <div className="text-right">
                                  <span className="font-medium text-zinc-700 dark:text-zinc-300 text-sm">{(card.customPrice ?? card.price ?? 0).toFixed(2)} ‚Ç¨</span>
                              </div>
                          </div>
                      ))
                  )}
              </div>
          </div>

          {/* ACTION RAPIDE (CORRECTION ICI : On utilise bien ton bleu #6275b3 en fond) */}
          <div className="space-y-6">
              <div className="bg-[#6275b3] rounded-xl p-6 text-white shadow-lg">
                  <h3 className="font-bold text-lg mb-2">Action Rapide</h3>
                  <p className="text-white/90 text-sm mb-6">Ajout rapide apr√®s ouverture de boosters ?</p>
                  
                  <Link href="/search" className="block w-full bg-white text-[#6275b3] font-bold text-center py-3 rounded-lg hover:bg-zinc-100 transition shadow-sm mb-3">
                      Ajouter des cartes
                  </Link>
                  <Link href="/trades/manual" className="block w-full bg-[#4a5a8a] hover:bg-[#3d4b6e] text-white font-bold text-center py-3 rounded-lg transition border border-white/20">
                      √âchange Manuel
                  </Link>
              </div>

              {/* ASTUCE (Bordure bleue pour le rappel) */}
              <div className="bg-white dark:bg-zinc-900 rounded-xl border-l-4 border-[#6275b3] shadow-sm p-6 border-y border-r border-zinc-200 dark:border-y-zinc-800 dark:border-r-zinc-800">
                  <h3 className="font-bold text-zinc-900 dark:text-white mb-2">Astuce</h3>
                  <p className="text-sm text-zinc-500 mb-4">
                      Remplissez votre Wishlist pour aider le scanner √† trouver des √©changes.
                  </p>
                  <Link href="/wishlist" className="text-sm font-bold text-[#6275b3] hover:underline">
                      G√©rer ma Wishlist
                  </Link>
              </div>
          </div>
      </div>
    </main>
  );
}
</file>

<file path="app/collection/page.tsx">
'use client';

import { useState, useMemo, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection } from '@/hooks/useCardCollection'; 
import MagicCard from '@/components/MagicCard';
import ImportModal from '@/components/ImportModal';
import ConfirmModal from '@/components/ConfirmModal';
import DeleteAllButton from '@/components/DeleteAllButton';
import CollectionToolsModal from '@/components/CollectionToolsModal';

type SortOption = 'name' | 'price_desc' | 'price_asc' | 'quantity' | 'date';

const ITEMS_PER_PAGE = 50; 

export default function CollectionPage() {
  const { user } = useAuth();
  
  const { 
    cards, loading, updateQuantity, removeCard, 
    setCustomPrice, toggleAttribute, refreshCollectionPrices, bulkSetTradeStatus,
    bulkRemoveCards, bulkUpdateAttribute, 
    totalPrice 
  } = useCardCollection('collection');

  const [isImportOpen, setIsImportOpen] = useState(false);
  const [isToolsOpen, setIsToolsOpen] = useState(false);
  const [cardToDelete, setCardToDelete] = useState<string | null>(null);

  const [isSelectMode, setIsSelectMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  
  const [visibleCount, setVisibleCount] = useState(ITEMS_PER_PAGE);
  const [showFilters, setShowFilters] = useState(false);

  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<SortOption>('date');
  const [filterSet, setFilterSet] = useState<string>('all');
  const [filterTrade, setFilterTrade] = useState(false);
  const [filterFoil, setFilterFoil] = useState(false);

  useEffect(() => {
    if (visibleCount !== ITEMS_PER_PAGE) {
      setVisibleCount(ITEMS_PER_PAGE);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchQuery, sortBy, filterSet, filterTrade, filterFoil]);

  const filteredAndSortedCards = useMemo(() => {
    let result = [...cards];

    if (searchQuery) {
        const lowerQ = searchQuery.toLowerCase();
        result = result.filter(c => c.name.toLowerCase().includes(lowerQ));
    }
    if (filterSet !== 'all') {
        result = result.filter(c => c.setName === filterSet);
    }
    if (filterTrade) {
        result = result.filter(c => c.isForTrade);
    }
    if (filterFoil) {
        result = result.filter(c => c.isFoil);
    }

    result.sort((a, b) => {
        const priceA = a.customPrice ?? a.price ?? 0;
        const priceB = b.customPrice ?? b.price ?? 0;
        switch (sortBy) {
            case 'name': return a.name.localeCompare(b.name);
            case 'price_desc': return priceB - priceA;
            case 'price_asc': return priceA - priceB;
            case 'quantity': return b.quantity - a.quantity;
            case 'date': default: return 0; 
        }
    });

    return result;
  }, [cards, searchQuery, sortBy, filterSet, filterTrade, filterFoil]);

  const visibleCards = useMemo(() => {
      return filteredAndSortedCards.slice(0, visibleCount);
  }, [filteredAndSortedCards, visibleCount]);

  const availableSets = useMemo(() => {
      const sets = new Set(cards.map(c => c.setName).filter((s): s is string => !!s));
      return Array.from(sets).sort();
  }, [cards]);

  const handleDecrement = async (cardId: string, currentQty: number) => {
    const result = await updateQuantity(cardId, -1, currentQty);
    if (result === 'shouldDelete') {
      setCardToDelete(cardId);
    }
  };

  const toggleSelection = (id: string) => {
      setSelectedIds(prev => 
          prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]
      );
  };

  const handleSelectAll = () => {
      if (selectedIds.length === filteredAndSortedCards.length) {
          setSelectedIds([]); 
      } else {
          setSelectedIds(filteredAndSortedCards.map(c => c.id)); 
      }
  };

  const handleBulkDelete = async () => {
      if (!confirm(`Supprimer ces ${selectedIds.length} cartes d√©finitivement ?`)) return;
      await bulkRemoveCards(selectedIds);
      setSelectedIds([]);
      setIsSelectMode(false);
  };

  const handleBulkTrade = async (isTrade: boolean) => {
      await bulkUpdateAttribute(selectedIds, 'isForTrade', isTrade);
      setSelectedIds([]);
      setIsSelectMode(false);
  };

  if (loading) return <div className="flex h-screen items-center justify-center text-zinc-500 animate-pulse">Chargement de votre collection...</div>;
  if (!user) return <p className="text-center p-10">Veuillez vous connecter.</p>;

  return (
    <main className="container mx-auto p-4 pb-24 relative">
      
      <div className="flex flex-col gap-4 mb-6">
        
        {/* TITRE + TOTAL (Avec fond bleu #6275b3 pour le badge) */}
        <div className="flex justify-between items-center">
            <h1 className="text-2xl md:text-3xl font-bold text-[#6275b3] truncate">
                Ma Collection 
                <span className="ml-2 text-base font-normal text-zinc-500">
                    ({filteredAndSortedCards.length})
                </span>
            </h1>
            <div className="shrink-0 bg-[#6275b3] text-white px-3 py-1.5 rounded-lg shadow-sm text-right">
                <span className="text-[10px] uppercase tracking-wide opacity-80 block">Total</span>
                <span className="font-bold whitespace-nowrap">{totalPrice.toFixed(2)} ‚Ç¨</span>
            </div>
        </div>
        
        <div className="flex items-center gap-2 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 no-scrollbar">
           <button 
             onClick={() => { setIsSelectMode(!isSelectMode); setSelectedIds([]); }}
             className={`shrink-0 px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm border flex items-center gap-2 whitespace-nowrap ${isSelectMode ? 'bg-[#6275b3] text-white border-[#6275b3]' : 'bg-white hover:bg-zinc-100 text-zinc-700 border-zinc-300 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-200'}`}
           >
             {isSelectMode ? 'Annuler' : 'S√©lectionner'}
           </button>

           {!isSelectMode && (
               <>
                <button 
                    onClick={() => setIsToolsOpen(true)}
                    className="shrink-0 bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-200 px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm border border-zinc-200 dark:border-zinc-600 flex items-center gap-2 whitespace-nowrap"
                >
                    G√©rer
                </button>

                <div className="shrink-0">
                    <DeleteAllButton targetCollection="collection" />
                </div>
                
                <button 
                    onClick={() => setIsImportOpen(true)} 
                    className="shrink-0 bg-[#6275b3] hover:bg-[#53639c] text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm whitespace-nowrap"
                >
                    Importer CSV
                </button>
               </>
           )}
        </div>
      </div>

      {/* FILTRES */}
      <div className="bg-white dark:bg-zinc-900 p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm mb-6">
          <div className="flex gap-2 items-center">
              <div className="grow">
                  <input 
                      type="text" 
                      placeholder="Rechercher une carte..." 
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-950 text-sm focus:ring-2 focus:ring-[#6275b3] outline-none"
                  />
              </div>
              <button 
                onClick={() => setShowFilters(!showFilters)}
                className="md:hidden shrink-0 px-3 py-2 bg-zinc-100 dark:bg-zinc-800 rounded-lg text-zinc-600 dark:text-zinc-300 border border-zinc-300 dark:border-zinc-600 text-sm font-medium"
              >
                {showFilters ? 'Masquer' : 'Filtres'}
              </button>
          </div>

          <div className={`mt-4 space-y-4 md:space-y-0 md:flex md:items-end md:gap-4 ${showFilters ? 'block' : 'hidden md:flex'}`}>
            <div className="min-w-[200px]">
                <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">Edition</label>
                <select value={filterSet} onChange={(e) => setFilterSet(e.target.value)} className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-900 text-sm cursor-pointer">
                    <option value="all">Toutes les √©ditions</option>
                    {availableSets.map(set => <option key={set} value={set}>{set}</option>)}
                </select>
            </div>
            <div className="min-w-[180px]">
                <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">Trier par</label>
                <select value={sortBy} onChange={(e) => setSortBy(e.target.value as SortOption)} className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-900 text-sm cursor-pointer">
                    <option value="date">Date d&apos;ajout</option>
                    <option value="price_desc">Prix : Haut - Bas</option>
                    <option value="price_asc">Prix : Bas - Haut</option>
                    <option value="name">Nom : A - Z</option>
                    <option value="quantity">Quantit√©</option>
                </select>
            </div>
            <div className="flex items-center gap-4 pb-3 pt-2 md:pt-0">
                <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" checked={filterFoil} onChange={(e) => setFilterFoil(e.target.checked)} className="w-4 h-4 text-[#6275b3] rounded" />
                    <span className="text-sm font-medium">Foil</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" checked={filterTrade} onChange={(e) => setFilterTrade(e.target.checked)} className="w-4 h-4 text-green-600 rounded" />
                    <span className="text-sm font-medium">√âchange</span>
                </label>
            </div>
          </div>
      </div>

      {isSelectMode && (
          <div className="mb-4 flex items-center justify-between bg-[#6275b3]/10 p-3 rounded-lg border border-[#6275b3]/30 animate-in fade-in slide-in-from-top-2">
              <span className="font-bold text-[#6275b3] pl-2">
                  {selectedIds.length} carte(s)
              </span>
              <button onClick={handleSelectAll} className="text-sm text-[#6275b3] font-bold px-3 py-1 rounded hover:bg-[#6275b3]/10 transition">
                  {selectedIds.length === filteredAndSortedCards.length ? 'D√©s√©lectionner' : 'Tout s√©lectionner'}
              </button>
          </div>
      )}

      {/* GRILLE */}
      {filteredAndSortedCards.length === 0 ? (
        <div className="text-center py-20 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl border-2 border-dashed border-zinc-200 dark:border-zinc-700">
          <p className="text-xl text-zinc-500 mb-4">Aucun r√©sultat ne correspond √† vos filtres.</p>
          <button onClick={() => { setSearchQuery(''); setFilterSet('all'); setFilterTrade(false); setFilterFoil(false); }} className="text-[#6275b3] hover:underline">R√©initialiser les filtres</button>
        </div>
      ) : (
        <>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            {visibleCards.map((card) => (
                <MagicCard 
                    key={card.id}
                    {...card}
                    onIncrement={() => updateQuantity(card.id, 1, card.quantity)}
                    onDecrement={() => handleDecrement(card.id, card.quantity)}
                    onEditPrice={(newPrice) => setCustomPrice(card.id, newPrice)}
                    onToggleAttribute={(field, val) => toggleAttribute(card.id, field, val)}
                    isSelectMode={isSelectMode}
                    isSelected={selectedIds.includes(card.id)}
                    onSelect={() => toggleSelection(card.id)}
                />
            ))}
            </div>

            {visibleCount < filteredAndSortedCards.length && (
                <div className="mt-8 flex justify-center pb-10">
                    <button 
                        onClick={() => setVisibleCount(prev => prev + ITEMS_PER_PAGE)}
                        className="bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200 px-8 py-3 rounded-full font-bold shadow-sm transition flex items-center gap-2"
                    >
                        Afficher plus ({filteredAndSortedCards.length - visibleCount}) ‚ñº
                    </button>
                </div>
            )}
        </>
      )}

      {/* ACTION BAR FLOTTANTE (Bleu) */}
      {isSelectMode && selectedIds.length > 0 && (
          <div className="fixed bottom-6 left-4 right-4 md:left-1/2 md:right-auto md:-translate-x-1/2 bg-white dark:bg-zinc-800 shadow-2xl border border-zinc-200 dark:border-zinc-700 p-2 rounded-2xl flex items-center justify-around gap-2 z-50 animate-in slide-in-from-bottom-6 duration-300">
              <button onClick={() => handleBulkTrade(true)} className="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1">
                  <span>Trade</span>
              </button>
              <button onClick={() => handleBulkTrade(false)} className="px-4 py-2 bg-zinc-100 hover:bg-zinc-200 text-zinc-800 rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1">
                  <span>Priv√©</span>
              </button>
              <div className="w-px h-8 bg-zinc-300 mx-1"></div>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1 shadow-md">
                  <span>Suppr</span>
              </button>
          </div>
      )}

      <ImportModal isOpen={isImportOpen} onClose={() => setIsImportOpen(false)} targetCollection="collection" />
      <CollectionToolsModal isOpen={isToolsOpen} onClose={() => setIsToolsOpen(false)} totalCards={cards.length} onRefreshPrices={refreshCollectionPrices} onBulkTrade={bulkSetTradeStatus} />
      <ConfirmModal isOpen={!!cardToDelete} onClose={() => setCardToDelete(null)} onConfirm={() => { if(cardToDelete) removeCard(cardToDelete); }} title="Retirer ?" message="Cette carte sera retir√©e de votre collection." />
    </main>
  );
}
</file>

<file path="components/MagicCard.tsx">
'use client';

import { useState, useEffect, memo } from 'react';

type MagicCardProps = {
  id?: string;
  name: string;
  imageUrl: string;
  imageBackUrl?: string | null;
  quantity?: number;
  price?: number;
  customPrice?: number; 
  setName?: string;
  isFoil?: boolean;
  isSpecificVersion?: boolean;
  isForTrade?: boolean; 
  onIncrement?: () => void;
  onDecrement?: () => void;
  onMove?: () => void;
  onEditPrice?: (newPrice: number) => void;
  onToggleAttribute?: (field: 'isFoil' | 'isSpecificVersion' | 'isForTrade', currentValue: boolean) => void;
  isWishlist?: boolean;
  readOnly?: boolean;
  isTradeView?: boolean;
  allowPriceEdit?: boolean;
  isSelectMode?: boolean;
  isSelected?: boolean;
  onSelect?: () => void;
};

const CARD_BACK_URL = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";

function MagicCard(props: MagicCardProps) {
  const { 
      name, imageUrl, imageBackUrl, quantity = 1, 
      price, customPrice, setName, 
      isFoil, isSpecificVersion, isForTrade,
      isTradeView, allowPriceEdit, 
      onEditPrice, onToggleAttribute, 
      readOnly, isWishlist,
      onIncrement, onDecrement, onMove,
      isSelectMode, isSelected, onSelect
  } = props;
  
  const [isFlipped, setIsFlipped] = useState(false);
  const [isEditingPrice, setIsEditingPrice] = useState(false);
  const [tempPrice, setTempPrice] = useState(customPrice?.toString() || price?.toString() || "0");

  useEffect(() => {
    if (!isEditingPrice) {
        const newVal = customPrice?.toString() || price?.toString() || "0";
        setTempPrice(prev => (prev !== newVal ? newVal : prev));
    }
  }, [customPrice, price, isEditingPrice]);

  const effectivePrice = customPrice !== undefined ? customPrice : (price || 0);

  const handleSavePrice = () => {
      if (onEditPrice) {
          onEditPrice(parseFloat(tempPrice));
          setIsEditingPrice(false);
      }
  };

  const currentImage = isFlipped && imageBackUrl ? imageBackUrl : imageUrl;

  const handleCardClick = () => {
      if (isSelectMode && onSelect) {
          onSelect();
      } else if (imageBackUrl) {
          setIsFlipped(!isFlipped);
      }
  };

  // --- VUE LISTE ---
  if (isTradeView) {
      return (
        <div className="flex items-center gap-3 bg-white dark:bg-zinc-900 p-2 rounded-lg border border-zinc-200 dark:border-zinc-800 content-visibility-auto">
            <div className="w-10 h-14 bg-zinc-100 rounded overflow-hidden flex-shrink-0 relative group cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
                 <img src={currentImage} className="w-full h-full object-cover" alt={name} loading="lazy" />
            </div>
            <div className="flex-grow min-w-0">
                <div className="flex items-center gap-2">
                    <p className="font-semibold text-sm truncate text-zinc-900 dark:text-zinc-100" title={name}>{name}</p>
                    {isFoil && <span className="text-[10px] font-bold text-amber-600 bg-amber-50 px-1 rounded">FOIL</span>}
                </div>
                <div className="flex items-center gap-2 text-xs text-zinc-500">
                    <p className="truncate">{setName}</p>
                </div>
            </div>
            <div className="text-right flex flex-col items-end">
                {isEditingPrice ? (
                    <div className="flex items-center gap-1">
                        <input type="number" value={tempPrice} onChange={(e) => setTempPrice(e.target.value)} className="w-16 p-1 text-xs border rounded text-black" autoFocus />
                        <button onClick={handleSavePrice} className="text-green-600 text-xs font-bold">OK</button>
                    </div>
                ) : (
                    <div 
                        className={`font-medium text-sm ${customPrice ? 'text-orange-600' : 'text-zinc-700 dark:text-zinc-300'} ${allowPriceEdit ? 'cursor-pointer hover:underline' : ''}`}
                        onClick={() => { if (allowPriceEdit) { setTempPrice(effectivePrice.toString()); setIsEditingPrice(true); }}}
                    >
                        {effectivePrice.toFixed(2)} ‚Ç¨
                    </div>
                )}
            </div>
        </div>
      );
  }

  // --- VUE GRILLE ---
  return (
    <div 
        onClick={handleCardClick}
        className={`relative group flex flex-col rounded-xl overflow-hidden p-3 gap-2 h-full content-visibility-auto
        bg-white dark:bg-zinc-900 border transition-all duration-200 shadow-sm hover:shadow-md
        
        /* S√âLECTION AVEC TON BLEU */
        ${isSelected 
            ? 'border-[#6275b3] ring-1 ring-[#6275b3] bg-[#6275b3]/5' 
            : 'border-zinc-200 dark:border-zinc-800 hover:border-[#6275b3] dark:hover:border-[#6275b3]'
        }
        ${isSelectMode ? 'cursor-pointer' : ''}
        `}
    >

      {isSelectMode && (
          <div className="absolute top-2 right-2 z-30 pointer-events-none">
              <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition-all ${isSelected ? 'bg-[#6275b3] border-[#6275b3]' : 'bg-white border-zinc-300'}`}>
                  {isSelected && <span className="text-white text-xs font-bold">‚úì</span>}
              </div>
          </div>
      )}

      <div className="relative w-full aspect-[2.5/3.5] bg-zinc-100 dark:bg-zinc-800 rounded-lg overflow-hidden shrink-0">
        <img
          src={currentImage || CARD_BACK_URL}
          alt={name}
          loading="lazy"
          className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
          onError={(e) => { e.currentTarget.src = CARD_BACK_URL; }}
        />
        {isFoil && <div className="absolute bottom-0 right-0 bg-amber-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-tl-md shadow-sm">FOIL</div>}
        {imageBackUrl && !isSelectMode && (
          <button onClick={(e) => { e.stopPropagation(); setIsFlipped(!isFlipped); }} className="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-1.5 rounded-full backdrop-blur-sm transition-opacity opacity-0 group-hover:opacity-100 z-10 text-[9px] font-bold">‚Üª</button>
        )}
      </div>
      
      <div className="flex-1 flex flex-col min-w-0 pt-1">
        <div className="flex justify-between items-start mb-0.5">
            <h3 className="font-semibold text-sm leading-tight text-zinc-900 dark:text-zinc-100 truncate flex-grow" title={name}>{name}</h3>
        </div>
        
        <p className="text-[11px] text-zinc-500 dark:text-zinc-400 truncate mb-2">{setName}</p>

        <div className={`flex flex-wrap gap-1 mb-2 ${isSelectMode ? 'pointer-events-none opacity-50' : ''}`}>
            {onToggleAttribute ? (
                <button 
                    onClick={(e) => { e.stopPropagation(); onToggleAttribute('isFoil', !!isFoil); }}
                    className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                        isFoil 
                        ? 'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800' 
                        : 'bg-zinc-50 text-zinc-400 border-zinc-100 hover:bg-zinc-100 dark:bg-zinc-800 dark:border-zinc-700'
                    }`}
                >
                    {isFoil ? 'Foil' : 'Normal'}
                </button>
            ) : null}

            {isWishlist ? (
                onToggleAttribute && (
                    <button 
                        onClick={(e) => { e.stopPropagation(); onToggleAttribute('isSpecificVersion', !!isSpecificVersion); }}
                        className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                            isSpecificVersion 
                            ? 'bg-[#6275b3]/10 text-[#6275b3] border-[#6275b3]/30' 
                            : 'bg-zinc-50 text-zinc-400 border-zinc-100'
                        }`}
                    >
                        {isSpecificVersion ? 'Exact' : 'Auto'}
                    </button>
                )
            ) : (
                onToggleAttribute && (
                    <button 
                        onClick={(e) => { e.stopPropagation(); onToggleAttribute('isForTrade', !!isForTrade); }}
                        className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                            isForTrade 
                            ? 'bg-emerald-50 text-emerald-700 border-emerald-200' 
                            : 'bg-zinc-50 text-zinc-400 border-zinc-100 hover:bg-zinc-100'
                        }`}
                    >
                        {isForTrade ? 'Trade' : 'Priv√©'}
                    </button>
                )
            )}
            
            {isWishlist && !readOnly && !isSelectMode && onMove && (
                <button 
                    onClick={(e) => { e.stopPropagation(); onMove(); }}
                    className="text-[10px] px-2 py-1 rounded border transition-colors font-bold flex-1 text-center bg-white text-emerald-600 border-emerald-200 hover:bg-emerald-50"
                    title="J'ai re√ßu cette carte"
                >
                    Achet√©
                </button>
            )}
        </div>
        
        <div className={`mt-auto flex justify-between items-center border-t border-zinc-100 dark:border-zinc-800 pt-2 ${isSelectMode ? 'pointer-events-none opacity-50' : ''}`}>
          <div className="flex items-center gap-1">
            {!readOnly && <button onClick={(e) => {e.stopPropagation(); onDecrement?.()}} className="w-5 h-5 rounded bg-zinc-100 hover:bg-zinc-200 text-zinc-600 flex items-center justify-center text-xs font-bold transition">-</button>}
            <span className={`text-sm ${readOnly ? 'font-bold text-zinc-700 dark:text-zinc-300' : 'w-4 text-center text-zinc-700 dark:text-zinc-300'}`}>{readOnly && "x"}{quantity}</span>
            {!readOnly && <button onClick={(e) => {e.stopPropagation(); onIncrement?.()}} className="w-5 h-5 rounded bg-[#6275b3]/10 hover:bg-[#6275b3]/20 text-[#6275b3] border border-[#6275b3]/30 flex items-center justify-center text-xs font-bold transition">+</button>}
          </div>
          
          <div className="text-right leading-none">
             <p className={`font-bold text-sm ${customPrice ? 'text-orange-600' : 'text-zinc-700 dark:text-zinc-200'}`}>
                 {(effectivePrice * quantity).toFixed(2)} ‚Ç¨
             </p>
          </div>
        </div>
      </div>
    </div>
  );
}

export default memo(MagicCard);
</file>

<file path="components/ImportModal.tsx">
// components/ImportModal.tsx
'use client';

import React, { useState, useMemo, useEffect } from 'react';
import Papa from 'papaparse';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, writeBatch, increment } from 'firebase/firestore';
import toast from 'react-hot-toast';

type ManaboxRow = {
  "Binder Name": string;
  "Name": string;
  "Set code": string;
  "Set name": string;
  "Collector number": string;
  "Foil": string;
  "Rarity": string;
  "Quantity": string;
  "ManaBox ID": string;
  "Scryfall ID": string; 
  "Purchase price": string;
  "Language": string;
  "Condition": string;
};

type ScryfallCard = {
  id: string;
  name: string;
  set: string;
  collector_number: string;
  set_name: string;
  prices?: { eur?: string; usd?: string };
  image_uris?: { normal?: string };
  card_faces?: Array<{ 
    name: string;
    image_uris?: { normal?: string } 
  }>;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  [key: string]: any;
};

type ExistingCard = {
  scryfallId?: string; 
  id: string;
  quantity: number;
  foil?: boolean;
};

type ImportModalProps = {
  isOpen: boolean;
  onClose: () => void;
  targetCollection?: string;
  currentCollection?: ExistingCard[];
};

export default function ImportModal({ isOpen, onClose, targetCollection = 'collection', currentCollection = [] }: ImportModalProps) {
  const { user } = useAuth();
  
  const [inputType, setInputType] = useState<'file' | 'text'>('file');
  const [textInput, setTextInput] = useState('');
  
  const [data, setData] = useState<ManaboxRow[]>([]);
  const [columns, setColumns] = useState<string[]>([]);
  const [step, setStep] = useState<'upload' | 'preview' | 'importing'>('upload');
  
  const [progress, setProgress] = useState(0);
  const [statusMsg, setStatusMsg] = useState('');
  const [importMode, setImportMode] = useState<'add' | 'sync'>('add'); 

  const existingMap = useMemo(() => {
    const map = new Map<string, ExistingCard>();
    currentCollection.forEach(card => {
        const key = card.id; 
        map.set(key, card);
    });
    return map;
  }, [currentCollection]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (isOpen && e.key === 'Escape' && step !== 'importing') handleClose();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, step]);

  const handleClose = () => {
    if (step === 'importing') return; 
    onClose();
    setTimeout(() => {
      setStep('upload');
      setData([]);
      setTextInput('');
      setProgress(0);
    }, 300);
  };

  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget && step !== 'importing') handleClose();
  };

  if (!isOpen) return null;

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      delimiter: ",", 
      encoding: "UTF-8",
      complete: (results) => {
        setColumns(results.meta.fields || []);
        setData(results.data as ManaboxRow[]);
        setStep('preview');
      },
      error: (error) => toast.error("Erreur CSV : " + error.message)
    });
  };

  const handleTextParse = () => {
    if (!textInput.trim()) return;

    const rows: ManaboxRow[] = [];
    const lines = textInput.split('\n');
    const regex = /^(\d+)\s+(.+?)\s+\((\w+)\)\s+(\S+)(?:\s+\*(F)\*)?/;

    lines.forEach(line => {
        const cleanLine = line.trim();
        if (!cleanLine) return;
        const match = cleanLine.match(regex);
        if (match) {
            rows.push({
                "Quantity": match[1],
                "Name": match[2],
                "Set code": match[3].toLowerCase(),
                "Collector number": match[4],
                "Foil": match[5] === 'F' ? "true" : "false",
                "Scryfall ID": "", 
                "Binder Name": "Import Texte",
                "Set name": "",
                "Rarity": "",
                "ManaBox ID": "",
                "Purchase price": "0",
                "Language": "en",
                "Condition": "Near Mint"
            });
        }
    });

    if (rows.length === 0) {
        toast.error("Format non reconnu.");
        return;
    }
    setColumns(["Name", "Set code", "Quantity", "Foil", "Collector number"]);
    setData(rows);
    setStep('preview');
  };

  const chunkArray = <T,>(array: T[], size: number): T[][] => {
    const chunks = [];
    for (let i = 0; i < array.length; i += size) {
      chunks.push(array.slice(i, i + size));
    }
    return chunks;
  };

  const getCardInfo = (scryfallCard: ScryfallCard) => {
    let name = scryfallCard.name;
    let imageUrl = scryfallCard.image_uris?.normal;
    let imageBackUrl = null;

    if (scryfallCard.card_faces && scryfallCard.card_faces.length > 1) {
      name = scryfallCard.card_faces[0].name;
      if (!imageUrl && scryfallCard.card_faces[0].image_uris) {
        imageUrl = scryfallCard.card_faces[0].image_uris.normal;
      }
      if (scryfallCard.card_faces[1].image_uris) {
        imageBackUrl = scryfallCard.card_faces[1].image_uris.normal;
      }
    }
    if (!imageUrl) {
        imageUrl = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";
    }
    return { name, imageUrl, imageBackUrl };
  };

  const startImport = async () => {
    if (!user) return;
    setStep('importing');
    setProgress(0);

    const rowsToFetch: ManaboxRow[] = [];
    const rowsToUpdateDirectly: ManaboxRow[] = [];
    let skippedCount = 0; 

    data.forEach(row => {
        const scryfallId = row["Scryfall ID"];
        const csvQty = parseInt(row["Quantity"]) || 1;
        const csvFoil = row["Foil"] === "true";
        const existing = scryfallId ? existingMap.get(scryfallId) : undefined;

        if (existing) {
            if (importMode === 'sync') {
                const existingFoil = !!existing.foil;
                if (existing.quantity === csvQty && existingFoil === csvFoil) {
                    skippedCount++;
                } else {
                    rowsToUpdateDirectly.push(row);
                }
            } else {
                if (csvQty > 0) rowsToUpdateDirectly.push(row);
            }
        } else {
            rowsToFetch.push(row);
        }
    });

    let processedCount = skippedCount; 
    let successCount = 0; 

    if (rowsToUpdateDirectly.length > 0) {
        setStatusMsg("Mise √† jour rapide...");
        const updateChunks = chunkArray(rowsToUpdateDirectly, 400);

        for (const chunk of updateChunks) {
            const batch = writeBatch(db);
            chunk.forEach(row => {
                const cardRef = doc(db, 'users', user.uid, targetCollection, row["Scryfall ID"]);
                const qtyToAdd = parseInt(row["Quantity"]);
                
                if (importMode === 'sync') {
                    batch.update(cardRef, {
                        quantity: qtyToAdd,
                        foil: row["Foil"] === "true",
                        price: parseFloat(row["Purchase price"]) || 0,
                    });
                } else {
                    batch.update(cardRef, {
                        quantity: increment(qtyToAdd),
                        foil: row["Foil"] === "true",
                        importedAt: new Date()
                    });
                }
                successCount++;
            });
            await batch.commit();
            processedCount += chunk.length;
            setProgress(Math.round((processedCount / data.length) * 100));
        }
    }

    if (rowsToFetch.length > 0) {
        setStatusMsg("Identification des cartes...");
        const fetchChunks = chunkArray(rowsToFetch, 75);

        for (const chunk of fetchChunks) {
            try {
                const identifiers = chunk.map(row => {
                    if (row["Scryfall ID"]) return { id: row["Scryfall ID"] };
                    return { name: row["Name"], set: row["Set code"], collector_number: row["Collector number"] };
                });
                
                const response = await fetch('https://api.scryfall.com/cards/collection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers })
                });

                const result = await response.json();
                const foundCards: ScryfallCard[] = result.data || [];
                const batch = writeBatch(db);
                let batchHasOps = false;
                
                foundCards.forEach(scryfallData => {
                    const matchingRow = chunk.find(r => 
                        r["Scryfall ID"] === scryfallData.id || 
                        (r["Set code"] === scryfallData.set && r["Collector number"] === scryfallData.collector_number)
                    );

                    if (matchingRow) {
                        const csvQty = parseInt(matchingRow["Quantity"]);
                        const csvFoil = matchingRow["Foil"] === "true";
                        
                        const existing = existingMap.get(scryfallData.id);
                        let shouldWrite = true;

                        if (existing && importMode === 'sync') {
                            const existingFoil = !!existing.foil;
                            if (existing.quantity === csvQty && existingFoil === csvFoil) {
                                shouldWrite = false;
                                skippedCount++;
                            }
                        }

                        if (shouldWrite) {
                            const { name, imageUrl, imageBackUrl } = getCardInfo(scryfallData);
                            const cardRef = doc(db, 'users', user.uid, targetCollection, scryfallData.id);
                            
                            const cardData = {
                                name, imageUrl, imageBackUrl,
                                setName: scryfallData.set_name, setCode: scryfallData.set,
                                scryfallId: scryfallData.id,
                                price: parseFloat(scryfallData.prices?.eur || "0"),
                                foil: csvFoil,
                                importedAt: new Date(),
                                // --- SAUVEGARDE COMPL√àTE ICI ---
                                scryfallData: scryfallData
                            };

                            if (importMode === 'add') {
                                 batch.set(cardRef, { ...cardData, quantity: increment(csvQty) }, { merge: true });
                            } else {
                                 batch.set(cardRef, { ...cardData, quantity: csvQty }, { merge: true });
                            }
                            successCount++;
                            batchHasOps = true;
                        }
                    }
                });

                if (batchHasOps) {
                    await batch.commit();
                }
                
            } catch (error) {
                console.error("Erreur Scryfall", error);
            }
            processedCount += chunk.length;
            setProgress(Math.round((processedCount / data.length) * 100));
            await new Promise(r => setTimeout(r, 100));
        }
    }

    toast.success(`${successCount} cartes synchronis√©e(s) !`, { duration: 4000 });
    handleClose();
  };

  return (
    <div 
      className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
      onClick={handleBackdropClick}
    >
      <div 
        className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-5xl w-full shadow-2xl border border-gray-100 dark:border-gray-700 flex flex-col max-h-[90vh]"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex-none flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
          <h2 className="text-xl font-bold text-gray-900 dark:text-white">
            Ajouter des cartes
          </h2>
          {step !== 'importing' && (
             <button onClick={handleClose} className="text-gray-500 hover:text-gray-700 text-lg p-2">‚úï</button>
          )}
        </div>

        <div className="flex-grow overflow-hidden flex flex-col min-h-0">
            
            {step === 'upload' && (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="flex-none flex border-b border-gray-200 dark:border-gray-700 mb-4">
                        <button onClick={() => setInputType('file')} className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${inputType === 'file' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}>üìÇ Fichier CSV</button>
                        <button onClick={() => setInputType('text')} className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${inputType === 'text' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}>üìù Copier / Coller</button>
                    </div>
                    {inputType === 'file' ? (
                        <div className="flex-grow p-12 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition relative cursor-pointer group flex flex-col items-center justify-center">
                            <input type="file" accept=".csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" />
                            <div className="text-6xl mb-4 group-hover:scale-110 transition-transform">üìÇ</div>
                            <p className="font-bold text-lg">D√©poser CSV Manabox</p>
                        </div>
                    ) : (
                        <div className="flex-grow flex flex-col min-h-0">
                            <textarea value={textInput} onChange={(e) => setTextInput(e.target.value)} rows={15} placeholder="Collez votre liste ici..." className="flex-grow w-full p-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none resize-none" />
                            <button onClick={handleTextParse} disabled={!textInput.trim()} className="flex-none mt-4 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold py-3 rounded-xl shadow-md transition">Analyser le texte</button>
                        </div>
                    )}
                </div>
            )}

            {step === 'preview' && (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="flex-none grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div onClick={() => setImportMode('add')} className={`p-3 rounded-xl border-2 cursor-pointer transition flex flex-col gap-1 ${importMode === 'add' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-300'}`}>
                            <div className="flex items-center gap-2 font-bold text-blue-700 dark:text-blue-300 text-sm">
                                <span className={`w-4 h-4 rounded-full border flex items-center justify-center ${importMode === 'add' ? 'border-blue-600 bg-blue-600' : 'border-gray-400'}`}>{importMode === 'add' && <span className="w-2 h-2 rounded-full bg-white"></span>}</span> Ajouter
                            </div>
                            <p className="text-[10px] text-gray-500 ml-6">Ajoute (+1) aux quantit√©s existantes.</p>
                        </div>
                        <div onClick={() => setImportMode('sync')} className={`p-3 rounded-xl border-2 cursor-pointer transition flex flex-col gap-1 ${importMode === 'sync' ? 'border-purple-500 bg-purple-50 dark:bg-purple-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-purple-300'}`}>
                            <div className="flex items-center gap-2 font-bold text-purple-700 dark:text-purple-300 text-sm">
                                <span className={`w-4 h-4 rounded-full border flex items-center justify-center ${importMode === 'sync' ? 'border-purple-600 bg-purple-600' : 'border-gray-400'}`}>{importMode === 'sync' && <span className="w-2 h-2 rounded-full bg-white"></span>}</span> Synchroniser
                            </div>
                            <p className="text-[10px] text-gray-500 ml-6">Remplace (=1) la quantit√© en base.</p>
                        </div>
                    </div>
                    <div className="flex-none flex justify-between items-center mb-2 px-1">
                        <span className="text-sm font-semibold">{data.length} cartes d√©tect√©es</span>
                        <button onClick={() => { setData([]); setStep('upload'); }} className="text-red-500 text-xs hover:underline">Retour</button>
                    </div>
                    <div className="flex-grow overflow-auto min-h-0 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900">
                        <table className="w-full text-xs text-left text-gray-500 dark:text-gray-400">
                            <thead className="text-gray-700 bg-gray-200 dark:bg-gray-800 sticky top-0 z-10">
                                <tr>{columns.slice(0,6).map((col, i) => <th key={i} className="px-4 py-2">{col}</th>)}</tr>
                            </thead>
                            <tbody>
                                {data.map((row, i) => (
                                    <tr key={i} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        {columns.slice(0,6).map((col, j) => <td key={j} className="px-4 py-1 truncate max-w-[150px]">{row[col as keyof ManaboxRow]}</td>)}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="flex-none pt-4">
                        <button onClick={startImport} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:-translate-y-0.5 ${importMode === 'add' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'}`}>
                            {importMode === 'add' ? '‚ûï Valider l\'Ajout' : 'üîÑ Valider la Synchronisation'}
                        </button>
                    </div>
                </div>
            )}

            {step === 'importing' && (
                <div className="flex flex-col items-center justify-center h-full py-10">
                    <div className="text-5xl font-bold text-blue-600 mb-2">{progress}%</div>
                    <p className="text-gray-500 animate-pulse mb-6">{statusMsg}</p>
                    <div className="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden max-w-md">
                        <div className="bg-blue-600 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                    </div>
                </div>
            )}
        </div>
      </div>
    </div>
  );
}
</file>

</files>
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# local tools
stripe.exe
</file>

<file path="app/user/[uid]/page.tsx">
// app/user/[uid]/page.tsx
'use client';

import { useState, useEffect, use } from 'react';
import { db } from '@/lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import { useCardCollection } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import { FriendProfile } from '@/hooks/useFriends'; // R√©utilisation du type

export default function UserProfilePage({ params }: { params: Promise<{ uid: string }> }) {
  // En Next.js 15+, params est une Promise
  const unwrappedParams = use(params);
  const targetUid = unwrappedParams.uid;

  const [profile, setProfile] = useState<FriendProfile | null>(null);
  const [activeTab, setActiveTab] = useState<'collection' | 'wishlist'>('collection');
  
  // On utilise notre hook modifi√© avec le targetUid !
  const { cards, loading, totalPrice } = useCardCollection(activeTab, 'default', targetUid);

  // Charger les infos du profil (Nom, Avatar)
  useEffect(() => {
    const fetchProfile = async () => {
      try {
        const docRef = doc(db, 'users', targetUid, 'public_profile', 'info');
        const snap = await getDoc(docRef);
        if (snap.exists()) {
            setProfile({ uid: targetUid, ...snap.data() } as FriendProfile);
        }
      } catch (e) {
        console.error("Erreur profil", e);
      }
    };
    fetchProfile();
  }, [targetUid]);

  if (!profile && !loading) return <div className="p-10 text-center">Profil introuvable ou priv√©.</div>;

  return (
    <main className="container mx-auto p-4 pb-20">
        
        {/* HEADER PROFIL */}
        <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 mb-6 flex flex-col md:flex-row items-center md:items-start gap-6">
            {/* Avatar */}
            <div className="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold border-4 border-white dark:border-gray-700 shadow-md overflow-hidden">
                {profile?.photoURL ? <img src={profile.photoURL} alt="" className="w-full h-full object-cover"/> : profile?.username?.[0]?.toUpperCase()}
            </div>
            
            {/* Infos */}
            <div className="text-center md:text-left flex-grow">
                <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-1">
                    {profile?.displayName || 'Utilisateur'}
                </h1>
                <p className="text-blue-600 dark:text-blue-400 font-medium bg-blue-50 dark:bg-blue-900/30 inline-block px-3 py-1 rounded-full text-sm">
                    @{profile?.username}
                </p>
            </div>

            {/* Stats Valeur */}
            <div className="bg-green-50 dark:bg-green-900/20 px-6 py-4 rounded-xl border border-green-100 dark:border-green-800 text-center">
                <p className="text-xs uppercase text-green-600 dark:text-green-400 font-bold mb-1">Valeur affich√©e</p>
                <p className="text-2xl font-bold text-green-700 dark:text-green-300">{totalPrice.toFixed(2)} ‚Ç¨</p>
            </div>
        </div>

        {/* TABS (Collection vs Wishlist) */}
        <div className="flex justify-center mb-8 border-b border-gray-200 dark:border-gray-700">
            <button 
                onClick={() => setActiveTab('collection')}
                className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                    activeTab === 'collection' 
                    ? 'border-blue-600 text-blue-600' 
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                üìö Sa Collection
            </button>
            <button 
                onClick={() => setActiveTab('wishlist')}
                className={`px-6 py-3 font-medium transition-colors border-b-2 ${
                    activeTab === 'wishlist' 
                    ? 'border-purple-600 text-purple-600' 
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
            >
                ‚ú® Sa Wishlist
            </button>
        </div>

        {/* GRILLE DE CARTES */}
        {loading ? (
            <p className="text-center p-10 text-gray-500">Chargement des cartes...</p>
        ) : cards.length === 0 ? (
            <div className="text-center py-16 bg-gray-50 dark:bg-gray-800/50 rounded-xl border-dashed border-2 border-gray-200 dark:border-gray-700">
                <p className="text-gray-400 italic">Cette liste est vide.</p>
            </div>
        ) : (
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
                {cards.map(card => (
                    <MagicCard 
                        key={card.id} 
                        {...card} 
                        readOnly={true} // <--- Important : Mode lecture seule
                    />
                ))}
            </div>
        )}

    </main>
  );
}
</file>

<file path="components/AdContainer.tsx">
// components/AdContainer.tsx
'use client';
import { usePremium } from '@/hooks/usePremium';
import Link from 'next/link';

export default function AdContainer() {
  const { isPremium, loading } = usePremium();

  if (loading || isPremium) return null;

  return (
    <div className="w-full my-4 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg flex flex-col items-center justify-center text-center animate-in fade-in duration-500">
        
        {/* Placeholder pour AdSense / Banni√®re */}
        <div className="w-full max-w-[300px] h-[250px] bg-white dark:bg-black border-2 border-dashed border-gray-300 flex flex-col items-center justify-center gap-2 text-gray-400 text-sm overflow-hidden">
            <span className="text-2xl">üì¢</span>
            <p>Espace Publicitaire</p>
        </div>
        
        <p className="text-[10px] text-gray-500 mt-3 uppercase tracking-wide">
            Supportez MagicWish - <Link href="/premium" className="underline hover:text-blue-500 font-bold">Retirer la pub (1‚Ç¨)</Link>
        </p>
    </div>
  );
}
</file>

<file path="components/ConfirmModal.tsx">
// components/ConfirmModal.tsx
'use client';

type ConfirmModalProps = {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  message?: string;
};

export default function ConfirmModal({ 
  isOpen, 
  onClose, 
  onConfirm, 
  title = "Confirmation", 
  message = "√ätes-vous s√ªr de vouloir faire √ßa ?" 
}: ConfirmModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
      <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full shadow-2xl border border-gray-100 dark:border-gray-700 animate-in fade-in zoom-in duration-200">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-2">{title}</h3>
        <p className="text-gray-500 dark:text-gray-300 mb-6">{message}</p>
        
        <div className="flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
          >
            Annuler
          </button>
          <button
            onClick={() => {
              onConfirm();
              onClose();
            }}
            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition shadow-sm"
          >
            Supprimer
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/DeleteAllButton.tsx">
// components/DeleteAllButton.tsx
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { collection, getDocs, writeBatch } from 'firebase/firestore';
import toast from 'react-hot-toast';
import ConfirmModal from './ConfirmModal';

type DeleteAllButtonProps = {
  targetCollection: 'wishlist' | 'collection';
};

export default function DeleteAllButton({ targetCollection }: DeleteAllButtonProps) {
  const { user } = useAuth();
  const [isDeleting, setIsDeleting] = useState(false);
  const [isConfirmOpen, setIsConfirmOpen] = useState(false);

  // Fonction utilitaire pour d√©couper en paquets de 500
  const chunkArray = <T,>(arr: T[], size: number): T[][] => {
    const chunks = [];
    for (let i = 0; i < arr.length; i += size) {
      chunks.push(arr.slice(i, i + size));
    }
    return chunks;
  };

  const handleDeleteAll = async () => {
    if (!user) return;

    setIsDeleting(true);
    const toastId = toast.loading("Suppression en cours...");

    try {
      // 1. On r√©cup√®re TOUTES les cartes
      const colRef = collection(db, 'users', user.uid, targetCollection);
      const snapshot = await getDocs(colRef);

      if (snapshot.empty) {
        toast.success("La liste est d√©j√† vide !", { id: toastId });
        setIsDeleting(false);
        return;
      }

      const docs = snapshot.docs;
      // 2. On d√©coupe en lots de 500 (limite technique Firestore)
      const batches = chunkArray(docs, 500);

      // 3. On supprime lot par lot
      for (const batchDocs of batches) {
        const batch = writeBatch(db);
        batchDocs.forEach((doc) => {
          batch.delete(doc.ref);
        });
        await batch.commit();
      }

      toast.success(`Tout a √©t√© supprim√© (${docs.length} cartes).`, { id: toastId });

    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de la suppression.", { id: toastId });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <>
      <button
        onClick={() => setIsConfirmOpen(true)}
        disabled={isDeleting}
        className="text-red-600 hover:text-red-800 hover:bg-red-50 dark:hover:bg-red-900/20 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
        title="Tout effacer"
      >
        {isDeleting ? '...' : 'üóëÔ∏è Vider la liste'}
      </button>

      <ConfirmModal
        isOpen={isConfirmOpen}
        onClose={() => setIsConfirmOpen(false)}
        onConfirm={handleDeleteAll}
        title="‚ö†Ô∏è DANGER : Tout supprimer ?"
        message={`Vous √™tes sur le point de supprimer INT√âGRALEMENT votre ${targetCollection}. Cette action est irr√©versible.`}
      />
    </>
  );
}
</file>

<file path="components/ThemeProvider.tsx">
'use client';

import { ThemeProvider as NextThemesProvider } from 'next-themes';
import { type ThemeProviderProps } from 'next-themes'; // corrig√© l'import

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
</file>

<file path="components/UsernameSetupModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, getDoc, writeBatch, serverTimestamp } from 'firebase/firestore';
import toast from 'react-hot-toast';

export default function UsernameSetupModal() {
  const { user, username, loading } = useAuth();
  const [isOpen, setIsOpen] = useState(false);
  
  const [inputVal, setInputVal] = useState('');
  const [isChecking, setIsChecking] = useState(false);

  // On ouvre la modale SI : user connect√©, chargement fini, ET pas de username
  useEffect(() => {
    if (!loading && user && !username) {
      setIsOpen(true);
    } else {
      setIsOpen(false);
    }
  }, [user, username, loading]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user || !inputVal) return;

    // 1. Nettoyage et Validation basique
    // Uniquement lettres minuscules, chiffres et underscores
    const cleanUsername = inputVal.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');

    if (cleanUsername.length < 3) {
      toast.error("Le pseudo doit faire au moins 3 caract√®res.");
      return;
    }
    
    if (cleanUsername !== inputVal.trim().toLowerCase()) {
        toast.error("Caract√®res sp√©ciaux interdits (sauf _ )");
        return;
    }

    setIsChecking(true);

    try {
      // 2. V√©rification d'unicit√© (On check la collection 'usernames')
      const usernameRef = doc(db, 'usernames', cleanUsername);
      const usernameSnap = await getDoc(usernameRef);

      if (usernameSnap.exists()) {
        toast.error(`Le pseudo "${cleanUsername}" est d√©j√† pris.`);
        setIsChecking(false);
        return;
      }

      // 3. Cr√©ation atomique (Tout ou rien) via Batch
      const batch = writeBatch(db);

      // A. R√©server le pseudo dans la collection globale
      batch.set(usernameRef, { uid: user.uid });

      // B. Cr√©er le profil public de l'utilisateur
      const profileRef = doc(db, 'users', user.uid, 'public_profile', 'info');
      batch.set(profileRef, {
        username: cleanUsername,
        displayName: user.displayName || 'Joueur Inconnu',
        photoURL: user.photoURL || null,
        createdAt: serverTimestamp(),
        bio: "Nouveau membre MagicWish"
      });

      await batch.commit();

      toast.success(`Bienvenue, @${cleanUsername} !`);
      setIsOpen(false); // Le AuthContext va se mettre √† jour auto et fermer la modale, mais on force ici pour UI instantan√©e

    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de la cr√©ation du profil.");
    } finally {
      setIsChecking(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 backdrop-blur-md">
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700 animate-in zoom-in duration-300">
        <div className="text-center mb-6">
          <div className="text-4xl mb-2">üëã</div>
          <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Bienvenue sur MagicWish !</h2>
          <p className="text-gray-500 dark:text-gray-400 mt-2">
            Pour permettre √† vos amis de vous trouver, veuillez choisir un <span className="font-bold text-blue-600">nom d'utilisateur unique</span>.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Votre pseudo (ex: jace_beleren)
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">@</span>
              <input
                type="text"
                value={inputVal}
                onChange={(e) => setInputVal(e.target.value.toLowerCase())}
                className="w-full pl-8 p-3 border rounded-lg bg-gray-50 dark:bg-gray-900 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 outline-none lowercase"
                placeholder="pseudo_unique"
                disabled={isChecking}
                autoFocus
              />
            </div>
            <p className="text-xs text-gray-400 mt-1">Lettres minuscules, chiffres et underscore (_) uniquement.</p>
          </div>

          <button
            type="submit"
            disabled={isChecking || inputVal.length < 3}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isChecking ? 'V√©rification...' : 'Valider mon profil üöÄ'}
          </button>
        </form>
      </div>
    </div>
  );
}
</file>

<file path="hooks/useWishlists.ts">
// hooks/useWishlists.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { collection, onSnapshot, addDoc, doc, serverTimestamp, setDoc } from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import { deleteWishlistAction } from '@/app/actions/wishlist'; // <--- IMPORT
import toast from 'react-hot-toast';

export type WishlistMeta = {
  id: string;
  name: string;
  isDefault?: boolean;
};

export function useWishlists() {
  const { user } = useAuth();
  const [lists, setLists] = useState<WishlistMeta[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setLists([]);
      setLoading(false);
      return;
    }

    const metaRef = collection(db, 'users', user.uid, 'wishlists_meta');
    
    const unsubscribe = onSnapshot(metaRef, (snapshot) => {
      const fetchedLists = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as WishlistMeta[];

      if (fetchedLists.length === 0 && !snapshot.metadata.fromCache) {
        createList("Liste principale", "default");
      } else {
        fetchedLists.sort((a, b) => {
          if (a.id === 'default') return -1;
          if (b.id === 'default') return 1;
          return a.name.localeCompare(b.name);
        });
        setLists(fetchedLists);
      }
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const createList = async (name: string, customId?: string) => {
    if (!user) return;
    try {
      const data = { name, createdAt: serverTimestamp() };
      if (customId) {
        await setDoc(doc(db, 'users', user.uid, 'wishlists_meta', customId), { ...data, isDefault: true });
      } else {
        await addDoc(collection(db, 'users', user.uid, 'wishlists_meta'), data);
      }
      toast.success(`Liste "${name}" cr√©√©e`);
    } catch (err) {
      console.error(err);
      toast.error("Erreur cr√©ation liste");
    }
  };

  const deleteList = async (listId: string) => {
    if (!user || listId === 'default') return; 
    if (!confirm("Supprimer cette liste et toutes ses cartes ?")) return;
    
    const toastId = toast.loading("Suppression en cours...");

    try {
        // Appel de la Server Action pour nettoyage complet
        const result = await deleteWishlistAction(user.uid, listId);

        if (result.success) {
            toast.success("Liste supprim√©e", { id: toastId });
        } else {
            throw new Error(result.error);
        }
    } catch (err: unknown) {
        console.error(err);
        let msg = "Erreur suppression";
        if (err instanceof Error) msg = err.message;
        toast.error(msg, { id: toastId });
    }
  };

  return { lists, loading, createList, deleteList };
}
</file>

<file path="lib/firebase-admin.ts">
// lib/firebase-admin.ts
import 'server-only';
import * as admin from 'firebase-admin';

// Fonction pour nettoyer la cl√© priv√©e (probl√®me fr√©quent avec les variables d'env)
function formatPrivateKey(key: string) {
  return key.replace(/\\n/g, '\n');
}

export function getAdminFirestore() {
  // On v√©rifie si une instance existe d√©j√† pour √©viter les erreurs de hot-reload
  if (admin.apps.length === 0) {
    admin.initializeApp({
      credential: admin.credential.cert({
        projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
        privateKey: formatPrivateKey(process.env.FIREBASE_PRIVATE_KEY || ""),
      }),
    });
  }
  return admin.firestore();
}
</file>

<file path="lib/firebase.ts">
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

// Initialisation unique (√©vite les erreurs de re-init en dev)
const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();

export const auth = getAuth(app);
export const db = getFirestore(app);
</file>

<file path="next.config.ts">
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // Mode strict pour d√©tecter les bugs en dev
  reactStrictMode: true,

  // Optimisation des images
  images: {
    formats: ['image/avif', 'image/webp'],
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'cards.scryfall.io', // Indispensable pour tes cartes
        port: '',
        pathname: '/**',
      },
      {
        protocol: 'https',
        hostname: '*.googleusercontent.com', // Indispensable pour les avatars Google Auth
        port: '',
        pathname: '/**',
      },
    ],
  },

  // S√©curit√© (Headers HTTP)
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        ],
      },
    ];
  },
};

export default nextConfig;
</file>

<file path="public/manifest.json">
{
  "name": "MagicWish",
  "short_name": "MagicWish",
  "description": "Votre wishlist et collection de cartes Magic",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/file.svg",
      "sizes": "any",
      "type": "image/svg+xml"
    }
  ]
}
</file>

<file path="app/actions/trade.ts">
// app/actions/trade.ts
'use server';

import { getAdminFirestore } from '@/lib/firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';
// AJOUT ICI : Import de z (Zod) et de CardSchema
import { z } from 'zod'; 
import { TradeExecutionSchema, ValidatedCard, CardSchema } from '@/lib/validators';

// Helper pour pr√©parer la donn√©e propre pour Firestore
const createCardData = (card: ValidatedCard) => {
    return {
        name: card.name,
        imageUrl: card.imageUrl,
        imageBackUrl: card.imageBackUrl || null,
        setName: card.setName || '',
        setCode: card.setCode || '',
        price: card.price || 0,
        quantity: card.quantity, 
        isFoil: card.isFoil || false,
        isSpecificVersion: card.isSpecificVersion || false,
        scryfallData: card.scryfallData || null,
        addedAt: FieldValue.serverTimestamp(),
        wishlistId: null,
        isForTrade: false 
    };
};

// --- ACTION 1 : √âCHANGE P2P S√âCURIS√â ---
export async function executeServerTrade(
    tradeId: string,
    senderUid: string,
    receiverUid: string,
    itemsGivenRaw: unknown,    
    itemsReceivedRaw: unknown  
) {
    const db = getAdminFirestore();

    try {
        // 1. VALIDATION STRICTE AVEC ZOD
        const validation = TradeExecutionSchema.safeParse({
            tradeId,
            senderUid,
            receiverUid,
            itemsGiven: itemsGivenRaw,
            itemsReceived: itemsReceivedRaw
        });

        if (!validation.success) {
            throw new Error("Donn√©es d'√©change invalides : " + validation.error.message);
        }

        const { itemsGiven, itemsReceived } = validation.data;

        await db.runTransaction(async (t) => {
            // PHASE 1 : TOUTES LES LECTURES
            
            // A. V√©rifier que l'√©change est toujours 'pending'
            const tradeRef = db.doc(`trades/${tradeId}`);
            const tradeSnap = await t.get(tradeRef);
            if (!tradeSnap.exists) throw new Error("√âchange introuvable");
            
            const tradeData = tradeSnap.data();
            if (tradeData?.status !== 'pending') {
                throw new Error(`Cet √©change n'est plus en attente (Status: ${tradeData?.status}).`);
            }

            // B. Lire les stocks Exp√©diteur
            const senderStockSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${senderUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                senderStockSnaps.push({ ref, card, snap });
            }

            // C. Lire les stocks Receveur
            const receiverStockSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${receiverUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                receiverStockSnaps.push({ ref, card, snap });
            }

            // D. Lire les destinations
            const senderDestSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${senderUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                senderDestSnaps.push({ ref, card, snap });
            }

            const receiverDestSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${receiverUid}/collection/${card.id}`);
                const snap = await t.get(ref);
                receiverDestSnaps.push({ ref, card, snap });
            }

            // PHASE 2 : TOUTES LES √âCRITURES

            // 1. Mise √† jour du statut de l'√©change
            t.update(tradeRef, { 
                status: 'completed',
                completedAt: FieldValue.serverTimestamp()
            });

            // 2. RETIRER les cartes de l'Exp√©diteur
            for (const item of senderStockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: ${item.card.name} manquante chez l'exp√©diteur.`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            // 3. RETIRER les cartes du Receveur
            for (const item of receiverStockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: ${item.card.name} manquante chez le partenaire.`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            // 4. AJOUTER chez l'Exp√©diteur + Clean Wishlist
            for (const item of senderDestSnaps) {
                const wishRef = db.doc(`users/${senderUid}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef); 
            }

            // 5. AJOUTER chez le Receveur + Clean Wishlist
            for (const item of receiverDestSnaps) {
                const wishRef = db.doc(`users/${receiverUid}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef);
            }
        });

        return { success: true };

    } catch (error: unknown) {
        console.error("Trade Error:", error);
        let errorMessage = "Une erreur inconnue est survenue";
        if (error instanceof Error) errorMessage = error.message;
        else if (typeof error === "string") errorMessage = error;
        return { success: false, error: errorMessage };
    }
}

// --- ACTION 2 : √âCHANGE MANUEL (SOLO) ---
export async function executeManualTrade(
    userId: string,
    itemsGivenRaw: unknown,    
    itemsReceivedRaw: unknown  
) {
    const db = getAdminFirestore();

    try {
        // Validation partielle : On utilise Zod pour valider les tableaux
        const ItemsGivenSchema = z.array(CardSchema);
        
        const parsedGiven = ItemsGivenSchema.safeParse(itemsGivenRaw);
        const parsedReceived = ItemsGivenSchema.safeParse(itemsReceivedRaw);

        if (!parsedGiven.success || !parsedReceived.success) {
             throw new Error("Donn√©es invalides pour l'√©change manuel.");
        }

        const itemsGiven = parsedGiven.data;
        const itemsReceived = parsedReceived.data;

        await db.runTransaction(async (t) => {
            // PHASE 1 : LECTURES
            const stockSnaps = [];
            for (const card of itemsGiven) {
                const ref = db.doc(`users/${userId}/collection/${card.id}`);
                const snap = await t.get(ref);
                stockSnaps.push({ ref, card, snap });
            }

            const destSnaps = [];
            for (const card of itemsReceived) {
                const ref = db.doc(`users/${userId}/collection/${card.id}`);
                const snap = await t.get(ref);
                destSnaps.push({ ref, card, snap });
            }

            // PHASE 2 : √âCRITURES
            for (const item of stockSnaps) {
                if (!item.snap.exists || (item.snap.data()?.quantity || 0) < item.card.quantity) {
                    throw new Error(`Erreur: Vous ne poss√©dez pas assez de "${item.card.name}".`);
                }
                if (item.snap.data()?.quantity === item.card.quantity) {
                    t.delete(item.ref);
                } else {
                    t.update(item.ref, { quantity: FieldValue.increment(-item.card.quantity) });
                }
            }

            for (const item of destSnaps) {
                const wishRef = db.doc(`users/${userId}/wishlist/${item.card.id}`);
                if (item.snap.exists) {
                    t.update(item.ref, { quantity: FieldValue.increment(item.card.quantity) });
                } else {
                    t.set(item.ref, createCardData(item.card));
                }
                t.delete(wishRef);
            }
        });

        return { success: true };

    } catch (error: unknown) {
        console.error("Manual Trade Error:", error);
        let errorMessage = "Erreur lors de l'√©change manuel";
        if (error instanceof Error) errorMessage = error.message;
        return { success: false, error: errorMessage };
    }
}
</file>

<file path="app/api/webhook/stripe/route.ts">
// app/api/webhook/stripe/route.ts
import { NextResponse } from 'next/server';
import { headers } from 'next/headers';
import Stripe from 'stripe';
import { getAdminFirestore } from '@/lib/firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';

export async function POST(req: Request) {
  // CORRECTION : Initialisation Lazy (au moment de la requ√™te)
  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
    apiVersion: '2025-11-17.clover',
  });

  const body = await req.text();
  const headerList = await headers();
  const signature = headerList.get('Stripe-Signature') as string;

  let event: Stripe.Event;

  try {
    event = stripe.webhooks.constructEvent(
        body, 
        signature, 
        process.env.STRIPE_WEBHOOK_SECRET!
    );
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  } catch (error: any) {
    console.error("Webhook signature failed", error.message);
    return new NextResponse(`Webhook Error: ${error.message}`, { status: 400 });
  }

  const db = getAdminFirestore();

  try {
      switch (event.type) {
        case 'checkout.session.completed': {
          const session = event.data.object as Stripe.Checkout.Session;
          const userId = session.client_reference_id; 
          
          if (userId) {
            await db.collection('users').doc(userId).set({
              isPremium: true,
              stripeCustomerId: session.customer as string,
              stripeSubscriptionId: session.subscription as string,
              premiumSince: FieldValue.serverTimestamp(),
            }, { merge: true });
            console.log(`‚úÖ User ${userId} passed Premium`);
          }
          break;
        }

        case 'customer.subscription.deleted': {
          const subscription = event.data.object as Stripe.Subscription;
          const stripeSubId = subscription.id;

          const snapshot = await db.collection('users')
            .where('stripeSubscriptionId', '==', stripeSubId)
            .get();

          if (!snapshot.empty) {
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { 
                    isPremium: false,
                    premiumEndedAt: FieldValue.serverTimestamp()
                });
            });
            await batch.commit();
            console.log(`Subscription ${stripeSubId} deleted. User downgraded.`);
          }
          break;
        }
      }
  } catch (err) {
      console.error("Firebase update error", err);
      return new NextResponse("Server Error", { status: 500 });
  }

  return NextResponse.json({ received: true });
}
</file>

<file path="app/premium/page.tsx">
// app/premium/page.tsx
'use client';

import { useAuth } from '@/lib/AuthContext';
import { usePremium } from '@/hooks/usePremium';
import { useState } from 'react';
import toast from 'react-hot-toast';
import { doc, getDoc } from 'firebase/firestore'; // Import suppl√©mentaire
import { db } from '@/lib/firebase';

export default function PremiumPage() {
    const { user } = useAuth();
    const { isPremium, loading } = usePremium();
    const [isRedirecting, setIsRedirecting] = useState(false);

    // Le lien de paiement avec le client_reference_id pour l'identification
    const paymentLink = `${process.env.NEXT_PUBLIC_STRIPE_PAYMENT_LINK}?client_reference_id=${user?.uid}`;

    // G√©rer la redirection vers le portail client Stripe pour annuler/modifier
    const handleManageSubscription = async () => {
        if (!user) return;
        setIsRedirecting(true);
        try {
            // On doit lire l'ID client Stripe stock√© dans le profil de l'utilisateur
            const docRef = await getDoc(doc(db, 'users', user.uid));
            const customerId = docRef.data()?.stripeCustomerId;

            if (!customerId) {
                toast.error("Impossible de trouver votre abonnement. Contactez le support.");
                setIsRedirecting(false);
                return;
            }

            // Appel de l'API pour g√©n√©rer le lien de gestion du portail Stripe
            const res = await fetch('/api/portal', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerId })
            });
            
            const data = await res.json();
            if (data.url) {
                window.location.href = data.url; // Redirection vers Stripe
            } else {
                throw new Error(data.error || "Erreur redirection Stripe");
            }
        } catch (e) {
            console.error(e);
            toast.error("Erreur gestion d'abonnement.");
            setIsRedirecting(false);
        }
    };

    if (loading) return <div className="p-10 text-center">Chargement...</div>;
    if (!user) return <div className="p-10 text-center">Connectez-vous pour acc√©der au Premium.</div>;

    return (
        <div className="container mx-auto p-8 text-center max-w-lg min-h-[80vh] flex flex-col justify-center">
            
            {isPremium ? (
                // --- VUE D√âJ√Ä ABONN√â ---
                <div className="bg-green-50 dark:bg-green-900/20 p-8 rounded-2xl border border-green-200 dark:border-green-800">
                    <div className="text-5xl mb-4">üíé</div>
                    <h1 className="text-3xl font-bold text-green-700 dark:text-green-400 mb-2">Vous √™tes Premium !</h1>
                    <p className="text-gray-600 dark:text-gray-300 mb-6">
                        Merci de soutenir le projet.
                    </p>
                    <button 
                        onClick={handleManageSubscription}
                        disabled={isRedirecting}
                        className="text-sm text-gray-500 underline hover:text-gray-700 dark:hover:text-gray-200 font-medium"
                    >
                        {isRedirecting ? 'Chargement...' : 'G√©rer mon abonnement / Annuler'}
                    </button>
                </div>
            ) : (
                // --- VUE VENTE ---
                <>
                    <h1 className="text-4xl font-bold mb-4 bg-linear-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Passez Premium
                    </h1>
                    <p className="mb-8 text-gray-600 dark:text-gray-300 text-lg">
                        Soutenez le d√©veloppement pour 1‚Ç¨ / mois.
                    </p>
                    
                    <ul className="text-left bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-8 space-y-4">
                        <li className="flex items-center gap-3">
                            <span className="bg-green-100 text-green-700 p-1 rounded-full text-xs">‚úì</span>
                            <span>Plus aucune publicit√©</span>
                        </li>
                        <li className="flex items-center gap-3">
                            <span className="bg-purple-100 text-purple-700 p-1 rounded-full text-xs">‚ô•</span>
                            <span className="font-bold">Juste 1,00 ‚Ç¨ / mois</span>
                        </li>
                    </ul>

                    <a 
                        href={paymentLink} 
                        className="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-105 transition transform"
                    >
                        Devenir Premium (1‚Ç¨)
                    </a>
                    <p className="text-xs text-gray-400 mt-4">Paiement s√©curis√© par Stripe.</p>
                </>
            )}
        </div>
    );
}
</file>

<file path="components/ThemeToggle.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useTheme } from 'next-themes';

export default function ThemeToggle() {
  const [mounted, setMounted] = useState(false);
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    // Petit hack pour satisfaire le linter et √©viter l'erreur de setState synchrone
    // On force l'ex√©cution au prochain cycle d'√©v√©nement
    const timer = setTimeout(() => {
        setMounted(true);
    }, 0);
    return () => clearTimeout(timer);
  }, []);

  // Si pas encore mont√© (c√¥t√© serveur), on renvoie un carr√© vide
  if (!mounted) {
    return <div className="w-9 h-9 p-2" />; 
  }

  return (
    <button
      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
      className="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-yellow-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
      title="Changer de th√®me"
      aria-label="Changer de th√®me"
    >
      {theme === 'dark' ? (
        // LUNE
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
          <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
        </svg>
      ) : (
        // SOLEIL
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 text-orange-500">
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
        </svg>
      )}
    </button>
  );
}
</file>

<file path="components/wishlist/GlobalWishlistView.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { WishlistMeta } from '@/hooks/useWishlists';
import { CardType } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import { db } from '@/lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import toast from 'react-hot-toast';

type Props = {
    lists: WishlistMeta[];
};

export default function GlobalWishlistView({ lists }: Props) {
    const { user } = useAuth();
    const [allCards, setAllCards] = useState<(CardType & { sourceListName: string })[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user || lists.length === 0) return;

        const fetchAll = async () => {
            setLoading(true);
            let combined: (CardType & { sourceListName: string })[] = [];

            try {
                // A. Liste par d√©faut
                const defaultRef = collection(db, 'users', user.uid, 'wishlist');
                const defaultSnap = await getDocs(defaultRef);
                const defaultCards = defaultSnap.docs.map(d => ({ 
                    ...d.data(), id: d.id, sourceListName: 'Liste principale' 
                })) as (CardType & { sourceListName: string })[];
                combined = [...defaultCards];

                // B. Listes customs
                const customLists = lists.filter(l => l.id !== 'default');
                const promises = customLists.map(async (list) => {
                    const colRef = collection(db, 'users', user.uid, 'wishlists_data', list.id, 'cards');
                    const snap = await getDocs(colRef);
                    return snap.docs.map(d => ({
                        ...d.data(),
                        id: d.id,
                        sourceListName: list.name
                    })) as (CardType & { sourceListName: string })[];
                });

                const results = await Promise.all(promises);
                results.forEach(res => {
                    combined = [...combined, ...res];
                });

                setAllCards(combined);
            } catch (error) {
                console.error("Erreur chargement global", error);
                toast.error("Erreur chargement global");
            } finally {
                setLoading(false);
            }
        };

        fetchAll();
    }, [user, lists]);

    const globalTotal = useMemo(() => {
        return allCards.reduce((acc, card) => acc + (card.price || 0) * card.quantity, 0);
    }, [allCards]);

    if (loading) return <div className="p-10 text-center animate-pulse">Fusion des listes en cours...</div>;

    return (
        <div className="animate-in fade-in duration-300">
             <div className="flex justify-between items-end mb-6 border-b pb-4 dark:border-gray-700 bg-linear-to-r from-blue-50 to-transparent dark:from-blue-900/20 p-4 rounded-t-xl">
                <div>
                    <h2 className="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                        üåç Vue Globale
                    </h2>
                    <p className="text-sm text-gray-500 mt-1">
                        Toutes vos cartes fusionn√©es ({allCards.length} cartes distinctes)
                    </p>
                </div>
                <div className="text-right">
                    <span className="text-xs text-gray-500 uppercase font-semibold">Valeur Totale</span>
                    <p className="text-3xl font-bold text-blue-600 dark:text-blue-400">{globalTotal.toFixed(2)} ‚Ç¨</p>
                </div>
            </div>

            {allCards.length === 0 ? (
                <div className="text-center py-12">
                    <p className="text-gray-500 italic">Aucune carte trouv√©e.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {allCards.map((card, idx) => (
                        <div key={`${card.id}-${idx}`} className="relative group">
                            <div className="absolute top-0 right-0 z-30 bg-black/70 text-white text-[10px] px-2 py-1 rounded-bl-lg backdrop-blur-sm pointer-events-none">
                                {card.sourceListName}
                            </div>
                            <MagicCard {...card} isWishlist={false} />
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="hooks/usePremium.ts">
// hooks/usePremium.ts
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, onSnapshot } from 'firebase/firestore';
import { useState, useEffect } from 'react';

export function usePremium() {
  const { user } = useAuth();
  const [isPremium, setIsPremium] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
        // eslint-disable-next-line react-hooks/set-state-in-effect
        setIsPremium(false);
        setLoading(false);
        return;
    }

    // √âcoute en temps r√©el les changements sur le document utilisateur
    const unsub = onSnapshot(doc(db, 'users', user.uid), (docSnap) => {
        // Le Webhook Stripe met √† jour ce champ
        setIsPremium(docSnap.data()?.isPremium === true);
        setLoading(false);
    }, (error) => {
        console.error("Erreur check premium", error);
        setLoading(false);
    });

    return () => unsub();
  }, [user]);

  return { isPremium, loading };
}
</file>

<file path="app/api/portal/route.ts">
// app/api/portal/route.ts
import { NextResponse } from 'next/server';
import Stripe from 'stripe';

export async function POST(req: Request) {
    try {
        // On initialise Stripe ICI, √† l'int√©rieur de la fonction
        // Cela √©vite de faire planter le build si la cl√© n'est pas encore l√†
        const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
            apiVersion: '2025-11-17.clover', 
        });

        const body = await req.json();
        const { customerId } = body; 

        if (!customerId) {
             return NextResponse.json({ error: "Customer ID manquant" }, { status: 400 });
        }

        const session = await stripe.billingPortal.sessions.create({
            customer: customerId,
            return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/premium`,
        });

        return NextResponse.json({ url: session.url });
        
    } catch (err: unknown) {
        console.error("Erreur cr√©ation portail Stripe:", err);
        let errorMessage = "Erreur serveur";
        if (err instanceof Error) errorMessage = err.message;
        else if (typeof err === 'string') errorMessage = err;
        return NextResponse.json({ error: errorMessage }, { status: 500 });
    }
}
</file>

<file path="app/api/search/route.ts">
// app/api/search/route.ts
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const query = searchParams.get('q'); 

  if (!query) {
    return NextResponse.json(
      { error: 'Aucun terme de recherche fourni.' }, 
      { status: 400 } 
    );
  }

  // --- CORRECTION : Suppression des guillemets pour permettre la recherche partielle ---
  // On utilise encodeURIComponent pour g√©rer proprement les espaces et caract√®res sp√©ciaux
  const scryfallUrl = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&unique=prints`;

  try {
    const scryfallResponse = await fetch(scryfallUrl);

    if (!scryfallResponse.ok) {
      const errorData = await scryfallResponse.json();
      console.error('Erreur Scryfall:', errorData);
      return NextResponse.json(
        { error: errorData.details || 'Carte non trouv√©e' }, 
        { status: scryfallResponse.status }
      );
    }

    const data = await scryfallResponse.json();
    return NextResponse.json(data);

  } catch (error) {
    console.error('Erreur interne du serveur:', error);
    return NextResponse.json(
      { error: 'Une erreur est survenue sur le serveur.' }, 
      { status: 500 }
    );
  }
}
</file>

<file path="app/layout.tsx">
// app/layout.tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { AuthProvider } from '@/lib/AuthContext';
import { ThemeProvider } from '@/components/ThemeProvider';
import Header from '@/components/Header'; 
import { Toaster } from 'react-hot-toast';
import UsernameSetupModal from '@/components/UsernameSetupModal'; 

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'MagicWish',
  description: 'Votre wishlist de cartes Magic',
  manifest: '/manifest.json',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="fr" suppressHydrationWarning>
      <body className={inter.className}>
        <ThemeProvider 
            attribute="class" 
            defaultTheme="light"      // Force le mode clair
            enableSystem={false}      // Ignore les pr√©f√©rences de l'ordinateur
            disableTransitionOnChange // √âvite les flashs de couleur au chargement
        >
          <AuthProvider>
            <Header />
            {children}
            <UsernameSetupModal />
            <Toaster position="bottom-right" />
          </AuthProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}
</file>

<file path="app/trades/new/[uid]/page.tsx">
// app/trades/new/[uid]/page.tsx
'use client';

import { useState, use, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import { useTradeSystem } from '@/hooks/useTradeSystem';
import { db } from '@/lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import { useRouter } from 'next/navigation';
import toast from 'react-hot-toast';

export default function DirectTradePage({ params }: { params: Promise<{ uid: string }> }) {
  const unwrappedParams = use(params);
  const targetUid = unwrappedParams.uid;

  const { user } = useAuth();
  const router = useRouter();
  const { proposeTrade } = useTradeSystem();

  // --- CHARGEMENT ---
  const { cards: myCollection, loading: loadingMe } = useCardCollection('collection');
  const { cards: friendCollection, loading: loadingHim } = useCardCollection('collection', 'default', targetUid);

  // --- √âTATS ---
  const [targetName, setTargetName] = useState('L\'ami');
  const [toGive, setToGive] = useState<CardType[]>([]);
  const [toReceive, setToReceive] = useState<CardType[]>([]);
  const [searchMe, setSearchMe] = useState('');
  const [searchHim, setSearchHim] = useState('');

  useEffect(() => {
    const fetchName = async () => {
        try {
            const snap = await getDoc(doc(db, 'users', targetUid, 'public_profile', 'info'));
            if(snap.exists()) setTargetName(snap.data().displayName || snap.data().username);
        } catch(e) { console.error(e); }
    };
    if (targetUid) fetchName();
  }, [targetUid]);

  // --- ACTIONS ---
  const handleSelectCard = (card: CardType, listType: 'give' | 'receive') => {
    const targetList = listType === 'give' ? toGive : toReceive;
    const setTarget = listType === 'give' ? setToGive : setToReceive;
    const existing = targetList.find(c => c.id === card.id);
    const maxStock = card.quantity;
    const currentSelected = existing ? existing.quantity : 0;

    if (currentSelected < maxStock) {
        if (existing) {
            setTarget(prev => prev.map(c => c.id === card.id ? { ...c, quantity: c.quantity + 1 } : c));
        } else {
            setTarget(prev => [...prev, { ...card, quantity: 1 }]);
        }
    } else {
        toast.error("Stock maximum atteint");
    }
  };

  const handleRemoveCard = (cardId: string, listType: 'give' | 'receive') => {
    const setTarget = listType === 'give' ? setToGive : setToReceive;
    setTarget(prev => prev.filter(c => c.id !== cardId));
  };

  const handlePropose = async () => {
    if (toGive.length === 0 && toReceive.length === 0) return;
    const success = await proposeTrade(targetUid, targetName, toGive, toReceive);
    if (success) router.push('/trades'); 
  };

  // CALCULS
  const valGive = toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const valReceive = toReceive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const balance = valGive - valReceive;

  if (!user) return <div className="p-10 text-center">Connexion requise.</div>;

  return (
    <div className="container mx-auto p-4 h-[calc(100vh-64px)] flex flex-col">
        
        {/* HEADER */}
        <div className="flex-none flex items-center gap-4 mb-4">
            <button onClick={() => router.back()} className="text-gray-500 hover:text-gray-700 bg-gray-100 px-3 py-1 rounded-lg text-sm">
                ‚Üê Retour
            </button>
            <h1 className="text-2xl font-bold truncate">
                √âchange avec <span className="text-blue-600">{targetName}</span>
            </h1>
        </div>

        {/* GRILLE PRINCIPALE */}
        <div className="grid lg:grid-cols-2 gap-6 grow overflow-hidden pb-24">
            
            {/* --- COLONNE GAUCHE (MOI) --- */}
            <div className="flex flex-col h-full bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                     <h2 className="font-bold text-red-600 mb-2">üì§ Je donne (Ma Collection)</h2>
                     <input 
                        type="text" 
                        placeholder="Filtrer ma collection..." 
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={searchMe}
                        onChange={e => setSearchMe(e.target.value)}
                    />
                </div>
                
                {/* LISTE D√âFILANTE UNIQUE (S√©lectionn√©s en haut, Dispos en bas) */}
                <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    
                    {/* S√âLECTIONN√âS */}
                    {toGive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800 overflow-hidden">
                            <div className="bg-red-100 dark:bg-red-900/30 px-3 py-1 text-xs font-bold text-red-700 dark:text-red-300">
                                S√âLECTION ({toGive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toGive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => handleRemoveCard(card.id, 'give')} className="text-red-500 hover:bg-red-50 rounded px-2">‚úï</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* DISPONIBLES */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Mon Classeur d&apos;√©change</p>
                        {loadingMe ? <p className="text-sm">Chargement...</p> : 
                            myCollection
                                .filter(c => c.isForTrade) // <--- FILTRE AJOUT√â ICI
                                .filter(c => c.name.toLowerCase().includes(searchMe.toLowerCase()))
                                .slice(0, 50) 
                                .map(card => (
                                    <div key={card.id} onClick={() => handleSelectCard(card, 'give')} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-red-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden relative">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                            {card.isForTrade && <div className="absolute bottom-0 right-0 bg-green-500 text-white text-[8px] px-1">ü§ù</div>}
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Dispo: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-red-500 transition-colors shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                {/* TOTAL COLONNE GAUCHE (Fixe en bas de colonne) */}
                <div className="flex-none bg-red-50 dark:bg-red-900/20 p-3 border-t border-red-100 dark:border-red-900 text-center">
                    <span className="text-xs text-red-600 dark:text-red-400 font-bold uppercase">Total Donn√©</span>
                    <div className="text-xl font-bold text-red-700 dark:text-red-300">{valGive.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>

            {/* --- COLONNE DROITE (AMI) --- */}
            <div className="flex flex-col h-full bg-blue-50/50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-blue-600 mb-2">üì• Je re√ßois (Sa Collection)</h2>
                    <input 
                        type="text" 
                        placeholder={`Filtrer chez ${targetName}...`}
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={searchHim}
                        onChange={e => setSearchHim(e.target.value)}
                    />
                </div>

                {/* LISTE D√âFILANTE UNIQUE */}
                <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                     {/* S√âLECTIONN√âS */}
                     {toReceive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-800 overflow-hidden">
                            <div className="bg-blue-100 dark:bg-blue-900/30 px-3 py-1 text-xs font-bold text-blue-700 dark:text-blue-300">
                                S√âLECTION ({toReceive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toReceive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => handleRemoveCard(card.id, 'receive')} className="text-red-500 hover:bg-red-50 rounded px-2">‚úï</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* DISPONIBLES */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Son Classeur d&apos;√©change</p>
                        {loadingHim ? <p className="text-sm">Chargement...</p> : 
                            friendCollection
                                .filter(c => c.isForTrade) // FILTRE D√âJ√Ä PR√âSENT
                                .filter(c => c.name.toLowerCase().includes(searchHim.toLowerCase()))
                                .slice(0, 50)
                                .map(card => (
                                    <div key={card.id} onClick={() => handleSelectCard(card, 'receive')} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-blue-100 dark:hover:bg-blue-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-blue-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden relative">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                            <div className="absolute bottom-0 right-0 bg-green-500 text-white text-[8px] px-1">ü§ù</div>
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Dispo: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-blue-500 transition-colors shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                {/* TOTAL COLONNE DROITE (Fixe en bas de colonne) */}
                <div className="flex-none bg-blue-50 dark:bg-blue-900/20 p-3 border-t border-blue-100 dark:border-blue-900 text-center">
                    <span className="text-xs text-blue-600 dark:text-blue-400 font-bold uppercase">Total Re√ßu</span>
                    <div className="text-xl font-bold text-blue-700 dark:text-blue-300">{valReceive.toFixed(2)} ‚Ç¨</div>
                </div>
            </div>
        </div>

        {/* FOOTER PRINCIPAL AVEC BALANCE CENTR√âE */}
        <div className="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-900 border-t dark:border-gray-800 flex items-center px-6 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            
            {/* Espace vide √† gauche pour l'√©quilibre */}
            <div className="flex-1"></div>

            {/* BALANCE CENTRALE */}
            <div className="flex-1 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-widest">Valeur R√©siduelle</span>
                <div className={`text-2xl font-black ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {balance > 0 ? '+' : ''}{balance.toFixed(2)} ‚Ç¨
                </div>
            </div>

            {/* BOUTON D'ACTION √Ä DROITE */}
            <div className="flex-1 flex justify-end">
                <button 
                    onClick={handlePropose}
                    disabled={toGive.length === 0 && toReceive.length === 0}
                    className="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 transition shadow-lg transform active:scale-95 flex items-center gap-2"
                >
                    <span>üöÄ</span> Proposer
                </button>
            </div>
        </div>

    </div>
  );
}
</file>

<file path="components/CollectionToolsModal.tsx">
// components/CollectionToolsModal.tsx
'use client';

import { useState } from 'react';
import AdContainer from './AdContainer';

type CollectionToolsModalProps = {
  isOpen: boolean;
  onClose: () => void;
  onRefreshPrices: () => Promise<void>;
  onBulkTrade: (action: 'excess' | 'all' | 'reset', threshold?: number) => void;
  totalCards: number;
};

export default function CollectionToolsModal({ 
    isOpen, onClose, onRefreshPrices, onBulkTrade, totalCards 
}: CollectionToolsModalProps) {
  
  const [threshold, setThreshold] = useState(4);
  const [isRefreshing, setIsRefreshing] = useState(false);

  if (!isOpen) return null;

  const handleRefresh = async () => {
      setIsRefreshing(true);
      await onRefreshPrices();
      setIsRefreshing(false);
  };

  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" onClick={onClose}>
      <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700" onClick={e => e.stopPropagation()}>
        
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold flex items-center gap-2 text-gray-900 dark:text-white">
                ‚öôÔ∏è Gestion Collection
            </h2>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">‚úï</button>
        </div>

        <div className="space-y-8">
            
            {/* SECTION 1 : CLASSEUR D'√âCHANGE */}
            <div>
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">Automatisations √âchange</h3>
                
                {/* Option Playset */}
                <div className="bg-green-50 dark:bg-green-900/10 p-3 rounded-xl border border-green-100 dark:border-green-800 mb-3">
                    <label className="text-sm font-medium text-gray-800 dark:text-gray-200 mb-2 block">
                        Mettre en √©change le surplus (Playset)
                    </label>
                    <div className="flex gap-2">
                        <div className="flex items-center bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-2">
                            <span className="text-xs text-gray-500 mr-2">Qt√© &gt;</span>
                            <input 
                                type="number" 
                                min="1" 
                                max="100" 
                                value={threshold} 
                                onChange={(e) => setThreshold(parseInt(e.target.value) || 4)}
                                className="w-10 text-center font-bold outline-none bg-transparent text-gray-900 dark:text-white"
                            />
                        </div>
                        <button 
                            onClick={() => onBulkTrade('excess', threshold)}
                            className="grow bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 rounded-lg transition"
                        >
                            Appliquer
                        </button>
                    </div>
                    <p className="text-[10px] text-gray-500 mt-2">
                        Exemple : Si Qt√© &gt; 4, la carte est marqu√©e &quot;Disponible √† l&apos;√©change&quot;.
                    </p>
                </div>

                {/* Actions Rapides */}
                <div className="grid grid-cols-2 gap-3">
                    <button 
                        onClick={() => onBulkTrade('all')}
                        className="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 text-gray-700 dark:text-gray-200 rounded-lg text-xs font-bold transition"
                    >
                        Tout mettre en Trade
                    </button>
                    <button 
                        onClick={() => onBulkTrade('reset')}
                        className="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-red-100 hover:text-red-600 text-gray-700 dark:text-gray-200 rounded-lg text-xs font-bold transition"
                    >
                        Tout retirer (Reset)
                    </button>
                </div>
            </div>

            {/* SECTION 2 : ACTUALISATION */}
            <div>
                <h3 className="text-sm font-bold text-gray-500 uppercase mb-3 border-b border-gray-200 dark:border-gray-700 pb-1">Donn√©es & Prix</h3>
                
                {isRefreshing && (
                    <div className="mb-4">
                        <AdContainer /> {/* <--- LA PUB APPARAIT PENDANT L'ATTENTE */}
                        <p className="text-center text-sm text-blue-600 animate-pulse mt-2">
                            Analyse des prix en cours...
                        </p>
                    </div>
                )}
                
                <button 
                    onClick={handleRefresh}
                    disabled={isRefreshing}
                    className="w-full bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/20 dark:hover:bg-blue-900/40 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-800 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2"
                >
                    {isRefreshing ? 'Mise √† jour en cours...' : 'üîÑ Actualiser Scryfall (Prix)'}
                </button>
                <p className="text-[10px] text-gray-400 text-center mt-2">
                    Met √† jour les prix et informations de vos {totalCards} cartes.
                </p>
            </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="hooks/useFriends.ts">
// hooks/useFriends.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { useAuth } from '@/lib/AuthContext';
import { 
  doc, setDoc, deleteDoc, 
  collection, onSnapshot, serverTimestamp, 
  query, collectionGroup, where, getDocs, limit,
  writeBatch // <--- C'√©tait l'import manquant
} from 'firebase/firestore';
import { acceptFriendRequestAction } from '@/app/actions/friends';
import toast from 'react-hot-toast';

export type FriendProfile = {
  uid: string;
  username: string;
  displayName: string;
  photoURL?: string; 
};

type FirestoreProfileData = {
    username: string;
    displayName: string;
    photoURL?: string;
    [key: string]: unknown;
};

export function useFriends() {
  const { user, username } = useAuth();
  
  const [friends, setFriends] = useState<FriendProfile[]>([]);
  const [requestsReceived, setRequestsReceived] = useState<FriendProfile[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setFriends(prev => prev.length > 0 ? [] : prev);
      setRequestsReceived(prev => prev.length > 0 ? [] : prev);
      setLoading(prev => prev ? false : prev);
      return;
    }

    const friendsRef = collection(db, 'users', user.uid, 'friends');
    const unsubFriends = onSnapshot(friendsRef, (snap) => {
      const list = snap.docs.map(d => d.data() as FriendProfile);
      setFriends(list);
    });

    const reqRef = collection(db, 'users', user.uid, 'friend_requests_received');
    const unsubReq = onSnapshot(reqRef, (snap) => {
      const list = snap.docs.map(d => ({ uid: d.id, ...d.data() } as FriendProfile));
      setRequestsReceived(list);
    });

    setLoading(false);

    return () => {
      unsubFriends();
      unsubReq();
    };
  }, [user]);

  // --- ACTIONS ---

  const searchUsers = async (searchTerm: string) => {
    const term = searchTerm.trim().toLowerCase();
    if (term.length < 2) return [];

    const usersQuery = query(
      collectionGroup(db, 'public_profile'), 
      where('username', '>=', term),
      where('username', '<=', term + '\uf8ff'),
      limit(5)
    );

    const snapshot = await getDocs(usersQuery);
    
    const results: FriendProfile[] = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data() as FirestoreProfileData;
      const foundUid = docSnap.ref.parent.parent?.id;

      if (foundUid && foundUid !== user?.uid) {
        results.push({
            uid: foundUid,
            username: data.username,
            displayName: data.displayName,
            photoURL: data.photoURL
        });
      }
    });

    return results;
  };

  const sendFriendRequest = async (targetUser: FriendProfile) => {
    if (!user || !username) return;

    if (friends.some(f => f.uid === targetUser.uid)) {
      toast.error("Vous √™tes d√©j√† amis !");
      return;
    }

    try {
      await setDoc(doc(db, 'users', targetUser.uid, 'friend_requests_received', user.uid), {
        uid: user.uid,
        username: username,
        displayName: user.displayName,
        photoURL: user.photoURL || null,
        sentAt: serverTimestamp()
      });
      
      toast.success(`Demande envoy√©e √† @${targetUser.username}`);
    } catch (error) {
      console.error(error);
      toast.error("Erreur lors de l'envoi.");
    }
  };

  const acceptRequest = async (sender: FriendProfile) => {
    if (!user) return;

    const toastId = toast.loading("Acceptation...");

    try {
        const cleanSender = {
            ...sender,
            photoURL: sender.photoURL || null
        };

        const result = await acceptFriendRequestAction(user.uid, cleanSender);

        if (result.success) {
            toast.success(`Ami ajout√© : @${sender.username}`, { id: toastId });
        } else {
            throw new Error(result.error);
        }
    } catch (err: unknown) {
      console.error(err);
      let msg = "Erreur validation";
      if (err instanceof Error) msg = err.message;
      toast.error(msg, { id: toastId });
    }
  };

  const declineRequest = async (senderUid: string) => {
    if (!user) return;
    try {
        await deleteDoc(doc(db, 'users', user.uid, 'friend_requests_received', senderUid));
        toast.success("Demande supprim√©e");
    } catch (error) {
        console.error(error);
        toast.error("Erreur lors du refus");
    }
  };
  
  // Suppression avec nettoyage complet (n√©cessite writeBatch)
  const removeFriend = async (friendUid: string) => {
      if(!user) return;
      if(!confirm("Retirer cet ami d√©finitivement ?")) return;
      
      try {
        const batch = writeBatch(db);
        
        // 1. Supprimer de MA liste
        batch.delete(doc(db, 'users', user.uid, 'friends', friendUid));
        
        // 2. Me supprimer de SA liste (Le "Unfriend" r√©ciproque)
        // La r√®gle de s√©curit√© 'allow delete' doit √™tre d√©ploy√©e pour que cela fonctionne
        batch.delete(doc(db, 'users', friendUid, 'friends', user.uid));

        await batch.commit();
        
        toast.success("Ami retir√© (Liaison coup√©e)");
      } catch (error) {
        console.error("Erreur suppression ami:", error);
        toast.error("Erreur lors de la suppression");
      }
  };

  return { 
    friends, 
    requestsReceived, 
    loading, 
    searchUsers, 
    sendFriendRequest, 
    acceptRequest, 
    declineRequest, 
    removeFriend
  };
}
</file>

<file path="lib/AuthContext.tsx">
'use client';

import { createContext, useContext, useEffect, useState, useMemo } from 'react';
import { 
  onAuthStateChanged, 
  signInWithPopup, 
  GoogleAuthProvider, 
  signOut, 
  User 
} from 'firebase/auth';
import { doc, onSnapshot, collection } from 'firebase/firestore'; 
import { auth, db } from './firebase'; 
import toast from 'react-hot-toast';

type AuthContextType = {
  user: User | null;
  username: string | null;
  loading: boolean;
  friendRequestCount: number; // Compteur pour les notifications
  signInWithGoogle: () => Promise<void>;
  logOut: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType>({
  user: null,
  username: null,
  loading: true,
  friendRequestCount: 0,
  signInWithGoogle: async () => {},
  logOut: async () => {},
});

export const useAuth = () => useContext(AuthContext);

export const AuthProvider = ({ children }: { children: React.ReactNode }) => {
  const [user, setUser] = useState<User | null>(null);
  const [username, setUsername] = useState<string | null>(null);
  const [friendRequestCount, setFriendRequestCount] = useState(0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);

      if (currentUser) {
        // 1. √âcoute du Pseudo (Profil Public)
        const profileRef = doc(db, 'users', currentUser.uid, 'public_profile', 'info');
        const unsubProfile = onSnapshot(profileRef, (docSnap) => {
          if (docSnap.exists()) {
            setUsername(docSnap.data().username);
          } else {
            setUsername(null);
          }
          // On ne met loading √† false qu'ici pour √™tre s√ªr d'avoir le username
          setLoading(false);
        });

        // 2. √âcoute des Demandes d'amis (Notifications)
        const requestsRef = collection(db, 'users', currentUser.uid, 'friend_requests_received');
        const unsubRequests = onSnapshot(requestsRef, (snap) => {
          setFriendRequestCount(snap.docs.length);
        });

        // Nettoyage quand l'utilisateur change ou se d√©connecte
        return () => {
          unsubProfile();
          unsubRequests();
        };
      } else {
        setUsername(null);
        setFriendRequestCount(0);
        setLoading(false);
      }
    });

    return () => unsubscribeAuth();
  }, []);

  const signInWithGoogle = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      toast.success('Connexion r√©ussie !');
    } catch (error: unknown) {
      // Gestion propre des erreurs sans 'any'
      if (error && typeof error === 'object' && 'code' in error) {
          const firebaseError = error as { code: string; message: string };
          
          // Ignorer si l'utilisateur a ferm√© la popup ou cliqu√© deux fois (conflit)
          if (firebaseError.code === 'auth/cancelled-popup-request' || 
              firebaseError.code === 'auth/popup-closed-by-user') {
              console.warn("Processus de connexion annul√© par l'utilisateur.");
              return; 
          }
      }

      console.error(error);
      toast.error("Erreur lors de la connexion Google");
    }
  };

  const logOut = async () => {
    try {
      await signOut(auth);
      toast.success('D√©connect√©');
    } catch (error) {
      console.error(error);
      toast.error("Erreur d√©connexion");
    }
  };

  const value = useMemo(() => ({
    user,
    username,
    friendRequestCount,
    loading,
    signInWithGoogle,
    logOut
  }), [user, username, loading, friendRequestCount]);

  return (
    <AuthContext.Provider value={value}>
      {children}
    </AuthContext.Provider>
  );
};
</file>

<file path="components/wishlist/SingleWishlistView.tsx">
// components/wishlist/SingleWishlistView.tsx
'use client';

import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import MagicCard from '@/components/MagicCard';
import toast from 'react-hot-toast';
import { moveCardFromWishlistToCollection } from '@/lib/services/collectionService'; // <--- Import du Service

type Props = {
    listId: string;
    listName: string;
};

export default function SingleWishlistView({ listId, listName }: Props) {
    const { cards, loading, updateQuantity, removeCard, toggleAttribute, totalPrice } = useCardCollection('wishlist', listId);
    const { user } = useAuth();
    
    const moveToCollection = async (card: CardType) => {
        if (!user) return;
        const toastId = toast.loading("D√©placement...");
        
        // Utilisation du service d√©di√© (Code propre et r√©utilisable)
        const result = await moveCardFromWishlistToCollection(user.uid, card, listId);

        if (result.success) {
            toast.success("Ajout√©e √† la collection !", { id: toastId });
        } else {
            toast.error(result.error || "Erreur technique", { id: toastId });
        }
    };

    if (loading) return <div className="p-10 text-center text-gray-500">Chargement des cartes...</div>;

    return (
        <div className="animate-in fade-in duration-300">
            <div className="flex justify-between items-end mb-6 border-b pb-4 dark:border-gray-700">
                <h2 className="text-2xl font-bold text-gray-800 dark:text-white">{listName}</h2>
                <div className="text-right">
                    <span className="text-xs text-gray-500 uppercase font-semibold">Total estim√©</span>
                    <p className="text-2xl font-bold text-green-600 dark:text-green-400">{totalPrice.toFixed(2)} ‚Ç¨</p>
                </div>
            </div>

            {cards.length === 0 ? (
                <div className="text-center py-12 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                    <p className="text-gray-500 italic">Cette liste est vide.</p>
                </div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {cards.map(card => (
                        <MagicCard 
                            key={card.id} 
                            {...card} 
                            isWishlist={true}
                            onIncrement={() => updateQuantity(card.id, 1, card.quantity)}
                            onDecrement={() => {
                                if(card.quantity === 1) { if(confirm("Supprimer ?")) removeCard(card.id); } 
                                else { updateQuantity(card.id, -1, card.quantity); }
                            }}
                            onMove={() => moveToCollection(card)}
                            onToggleAttribute={(field, val) => toggleAttribute(card.id, field, val)}
                        />
                    ))}
                </div>
            )}
        </div>
    );
}
</file>

<file path="lib/cardUtils.ts">
// lib/cardUtils.ts

// D√©finition stricte des champs Scryfall que nous utilisons
// Cela √©vite les crashs si l'API change ou si on acc√®de √† un champ inexistant
export type ScryfallRawData = {
  id: string;
  name: string;
  set: string;
  set_name: string;
  collector_number: string;
  released_at?: string;
  image_uris?: {
    small?: string;
    normal?: string;
    large?: string;
    png?: string;
  };
  card_faces?: Array<{
    name: string;
    image_uris?: {
      normal?: string;
    };
  }>;
  prices?: {
    eur?: string;
    eur_foil?: string;
    usd?: string;
  };
  finishes?: string[]; // 'foil', 'nonfoil', 'etched'
  // On autorise d'autres champs inconnus sans casser le typage strict ci-dessus
  [key: string]: unknown;
};

export const normalizeCardData = (data: ScryfallRawData) => {
  // Gestion des noms pour les cartes doubles (ex: "Malakir Rebirth // Malakir Mire")
  const rawName = data.name;
  const name = rawName.split(' // ')[0]; 

  let imageUrl = "";
  let imageBackUrl: string | null = null;

  // CAS 1 : Carte standard (image √† la racine)
  if (data.image_uris?.normal) {
    imageUrl = data.image_uris.normal;
  } 
  // CAS 2 : Carte double face (Transform, Modal DFC, etc.)
  else if (data.card_faces && data.card_faces.length > 0) {
    // Face Avant
    if (data.card_faces[0].image_uris?.normal) {
      imageUrl = data.card_faces[0].image_uris.normal;
    }
    
    // Face Arri√®re (si elle a une image)
    if (data.card_faces[1] && data.card_faces[1].image_uris?.normal) {
      imageBackUrl = data.card_faces[1].image_uris.normal;
    }
  }

  // Fallback si aucune image trouv√©e (Card Back par d√©faut)
  if (!imageUrl) {
    imageUrl = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";
  }

  return {
    id: data.id,
    scryfallId: data.id,
    name,
    imageUrl,
    imageBackUrl, // Sera string ou null (jamais undefined)
    setName: data.set_name,
    setCode: data.set,
    price: parseFloat(data.prices?.eur || "0"),
    scryfallData: data // On garde la donn√©e brute
  };
};
</file>

<file path="package.json">
{
  "name": "magicwish",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@types/papaparse": "^5.5.1",
    "firebase": "^12.5.0",
    "firebase-admin": "^13.6.0",
    "next": "^16.0.8",
    "next-themes": "^0.4.6",
    "papaparse": "^5.5.3",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-hot-toast": "^2.6.0",
    "stripe": "^20.0.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

:root {
  /* --- PALETTE DE BASE (Mode Clair) --- */
  
  /* Fond principal de la page */
  --background: #f4f6fc; 
  /* Texte principal */
  --foreground: #27272a; /* Zinc-800 */

  /* Surfaces (Cartes, Header, Modales) */
  --surface: #ffffff;
  --surface-foreground: #27272a;

  /* Bordures */
  --border: #e4e4e7; /* Zinc-200 */

  /* COULEUR PRIMAIRE (Ton Bleu #6275b3) */
  --primary: #6275b3;
  --primary-foreground: #ffffff;

  /* COULEUR SECONDAIRE (Pour les accents doux) */
  --secondary: #eef2ff; /* Indigo-50 modifi√© */
  --secondary-foreground: #6275b3;

  /* √âL√âMENTS D'√âTAT */
  --muted: #a1a1aa; /* Zinc-400 */
  --danger: #ef4444; /* Red-500 */
  --success: #10b981; /* Emerald-500 */
}

.dark {
  /* --- PALETTE MODE SOMBRE --- */
  --background: #09090b; /* Zinc-950 */
  --foreground: #f4f4f5; /* Zinc-100 */

  --surface: #18181b; /* Zinc-900 */
  --surface-foreground: #f4f4f5;

  --border: #27272a; /* Zinc-800 */

  /* On garde le m√™me bleu ou on l'√©claircit l√©g√®rement pour le contraste sombre */
  --primary: #7a8bc9; 
  --primary-foreground: #ffffff;

  --secondary: #1e1b4b; /* Indigo-950 */
  --secondary-foreground: #a5b4fc;
}

/* --- CONFIGURATION TAILWIND --- */
@theme inline {
  /* On mappe les variables CSS aux classes Tailwind */
  
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  
  --color-surface: var(--surface);
  --color-surface-foreground: var(--surface-foreground);
  
  --color-border: var(--border);

  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);

  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);

  --color-muted: var(--muted);
  --color-danger: var(--danger);
  --color-success: var(--success);

  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  -webkit-font-smoothing: antialiased;
}

@layer components {
  /* Bouton standard utilisant la variable Primary */
  .btn-primary {
    @apply bg-primary text-primary-foreground font-bold py-2 px-4 rounded-lg shadow-sm transition-transform active:scale-95 hover:opacity-90;
  }
}
</file>

<file path="app/search/page.tsx">
'use client';

import { useState, useMemo } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, setDoc, increment, serverTimestamp } from 'firebase/firestore';
import { ScryfallRawData } from '@/lib/cardUtils';
import { CardType } from '@/hooks/useCardCollection';
import { useWishlists } from '@/hooks/useWishlists';
import CardVersionPickerModal from '@/components/CardVersionPickerModal';
import toast from 'react-hot-toast';

export default function SearchPage() {
  const { user } = useAuth();
  const { lists } = useWishlists();
  
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<ScryfallRawData[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);

  const [modalOpen, setModalOpen] = useState(false);
  const [selectedBaseCard, setSelectedBaseCard] = useState<ScryfallRawData | null>(null);
  const [targetDestination, setTargetDestination] = useState<'collection' | 'wishlist'>('collection');

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!query.trim()) return;
    setIsSearching(true);
    setHasSearched(true);
    setResults([]);
    try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data.data) setResults(data.data);
        else toast.error("Aucune carte trouvee.");
    } catch (error) { console.error(error); toast.error("Erreur de recherche."); } 
    finally { setIsSearching(false); }
  };

  const openPicker = (card: ScryfallRawData, destination: 'collection' | 'wishlist') => {
      setSelectedBaseCard(card);
      setTargetDestination(destination);
      setModalOpen(true);
  };

  const handleConfirmAdd = async (card: CardType, targetListId: string = 'default') => {
      if (!user) return;
      const destLabel = targetDestination === 'collection' ? 'Collection' : 'Wishlist';
      const toastId = toast.loading(`Ajout a : ${destLabel}...`);
      try {
          let collectionPath = 'collection';
          if (targetDestination === 'wishlist') {
              if (targetListId === 'default') collectionPath = 'wishlist';
              else collectionPath = `wishlists_data/${targetListId}/cards`;
          }
          const cardRef = doc(db, 'users', user.uid, collectionPath, card.id);
          const dataToSave = {
              ...card, imageBackUrl: card.imageBackUrl || null, addedAt: serverTimestamp(),
              wishlistId: targetDestination === 'wishlist' ? targetListId : null, isForTrade: false 
          };
          await setDoc(cardRef, { ...dataToSave, quantity: increment(card.quantity) }, { merge: true });
          toast.success(`Ajoute avec succes !`, { id: toastId });
      } catch (error) { console.error(error); toast.error("Erreur ajout", { id: toastId }); }
  };

  const uniqueResults = useMemo(() => {
    const seen = new Set();
    return results.filter(c => {
        const name = c.name.split(' // ')[0];
        if (seen.has(name)) return false;
        seen.add(name);
        return true;
    });
  }, [results]);

  return (
    <main className="container mx-auto p-4 max-w-5xl min-h-[85vh]">
      
      <div className="text-center mb-8 pt-4">
          <h1 className="text-3xl font-bold text-[#6275b3] mb-2">
              Centre de Recherche
          </h1>
          <p className="text-zinc-500">
              Trouvez n&apos;importe quelle carte et ajoutez-la a votre Collection ou votre Wishlist.
          </p>
      </div>

      <div className="max-w-2xl mx-auto mb-10 sticky top-4 z-20">
          <form onSubmit={handleSearch} className="relative shadow-lg rounded-full">
              <input 
                  type="text" 
                  className="w-full p-4 pl-6 pr-14 rounded-full border border-zinc-200 bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-white focus:border-[#6275b3] focus:ring-2 focus:ring-[#6275b3]/20 outline-none transition text-lg"
                  placeholder="Nom de la carte (ex: Black Lotus, Sol Ring...)"
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  autoFocus
              />
              <button 
                  type="submit"
                  disabled={isSearching || !query.trim()}
                  className="absolute right-2 top-2 bottom-2 bg-[#6275b3] hover:bg-[#53639c] text-white rounded-full w-12 flex items-center justify-center transition disabled:opacity-50"
              >
                  {isSearching ? '...' : 'Go'}
              </button>
          </form>
      </div>

      {isSearching ? (
          <div className="text-center py-20">
              <div className="inline-block w-8 h-8 border-4 border-[#6275b3] border-t-transparent rounded-full animate-spin mb-4"></div>
              <p className="text-zinc-400">Recherche en cours...</p>
          </div>
      ) : uniqueResults.length > 0 ? (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
              {uniqueResults.map((card) => (
                  <div key={card.id} className="bg-white dark:bg-zinc-800 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-700 overflow-hidden flex flex-col group hover:shadow-md transition">
                      <div className="relative aspect-[2.5/3.5] bg-zinc-200 overflow-hidden">
                          {card.image_uris?.normal ? (
                              <img src={card.image_uris.normal} alt={card.name} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                          ) : (
                             <div className="flex items-center justify-center h-full text-zinc-400 text-xs">Pas d&apos;image</div>
                          )}
                          
                          <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4">
                              <button 
                                  onClick={() => openPicker(card, 'collection')}
                                  className="w-full bg-[#6275b3] hover:bg-[#53639c] text-white font-bold py-2 rounded-lg text-sm shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300"
                              >
                                  + Collection
                              </button>
                              <button 
                                  onClick={() => openPicker(card, 'wishlist')}
                                  className="w-full bg-white text-[#6275b3] font-bold py-2 rounded-lg text-sm shadow-lg transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 delay-75"
                              >
                                  + Wishlist
                              </button>
                          </div>
                      </div>

                      <div className="p-3">
                          <h3 className="font-bold text-zinc-900 dark:text-white truncate" title={card.name}>{card.name}</h3>
                          <p className="text-xs text-zinc-500">{card.set_name}</p>
                      </div>
                  </div>
              ))}
          </div>
      ) : hasSearched ? (
          <div className="text-center py-20 bg-zinc-50 dark:bg-zinc-800/50 rounded-2xl border-2 border-dashed border-zinc-200 dark:border-zinc-700">
              <p className="text-xl text-zinc-500">Aucun r√©sultat trouv√©.</p>
          </div>
      ) : (
          <div className="grid md:grid-cols-2 gap-4 max-w-3xl mx-auto opacity-50 hover:opacity-100 transition-opacity">
               <div className="p-6 border-2 border-dashed border-zinc-200 dark:border-zinc-700 rounded-xl text-center">
                   <span className="text-4xl mb-2 block font-bold text-zinc-300">COLLECTION</span>
                   <h3 className="font-bold text-zinc-600 dark:text-zinc-400">Compl√©ter ma Collection</h3>
               </div>
               <div className="p-6 border-2 border-dashed border-zinc-200 dark:border-zinc-700 rounded-xl text-center">
                   <span className="text-4xl mb-2 block font-bold text-zinc-300">WISHLIST</span>
                   <h3 className="font-bold text-zinc-600 dark:text-zinc-400">Remplir ma Wishlist</h3>
               </div>
          </div>
      )}

      <CardVersionPickerModal 
          isOpen={modalOpen}
          onClose={() => setModalOpen(false)}
          baseCard={selectedBaseCard}
          onConfirm={handleConfirmAdd}
          destination={targetDestination}
          availableLists={lists}
      />

    </main>
  );
}
</file>

<file path="hooks/useTradeMatcher.ts">
// hooks/useTradeMatcher.ts
import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { collection, getDocs, doc, writeBatch, query, where } from 'firebase/firestore'; 
import { useWishlists, WishlistMeta } from './useWishlists'; 
import { useFriends, FriendProfile } from './useFriends';
import { CardType } from './useCardCollection';

export type TradeProposal = {
  friend: FriendProfile;
  toReceive: CardType[]; 
  toGive: CardType[];    
  balance: number;       
};

// Typage strict pour la r√©ponse de l'API Scryfall dans refreshPrices
type ScryfallPriceUpdate = {
    id: string;
    prices: {
        eur: string | null;
        usd: string | null;
    };
};

type ScryfallCollectionResponse = {
    data: ScryfallPriceUpdate[];
    not_found?: unknown[];
    object: string;
};

export function useTradeMatcher() {
  const { user } = useAuth();
  const { lists } = useWishlists();
  const { friends } = useFriends();
  
  const [proposals, setProposals] = useState<TradeProposal[]>([]);
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState("");

  // --- 1. CHARGEMENT OPTIMIS√â (Avec filtrage 'isForTrade' c√¥t√© serveur) ---
  const fetchCardsAsMap = async (
      uid: string, 
      mode: 'collection' | 'wishlist', 
      userLists: WishlistMeta[] = [],
      onlyTradeable: boolean = false // <--- Nouveau param√®tre d'optimisation
  ) => {
    const cardsMap = new Map<string, CardType>();

    try {
        if (mode === 'collection') {
            const colRef = collection(db, 'users', uid, 'collection');
            
            // OPTIMISATION : Si on ne veut que les √©changes, on filtre via Firestore (√©conomie de lectures)
            let q;
            if (onlyTradeable) {
                q = query(colRef, where('isForTrade', '==', true));
            } else {
                q = colRef;
            }

            const snap = await getDocs(q);
            snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
        } else {
            // Charge la liste par d√©faut
            const defSnap = await getDocs(collection(db, 'users', uid, 'wishlist'));
            defSnap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
            
            // Charge les listes customs en parall√®le
            if (userLists.length > 0) {
                const listPromises = userLists
                    .filter(l => l.id !== 'default')
                    .map(list => getDocs(collection(db, 'users', uid, 'wishlists_data', list.id, 'cards')));
                
                const snapshots = await Promise.all(listPromises);
                snapshots.forEach(snap => {
                    snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
                });
            } else {
                // Fallback si pas de userLists fournies (pour les amis) : on lit les m√©tadonn√©es
                const metaSnap = await getDocs(collection(db, 'users', uid, 'wishlists_meta'));
                const listPromises = metaSnap.docs.map(m => getDocs(collection(db, 'users', uid, 'wishlists_data', m.id, 'cards')));
                const snapshots = await Promise.all(listPromises);
                snapshots.forEach(snap => {
                     snap.forEach(d => cardsMap.set(d.id, { id: d.id, ...d.data() } as CardType));
                });
            }
        }
    } catch (e) {
        console.error(`Erreur chargement ${mode} pour ${uid}`, e);
    }
    return cardsMap;
  };

  // --- 2. MISE √Ä JOUR PRIX CIBL√âE (CORRIG√âE & STRICTE) ---
  const refreshPricesForProposals = async (currentProposals: TradeProposal[], myUid: string) => {
     // On extrait toutes les cartes uniques impliqu√©es
     const cardsToUpdateMap = new Map<string, { card: CardType, ownerUid: string, collection: string }>();

     currentProposals.forEach(p => {
         // IMPORTANT: On ne mettra pas √† jour les cartes de l'ami ici car on n'a pas les droits d'√©criture
         p.toReceive.forEach(c => cardsToUpdateMap.set(`${p.friend.uid}_${c.id}`, { card: c, ownerUid: p.friend.uid, collection: 'collection' }));
         p.toGive.forEach(c => cardsToUpdateMap.set(`${myUid}_${c.id}`, { card: c, ownerUid: myUid, collection: 'collection' }));
     });

     const updatesArray = Array.from(cardsToUpdateMap.values());
     if (updatesArray.length === 0) return;

     // On traite par paquets de 75 (limite Scryfall)
     const chunks = [];
     for (let i = 0; i < updatesArray.length; i += 75) {
         chunks.push(updatesArray.slice(i, i + 75));
     }

     const batch = writeBatch(db); 
     let hasUpdates = false;

     for (const chunk of chunks) {
         try {
             // On ne demande √† Scryfall que les IDs
             const identifiers = chunk.map(item => ({ id: item.card.id }));
             
             const res = await fetch('https://api.scryfall.com/cards/collection', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ identifiers })
             });

             if (!res.ok) continue;

             // Typage strict de la r√©ponse
             const data = await res.json() as ScryfallCollectionResponse;
             const foundCards = data.data || [];

             foundCards.forEach(scryCard => {
                 const newPrice = parseFloat(scryCard.prices.eur || "0");
                 
                 // On retrouve les cartes locales qui correspondent √† cet ID Scryfall
                 const localMatches = chunk.filter(item => item.card.id === scryCard.id);

                 localMatches.forEach(match => {
                     // Update m√©moire (ref) pour l'affichage imm√©diat
                     if (match.card.price !== newPrice) {
                         match.card.price = newPrice;
                         
                         // Update Firestore : UNIQUEMENT SI C'EST MA CARTE
                         if (match.ownerUid === myUid) {
                             const ref = doc(db, 'users', match.ownerUid, match.collection, match.card.id);
                             batch.update(ref, { price: newPrice });
                             hasUpdates = true;
                         }
                     }
                 });
             });
         } catch (e) { console.error("Err price fetch batch", e); }
     }

     if (hasUpdates) {
         await batch.commit();
     }
  };

  // --- 3. ALGORITHME PRINCIPAL ---
  const runScan = async () => {
    if (!user || friends.length === 0) return;
    setLoading(true);
    setStatus("Chargement de vos donn√©es...");

    try {
        // A. Charger MES donn√©es
        // OPTIMISATION: Pour ma collection, je ne charge que ce qui est "For Trade"
        const [myCollectionMap, myWishlistMap] = await Promise.all([
            fetchCardsAsMap(user.uid, 'collection', [], true), 
            fetchCardsAsMap(user.uid, 'wishlist', lists)
        ]);

        // B. Indexation de MA Wishlist (Set pour O(1))
        const myWishlistIds = new Set<string>();
        const myWishlistNames = new Set<string>();
        myWishlistMap.forEach(c => {
            if (c.isSpecificVersion) myWishlistIds.add(c.id);
            else myWishlistNames.add(c.name);
        });

        // C. Indexation de MON Trade Binder
        // Note: myCollectionMap ne contient d√©j√† QUE les cartes isForTrade gr√¢ce au filtre Firestore
        const myTradeCards = Array.from(myCollectionMap.values());

        setStatus(`Analyse simultan√©e de ${friends.length} amis...`);

        // D. SCAN PARALL√àLE DES AMIS
        const matchPromises = friends.map(async (friend) => {
            // OPTIMISATION: On ne charge que les cartes √©changeables de l'ami
            const [friendCollectionMap, friendWishlistMap] = await Promise.all([
                fetchCardsAsMap(friend.uid, 'collection', [], true),
                fetchCardsAsMap(friend.uid, 'wishlist')
            ]);

            const toReceive: CardType[] = [];
            const toGive: CardType[] = [];

            // 1. Check ce que JE re√ßois (Sa Collection [d√©j√† filtr√©e Trade] vs Ma Wishlist)
            friendCollectionMap.forEach(card => {
                // Le check isForTrade est redondant ici si le serveur a bien filtr√©, mais on garde par s√©curit√©
                if (card.isForTrade) { 
                    if (myWishlistIds.has(card.id) || myWishlistNames.has(card.name)) {
                        toReceive.push(card);
                    }
                }
            });

            // 2. Check ce que JE donne (Ma Collection vs Sa Wishlist)
            const friendWishlistIds = new Set<string>();
            const friendWishlistNames = new Set<string>();
            friendWishlistMap.forEach(c => {
                if (c.isSpecificVersion) friendWishlistIds.add(c.id);
                else friendWishlistNames.add(c.name);
            });

            myTradeCards.forEach(card => {
                if (friendWishlistIds.has(card.id) || friendWishlistNames.has(card.name)) {
                    toGive.push(card);
                }
            });

            if (toReceive.length > 0 || toGive.length > 0) {
                return {
                    friend,
                    toReceive,
                    toGive,
                    balance: 0 
                } as TradeProposal;
            }
            return null;
        });

        const results = await Promise.all(matchPromises);
        const validProposals = results.filter((p): p is TradeProposal => p !== null);

        // E. MISE √Ä JOUR DES PRIX (Seulement pour les cartes match√©es)
        if (validProposals.length > 0) {
            setStatus("Actualisation des prix...");
            await refreshPricesForProposals(validProposals, user.uid);
            
            validProposals.forEach(p => {
                const valReceive = p.toReceive.reduce((sum, c) => sum + (c.customPrice ?? c.price ?? 0), 0);
                const valGive = p.toGive.reduce((sum, c) => sum + (c.customPrice ?? c.price ?? 0), 0);
                p.balance = valGive - valReceive;
            });
        }

        setProposals(validProposals);

    } catch (error) {
        console.error("Erreur scan", error);
    } finally {
        setLoading(false);
        setStatus("");
    }
  };

  return { proposals, loading, status, runScan };
}
</file>

<file path="hooks/useTradeSystem.ts">
// hooks/useTradeSystem.ts
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { 
  collection, query, where, onSnapshot, 
  doc, updateDoc, orderBy, 
  Timestamp
} from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import { CardType } from './useCardCollection';
import { executeServerTrade } from '@/app/actions/trade'; 
import { proposeTradeAction } from '@/app/actions/trade-proposal'; // <--- IMPORT
import toast from 'react-hot-toast';

export type TradeStatus = 'pending' | 'completed' | 'rejected' | 'cancelled';

export type TradeRequest = {
  id: string;
  senderUid: string;
  senderName: string;
  receiverUid: string;
  receiverName: string;
  itemsGiven: CardType[];
  itemsReceived: CardType[];
  status: TradeStatus;
  createdAt: Timestamp;
};

// Fonction utilitaire pour convertir les CardType du client vers le format attendu par le serveur
// (G√®re les incompatibilit√©s de types strictes si n√©cessaire)
const mapCardsForServer = (cards: CardType[]) => {
    return cards.map(c => ({
        ...c,
        imageBackUrl: c.imageBackUrl || null,
        scryfallData: (c.scryfallData as Record<string, unknown>) || null
    }));
};

export function useTradeSystem() {
  const { user, username } = useAuth();
  
  const [incomingTrades, setIncomingTrades] = useState<TradeRequest[]>([]);
  const [outgoingTrades, setOutgoingTrades] = useState<TradeRequest[]>([]);
  const [loading, setLoading] = useState(true);
  const [isProcessing, setIsProcessing] = useState(false);

  useEffect(() => {
    if (!user) return;

    const qIn = query(
      collection(db, 'trades'),
      where('receiverUid', '==', user.uid),
      where('status', '==', 'pending'),
      orderBy('createdAt', 'desc')
    );

    const qOut = query(
      collection(db, 'trades'),
      where('senderUid', '==', user.uid),
      where('status', '==', 'pending'),
      orderBy('createdAt', 'desc')
    );

    const unsubIn = onSnapshot(qIn, (snap) => {
      setIncomingTrades(snap.docs.map(d => ({ id: d.id, ...d.data() } as TradeRequest)));
    });

    const unsubOut = onSnapshot(qOut, (snap) => {
      setOutgoingTrades(snap.docs.map(d => ({ id: d.id, ...d.data() } as TradeRequest)));
      setLoading(false);
    });

    return () => { unsubIn(); unsubOut(); };
  }, [user]);

  const proposeTrade = async (receiverUid: string, receiverName: string, toGive: CardType[], toReceive: CardType[]) => {
    if (!user) return false;
    const toastId = toast.loading("Envoi de la proposition...");

    try {
      // Pr√©paration des donn√©es pour la Server Action
      const payload = {
          senderUid: user.uid,
          senderName: username || user.displayName || 'Inconnu',
          receiverUid,
          receiverName,
          itemsGiven: mapCardsForServer(toGive),
          itemsReceived: mapCardsForServer(toReceive)
      };

      // Appel de la Server Action
      const result = await proposeTradeAction(payload);

      if (result.success) {
          toast.success("Proposition envoy√©e !", { id: toastId });
          return true;
      } else {
          throw new Error(result.error);
      }

    } catch (e: unknown) {
      console.error("Erreur proposeTrade:", e);
      let msg = "Erreur envoi";
      if (e instanceof Error) msg = e.message;
      toast.error(msg, { id: toastId });
      return false;
    }
  };

  const acceptTrade = async (trade: TradeRequest) => {
    if (!user) return;
    
    setIsProcessing(true);
    const toastId = toast.loading("Validation s√©curis√©e en cours...");

    try {
        // executeServerTrade attend toujours CardType[], on passe directement
        const result = await executeServerTrade(
            trade.id, 
            trade.senderUid,
            user.uid, 
            trade.itemsGiven,
            trade.itemsReceived
        );

        if (result.success) {
            toast.success("√âchange termin√© avec succ√®s !", { id: toastId });
        } else {
            throw new Error(result.error || "Erreur serveur inconnue");
        }

    } catch (error: unknown) { 
        console.error("Erreur Accept Trade:", error);
        let msg = "√âchec de l'√©change";
        if (error instanceof Error) msg = error.message;
        else if (typeof error === "string") msg = error;
        toast.error(msg, { id: toastId });
    } finally {
        setIsProcessing(false);
    }
  };

  const rejectTrade = async (tradeId: string) => {
    if(!confirm("Refuser cet √©change ?")) return;
    try {
        await updateDoc(doc(db, 'trades', tradeId), { status: 'rejected' });
        toast.success("√âchange refus√©");
    } catch (error) {
        console.error(error);
        toast.error("Erreur");
    }
  };

  const cancelTrade = async (tradeId: string) => {
    if(!confirm("Annuler cette proposition ?")) return;
    try {
        await updateDoc(doc(db, 'trades', tradeId), { status: 'cancelled' });
        toast.success("Proposition annul√©e");
    } catch (error) {
        console.error(error);
        toast.error("Erreur");
    }
  };

  return { 
    incomingTrades, outgoingTrades, loading, 
    proposeTrade, acceptTrade, rejectTrade, cancelTrade,
    isProcessing 
  };
}
</file>

<file path="app/contacts/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { useAuth } from '@/lib/AuthContext';
import { useFriends, FriendProfile } from '@/hooks/useFriends';
import toast from 'react-hot-toast';

const PLANESWALKERS = [
  "Jace", "Liliana", "Chandra", "Ajani", "Garruk", 
  "Teferi", "Nissa", "Gideon", "Nicol_Bolas", "Ugin"
];

export default function ContactsPage() {
  const { user } = useAuth();
  const { 
    friends, requestsReceived, loading,
    searchUsers, sendFriendRequest, acceptRequest, declineRequest, removeFriend
  } = useFriends();

  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<FriendProfile[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [randomPlaceholder, setRandomPlaceholder] = useState("ex: Jace...");

  useEffect(() => {
    const randomName = PLANESWALKERS[Math.floor(Math.random() * PLANESWALKERS.length)];
    setRandomPlaceholder(`ex: ${randomName} (pour trouver ${randomName.toLowerCase()}_fan...)`);
  }, []);

  if (!user) return <div className="p-10 text-center">Veuillez vous connecter.</div>;

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!searchQuery.trim()) return;
    setIsSearching(true);
    setSearchResults([]);
    try {
      const results = await searchUsers(searchQuery);
      setSearchResults(results);
      if (results.length === 0) toast("Aucun utilisateur trouve");
    } catch (err) { console.error(err); toast.error("Erreur recherche"); }
    finally { setIsSearching(false); }
  };

  return (
    <main className="container mx-auto p-4 max-w-4xl min-h-[80vh]">
      <h1 className="text-3xl font-bold mb-8 text-[#6275b3] flex items-center gap-2">
        Mes Contacts
      </h1>

      <div className="grid md:grid-cols-2 gap-8">
        <div className="space-y-8">
            <div className="bg-white dark:bg-zinc-900 p-6 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-700">
                <h2 className="font-bold text-lg mb-4 text-zinc-800 dark:text-white">Chercher un ami</h2>
                <form onSubmit={handleSearch} className="flex gap-2 mb-4">
                    <div className="relative grow">
                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400">@</span>
                        <input 
                            type="text" 
                            placeholder={randomPlaceholder} 
                            className="w-full pl-7 p-2 border rounded-lg bg-zinc-50 dark:bg-zinc-950 dark:border-zinc-700 outline-none focus:ring-2 focus:ring-[#6275b3] lowercase text-zinc-900 dark:text-white"
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value.toLowerCase())}
                        />
                    </div>
                    <button type="submit" disabled={isSearching} className="bg-[#6275b3] hover:bg-[#53639c] text-white px-4 py-2 rounded-lg font-bold transition disabled:opacity-50">
                        {isSearching ? '...' : 'Chercher'}
                    </button>
                </form>
                <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                    {searchResults.map(result => (
                        <div key={result.uid} className="flex items-center justify-between bg-blue-50 dark:bg-blue-900/10 p-3 rounded-lg border border-blue-100 dark:border-blue-900/30 animate-in fade-in">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 rounded-full bg-[#6275b3] flex items-center justify-center text-white font-bold text-xs overflow-hidden relative">
                                    {result.photoURL ? <Image src={result.photoURL} alt="" fill className="object-cover" /> : result.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <p className="font-bold text-sm text-zinc-900 dark:text-white">{result.displayName}</p>
                                    <p className="text-xs text-[#6275b3]">@{result.username}</p>
                                </div>
                            </div>
                            <button onClick={() => sendFriendRequest(result)} className="text-xs bg-[#6275b3] text-white px-3 py-1.5 rounded-full hover:bg-[#53639c] transition shadow-sm">Ajouter</button>
                        </div>
                    ))}
                </div>
            </div>

            {requestsReceived.length > 0 && (
                <div className="bg-white dark:bg-zinc-900 p-6 rounded-xl shadow-sm border border-orange-200 dark:border-orange-900/50 animate-in slide-in-from-left-4">
                    <h2 className="font-bold text-lg mb-4 text-orange-600 dark:text-orange-400 flex items-center gap-2">
                        Demandes re√ßues <span className="bg-orange-100 text-orange-800 text-xs px-2 py-0.5 rounded-full">{requestsReceived.length}</span>
                    </h2>
                    <div className="space-y-3">
                        {requestsReceived.map(req => (
                            <div key={req.uid} className="flex items-center justify-between p-3 bg-zinc-50 dark:bg-zinc-800/50 rounded-lg">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-zinc-200 overflow-hidden relative">
                                        {req.photoURL ? <Image src={req.photoURL} alt="" fill className="object-cover" /> : <span className="flex items-center justify-center h-full font-bold text-zinc-500">{req.username[0].toUpperCase()}</span>}
                                    </div>
                                    <div>
                                        <p className="font-bold text-sm text-zinc-900 dark:text-white">{req.displayName}</p>
                                        <p className="text-xs text-zinc-500">@{req.username}</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => acceptRequest(req)} className="p-2 bg-green-100 text-green-700 hover:bg-green-200 rounded-full transition">V</button>
                                    <button onClick={() => declineRequest(req.uid)} className="p-2 bg-red-100 text-red-700 hover:bg-red-200 rounded-full transition">X</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>

        <div className="bg-white dark:bg-zinc-900 p-6 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-700 h-fit">
            <h2 className="font-bold text-lg mb-4 flex items-center gap-2 text-zinc-800 dark:text-white">
                Mes Amis <span className="text-zinc-400 font-normal">({friends.length})</span>
            </h2>
            {loading ? <p className="text-zinc-500 text-sm">Chargement...</p> : friends.length === 0 ? (
                <div className="text-center py-10 text-zinc-400 italic"><p>Aucun ami pour l&apos;instant.</p></div>
            ) : (
                <div className="space-y-2">
                    {friends.map(friend => (
                        <div key={friend.uid} className="group flex items-center justify-between p-3 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 rounded-lg transition border border-transparent hover:border-zinc-200 dark:hover:border-zinc-700">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-[#6275b3] flex items-center justify-center text-white font-bold shadow-sm overflow-hidden relative">
                                    {friend.photoURL ? <Image src={friend.photoURL} alt="" fill className="object-cover" /> : friend.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <p className="font-bold text-zinc-800 dark:text-zinc-200">{friend.displayName}</p>
                                    <p className="text-xs text-zinc-500">@{friend.username}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                <Link href={`/user/${friend.uid}`} className="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded hover:bg-blue-200 transition font-medium">Voir</Link>
                                <Link href={`/trades/new/${friend.uid}`} className="text-xs bg-purple-100 text-purple-700 px-3 py-1.5 rounded hover:bg-purple-200 transition font-medium flex items-center gap-1">Echanger</Link>
                                <button onClick={() => removeFriend(friend.uid)} className="text-red-400 hover:text-red-600 text-xs px-2 py-1">X</button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
      </div>
    </main>
  );
}
</file>

<file path="app/trades/manual/page.tsx">
'use client';

import { useState, useMemo, useTransition } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection, CardType } from '@/hooks/useCardCollection';
import { executeManualTrade } from '@/app/actions/trade'; // <--- Import de la Server Action
import toast from 'react-hot-toast';
import CardVersionPickerModal from '@/components/CardVersionPickerModal';
import { ScryfallRawData } from '@/lib/cardUtils';

export default function ManualTradePage() {
  const { user } = useAuth();
  const { cards: myCollection, loading } = useCardCollection('collection'); 
  
  // useTransition g√®re l'√©tat "pending" pendant que le serveur travaille
  const [isPending, startTransition] = useTransition();

  const [toGive, setToGive] = useState<CardType[]>([]);
  const [toReceive, setToReceive] = useState<CardType[]>([]);
  
  const [localSearch, setLocalSearch] = useState('');
  
  const [remoteSearch, setRemoteSearch] = useState('');
  const [searchResults, setSearchResults] = useState<ScryfallRawData[]>([]);
  const [isSearching, setIsSearching] = useState(false);

  const [cardToPick, setCardToPick] = useState<ScryfallRawData | null>(null);

  const handleAddToGive = (card: CardType) => {
      const existing = toGive.find(c => c.id === card.id);
      if (existing) {
          if (existing.quantity < card.quantity) { 
              setToGive(prev => prev.map(c => c.id === card.id ? { ...c, quantity: c.quantity + 1 } : c));
          } else {
              toast.error("Stock max atteint");
          }
      } else {
          setToGive(prev => [...prev, { ...card, quantity: 1 }]);
      }
  };

  const handleSearchScryfall = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!remoteSearch.trim()) return;
      setIsSearching(true);
      try {
          const res = await fetch(`/api/search?q=${remoteSearch}`); 
          const data = await res.json();
          setSearchResults(data.data || []);
      } catch (e) { toast.error("Erreur recherche"); }
      finally { setIsSearching(false); }
  };

  const handleSearchResultClick = (scryfallCard: ScryfallRawData) => {
    setCardToPick(scryfallCard);
  };

  const handleConfirmReceive = (card: CardType) => {
      const existing = toReceive.find(c => c.id === card.id && c.isFoil === card.isFoil); 
      
      if (existing) {
          setToReceive(prev => prev.map(c => 
              (c.id === card.id && c.isFoil === card.isFoil) 
              ? { ...c, quantity: c.quantity + card.quantity } 
              : c
          ));
      } else {
          setToReceive(prev => [...prev, card]);
      }
      
      setSearchResults([]); 
      setRemoteSearch("");
      toast.success(`Ajout√© : ${card.name}`);
  };

  // --- NOUVELLE LOGIQUE DE VALIDATION S√âCURIS√âE ---
  const handleValidate = async () => {
      if (!user) return;
      if (toGive.length === 0 && toReceive.length === 0) return;
      if (!confirm("Confirmer cet √©change ? Vos cartes donn√©es seront retir√©es de votre collection.")) return;

      const toastId = toast.loading("Validation s√©curis√©e...");

      startTransition(async () => {
        // On appelle le serveur
        const result = await executeManualTrade(user.uid, toGive, toReceive);
        
        if (result.success) {
            toast.success("Echange valid√© !", { id: toastId });
            setToGive([]);
            setToReceive([]);
            setLocalSearch("");
        } else {
            toast.error(result.error || "Erreur lors de l'√©change", { id: toastId });
        }
      });
  };

  const valGive = toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0) * c.quantity, 0);
  const valReceive = toReceive.reduce((acc, c) => acc + (c.price || 0) * c.quantity, 0);

  const uniqueSearchResults = useMemo(() => {
    const seen = new Set();
    return searchResults.filter(card => {
      const rawName = card.name || "";
      const name = rawName.split(' // ')[0];
      if (seen.has(name)) return false;
      seen.add(name);
      return true;
    });
  }, [searchResults]);

  if (!user) return <div className="p-10 text-center">Connectez-vous.</div>;

  return (
    <div className="container mx-auto p-4 h-[calc(100vh-64px)] flex flex-col">
        
        <h1 className="text-2xl font-bold mb-4 flex-none flex items-center gap-2">
            √âchange Manuel / Externe
        </h1>

        <div className="grid lg:grid-cols-2 gap-6 grow overflow-hidden pb-24">
            
            {/* COLONNE GAUCHE : JE DONNE */}
            <div className="flex flex-col h-full bg-red-50/50 dark:bg-red-900/10 rounded-xl border border-red-100 dark:border-red-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-red-600 mb-2">Je donne (De ma collection)</h2>
                    <input 
                        type="text" 
                        placeholder="Chercher dans ma collection..." 
                        className="w-full p-2 mb-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                        value={localSearch}
                        onChange={e => setLocalSearch(e.target.value)}
                    />
                </div>
                
                 <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    {/* Liste des cartes s√©lectionn√©es */}
                    {toGive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-red-200 dark:border-red-800 overflow-hidden">
                            <div className="bg-red-100 dark:bg-red-900/30 px-3 py-1 text-xs font-bold text-red-700 dark:text-red-300">
                                S√âLECTION ({toGive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toGive.map(card => (
                                <div key={card.id} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <span className="truncate">{card.quantity}x {card.name}</span>
                                    <button onClick={() => setToGive(p => p.filter(c => c.id !== card.id))} className="text-red-500 hover:bg-red-50 rounded px-1">X</button>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Liste de la collection */}
                    <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ma Collection</p>
                        {loading ? <p className="text-sm">Chargement...</p> : 
                            myCollection
                                .filter(c => c.name.toLowerCase().includes(localSearch.toLowerCase()))
                                .slice(0, 50)
                                .map(card => (
                                    <div key={card.id} onClick={() => handleAddToGive(card)} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-red-100 dark:hover:bg-red-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-red-200 transition shadow-sm group">
                                        <div className="w-8 h-11 bg-gray-200 rounded shrink-0 overflow-hidden">
                                            <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                                        </div>
                                        <div className="grow min-w-0">
                                            <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                            <p className="text-[10px] text-gray-500">{card.setName} - Stock: {card.quantity}</p>
                                        </div>
                                        <span className="text-xs font-bold text-gray-400 group-hover:text-red-500 shrink-0">+</span>
                                    </div>
                                ))
                        }
                    </div>
                </div>

                <div className="flex-none bg-red-50 dark:bg-red-900/20 p-3 border-t border-red-100 dark:border-red-900 text-center">
                    <span className="text-xs text-red-600 dark:text-red-400 font-bold uppercase">Total Donn√©</span>
                    <div className="text-xl font-bold text-red-700 dark:text-red-300">{valGive.toFixed(2)} EUR</div>
                </div>
            </div>

            {/* COLONNE DROITE : JE RE√áOIS */}
            <div className="flex flex-col h-full bg-green-50/50 dark:bg-green-900/10 rounded-xl border border-green-100 dark:border-green-900 overflow-hidden relative shadow-sm">
                <div className="p-4 pb-0 flex-none">
                    <h2 className="font-bold text-green-600 mb-2">Je re√ßois (Ajout libre)</h2>
                    <form onSubmit={handleSearchScryfall} className="flex gap-2 mb-2">
                        <input 
                            type="text" 
                            placeholder="Rechercher carte √† recevoir..." 
                            className="grow p-2 rounded border dark:bg-gray-800 dark:text-white dark:border-gray-600 text-sm"
                            value={remoteSearch}
                            onChange={e => setRemoteSearch(e.target.value)}
                        />
                        <button type="submit" className="bg-green-600 hover:bg-green-700 text-white px-3 rounded shadow-sm">V</button>
                    </form>
                </div>

                 <div className="grow overflow-y-auto custom-scrollbar p-4 pt-0 space-y-4">
                    
                    {toReceive.length > 0 && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg border border-green-200 dark:border-green-800 overflow-hidden">
                            <div className="bg-green-100 dark:bg-green-900/30 px-3 py-1 text-xs font-bold text-green-700 dark:text-green-300">
                                S√âLECTION ({toReceive.reduce((a,c)=>a+c.quantity,0)})
                            </div>
                            {toReceive.map((card, idx) => (
                                <div key={`${card.id}-${idx}`} className="flex justify-between items-center text-sm p-2 border-b dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <span className="font-bold shrink-0">{card.quantity}x</span>
                                        <div className="flex flex-col truncate">
                                            <span className="dark:text-gray-200 truncate">{card.name}</span>
                                            <span className="text-[10px] text-gray-500 truncate">
                                                {card.setName} {card.isFoil && 'Foil'}
                                            </span>
                                        </div>
                                    </div>
                                    <button onClick={() => setToReceive(p => p.filter((_, i) => i !== idx))} className="text-red-500 hover:bg-red-50 rounded px-1 ml-2">X</button>
                                </div>
                            ))}
                        </div>
                    )}

                     <div className="space-y-1">
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">R√©sultats Scryfall</p>
                        {isSearching && <p className="text-xs text-center py-4">Recherche...</p>}
                        
                        {uniqueSearchResults.map(card => (
                            <div key={card.id} onClick={() => handleSearchResultClick(card)} className="cursor-pointer bg-white dark:bg-gray-800/50 hover:bg-green-100 dark:hover:bg-green-900/30 p-2 rounded flex items-center gap-2 border border-transparent hover:border-green-200 transition shadow-sm group">
                                 <div className="w-8 h-11 bg-gray-200 rounded overflow-hidden shrink-0">
                                    {card.image_uris?.small && <img src={card.image_uris.small} className="w-full h-full object-cover" alt="" />}
                                 </div>
                                 <div className="grow min-w-0">
                                    <p className="font-bold text-xs truncate dark:text-gray-200">{card.name}</p>
                                    <p className="text-[10px] text-gray-500 italic">S√©lectionner version...</p>
                                 </div>
                                 <span className="text-xs font-bold text-gray-400 group-hover:text-green-500 shrink-0">Choisir</span>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="flex-none bg-green-50 dark:bg-green-900/20 p-3 border-t border-green-100 dark:border-green-900 text-center">
                    <span className="text-xs text-green-600 dark:text-green-400 font-bold uppercase">Total Re√ßu</span>
                    <div className="text-xl font-bold text-green-700 dark:text-green-300">{valReceive.toFixed(2)} EUR</div>
                </div>
            </div>
        </div>

        <div className="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-900 border-t dark:border-gray-800 flex justify-between items-center px-6 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            
            <div className="flex-1"></div>

            <div className="flex-1 flex flex-col items-center justify-center">
                <span className="text-xs text-gray-400 font-bold uppercase tracking-widest">Balance</span>
                <div className={`text-2xl font-black ${valGive - valReceive >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {valGive - valReceive > 0 ? '+' : ''}{(valGive - valReceive).toFixed(2)} EUR
                </div>
            </div>

            <div className="flex-1 flex justify-end">
                <button 
                    onClick={handleValidate}
                    // D√©sactiv√© pendant le chargement (isPending) ou si vide
                    disabled={isPending || (toGive.length === 0 && toReceive.length === 0)}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 transition shadow-lg transform active:scale-95"
                >
                    {isPending ? 'Validation...' : 'Valider l\'√©change'}
                </button>
            </div>
        </div>

        <CardVersionPickerModal 
            isOpen={!!cardToPick}
            baseCard={cardToPick}
            onClose={() => setCardToPick(null)}
            onConfirm={handleConfirmReceive}
        />

    </div>
  );
}
</file>

<file path="app/trades/page.tsx">
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useTradeMatcher, TradeProposal } from '@/hooks/useTradeMatcher';
import { useTradeSystem, TradeRequest } from '@/hooks/useTradeSystem';
import Link from 'next/link';
import { useCardCollection, CardType } from '@/hooks/useCardCollection'; 
import MagicCard from '@/components/MagicCard'; 

// --- COMPOSANT : CARTE DE DEMANDE RECUE ---
const IncomingRequestCard = ({ trade }: { trade: TradeRequest }) => {
    const { acceptTrade, rejectTrade, isProcessing } = useTradeSystem();
    const [isOpen, setIsOpen] = useState(false);

    const valReceive = trade.itemsGiven.reduce((acc: number, c: CardType) => acc + (c.price || 0), 0); 
    const valGive = trade.itemsReceived.reduce((acc: number, c: CardType) => acc + (c.price || 0), 0);

    return (
        <div className="bg-white dark:bg-zinc-900 rounded-xl border-l-4 border-[#6275b3] shadow-sm p-4 mb-4 border-y border-r border-zinc-200 dark:border-zinc-800">
            <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                <div>
                    <h3 className="font-bold text-zinc-900 dark:text-white">Proposition de {trade.senderName}</h3>
                    <p className="text-sm text-zinc-500">
                        Tu re√ßois <span className="text-green-600 font-bold">{trade.itemsGiven.length} cartes</span> (~{valReceive.toFixed(0)}‚Ç¨) 
                        contre <span className="text-red-600 font-bold">{trade.itemsReceived.length} cartes</span> (~{valGive.toFixed(0)}‚Ç¨)
                    </p>
                </div>
                <div className="flex gap-2 self-end sm:self-auto">
                    <button onClick={() => setIsOpen(!isOpen)} className="text-sm text-zinc-500 underline mr-2">D√©tails</button>
                    <button onClick={() => rejectTrade(trade.id)} disabled={isProcessing} className="px-3 py-1.5 bg-zinc-100 hover:bg-red-100 text-red-700 rounded-lg text-sm font-medium transition">Refuser</button>
                    <button onClick={() => acceptTrade(trade)} disabled={isProcessing} className="px-3 py-1.5 bg-[#6275b3] hover:bg-[#53639c] text-white rounded-lg text-sm font-medium transition shadow-sm">Accepter</button>
                </div>
            </div>
            {isOpen && (
                <div className="mt-4 pt-4 border-t border-zinc-100 dark:border-zinc-800 grid md:grid-cols-2 gap-4">
                    <div className="bg-green-50/50 p-3 rounded"><p className="text-xs font-bold text-green-700 mb-2">Tu vas recevoir :</p><div className="flex flex-wrap gap-2">{trade.itemsGiven.map((c: CardType) => (<div key={c.id} className="relative group w-12 h-16 bg-zinc-200 rounded overflow-hidden"><img src={c.imageUrl} className="w-full h-full object-cover"/><div className="absolute bottom-0 right-0 bg-black/50 text-white text-[8px] px-1">{c.quantity}x</div></div>))}</div></div>
                    <div className="bg-red-50/50 p-3 rounded"><p className="text-xs font-bold text-red-700 mb-2">Tu vas donner :</p><div className="flex flex-wrap gap-2">{trade.itemsReceived.map((c: CardType) => (<div key={c.id} className="relative group w-12 h-16 bg-zinc-200 rounded overflow-hidden"><img src={c.imageUrl} className="w-full h-full object-cover"/><div className="absolute bottom-0 right-0 bg-black/50 text-white text-[8px] px-1">{c.quantity}x</div></div>))}</div></div>
                </div>
            )}
        </div>
    );
};

// --- COMPOSANT : PROPOSITION D'√âCHANGE ---
const TradeRowProposal = ({ proposal, onProposalSent }: { proposal: TradeProposal, onProposalSent: () => void }) => {
    const { setCustomPrice } = useCardCollection('collection');
    const { proposeTrade } = useTradeSystem(); 
    const totalGive = proposal.toGive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0), 0);
    const totalReceive = proposal.toReceive.reduce((acc, c) => acc + (c.customPrice ?? c.price ?? 0), 0);
    const delta = totalGive - totalReceive;
    const handlePropose = async () => { const success = await proposeTrade(proposal.friend.uid, proposal.friend.displayName, proposal.toGive, proposal.toReceive); if (success) onProposalSent(); };

    return (
        <div className="bg-white dark:bg-zinc-900 rounded-2xl shadow-sm border border-zinc-100 dark:border-zinc-700 overflow-hidden mb-8 shrink-0">
            <div className="bg-zinc-50 dark:bg-zinc-800/50 p-4 border-b border-zinc-100 dark:border-zinc-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-[#6275b3] flex items-center justify-center text-white font-bold overflow-hidden">
                        {proposal.friend.photoURL ? <img src={proposal.friend.photoURL} alt="" className="w-full h-full object-cover"/> : proposal.friend.username[0].toUpperCase()}
                    </div>
                    <div>
                        <h2 className="text-xl font-bold text-zinc-900 dark:text-white">√âchange avec {proposal.friend.displayName}</h2>
                        <Link href={`/user/${proposal.friend.uid}`} className="text-sm text-[#6275b3] hover:underline">Voir profil</Link>
                    </div>
                </div>
                <button onClick={handlePropose} className="bg-[#6275b3] hover:bg-[#53639c] text-white px-4 py-2 rounded-lg font-bold shadow-sm transition text-sm w-full sm:w-auto">Proposer</button>
            </div>
            <div className="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x border-zinc-100 dark:border-zinc-700">
                <div className="p-4 bg-red-50/30 dark:bg-red-900/10">
                    <h3 className="font-bold text-red-600 dark:text-red-400 mb-4 flex justify-between">Tu donnerais ({proposal.toGive.length}) <span className="text-sm bg-white dark:bg-zinc-800 px-2 py-1 rounded shadow-sm">{totalGive.toFixed(2)} ‚Ç¨</span></h3>
                    <div className="space-y-3">{proposal.toGive.map(card => (<MagicCard key={card.id} {...card} isTradeView={true} allowPriceEdit={true} onEditPrice={(newPrice) => setCustomPrice(card.id, newPrice)} />))}</div>
                </div>
                <div className="p-4 bg-green-50/30 dark:bg-green-900/10">
                    <h3 className="font-bold text-green-600 dark:text-green-400 mb-4 flex justify-between">Tu recevrais ({proposal.toReceive.length}) <span className="text-sm bg-white dark:bg-zinc-800 px-2 py-1 rounded shadow-sm">{totalReceive.toFixed(2)} ‚Ç¨</span></h3>
                    <div className="space-y-3">{proposal.toReceive.map(card => (<MagicCard key={card.id} {...card} isTradeView={true} allowPriceEdit={false} />))}</div>
                </div>
            </div>
            <div className="p-2 text-center text-xs text-zinc-400 border-t border-zinc-100 dark:border-zinc-700">Balance : {delta.toFixed(2)} ‚Ç¨</div>
        </div>
    );
};

export default function TradesPage() {
  const { user } = useAuth();
  const { proposals, loading, status, runScan } = useTradeMatcher();
  const { incomingTrades, outgoingTrades, cancelTrade } = useTradeSystem(); 
  const [activeTab, setActiveTab] = useState<'scan' | 'requests'>('scan');

  if (!user) return <div className="p-10 text-center">Connectez-vous.</div>;

  return (
    <main className="container mx-auto p-4 max-w-5xl h-[calc(100vh-64px)] flex flex-col">
        
        <div className="flex-none flex flex-col md:flex-row justify-between items-end mb-4 gap-4 border-b border-zinc-200 dark:border-zinc-700 pb-4">
            <div>
                <h1 className="text-3xl font-bold text-[#6275b3]">Centre d&apos;Echanges</h1>
            </div>
            <div className="flex gap-4">
                <button 
                    onClick={() => setActiveTab('scan')}
                    className={`pb-2 px-2 font-bold transition ${activeTab === 'scan' ? 'text-[#6275b3] border-b-2 border-[#6275b3]' : 'text-zinc-500 hover:text-zinc-700'}`}
                >
                    Scanner ({proposals.length})
                </button>
                <button 
                    onClick={() => setActiveTab('requests')}
                    className={`pb-2 px-2 font-bold transition relative ${activeTab === 'requests' ? 'text-[#6275b3] border-b-2 border-[#6275b3]' : 'text-zinc-500 hover:text-zinc-700'}`}
                >
                    Demandes 
                    {incomingTrades.length > 0 && <span className="ml-2 bg-orange-500 text-white text-[10px] px-1.5 rounded-full align-top">{incomingTrades.length}</span>}
                </button>
            </div>
        </div>

        <div className="grow overflow-y-auto custom-scrollbar pb-10">
            {activeTab === 'scan' && (
                <div className="animate-in fade-in">
                    <div className="flex flex-col sm:flex-row justify-end mb-6 gap-3 sticky top-0 bg-white/80 dark:bg-zinc-950/80 backdrop-blur-sm z-10 py-2">
                         <Link href="/trades/manual" className="bg-zinc-100 hover:bg-zinc-200 text-zinc-800 px-4 py-2 rounded-lg font-bold transition text-sm flex items-center justify-center">Mode Manuel</Link>
                        <button onClick={runScan} disabled={loading} className="bg-[#6275b3] hover:bg-[#53639c] text-white px-4 py-2 rounded-lg font-bold shadow transition text-sm disabled:opacity-50 w-full sm:w-auto">
                            {loading ? status : "Lancer le Scanner"}
                        </button>
                    </div>
                    {proposals.length === 0 && !loading && (
                        <div className="text-center py-20 text-zinc-400 border-2 border-dashed border-zinc-200 dark:border-zinc-700 rounded-xl">
                            Lancez le scanner pour trouver des &quot;matchs&quot; avec vos amis.
                        </div>
                    )}
                    <div className="space-y-8">
                        {proposals.map(proposal => (<TradeRowProposal key={proposal.friend.uid} proposal={proposal} onProposalSent={runScan} />))}
                    </div>
                </div>
            )}

            {activeTab === 'requests' && (
                <div className="animate-in fade-in space-y-8">
                    <div>
                        <h2 className="font-bold text-zinc-500 uppercase text-xs mb-4 sticky top-0 bg-white dark:bg-zinc-950 py-2 z-10">√Ä traiter ({incomingTrades.length})</h2>
                        {incomingTrades.length === 0 && <p className="text-zinc-400 italic text-sm">Aucune demande en attente.</p>}
                        {incomingTrades.map((trade: TradeRequest) => (<IncomingRequestCard key={trade.id} trade={trade} />))}
                    </div>
                    <div>
                        <h2 className="font-bold text-zinc-500 uppercase text-xs mb-4 pt-4 border-t dark:border-zinc-700">En attente ({outgoingTrades.length})</h2>
                        {outgoingTrades.length === 0 && <p className="text-zinc-400 italic text-sm">Aucune proposition en cours.</p>}
                        {outgoingTrades.map((trade: TradeRequest) => (
                             <div key={trade.id} className="flex justify-between items-center p-3 bg-zinc-50 dark:bg-zinc-800/50 rounded-lg border border-zinc-100 dark:border-zinc-700 mb-2">
                                <span className="text-sm text-zinc-600 dark:text-zinc-300">Envoy√©e √† <span className="font-bold">{trade.receiverName}</span></span>
                                <button onClick={() => cancelTrade(trade.id)} className="text-xs text-red-500 hover:underline">Annuler</button>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    </main>
  );
}
</file>

<file path="components/CardVersionPickerModal.tsx">
'use client';

import { useState, useEffect, useMemo } from 'react';
import { CardType } from '@/hooks/useCardCollection';
import { normalizeCardData, ScryfallRawData } from '@/lib/cardUtils'; 
import { WishlistMeta } from '@/hooks/useWishlists'; 
import toast from 'react-hot-toast';

type Props = {
  isOpen: boolean;
  onClose: () => void;
  baseCard: ScryfallRawData | null; 
  onConfirm: (card: CardType, targetListId?: string) => void;
  destination?: 'collection' | 'wishlist'; 
  availableLists?: WishlistMeta[];
};

export default function CardVersionPickerModal({ 
  isOpen, onClose, baseCard, onConfirm, destination, availableLists 
}: Props) {
  const [versions, setVersions] = useState<ScryfallRawData[]>([]);
  const [loading, setLoading] = useState(false);
  
  const [selectedVersionId, setSelectedVersionId] = useState<string>('');
  const [isFoil, setIsFoil] = useState(false);
  const [quantity, setQuantity] = useState(1);
  const [isFlipped, setIsFlipped] = useState(false); 
  const [anyVersion, setAnyVersion] = useState(false);
  
  const [selectedListId, setSelectedListId] = useState<string>('default');

  useEffect(() => {
    const fetchVersions = async (oracleId: string) => {
        setLoading(true);
        try {
          const res = await fetch(`https://api.scryfall.com/cards/search?q=oracle_id:${oracleId}&unique=prints&order=released`);
          const data = await res.json();
          
          if (data.data && data.data.length > 0) {
            setVersions(data.data); 
            const defaultVer = data.data.find((c: ScryfallRawData) => c.id === baseCard?.id) || data.data[0];
            setSelectedVersionId(defaultVer.id);
          }
        } catch (e) {
          console.error(e);
          toast.error("Impossible de charger les versions");
        } finally {
          setLoading(false);
        }
    };

    if (isOpen && baseCard?.oracle_id) {
      fetchVersions(baseCard.oracle_id as string);
    }

    setQuantity(1);
    setIsFoil(false);
    setIsFlipped(false);
    setAnyVersion(false);
    setSelectedListId('default'); 
  }, [isOpen, baseCard]); 

  const currentCardRaw = useMemo(() => {
    return versions.find(v => v.id === selectedVersionId) || baseCard;
  }, [versions, selectedVersionId, baseCard]);

  if (!isOpen || !currentCardRaw) return null;

  const { imageUrl, imageBackUrl, name, setName, setCode, price } = normalizeCardData(currentCardRaw);
  
  const priceNormal = parseFloat(currentCardRaw.prices?.eur || "0");
  const priceFoil = parseFloat(currentCardRaw.prices?.eur_foil || "0");
  const currentPrice = isFoil ? (priceFoil || priceNormal) : (priceNormal || priceFoil);
  
  const hasFoilVersion = currentCardRaw.finishes?.includes('foil') || !!currentCardRaw.prices?.eur_foil;
  const hasNonFoilVersion = currentCardRaw.finishes?.includes('nonfoil') || !!currentCardRaw.prices?.eur;

  const handleConfirm = () => {
    const finalCard: CardType = {
        id: currentCardRaw.id,
        name: name,
        imageUrl: imageUrl,
        imageBackUrl: imageBackUrl || null,
        quantity: quantity,
        price: currentPrice,
        setName: setName,
        setCode: setCode,
        isFoil: isFoil,
        isSpecificVersion: !anyVersion,
        scryfallData: currentCardRaw,
        wishlistId: destination === 'wishlist' ? selectedListId : undefined 
    };
    
    onConfirm(finalCard, selectedListId);
    onClose();
  };

  const handleAnyVersionChange = (checked: boolean) => {
      setAnyVersion(checked);
      
      if (checked && versions.length > 0) {
          const sorted = [...versions].sort((a, b) => 
              (b.released_at || '').localeCompare(a.released_at || '')
          );
          
          const newest = sorted[0];
          if (newest) {
              setSelectedVersionId(newest.id);
              setIsFoil(false);
              setIsFlipped(false);
          }
      }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-gray-900 w-full max-w-md rounded-2xl overflow-hidden shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
        
        <div className="p-4 flex justify-between items-center border-b border-gray-800">
            <h3 className="text-white font-bold truncate pr-4">{name}</h3>
            <button onClick={onClose} className="text-gray-400 hover:text-white px-2 text-xl">X</button>
        </div>

        <div className="overflow-y-auto p-6 flex flex-col items-center space-y-6 custom-scrollbar">
            
            <div className="relative w-64 aspect-[2.5/3.5] rounded-xl overflow-hidden shadow-lg ring-1 ring-white/10 group cursor-pointer" onClick={() => imageBackUrl && setIsFlipped(!isFlipped)}>
                {loading ? (
                    <div className="w-full h-full bg-gray-800 animate-pulse flex items-center justify-center text-gray-500">Chargement...</div>
                ) : (
                    <img src={isFlipped && imageBackUrl ? imageBackUrl : imageUrl} alt="" className={`w-full h-full object-cover transition-transform duration-300 ${anyVersion ? 'opacity-80 grayscale-[50%]' : ''}`} />
                )}
                {anyVersion && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-[2px]">
                        <span className="bg-blue-600 text-white font-bold px-3 py-1 rounded-full text-sm shadow-lg border border-white/20">Generique</span>
                    </div>
                )}
                {isFoil && !anyVersion && <div className="absolute inset-0 bg-gradient-to-tr from-purple-500/30 to-transparent mix-blend-overlay pointer-events-none" />}
            </div>

            {destination === 'wishlist' && availableLists && availableLists.length > 0 && (
                <div className="w-full space-y-1 bg-purple-900/20 p-3 rounded-xl border border-purple-500/30">
                    <label className="text-xs text-purple-300 font-bold uppercase tracking-wider">Ajouter a la liste :</label>
                    <select 
                        value={selectedListId}
                        onChange={(e) => setSelectedListId(e.target.value)}
                        className="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                    >
                        {availableLists.map(list => (
                            <option key={list.id} value={list.id}>{list.name}</option>
                        ))}
                    </select>
                </div>
            )}

            <div className={`w-full space-y-2 transition-opacity ${anyVersion ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                <label className="text-xs text-gray-400 uppercase font-bold tracking-wider">Edition / Set</label>
                <div className="relative">
                    <select 
                        className="w-full bg-gray-800 text-white border border-gray-700 rounded-xl p-3 appearance-none focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                        value={selectedVersionId}
                        onChange={(e) => { setSelectedVersionId(e.target.value); setIsFoil(false); setIsFlipped(false); }}
                    >
                        {versions.map((v) => (
                            <option key={v.id} value={v.id}>{v.set_name} ({v.set.toUpperCase()}) #{v.collector_number}</option>
                        ))}
                    </select>
                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">V</div>
                </div>
            </div>

            <div className="w-full space-y-4">
                <label className="flex items-center justify-between bg-blue-900/20 p-3 rounded-xl border border-blue-900/50 cursor-pointer hover:bg-blue-900/30 transition">
                    <div className="flex flex-col">
                        <span className="text-sm font-bold text-blue-100">Peu importe l&apos;edition</span>
                        <span className="text-[10px] text-blue-300">Selectionnera la version la plus recente</span>
                    </div>
                    <div className="relative inline-flex items-center cursor-pointer">
                        <input 
                            type="checkbox" 
                            className="sr-only peer" 
                            checked={anyVersion} 
                            onChange={(e) => handleAnyVersionChange(e.target.checked)} 
                        />
                        <div className="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </div>
                </label>

                <div className="flex gap-4">
                    <div className={`flex-1 bg-gray-800 rounded-xl p-2 flex flex-col items-center justify-center gap-1 border border-gray-700 transition-opacity ${anyVersion ? 'opacity-30 pointer-events-none' : ''}`}>
                        <span className="text-[10px] text-gray-400 font-bold uppercase">Finition</span>
                        <div className="flex bg-gray-900 rounded-lg p-1 w-full">
                            <button onClick={() => setIsFoil(false)} disabled={!hasNonFoilVersion} className={`flex-1 text-[10px] py-1 rounded transition ${!isFoil ? 'bg-gray-700 text-white font-bold' : 'text-gray-500'} ${!hasNonFoilVersion && 'opacity-30'}`}>Normal</button>
                            <button onClick={() => setIsFoil(true)} disabled={!hasFoilVersion} className={`flex-1 text-[10px] py-1 rounded transition ${isFoil ? 'bg-purple-600 text-white font-bold' : 'text-gray-500'} ${!hasFoilVersion && 'opacity-30'}`}>Foil</button>
                        </div>
                    </div>
                    <div className="flex-1 bg-gray-800 rounded-xl p-2 flex flex-col items-center justify-center gap-1 border border-gray-700">
                         <span className="text-[10px] text-gray-400 font-bold uppercase">Quantite</span>
                         <div className="flex items-center gap-3">
                            <button onClick={() => setQuantity(Math.max(1, quantity - 1))} className="w-6 h-6 rounded-full bg-gray-700 text-white font-bold">-</button>
                            <span className="text-lg font-bold text-white w-4 text-center">{quantity}</span>
                            <button onClick={() => setQuantity(quantity + 1)} className="w-6 h-6 rounded-full bg-blue-600 text-white font-bold">+</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div className="p-4 bg-gray-800 border-t border-gray-700">
            <button 
                onClick={handleConfirm}
                className={`w-full font-bold py-4 rounded-xl text-lg transition shadow-lg transform active:scale-95 flex justify-center items-center gap-2 ${anyVersion ? 'bg-blue-600 hover:bg-blue-500 text-white' : 'bg-amber-500 hover:bg-amber-400 text-black'}`}
            >
                <span>{anyVersion ? 'Ajouter (Generique)' : 'Ajouter (Exact)'}</span>
                {quantity > 1 && <span className="bg-black/20 px-2 py-0.5 rounded text-sm">{quantity}</span>}
            </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/Header.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { useAuth } from '@/lib/AuthContext';
import { usePathname } from 'next/navigation';
import ThemeToggle from './ThemeToggle';

export default function Header() {
  const { user, logOut, friendRequestCount } = useAuth();
  const pathname = usePathname();
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const linkClass = (path: string) => `
    text-sm font-medium transition-colors block py-2 md:py-0
    ${pathname === path 
      ? 'text-primary font-bold' 
      : 'text-zinc-500 hover:text-primary'}
  `;

  return (
    // UTILISATION DES VARIABLES : bg-surface, border-border
    <header className="bg-surface/80 backdrop-blur-md border-b border-border p-4 sticky top-0 z-40 transition-colors duration-300">
      <div className="container mx-auto">
        <div className="flex justify-between items-center">
          
          {/* Logo utilise text-primary */}
          <Link 
            href="/" 
            className="text-2xl font-black tracking-tight text-primary hover:opacity-80 transition"
            onClick={() => setIsMenuOpen(false)}
          >
            MagicWish
          </Link>

          <div className="flex items-center gap-4">
            <ThemeToggle />

            {user ? (
              <>
                <nav className="hidden md:flex gap-6 mr-4 items-center">
                  <Link href="/search" className={linkClass('/search')}>Recherche</Link> 
                  <Link href="/wishlist" className={linkClass('/wishlist')}>Wishlist</Link>
                  <Link href="/collection" className={linkClass('/collection')}>Collection</Link>
                  <Link href="/trades" className={linkClass('/trades')}>Echanges</Link>
                  <Link href="/contacts" className={`${linkClass('/contacts')} relative flex items-center gap-1`}>
                    Contacts
                    {friendRequestCount > 0 && (
                      <span className="absolute -top-1.5 -right-2 bg-primary text-primary-foreground text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse">
                        {friendRequestCount}
                      </span>
                    )}
                  </Link>
                </nav>

                <div className="h-5 w-px bg-border hidden md:block"></div>

                <div className="flex items-center gap-3">
                  {user.photoURL && (
                    <img 
                      src={user.photoURL} 
                      alt="Avatar" 
                      className="w-8 h-8 rounded-full bg-surface border border-border object-cover"
                    />
                  )}
                  <button
                    onClick={logOut}
                    className="hidden md:block text-xs font-medium text-muted hover:text-primary transition"
                  >
                    D√©connexion
                  </button>

                  <button 
                    onClick={() => setIsMenuOpen(!isMenuOpen)}
                    className="md:hidden p-2 text-primary hover:bg-secondary rounded-lg transition-colors"
                  >
                    Menu
                  </button>
                </div>
              </>
            ) : (
              <Link
                href="/login"
                className="bg-primary text-primary-foreground px-5 py-2 rounded-lg text-sm font-bold hover:opacity-90 transition shadow-md"
              >
                Se connecter
              </Link>
            )}
          </div>
        </div>
        
        {/* MOBILE MENU */}
        {user && isMenuOpen && (
          <div className="md:hidden mt-4 pt-4 border-t border-border animate-in slide-in-from-top-2">
             <nav className="flex flex-col space-y-3">
               <Link href="/search" className={linkClass('/search')} onClick={() => setIsMenuOpen(false)}>Recherche</Link>
               <Link href="/wishlist" className={linkClass('/wishlist')} onClick={() => setIsMenuOpen(false)}>Wishlist</Link>
               <Link href="/collection" className={linkClass('/collection')} onClick={() => setIsMenuOpen(false)}>Collection</Link>
               <Link href="/trades" className={linkClass('/trades')} onClick={() => setIsMenuOpen(false)}>Echanges</Link>
               <Link href="/contacts" className={linkClass('/contacts')} onClick={() => setIsMenuOpen(false)}>Contacts</Link>
               <button onClick={() => { logOut(); setIsMenuOpen(false); }} className="text-left py-2 text-danger text-sm font-medium">D√©connexion</button>
             </nav>
          </div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="hooks/useCardCollection.ts">
// hooks/useCardCollection.ts
import { useState, useEffect, useMemo } from 'react';
import { db } from '@/lib/firebase';
import { collection, onSnapshot, doc, updateDoc, deleteDoc, increment, writeBatch } from 'firebase/firestore';
import { useAuth } from '@/lib/AuthContext';
import toast from 'react-hot-toast';

// Definition d'un type partiel pour Scryfall
type ScryfallDataRaw = {
    id: string;
    prices?: { eur?: string; usd?: string };
    [key: string]: unknown; 
};

export type CardType = {
  id: string;
  name: string;
  imageUrl: string;
  imageBackUrl?: string | null;
  quantity: number;
  price?: number; 
  customPrice?: number;
  setName?: string;
  setCode?: string;
  wishlistId?: string;
  
  isFoil?: boolean;             
  isSpecificVersion?: boolean;
  isForTrade?: boolean; 
  
  scryfallData?: Record<string, unknown>;
};

export function useCardCollection(
    target: 'collection' | 'wishlist', 
    listId: string = 'default',
    targetUid?: string
) {
  const { user, loading: authLoading } = useAuth();
  const [cards, setCards] = useState<CardType[]>([]);
  const [loading, setLoading] = useState(true);

  const effectiveUid = targetUid || user?.uid;
  const isOwner = user?.uid === effectiveUid; 

  useEffect(() => {
    if (!effectiveUid || authLoading) {
        if (!authLoading && !effectiveUid) setLoading(false);
        return;
    }
    setLoading(true);

    let collectionPath = '';
    if (target === 'collection') {
        collectionPath = `users/${effectiveUid}/collection`;
    } else {
        if (listId === 'default') collectionPath = `users/${effectiveUid}/wishlist`;
        else collectionPath = `users/${effectiveUid}/wishlists_data/${listId}/cards`;
    }

    const colRef = collection(db, collectionPath);
    const unsubscribe = onSnapshot(colRef, (snapshot) => {
      const items = snapshot.docs.map((doc) => ({
        id: doc.id,
        wishlistId: listId,
        ...doc.data(),
      })) as CardType[];
      setCards(items);
      setLoading(false);
    });
    return () => unsubscribe();
  }, [effectiveUid, target, listId, authLoading]);

  // --- ACTIONS ---

  const getDocRef = (cardId: string) => {
      if (!isOwner || !effectiveUid) return null;
      let path = '';
      if (target === 'collection') path = `users/${effectiveUid}/collection`;
      else if (listId === 'default') path = `users/${effectiveUid}/wishlist`;
      else path = `users/${effectiveUid}/wishlists_data/${listId}/cards`;
      return doc(db, path, cardId);
  };

  const setCustomPrice = async (cardId: string, price: number) => {
      if (!isOwner) return;
      const ref = getDocRef(cardId);
      if (ref) {
          await updateDoc(ref, { customPrice: price });
          toast.success("Prix mis √† jour");
      }
  };

  const toggleAttribute = async (
      cardId: string, 
      field: 'isFoil' | 'isSpecificVersion' | 'isForTrade', 
      currentValue: boolean
  ) => {
      if (!isOwner) return;
      const ref = getDocRef(cardId);
      if (ref) {
          await updateDoc(ref, { [field]: !currentValue });
      }
  };

  const updateQuantity = async (cardId: string, amount: number, currentQuantity: number) => {
    if (!isOwner) return;
    const ref = getDocRef(cardId);
    if (!ref) return;
    if (currentQuantity + amount <= 0) return 'shouldDelete';
    try {
      await updateDoc(ref, { quantity: increment(amount) });
      return 'updated';
    } catch (err) { return 'error'; }
  };

  const removeCard = async (cardId: string) => {
    if (!isOwner) return;
    const ref = getDocRef(cardId);
    if(ref) { await deleteDoc(ref); toast.success('Carte retir√©e', { icon: 'üóëÔ∏è' }); }
  };

  // --- MISE √Ä JOUR GLOBALE DES PRIX ---
  const refreshCollectionPrices = async () => {
      if (!isOwner || cards.length === 0) return;
      const toastId = toast.loading(`Mise √† jour de ${cards.length} cartes...`);

      try {
          const chunks = [];
          for (let i = 0; i < cards.length; i += 75) {
              chunks.push(cards.slice(i, i + 75));
          }

          for (const chunk of chunks) {
              const identifiers = chunk.map(c => ({ id: c.id }));

              const res = await fetch('https://api.scryfall.com/cards/collection', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ identifiers })
              });

              if (!res.ok) continue;

              const data = await res.json();
              const foundCards = (data.data as ScryfallDataRaw[]) || [];
              
              const batch = writeBatch(db);
              let batchHasOps = false;

              foundCards.forEach(scryCard => {
                  const localCard = chunk.find(c => c.id === scryCard.id);
                  const newPrice = parseFloat(scryCard.prices?.eur || "0");

                  if (localCard) {
                      const ref = getDocRef(localCard.id);
                      if (ref) {
                          batch.update(ref, { 
                              price: newPrice,
                              scryfallData: scryCard as Record<string, unknown>
                          });
                          batchHasOps = true;
                      }
                  }
              });

              if (batchHasOps) await batch.commit();
              await new Promise(r => setTimeout(r, 100));
          }

          toast.success("Collection mise √† jour avec succ√®s !", { id: toastId });

      } catch (e) {
          console.error(e);
          toast.error("Erreur lors de la mise √† jour", { id: toastId });
      }
  };

  // --- GESTION DE MASSE DU CLASSEUR D'√âCHANGE ---
  const bulkSetTradeStatus = async (
      action: 'excess' | 'all' | 'reset', 
      threshold: number = 4
  ) => {
      if (!isOwner || cards.length === 0) return;
      
      const batch = writeBatch(db);
      let opCount = 0;
      let label = "";

      cards.forEach(card => {
          let shouldUpdate = false;
          let newValue = false;

          if (action === 'reset') {
              if (card.isForTrade) {
                  shouldUpdate = true;
                  newValue = false;
              }
              label = "Remise √† z√©ro";
          } 
          else if (action === 'all') {
              if (!card.isForTrade) {
                  shouldUpdate = true;
                  newValue = true;
              }
              label = "Tout ajouter";
          } 
          else if (action === 'excess') {
              if (card.quantity > threshold && !card.isForTrade) {
                  shouldUpdate = true;
                  newValue = true;
              }
          }

          if (shouldUpdate) {
              const ref = getDocRef(card.id);
              if (ref) {
                  batch.update(ref, { isForTrade: newValue });
                  opCount++;
              }
          }
      });

      if (opCount > 0) {
          await batch.commit();
          toast.success(`${opCount} cartes mises √† jour (${action === 'excess' ? `Quantit√© > ${threshold}` : label})`);
      } else {
          toast(`Aucune carte ne correspond aux crit√®res.`);
      }
  };

  // --- NOUVEAU : ACTIONS DE S√âLECTION MULTIPLE ---

  const bulkRemoveCards = async (cardIds: string[]) => {
      if (!isOwner || cardIds.length === 0) return;
      
      const batch = writeBatch(db);
      cardIds.forEach(id => {
          const ref = getDocRef(id);
          if (ref) batch.delete(ref);
      });

      await batch.commit();
      toast.success(`${cardIds.length} cartes supprim√©es`);
  };

  const bulkUpdateAttribute = async (cardIds: string[], field: 'isForTrade' | 'isFoil', value: boolean) => {
      if (!isOwner || cardIds.length === 0) return;

      const batch = writeBatch(db);
      cardIds.forEach(id => {
          const ref = getDocRef(id);
          if (ref) batch.update(ref, { [field]: value });
      });

      await batch.commit();
      toast.success("Mise √† jour effectu√©e");
  };

  const totalPrice = useMemo(() => {
    return cards.reduce((acc, card) => {
        const effectivePrice = card.customPrice !== undefined ? card.customPrice : (card.price || 0);
        return acc + effectivePrice * card.quantity;
    }, 0);
  }, [cards]);

  return { 
      cards, loading, isOwner, totalPrice,
      updateQuantity, removeCard, setCustomPrice, toggleAttribute,
      refreshCollectionPrices, bulkSetTradeStatus,
      bulkRemoveCards, bulkUpdateAttribute 
  };
}
</file>

<file path="app/wishlist/page.tsx">
'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useWishlists } from '@/hooks/useWishlists';
import SingleWishlistView from '@/components/wishlist/SingleWishlistView';
import GlobalWishlistView from '@/components/wishlist/GlobalWishlistView';

export default function WishlistPage() {
  const { user } = useAuth();
  const { lists, createList, deleteList, loading: metaLoading } = useWishlists();
  
  const [selectedListId, setSelectedListId] = useState<string>('default');
  const [newListName, setNewListName] = useState('');

  if (!user) return <p className="p-10 text-center">Veuillez vous connecter.</p>;

  const handleCreate = (e: React.FormEvent) => {
    e.preventDefault();
    if(newListName.trim()) {
        createList(newListName);
        setNewListName('');
    }
  };

  return (
    <main className="container mx-auto p-4 flex flex-col md:flex-row gap-8 min-h-[85vh]">
      
      {/* SIDEBAR */}
      <aside className="w-full md:w-72 flex-none space-y-6">
        <div className="bg-white dark:bg-zinc-900 p-5 rounded-xl shadow-sm border border-zinc-200 dark:border-zinc-800 sticky top-24">
            <h3 className="font-bold mb-4 text-zinc-900 dark:text-white flex items-center gap-2 border-b border-zinc-100 dark:border-zinc-800 pb-2">
                üìë Mes Listes
            </h3>
            
            {metaLoading ? (
                <p className="text-sm text-zinc-400">Chargement...</p>
            ) : (
                <div className="flex flex-col gap-1 max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                    
                    {/* BOUTON VUE GLOBALE */}
                    <button
                        onClick={() => setSelectedListId('GLOBAL_VIEW')}
                        className={`text-left px-3 py-2.5 rounded-lg text-sm transition-all duration-200 flex items-center gap-2 mb-2 ${
                            selectedListId === 'GLOBAL_VIEW'
                            ? 'bg-purple-600 text-white shadow-md font-medium' 
                            : 'bg-purple-50 text-purple-700 hover:bg-purple-100 dark:bg-purple-900/20 dark:text-purple-300'
                        }`}
                    >
                        <span>üåç</span> Tout voir (Fusionn√©)
                    </button>

                    <div className="border-t border-zinc-100 dark:border-zinc-800 my-2"></div>

                    {lists.map(list => (
                        <div key={list.id} className="group flex items-center relative">
                            <button
                                onClick={() => setSelectedListId(list.id)}
                                className={`grow text-left px-3 py-2.5 rounded-lg text-sm transition-all duration-200 ${
                                    selectedListId === list.id 
                                    ? 'bg-[#6275b3] text-white shadow-md font-medium' // <--- ICI LE BLEU CUSTOM
                                    : 'hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-300'
                                }`}
                            >
                                {list.name}
                            </button>
                            
                            {list.id !== 'default' && (
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        deleteList(list.id);
                                        if (selectedListId === list.id) setSelectedListId('default');
                                    }}
                                    className={`absolute right-2 p-1.5 rounded-md transition-opacity ${
                                        selectedListId === list.id 
                                        ? 'text-white/70 hover:text-white' 
                                        : 'opacity-0 group-hover:opacity-100 text-zinc-400 hover:text-red-600'
                                    }`}
                                    title="Supprimer"
                                >
                                    ‚úï
                                </button>
                            )}
                        </div>
                    ))}
                </div>
            )}

            {/* Formulaire Cr√©ation */}
            <form onSubmit={handleCreate} className="mt-6 pt-4 border-t border-zinc-100 dark:border-zinc-800">
                <div className="flex gap-2">
                    <input 
                        type="text" 
                        placeholder="Nom nouvelle liste..." 
                        className="w-full text-sm p-2 border rounded-lg bg-zinc-50 dark:bg-zinc-950 dark:border-zinc-700 focus:ring-2 focus:ring-[#6275b3] outline-none"
                        value={newListName}
                        onChange={e => setNewListName(e.target.value)}
                    />
                    <button 
                        type="submit"
                        className="bg-[#6275b3] hover:bg-[#53639c] text-white px-3 rounded-lg font-bold text-lg leading-none pb-1"
                    >
                        +
                    </button>
                </div>
            </form>
        </div>
      </aside>

      <section className="grow min-w-0">
          {selectedListId === 'GLOBAL_VIEW' ? (
              <GlobalWishlistView lists={lists} />
          ) : (
              <SingleWishlistView 
                key={selectedListId} 
                listId={selectedListId} 
                listName={lists.find(l => l.id === selectedListId)?.name || 'Liste'} 
              />
          )}
      </section>

    </main>
  );
}
</file>

<file path="app/page.tsx">
'use client';

import { useAuth } from '@/lib/AuthContext';
import { useCardCollection } from '@/hooks/useCardCollection';
import { useTradeSystem } from '@/hooks/useTradeSystem';
import Link from 'next/link';
import { useState, useEffect } from 'react';
import { db } from '@/lib/firebase';
import { collection, query, orderBy, limit, getDocs } from 'firebase/firestore';
import { CardType } from '@/hooks/useCardCollection';

export default function DashboardPage() {
  const { user, loading: authLoading, friendRequestCount, username } = useAuth();
  const { totalPrice, cards } = useCardCollection('collection'); 
  const { incomingTrades, outgoingTrades } = useTradeSystem(); 
  
  const [recentCards, setRecentCards] = useState<CardType[]>([]);

  useEffect(() => {
    const fetchRecent = async () => {
      if (!user) return;
      try {
        const q = query(
            collection(db, 'users', user.uid, 'collection'), 
            orderBy('addedAt', 'desc'), 
            limit(5)
        );
        const snap = await getDocs(q);
        setRecentCards(snap.docs.map(d => ({ id: d.id, ...d.data() } as CardType)));
      } catch (e) { console.error(e); }
    };
    fetchRecent();
  }, [user]);

  if (authLoading) return <div className="flex h-screen items-center justify-center animate-pulse text-[#6275b3]">Chargement...</div>;

  if (!user) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[80vh] text-center p-4">
        <h1 className="text-5xl font-black text-[#6275b3] mb-6 tracking-tight">
          MagicWish
        </h1>
        <p className="text-xl text-zinc-600 dark:text-zinc-400 max-w-lg mb-8">
          G√©rez votre collection, vos wishlists et vos √©changes en toute simplicit√©.
        </p>
        <Link 
          href="/login"
          className="bg-[#6275b3] hover:bg-[#53639c] text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition transform hover:scale-105"
        >
          Commencer maintenant
        </Link>
      </div>
    );
  }

  // Styles de base pour les cartes bleut√©es en mode clair / gris fonc√© en mode sombre
  const cardStyle = "p-6 rounded-2xl border transition-all duration-200 shadow-sm hover:shadow-md hover:-translate-y-1 group bg-white border-[#6275b3]/20 dark:bg-zinc-900 dark:border-zinc-800 hover:border-[#6275b3]";

  return (
    <main className="container mx-auto p-4 max-w-5xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-zinc-900 dark:text-white">
          Bonjour, <span className="text-[#6275b3]">{username || user.displayName}</span>
        </h1>
        <p className="text-zinc-500">Tableau de bord</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        
        {/* CARTE ECHANGES */}
        <Link href="/trades" className={`${cardStyle} 
            ${incomingTrades.length > 0 ? 'bg-orange-50 border-orange-300' : ''}`}>
            <div className="flex justify-between items-start mb-2">
                <span className={`font-bold text-lg group-hover:text-[#6275b3] transition-colors ${incomingTrades.length > 0 ? 'text-orange-700' : 'text-zinc-800 dark:text-zinc-100'}`}>
                    √âchanges
                </span>
                {incomingTrades.length > 0 && <span className="bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">{incomingTrades.length}</span>}
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {incomingTrades.length > 0 ? "Propositions en attente !" : `${outgoingTrades.length} propositions en cours.`}
            </p>
        </Link>

        {/* CARTE CONTACTS */}
        <Link href="/contacts" className={`${cardStyle} ${friendRequestCount > 0 ? 'bg-[#6275b3]/10 border-[#6275b3]' : ''}`}>
            <div className="flex justify-between items-start mb-2">
                <span className={`font-bold text-lg group-hover:text-[#6275b3] transition-colors ${friendRequestCount > 0 ? 'text-[#6275b3]' : 'text-zinc-800 dark:text-zinc-100'}`}>
                    Contacts
                </span>
                {friendRequestCount > 0 && <span className="bg-[#6275b3] text-white text-xs font-bold px-2 py-1 rounded-full">{friendRequestCount}</span>}
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {friendRequestCount > 0 ? "Nouvelles demandes d'amis." : "G√©rer ma liste d'amis."}
            </p>
        </Link>

        {/* CARTE TOTAL */}
        <Link href="/collection" className={cardStyle}>
            <div className="flex justify-between items-start mb-2">
                <span className="font-bold text-lg text-zinc-800 dark:text-zinc-100 group-hover:text-[#6275b3] transition-colors">Total</span>
                <span className="text-emerald-600 font-bold bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded text-xs">{totalPrice.toFixed(2)} ‚Ç¨</span>
            </div>
            <p className="text-sm text-zinc-500 group-hover:text-zinc-600 dark:text-zinc-400">
                {cards.length} cartes collectionn√©es.
            </p>
        </Link>
      </div>

      <div className="grid lg:grid-cols-3 gap-8">
          {/* LISTE R√âCENTS */}
          <div className="lg:col-span-2 space-y-4">
              <div className="flex justify-between items-center">
                  <h2 className="font-bold text-lg text-zinc-800 dark:text-white">Derniers ajouts</h2>
                  <Link href="/collection" className="text-sm text-[#6275b3] hover:underline font-medium">Tout voir</Link>
              </div>
              
              <div className="bg-white dark:bg-zinc-900 rounded-xl border border-[#6275b3]/20 dark:border-zinc-800 overflow-hidden shadow-sm">
                  {recentCards.length === 0 ? (
                      <div className="p-8 text-center text-zinc-400">
                          Pas encore de cartes ? <Link href="/collection" className="text-[#6275b3] underline">Importez-en !</Link>
                      </div>
                  ) : (
                      recentCards.map((card) => (
                          <div key={card.id} className="flex items-center gap-4 p-3 border-b border-[#6275b3]/10 dark:border-zinc-800 last:border-0 hover:bg-[#6275b3]/5 dark:hover:bg-zinc-800/50 transition">
                              <div className="w-10 h-14 bg-zinc-200 rounded overflow-hidden shrink-0">
                                  <img src={card.imageUrl} className="w-full h-full object-cover" alt="" />
                              </div>
                              <div className="grow">
                                  <p className="font-semibold text-sm text-zinc-900 dark:text-zinc-100">{card.name}</p>
                                  <p className="text-xs text-zinc-500">{card.setName} {card.isFoil && <span className="text-amber-600 bg-amber-50 px-1 rounded text-[9px] font-bold">Foil</span>}</p>
                              </div>
                              <div className="text-right">
                                  <span className="font-medium text-zinc-700 dark:text-zinc-300 text-sm">{(card.customPrice ?? card.price ?? 0).toFixed(2)} ‚Ç¨</span>
                              </div>
                          </div>
                      ))
                  )}
              </div>
          </div>

          {/* ACTION RAPIDE */}
          <div className="space-y-6">
              <div className="bg-[#6275b3] rounded-xl p-6 text-white shadow-lg shadow-[#6275b3]/20">
                  <h3 className="font-bold text-lg mb-2">Action Rapide</h3>
                  <p className="text-white/90 text-sm mb-6">Ajout rapide apr√®s ouverture de boosters ?</p>
                  
                  <Link href="/search" className="block w-full bg-white text-[#6275b3] font-bold text-center py-3 rounded-lg hover:bg-zinc-100 transition shadow-sm mb-3">
                      Ajouter des cartes
                  </Link>
                  <Link href="/trades/manual" className="block w-full bg-[#4a5a8a] hover:bg-[#3d4b6e] text-white font-bold text-center py-3 rounded-lg transition border border-white/20">
                      √âchange Manuel
                  </Link>
              </div>

              {/* ASTUCE */}
              <div className="bg-white dark:bg-zinc-900 rounded-xl border-l-4 border-[#6275b3] shadow-sm p-6 border-y border-r border-[#6275b3]/20 dark:border-y-zinc-800 dark:border-r-zinc-800">
                  <h3 className="font-bold text-zinc-900 dark:text-white mb-2">Astuce</h3>
                  <p className="text-sm text-zinc-500 mb-4">
                      Remplissez votre Wishlist pour aider le scanner √† trouver des √©changes.
                  </p>
                  <Link href="/wishlist" className="text-sm font-bold text-[#6275b3] hover:underline">
                      G√©rer ma Wishlist
                  </Link>
              </div>
          </div>
      </div>
    </main>
  );
}
</file>

<file path="app/collection/page.tsx">
'use client';

import { useState, useMemo, useEffect } from 'react';
import { useAuth } from '@/lib/AuthContext';
import { useCardCollection } from '@/hooks/useCardCollection'; 
import MagicCard from '@/components/MagicCard';
import ImportModal from '@/components/ImportModal';
import ConfirmModal from '@/components/ConfirmModal';
import DeleteAllButton from '@/components/DeleteAllButton';
import CollectionToolsModal from '@/components/CollectionToolsModal';

type SortOption = 'name' | 'price_desc' | 'price_asc' | 'quantity' | 'date';

const ITEMS_PER_PAGE = 50; 

export default function CollectionPage() {
  const { user } = useAuth();
  
  const { 
    cards, loading, updateQuantity, removeCard, 
    setCustomPrice, toggleAttribute, refreshCollectionPrices, bulkSetTradeStatus,
    bulkRemoveCards, bulkUpdateAttribute, 
    totalPrice 
  } = useCardCollection('collection');

  const [isImportOpen, setIsImportOpen] = useState(false);
  const [isToolsOpen, setIsToolsOpen] = useState(false);
  const [cardToDelete, setCardToDelete] = useState<string | null>(null);

  const [isSelectMode, setIsSelectMode] = useState(false);
  const [selectedIds, setSelectedIds] = useState<string[]>([]);
  
  const [visibleCount, setVisibleCount] = useState(ITEMS_PER_PAGE);
  const [showFilters, setShowFilters] = useState(false);

  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState<SortOption>('date');
  const [filterSet, setFilterSet] = useState<string>('all');
  const [filterTrade, setFilterTrade] = useState(false);
  const [filterFoil, setFilterFoil] = useState(false);

  useEffect(() => {
    if (visibleCount !== ITEMS_PER_PAGE) {
      setVisibleCount(ITEMS_PER_PAGE);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchQuery, sortBy, filterSet, filterTrade, filterFoil]);

  const filteredAndSortedCards = useMemo(() => {
    let result = [...cards];

    if (searchQuery) {
        const lowerQ = searchQuery.toLowerCase();
        result = result.filter(c => c.name.toLowerCase().includes(lowerQ));
    }
    if (filterSet !== 'all') {
        result = result.filter(c => c.setName === filterSet);
    }
    if (filterTrade) {
        result = result.filter(c => c.isForTrade);
    }
    if (filterFoil) {
        result = result.filter(c => c.isFoil);
    }

    result.sort((a, b) => {
        const priceA = a.customPrice ?? a.price ?? 0;
        const priceB = b.customPrice ?? b.price ?? 0;
        switch (sortBy) {
            case 'name': return a.name.localeCompare(b.name);
            case 'price_desc': return priceB - priceA;
            case 'price_asc': return priceA - priceB;
            case 'quantity': return b.quantity - a.quantity;
            case 'date': default: return 0; 
        }
    });

    return result;
  }, [cards, searchQuery, sortBy, filterSet, filterTrade, filterFoil]);

  const visibleCards = useMemo(() => {
      return filteredAndSortedCards.slice(0, visibleCount);
  }, [filteredAndSortedCards, visibleCount]);

  const availableSets = useMemo(() => {
      const sets = new Set(cards.map(c => c.setName).filter((s): s is string => !!s));
      return Array.from(sets).sort();
  }, [cards]);

  const handleDecrement = async (cardId: string, currentQty: number) => {
    const result = await updateQuantity(cardId, -1, currentQty);
    if (result === 'shouldDelete') {
      setCardToDelete(cardId);
    }
  };

  const toggleSelection = (id: string) => {
      setSelectedIds(prev => 
          prev.includes(id) ? prev.filter(pid => pid !== id) : [...prev, id]
      );
  };

  const handleSelectAll = () => {
      if (selectedIds.length === filteredAndSortedCards.length) {
          setSelectedIds([]); 
      } else {
          setSelectedIds(filteredAndSortedCards.map(c => c.id)); 
      }
  };

  const handleBulkDelete = async () => {
      if (!confirm(`Supprimer ces ${selectedIds.length} cartes d√©finitivement ?`)) return;
      await bulkRemoveCards(selectedIds);
      setSelectedIds([]);
      setIsSelectMode(false);
  };

  const handleBulkTrade = async (isTrade: boolean) => {
      await bulkUpdateAttribute(selectedIds, 'isForTrade', isTrade);
      setSelectedIds([]);
      setIsSelectMode(false);
  };

  if (loading) return <div className="flex h-screen items-center justify-center text-zinc-500 animate-pulse">Chargement de votre collection...</div>;
  if (!user) return <p className="text-center p-10">Veuillez vous connecter.</p>;

  return (
    <main className="container mx-auto p-4 pb-24 relative">
      
      <div className="flex flex-col gap-4 mb-6">
        
        {/* TITRE + TOTAL (Avec fond bleu #6275b3 pour le badge) */}
        <div className="flex justify-between items-center">
            <h1 className="text-2xl md:text-3xl font-bold text-[#6275b3] truncate">
                Ma Collection 
                <span className="ml-2 text-base font-normal text-zinc-500">
                    ({filteredAndSortedCards.length})
                </span>
            </h1>
            <div className="shrink-0 bg-[#6275b3] text-white px-3 py-1.5 rounded-lg shadow-sm text-right">
                <span className="text-[10px] uppercase tracking-wide opacity-80 block">Total</span>
                <span className="font-bold whitespace-nowrap">{totalPrice.toFixed(2)} ‚Ç¨</span>
            </div>
        </div>
        
        <div className="flex items-center gap-2 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0 no-scrollbar">
           <button 
             onClick={() => { setIsSelectMode(!isSelectMode); setSelectedIds([]); }}
             className={`shrink-0 px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm border flex items-center gap-2 whitespace-nowrap ${isSelectMode ? 'bg-[#6275b3] text-white border-[#6275b3]' : 'bg-white hover:bg-zinc-100 text-zinc-700 border-zinc-300 dark:bg-zinc-800 dark:border-zinc-600 dark:text-zinc-200'}`}
           >
             {isSelectMode ? 'Annuler' : 'S√©lectionner'}
           </button>

           {!isSelectMode && (
               <>
                <button 
                    onClick={() => setIsToolsOpen(true)}
                    className="shrink-0 bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-200 px-3 py-2 rounded-lg text-sm font-medium transition shadow-sm border border-zinc-200 dark:border-zinc-600 flex items-center gap-2 whitespace-nowrap"
                >
                    G√©rer
                </button>

                <div className="shrink-0">
                    <DeleteAllButton targetCollection="collection" />
                </div>
                
                <button 
                    onClick={() => setIsImportOpen(true)} 
                    className="shrink-0 bg-[#6275b3] hover:bg-[#53639c] text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm whitespace-nowrap"
                >
                    Importer CSV
                </button>
               </>
           )}
        </div>
      </div>

      {/* FILTRES */}
      <div className="bg-white dark:bg-zinc-900 p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm mb-6">
          <div className="flex gap-2 items-center">
              <div className="grow">
                  <input 
                      type="text" 
                      placeholder="Rechercher une carte..." 
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-950 text-sm focus:ring-2 focus:ring-[#6275b3] outline-none"
                  />
              </div>
              <button 
                onClick={() => setShowFilters(!showFilters)}
                className="md:hidden shrink-0 px-3 py-2 bg-zinc-100 dark:bg-zinc-800 rounded-lg text-zinc-600 dark:text-zinc-300 border border-zinc-300 dark:border-zinc-600 text-sm font-medium"
              >
                {showFilters ? 'Masquer' : 'Filtres'}
              </button>
          </div>

          <div className={`mt-4 space-y-4 md:space-y-0 md:flex md:items-end md:gap-4 ${showFilters ? 'block' : 'hidden md:flex'}`}>
            <div className="min-w-[200px]">
                <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">Edition</label>
                <select value={filterSet} onChange={(e) => setFilterSet(e.target.value)} className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-900 text-sm cursor-pointer">
                    <option value="all">Toutes les √©ditions</option>
                    {availableSets.map(set => <option key={set} value={set}>{set}</option>)}
                </select>
            </div>
            <div className="min-w-[180px]">
                <label className="block text-xs font-bold text-zinc-500 mb-1 uppercase">Trier par</label>
                <select value={sortBy} onChange={(e) => setSortBy(e.target.value as SortOption)} className="w-full p-2.5 rounded-lg border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-900 text-sm cursor-pointer">
                    <option value="date">Date d&apos;ajout</option>
                    <option value="price_desc">Prix : Haut - Bas</option>
                    <option value="price_asc">Prix : Bas - Haut</option>
                    <option value="name">Nom : A - Z</option>
                    <option value="quantity">Quantit√©</option>
                </select>
            </div>
            <div className="flex items-center gap-4 pb-3 pt-2 md:pt-0">
                <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" checked={filterFoil} onChange={(e) => setFilterFoil(e.target.checked)} className="w-4 h-4 text-[#6275b3] rounded" />
                    <span className="text-sm font-medium">Foil</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer select-none">
                    <input type="checkbox" checked={filterTrade} onChange={(e) => setFilterTrade(e.target.checked)} className="w-4 h-4 text-green-600 rounded" />
                    <span className="text-sm font-medium">√âchange</span>
                </label>
            </div>
          </div>
      </div>

      {isSelectMode && (
          <div className="mb-4 flex items-center justify-between bg-[#6275b3]/10 p-3 rounded-lg border border-[#6275b3]/30 animate-in fade-in slide-in-from-top-2">
              <span className="font-bold text-[#6275b3] pl-2">
                  {selectedIds.length} carte(s)
              </span>
              <button onClick={handleSelectAll} className="text-sm text-[#6275b3] font-bold px-3 py-1 rounded hover:bg-[#6275b3]/10 transition">
                  {selectedIds.length === filteredAndSortedCards.length ? 'D√©s√©lectionner' : 'Tout s√©lectionner'}
              </button>
          </div>
      )}

      {/* GRILLE */}
      {filteredAndSortedCards.length === 0 ? (
        <div className="text-center py-20 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl border-2 border-dashed border-zinc-200 dark:border-zinc-700">
          <p className="text-xl text-zinc-500 mb-4">Aucun r√©sultat ne correspond √† vos filtres.</p>
          <button onClick={() => { setSearchQuery(''); setFilterSet('all'); setFilterTrade(false); setFilterFoil(false); }} className="text-[#6275b3] hover:underline">R√©initialiser les filtres</button>
        </div>
      ) : (
        <>
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            {visibleCards.map((card) => (
                <MagicCard 
                    key={card.id}
                    {...card}
                    onIncrement={() => updateQuantity(card.id, 1, card.quantity)}
                    onDecrement={() => handleDecrement(card.id, card.quantity)}
                    onEditPrice={(newPrice) => setCustomPrice(card.id, newPrice)}
                    onToggleAttribute={(field, val) => toggleAttribute(card.id, field, val)}
                    isSelectMode={isSelectMode}
                    isSelected={selectedIds.includes(card.id)}
                    onSelect={() => toggleSelection(card.id)}
                />
            ))}
            </div>

            {visibleCount < filteredAndSortedCards.length && (
                <div className="mt-8 flex justify-center pb-10">
                    <button 
                        onClick={() => setVisibleCount(prev => prev + ITEMS_PER_PAGE)}
                        className="bg-zinc-100 hover:bg-zinc-200 dark:bg-zinc-800 dark:hover:bg-zinc-700 text-zinc-800 dark:text-zinc-200 px-8 py-3 rounded-full font-bold shadow-sm transition flex items-center gap-2"
                    >
                        Afficher plus ({filteredAndSortedCards.length - visibleCount}) ‚ñº
                    </button>
                </div>
            )}
        </>
      )}

      {/* ACTION BAR FLOTTANTE (Bleu) */}
      {isSelectMode && selectedIds.length > 0 && (
          <div className="fixed bottom-6 left-4 right-4 md:left-1/2 md:right-auto md:-translate-x-1/2 bg-white dark:bg-zinc-800 shadow-2xl border border-zinc-200 dark:border-zinc-700 p-2 rounded-2xl flex items-center justify-around gap-2 z-50 animate-in slide-in-from-bottom-6 duration-300">
              <button onClick={() => handleBulkTrade(true)} className="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1">
                  <span>Trade</span>
              </button>
              <button onClick={() => handleBulkTrade(false)} className="px-4 py-2 bg-zinc-100 hover:bg-zinc-200 text-zinc-800 rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1">
                  <span>Priv√©</span>
              </button>
              <div className="w-px h-8 bg-zinc-300 mx-1"></div>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl text-sm font-bold transition flex flex-col items-center leading-none gap-1 shadow-md">
                  <span>Suppr</span>
              </button>
          </div>
      )}

      <ImportModal isOpen={isImportOpen} onClose={() => setIsImportOpen(false)} targetCollection="collection" />
      <CollectionToolsModal isOpen={isToolsOpen} onClose={() => setIsToolsOpen(false)} totalCards={cards.length} onRefreshPrices={refreshCollectionPrices} onBulkTrade={bulkSetTradeStatus} />
      <ConfirmModal isOpen={!!cardToDelete} onClose={() => setCardToDelete(null)} onConfirm={() => { if(cardToDelete) removeCard(cardToDelete); }} title="Retirer ?" message="Cette carte sera retir√©e de votre collection." />
    </main>
  );
}
</file>

<file path="components/MagicCard.tsx">
'use client';

import { useState, useEffect, memo } from 'react';

type MagicCardProps = {
  id?: string;
  name: string;
  imageUrl: string;
  imageBackUrl?: string | null;
  quantity?: number;
  price?: number;
  customPrice?: number; 
  setName?: string;
  isFoil?: boolean;
  isSpecificVersion?: boolean;
  isForTrade?: boolean; 
  onIncrement?: () => void;
  onDecrement?: () => void;
  onMove?: () => void;
  onEditPrice?: (newPrice: number) => void;
  onToggleAttribute?: (field: 'isFoil' | 'isSpecificVersion' | 'isForTrade', currentValue: boolean) => void;
  isWishlist?: boolean;
  readOnly?: boolean;
  isTradeView?: boolean;
  allowPriceEdit?: boolean;
  isSelectMode?: boolean;
  isSelected?: boolean;
  onSelect?: () => void;
};

const CARD_BACK_URL = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";

function MagicCard(props: MagicCardProps) {
  const { 
      name, imageUrl, imageBackUrl, quantity = 1, 
      price, customPrice, setName, 
      isFoil, isSpecificVersion, isForTrade,
      isTradeView, allowPriceEdit, 
      onEditPrice, onToggleAttribute, 
      readOnly, isWishlist,
      onIncrement, onDecrement, onMove,
      isSelectMode, isSelected, onSelect
  } = props;
  
  const [isFlipped, setIsFlipped] = useState(false);
  const [isEditingPrice, setIsEditingPrice] = useState(false);
  const [tempPrice, setTempPrice] = useState(customPrice?.toString() || price?.toString() || "0");

  useEffect(() => {
    if (!isEditingPrice) {
        const newVal = customPrice?.toString() || price?.toString() || "0";
        // eslint-disable-next-line react-hooks/set-state-in-effect
        setTempPrice(prev => (prev !== newVal ? newVal : prev));
    }
  }, [customPrice, price, isEditingPrice]);

  const effectivePrice = customPrice !== undefined ? customPrice : (price || 0);

  const handleSavePrice = () => {
      if (onEditPrice) {
          onEditPrice(parseFloat(tempPrice));
          setIsEditingPrice(false);
      }
  };

  const currentImage = isFlipped && imageBackUrl ? imageBackUrl : imageUrl;

  const handleCardClick = () => {
      if (isSelectMode && onSelect) {
          onSelect();
      } else if (imageBackUrl) {
          setIsFlipped(!isFlipped);
      }
  };

  // --- VUE LISTE ---
  if (isTradeView) {
      return (
        <div className="flex items-center gap-3 bg-surface p-2 rounded-lg border border-border content-visibility-auto transition-colors">
            <div className="w-10 h-14 bg-secondary rounded overflow-hidden flex-shrink-0 relative group cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
                 <img src={currentImage} className="w-full h-full object-cover" alt={name} loading="lazy" />
            </div>
            <div className="flex-grow min-w-0">
                <div className="flex items-center gap-2">
                    <p className="font-semibold text-sm truncate text-foreground" title={name}>{name}</p>
                    {isFoil && <span className="text-[10px] font-bold text-amber-600 bg-amber-50 px-1 rounded">FOIL</span>}
                </div>
                <div className="flex items-center gap-2 text-xs text-muted">
                    <p className="truncate">{setName}</p>
                </div>
            </div>
            <div className="text-right flex flex-col items-end">
                {isEditingPrice ? (
                    <div className="flex items-center gap-1">
                        <input type="number" value={tempPrice} onChange={(e) => setTempPrice(e.target.value)} className="w-16 p-1 text-xs border rounded bg-background text-foreground" autoFocus />
                        <button onClick={handleSavePrice} className="text-success text-xs font-bold">OK</button>
                    </div>
                ) : (
                    <div 
                        className={`font-medium text-sm ${customPrice ? 'text-orange-600' : 'text-foreground'} ${allowPriceEdit ? 'cursor-pointer hover:text-primary' : ''}`}
                        onClick={() => { if (allowPriceEdit) { setTempPrice(effectivePrice.toString()); setIsEditingPrice(true); }}}
                    >
                        {effectivePrice.toFixed(2)} ‚Ç¨
                    </div>
                )}
            </div>
        </div>
      );
  }

  // --- VUE GRILLE ---
  return (
    <div 
        onClick={handleCardClick}
        className={`relative group flex flex-col rounded-xl overflow-hidden p-3 gap-2 h-full content-visibility-auto
        bg-surface border transition-all duration-200 shadow-sm hover:shadow-md
        
        /* S√âLECTION CENTRALIS√âE */
        ${isSelected 
            ? 'border-primary ring-1 ring-primary bg-primary/5' 
            : 'border-border hover:border-primary'
        }
        ${isSelectMode ? 'cursor-pointer' : ''}
        `}
    >

      {isSelectMode && (
          <div className="absolute top-2 right-2 z-30 pointer-events-none">
              <div className={`w-5 h-5 rounded-full border flex items-center justify-center transition-all ${isSelected ? 'bg-primary border-primary' : 'bg-surface border-muted'}`}>
                  {isSelected && <span className="text-primary-foreground text-xs font-bold">‚úì</span>}
              </div>
          </div>
      )}

      <div className="relative w-full aspect-[2.5/3.5] bg-secondary rounded-lg overflow-hidden shrink-0">
        <img
          src={currentImage || CARD_BACK_URL}
          alt={name}
          loading="lazy"
          className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
          onError={(e) => { e.currentTarget.src = CARD_BACK_URL; }}
        />
        {isFoil && <div className="absolute bottom-0 right-0 bg-amber-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-tl-md shadow-sm">FOIL</div>}
        {imageBackUrl && !isSelectMode && (
          <button onClick={(e) => { e.stopPropagation(); setIsFlipped(!isFlipped); }} className="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-1.5 rounded-full backdrop-blur-sm transition-opacity opacity-0 group-hover:opacity-100 z-10 text-[9px] font-bold">‚Üª</button>
        )}
      </div>
      
      <div className="flex-1 flex flex-col min-w-0 pt-1">
        <div className="flex justify-between items-start mb-0.5">
            <h3 className="font-semibold text-sm leading-tight text-foreground truncate flex-grow" title={name}>{name}</h3>
        </div>
        
        <p className="text-[11px] text-muted truncate mb-2">{setName}</p>

        <div className={`flex flex-wrap gap-1 mb-2 ${isSelectMode ? 'pointer-events-none opacity-50' : ''}`}>
            {onToggleAttribute ? (
                <button 
                    onClick={(e) => { e.stopPropagation(); onToggleAttribute('isFoil', !!isFoil); }}
                    className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                        isFoil 
                        ? 'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800' 
                        : 'bg-secondary text-muted border-transparent hover:bg-border'
                    }`}
                >
                    {isFoil ? 'Foil' : 'Normal'}
                </button>
            ) : null}

            {isWishlist ? (
                onToggleAttribute && (
                    <button 
                        onClick={(e) => { e.stopPropagation(); onToggleAttribute('isSpecificVersion', !!isSpecificVersion); }}
                        className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                            isSpecificVersion 
                            ? 'bg-primary/10 text-primary border-primary/30' 
                            : 'bg-secondary text-muted border-transparent'
                        }`}
                    >
                        {isSpecificVersion ? 'Exact' : 'Auto'}
                    </button>
                )
            ) : (
                onToggleAttribute && (
                    <button 
                        onClick={(e) => { e.stopPropagation(); onToggleAttribute('isForTrade', !!isForTrade); }}
                        className={`text-[10px] px-2 py-1 rounded border transition-colors font-medium flex-1 text-center ${
                            isForTrade 
                            ? 'bg-success/10 text-success border-success/20' 
                            : 'bg-secondary text-muted border-transparent hover:bg-border'
                        }`}
                    >
                        {isForTrade ? 'Trade' : 'Priv√©'}
                    </button>
                )
            )}
            
            {isWishlist && !readOnly && !isSelectMode && onMove && (
                <button 
                    onClick={(e) => { e.stopPropagation(); onMove(); }}
                    className="text-[10px] px-2 py-1 rounded border transition-colors font-bold flex-1 text-center bg-surface text-success border-success/30 hover:bg-success/5"
                    title="J'ai re√ßu cette carte"
                >
                    Achet√©
                </button>
            )}
        </div>
        
        <div className={`mt-auto flex justify-between items-center border-t border-border pt-2 ${isSelectMode ? 'pointer-events-none opacity-50' : ''}`}>
          <div className="flex items-center gap-1">
            {!readOnly && <button onClick={(e) => {e.stopPropagation(); onDecrement?.()}} className="w-5 h-5 rounded bg-secondary hover:bg-border text-muted hover:text-foreground flex items-center justify-center text-xs font-bold transition">-</button>}
            <span className={`text-sm ${readOnly ? 'font-bold text-foreground' : 'w-4 text-center text-foreground'}`}>{readOnly && "x"}{quantity}</span>
            {!readOnly && <button onClick={(e) => {e.stopPropagation(); onIncrement?.()}} className="w-5 h-5 rounded bg-primary/10 hover:bg-primary/20 text-primary border border-primary/30 flex items-center justify-center text-xs font-bold transition">+</button>}
          </div>
          
          <div className="text-right leading-none">
             <p className={`font-bold text-sm ${customPrice ? 'text-orange-600' : 'text-foreground'}`}>
                 {(effectivePrice * quantity).toFixed(2)} ‚Ç¨
             </p>
          </div>
        </div>
      </div>
    </div>
  );
}

export default memo(MagicCard);
</file>

<file path="components/ImportModal.tsx">
// components/ImportModal.tsx
'use client';

import React, { useState, useMemo, useEffect } from 'react';
import Papa from 'papaparse';
import { useAuth } from '@/lib/AuthContext';
import { db } from '@/lib/firebase';
import { doc, writeBatch, increment } from 'firebase/firestore';
import toast from 'react-hot-toast';

type ManaboxRow = {
  "Binder Name": string;
  "Name": string;
  "Set code": string;
  "Set name": string;
  "Collector number": string;
  "Foil": string;
  "Rarity": string;
  "Quantity": string;
  "ManaBox ID": string;
  "Scryfall ID": string; 
  "Purchase price": string;
  "Language": string;
  "Condition": string;
};

type ScryfallCard = {
  id: string;
  name: string;
  set: string;
  collector_number: string;
  set_name: string;
  prices?: { eur?: string; usd?: string };
  image_uris?: { normal?: string };
  card_faces?: Array<{ 
    name: string;
    image_uris?: { normal?: string } 
  }>;
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  [key: string]: any;
};

type ExistingCard = {
  scryfallId?: string; 
  id: string;
  quantity: number;
  foil?: boolean;
};

type ImportModalProps = {
  isOpen: boolean;
  onClose: () => void;
  targetCollection?: string;
  currentCollection?: ExistingCard[];
};

export default function ImportModal({ isOpen, onClose, targetCollection = 'collection', currentCollection = [] }: ImportModalProps) {
  const { user } = useAuth();
  
  const [inputType, setInputType] = useState<'file' | 'text'>('file');
  const [textInput, setTextInput] = useState('');
  
  const [data, setData] = useState<ManaboxRow[]>([]);
  const [columns, setColumns] = useState<string[]>([]);
  const [step, setStep] = useState<'upload' | 'preview' | 'importing'>('upload');
  
  const [progress, setProgress] = useState(0);
  const [statusMsg, setStatusMsg] = useState('');
  const [importMode, setImportMode] = useState<'add' | 'sync'>('add'); 

  const existingMap = useMemo(() => {
    const map = new Map<string, ExistingCard>();
    currentCollection.forEach(card => {
        const key = card.id; 
        map.set(key, card);
    });
    return map;
  }, [currentCollection]);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (isOpen && e.key === 'Escape' && step !== 'importing') handleClose();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, step]);

  const handleClose = () => {
    if (step === 'importing') return; 
    onClose();
    setTimeout(() => {
      setStep('upload');
      setData([]);
      setTextInput('');
      setProgress(0);
    }, 300);
  };

  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget && step !== 'importing') handleClose();
  };

  if (!isOpen) return null;

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      delimiter: ",", 
      encoding: "UTF-8",
      complete: (results) => {
        setColumns(results.meta.fields || []);
        setData(results.data as ManaboxRow[]);
        setStep('preview');
      },
      error: (error) => toast.error("Erreur CSV : " + error.message)
    });
  };

  const handleTextParse = () => {
    if (!textInput.trim()) return;

    const rows: ManaboxRow[] = [];
    const lines = textInput.split('\n');
    const regex = /^(\d+)\s+(.+?)\s+\((\w+)\)\s+(\S+)(?:\s+\*(F)\*)?/;

    lines.forEach(line => {
        const cleanLine = line.trim();
        if (!cleanLine) return;
        const match = cleanLine.match(regex);
        if (match) {
            rows.push({
                "Quantity": match[1],
                "Name": match[2],
                "Set code": match[3].toLowerCase(),
                "Collector number": match[4],
                "Foil": match[5] === 'F' ? "true" : "false",
                "Scryfall ID": "", 
                "Binder Name": "Import Texte",
                "Set name": "",
                "Rarity": "",
                "ManaBox ID": "",
                "Purchase price": "0",
                "Language": "en",
                "Condition": "Near Mint"
            });
        }
    });

    if (rows.length === 0) {
        toast.error("Format non reconnu.");
        return;
    }
    setColumns(["Name", "Set code", "Quantity", "Foil", "Collector number"]);
    setData(rows);
    setStep('preview');
  };

  const chunkArray = <T,>(array: T[], size: number): T[][] => {
    const chunks = [];
    for (let i = 0; i < array.length; i += size) {
      chunks.push(array.slice(i, i + size));
    }
    return chunks;
  };

  const getCardInfo = (scryfallCard: ScryfallCard) => {
    let name = scryfallCard.name;
    let imageUrl = scryfallCard.image_uris?.normal;
    let imageBackUrl = null;

    if (scryfallCard.card_faces && scryfallCard.card_faces.length > 1) {
      name = scryfallCard.card_faces[0].name;
      if (!imageUrl && scryfallCard.card_faces[0].image_uris) {
        imageUrl = scryfallCard.card_faces[0].image_uris.normal;
      }
      if (scryfallCard.card_faces[1].image_uris) {
        imageBackUrl = scryfallCard.card_faces[1].image_uris.normal;
      }
    }
    if (!imageUrl) {
        imageUrl = "https://cards.scryfall.io/large/front/a/6/a6984342-f723-4e80-8e69-902d287a915f.jpg";
    }
    return { name, imageUrl, imageBackUrl };
  };

  const startImport = async () => {
    if (!user) return;
    setStep('importing');
    setProgress(0);

    const rowsToFetch: ManaboxRow[] = [];
    const rowsToUpdateDirectly: ManaboxRow[] = [];
    let skippedCount = 0; 

    data.forEach(row => {
        const scryfallId = row["Scryfall ID"];
        const csvQty = parseInt(row["Quantity"]) || 1;
        const csvFoil = row["Foil"] === "true";
        const existing = scryfallId ? existingMap.get(scryfallId) : undefined;

        if (existing) {
            if (importMode === 'sync') {
                const existingFoil = !!existing.foil;
                if (existing.quantity === csvQty && existingFoil === csvFoil) {
                    skippedCount++;
                } else {
                    rowsToUpdateDirectly.push(row);
                }
            } else {
                if (csvQty > 0) rowsToUpdateDirectly.push(row);
            }
        } else {
            rowsToFetch.push(row);
        }
    });

    let processedCount = skippedCount; 
    let successCount = 0; 

    if (rowsToUpdateDirectly.length > 0) {
        setStatusMsg("Mise √† jour rapide...");
        const updateChunks = chunkArray(rowsToUpdateDirectly, 400);

        for (const chunk of updateChunks) {
            const batch = writeBatch(db);
            chunk.forEach(row => {
                const cardRef = doc(db, 'users', user.uid, targetCollection, row["Scryfall ID"]);
                const qtyToAdd = parseInt(row["Quantity"]);
                
                if (importMode === 'sync') {
                    batch.update(cardRef, {
                        quantity: qtyToAdd,
                        foil: row["Foil"] === "true",
                        price: parseFloat(row["Purchase price"]) || 0,
                    });
                } else {
                    batch.update(cardRef, {
                        quantity: increment(qtyToAdd),
                        foil: row["Foil"] === "true",
                        importedAt: new Date()
                    });
                }
                successCount++;
            });
            await batch.commit();
            processedCount += chunk.length;
            setProgress(Math.round((processedCount / data.length) * 100));
        }
    }

    if (rowsToFetch.length > 0) {
        setStatusMsg("Identification des cartes...");
        const fetchChunks = chunkArray(rowsToFetch, 75);

        for (const chunk of fetchChunks) {
            try {
                const identifiers = chunk.map(row => {
                    if (row["Scryfall ID"]) return { id: row["Scryfall ID"] };
                    return { name: row["Name"], set: row["Set code"], collector_number: row["Collector number"] };
                });
                
                const response = await fetch('https://api.scryfall.com/cards/collection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifiers })
                });

                const result = await response.json();
                const foundCards: ScryfallCard[] = result.data || [];
                const batch = writeBatch(db);
                let batchHasOps = false;
                
                foundCards.forEach(scryfallData => {
                    const matchingRow = chunk.find(r => 
                        r["Scryfall ID"] === scryfallData.id || 
                        (r["Set code"] === scryfallData.set && r["Collector number"] === scryfallData.collector_number)
                    );

                    if (matchingRow) {
                        const csvQty = parseInt(matchingRow["Quantity"]);
                        const csvFoil = matchingRow["Foil"] === "true";
                        
                        const existing = existingMap.get(scryfallData.id);
                        let shouldWrite = true;

                        if (existing && importMode === 'sync') {
                            const existingFoil = !!existing.foil;
                            if (existing.quantity === csvQty && existingFoil === csvFoil) {
                                shouldWrite = false;
                                skippedCount++;
                            }
                        }

                        if (shouldWrite) {
                            const { name, imageUrl, imageBackUrl } = getCardInfo(scryfallData);
                            const cardRef = doc(db, 'users', user.uid, targetCollection, scryfallData.id);
                            
                            const cardData = {
                                name, imageUrl, imageBackUrl,
                                setName: scryfallData.set_name, setCode: scryfallData.set,
                                scryfallId: scryfallData.id,
                                price: parseFloat(scryfallData.prices?.eur || "0"),
                                foil: csvFoil,
                                importedAt: new Date(),
                                // --- SAUVEGARDE COMPL√àTE ICI ---
                                scryfallData: scryfallData
                            };

                            if (importMode === 'add') {
                                 batch.set(cardRef, { ...cardData, quantity: increment(csvQty) }, { merge: true });
                            } else {
                                 batch.set(cardRef, { ...cardData, quantity: csvQty }, { merge: true });
                            }
                            successCount++;
                            batchHasOps = true;
                        }
                    }
                });

                if (batchHasOps) {
                    await batch.commit();
                }
                
            } catch (error) {
                console.error("Erreur Scryfall", error);
            }
            processedCount += chunk.length;
            setProgress(Math.round((processedCount / data.length) * 100));
            await new Promise(r => setTimeout(r, 100));
        }
    }

    toast.success(`${successCount} cartes synchronis√©e(s) !`, { duration: 4000 });
    handleClose();
  };

  return (
    <div 
      className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm"
      onClick={handleBackdropClick}
    >
      <div 
        className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-5xl w-full shadow-2xl border border-gray-100 dark:border-gray-700 flex flex-col max-h-[90vh]"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex-none flex justify-between items-center mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
          <h2 className="text-xl font-bold text-gray-900 dark:text-white">
            Ajouter des cartes
          </h2>
          {step !== 'importing' && (
             <button onClick={handleClose} className="text-gray-500 hover:text-gray-700 text-lg p-2">‚úï</button>
          )}
        </div>

        <div className="flex-grow overflow-hidden flex flex-col min-h-0">
            
            {step === 'upload' && (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="flex-none flex border-b border-gray-200 dark:border-gray-700 mb-4">
                        <button onClick={() => setInputType('file')} className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${inputType === 'file' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}>üìÇ Fichier CSV</button>
                        <button onClick={() => setInputType('text')} className={`px-4 py-2 font-medium text-sm border-b-2 transition-colors ${inputType === 'text' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'}`}>üìù Copier / Coller</button>
                    </div>
                    {inputType === 'file' ? (
                        <div className="flex-grow p-12 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition relative cursor-pointer group flex flex-col items-center justify-center">
                            <input type="file" accept=".csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" />
                            <div className="text-6xl mb-4 group-hover:scale-110 transition-transform">üìÇ</div>
                            <p className="font-bold text-lg">D√©poser CSV Manabox</p>
                        </div>
                    ) : (
                        <div className="flex-grow flex flex-col min-h-0">
                            <textarea value={textInput} onChange={(e) => setTextInput(e.target.value)} rows={15} placeholder="Collez votre liste ici..." className="flex-grow w-full p-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900 font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none resize-none" />
                            <button onClick={handleTextParse} disabled={!textInput.trim()} className="flex-none mt-4 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-bold py-3 rounded-xl shadow-md transition">Analyser le texte</button>
                        </div>
                    )}
                </div>
            )}

            {step === 'preview' && (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="flex-none grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div onClick={() => setImportMode('add')} className={`p-3 rounded-xl border-2 cursor-pointer transition flex flex-col gap-1 ${importMode === 'add' ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-blue-300'}`}>
                            <div className="flex items-center gap-2 font-bold text-blue-700 dark:text-blue-300 text-sm">
                                <span className={`w-4 h-4 rounded-full border flex items-center justify-center ${importMode === 'add' ? 'border-blue-600 bg-blue-600' : 'border-gray-400'}`}>{importMode === 'add' && <span className="w-2 h-2 rounded-full bg-white"></span>}</span> Ajouter
                            </div>
                            <p className="text-[10px] text-gray-500 ml-6">Ajoute (+1) aux quantit√©s existantes.</p>
                        </div>
                        <div onClick={() => setImportMode('sync')} className={`p-3 rounded-xl border-2 cursor-pointer transition flex flex-col gap-1 ${importMode === 'sync' ? 'border-purple-500 bg-purple-50 dark:bg-purple-900/20' : 'border-gray-200 dark:border-gray-700 hover:border-purple-300'}`}>
                            <div className="flex items-center gap-2 font-bold text-purple-700 dark:text-purple-300 text-sm">
                                <span className={`w-4 h-4 rounded-full border flex items-center justify-center ${importMode === 'sync' ? 'border-purple-600 bg-purple-600' : 'border-gray-400'}`}>{importMode === 'sync' && <span className="w-2 h-2 rounded-full bg-white"></span>}</span> Synchroniser
                            </div>
                            <p className="text-[10px] text-gray-500 ml-6">Remplace (=1) la quantit√© en base.</p>
                        </div>
                    </div>
                    <div className="flex-none flex justify-between items-center mb-2 px-1">
                        <span className="text-sm font-semibold">{data.length} cartes d√©tect√©es</span>
                        <button onClick={() => { setData([]); setStep('upload'); }} className="text-red-500 text-xs hover:underline">Retour</button>
                    </div>
                    <div className="flex-grow overflow-auto min-h-0 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900">
                        <table className="w-full text-xs text-left text-gray-500 dark:text-gray-400">
                            <thead className="text-gray-700 bg-gray-200 dark:bg-gray-800 sticky top-0 z-10">
                                <tr>{columns.slice(0,6).map((col, i) => <th key={i} className="px-4 py-2">{col}</th>)}</tr>
                            </thead>
                            <tbody>
                                {data.map((row, i) => (
                                    <tr key={i} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                                        {columns.slice(0,6).map((col, j) => <td key={j} className="px-4 py-1 truncate max-w-[150px]">{row[col as keyof ManaboxRow]}</td>)}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="flex-none pt-4">
                        <button onClick={startImport} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:-translate-y-0.5 ${importMode === 'add' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'}`}>
                            {importMode === 'add' ? '‚ûï Valider l\'Ajout' : 'üîÑ Valider la Synchronisation'}
                        </button>
                    </div>
                </div>
            )}

            {step === 'importing' && (
                <div className="flex flex-col items-center justify-center h-full py-10">
                    <div className="text-5xl font-bold text-blue-600 mb-2">{progress}%</div>
                    <p className="text-gray-500 animate-pulse mb-6">{statusMsg}</p>
                    <div className="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden max-w-md">
                        <div className="bg-blue-600 h-full rounded-full transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                    </div>
                </div>
            )}
        </div>
      </div>
    </div>
  );
}
</file>

</files>
