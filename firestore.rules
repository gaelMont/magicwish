'use client';

import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { Trophy, Search, Users, Star, TrendingUp } from 'lucide-react';
import { db } from '@/lib/firebase/config';
import { collection, getDocs, query, where, orderBy, limit, doc, setDoc } from 'firebase/firestore';
import PantheonRow from '@/components/pantheon/PantheonRow';
import { useAuth } from '@/context/AuthContext';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { toast } from 'sonner';

// Définition stricte du type utilisateur pour éviter 'any'
interface PantheonUser {
  id: string;
  displayName?: string;
  photoURL?: string;
  cardCount: number;
  totalValue?: number;
  isCollectionPublic: boolean;
  rank?: number;
  // Ajoute d'autres propriétés si nécessaire selon ton schéma Firestore
}

export default function PantheonPage() {
  const { user } = useAuth();
  const [users, setUsers] = useState<PantheonUser[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('cards'); // 'cards' | 'value'

  useEffect(() => {
    const fetchUsers = async () => {
      try {
        const q = query(
          collection(db, 'users'),
          where('cardCount', '>', 0),
          orderBy('cardCount', 'desc'),
          limit(50)
        );
        
        const querySnapshot = await getDocs(q);
        const usersData = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })) as PantheonUser[];

        setUsers(usersData);
      } catch (error) {
        console.error('Error fetching pantheon:', error);
        toast.error('Erreur lors du chargement du panthéon');
      } finally {
        setLoading(false);
      }
    };

    fetchUsers();
  }, []);

  const handleUpdateVisibility = async (userId: string, isPublic: boolean) => {
    // 1. Sauvegarder l'état précédent pour le rollback en cas d'erreur
    const previousUsers = [...users];

    // 2. Mise à jour Optimiste : on met à jour l'UI immédiatement
    setUsers(prevUsers => prevUsers.map(user => 
      user.id === userId 
        ? { ...user, isCollectionPublic: isPublic }
        : user
    ));

  match /chats/{chatId} {
      // Un utilisateur peut lire une discussion s'il fait partie des participants
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // La création initiale se fait via Server Action (Admin SDK), 
      // mais on permet la lecture et l'ajout de messages pour les participants
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        allow create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;
      }
    }

    try {
      const userRef = doc(db, 'users', userId);
      
      // 3. Utilisation de setDoc avec merge: true pour éviter l'erreur "No document to update"
      // Si le document n'existe pas, il sera créé avec ce champ uniquement.
      // S'il existe, seul le champ isCollectionPublic sera mis à jour.
      await setDoc(userRef, {
        isCollectionPublic: isPublic
      }, { merge: true });

      toast.success(isPublic ? 'Collection rendue publique' : 'Collection rendue privée');
    } catch (error) {
      console.error('Error updating visibility:', error);
      
      // 4. Rollback : on rétablit l'état précédent en cas d'erreur
      setUsers(previousUsers);
      toast.error('Impossible de modifier la visibilité');
    }
  };

  const filteredUsers = users
    .filter(u => u.displayName?.toLowerCase().includes(searchTerm.toLowerCase()))
    .sort((a, b) => {
      if (sortBy === 'value') {
        return (b.totalValue || 0) - (a.totalValue || 0);
      }
      return b.cardCount - a.cardCount;
    });

  if (loading) {
    return (
      <div className="min-h-screen pt-24 pb-12 flex justify-center items-center">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen pt-24 pb-12 px-4 sm:px-6 lg:px-8 bg-background">
      <div className="max-w-7xl mx-auto space-y-8">
        {/* Header */}
        <div className="text-center space-y-4">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="flex items-center justify-center gap-3"
          >
            <Trophy className="w-10 h-10 text-yellow-500" />
            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-500 to-amber-600">
              Panthéon des Collectionneurs
            </h1>
          </motion.div>
          <p className="text-muted-foreground max-w-2xl mx-auto">
            Découvrez les plus grandes collections de la communauté MagicWish.
            Classement basé sur le nombre de cartes et la rareté.
          </p>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-card border border-border/50 rounded-xl p-6 shadow-sm"
          >
            <div className="flex items-center gap-4">
              <div className="p-3 bg-primary/10 rounded-lg">
                <Users className="w-6 h-6 text-primary" />
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Collectionneurs</p>
                <p className="text-2xl font-bold">{users.length}</p>
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="bg-card border border-border/50 rounded-xl p-6 shadow-sm"
          >
            <div className="flex items-center gap-4">
              <div className="p-3 bg-yellow-500/10 rounded-lg">
                <Star className="w-6 h-6 text-yellow-500" />
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Top Collection</p>
                <p className="text-2xl font-bold">
                  {users[0]?.cardCount || 0} cartes
                </p>
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className="bg-card border border-border/50 rounded-xl p-6 shadow-sm"
          >
            <div className="flex items-center gap-4">
              <div className="p-3 bg-green-500/10 rounded-lg">
                <TrendingUp className="w-6 h-6 text-green-500" />
              </div>
              <div>
                <p className="text-sm text-muted-foreground">Valeur Totale</p>
                <p className="text-2xl font-bold">Soon</p>
              </div>
            </div>
          </motion.div>
        </div>

        {/* Filters */}
        <div className="flex flex-col sm:flex-row gap-4 justify-between items-center bg-card p-4 rounded-xl border border-border/50">
          <div className="relative w-full sm:w-96">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input
              placeholder="Rechercher un collectionneur..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-9"
            />
          </div>
          
          <Select value={sortBy} onValueChange={setSortBy}>
            <SelectTrigger className="w-full sm:w-[200px]">
              <SelectValue placeholder="Trier par" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="cards">Nombre de cartes</SelectItem>
              <SelectItem value="value">Valeur estimée</SelectItem>
            </SelectContent>
          </Select>
        </div>

        {/* List */}
        <div className="space-y-4">
          {filteredUsers.map((pantheonUser, index) => (
            <PantheonRow
              key={pantheonUser.id}
              user={pantheonUser}
              rank={index + 1}
              isCurrentUser={user?.uid === pantheonUser.id}
              onUpdateVisibility={handleUpdateVisibility}
            />
          ))}
          
          {filteredUsers.length === 0 && (
            <div className="text-center py-12 text-muted-foreground">
              Aucun collectionneur trouvé
            </div>
          )}
        </div>
      </div>
    </div>
  );
}